<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
	pageEncoding="ISO-8859-1"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet"
	href="${contextPath}/assets/js/plugin/jquery_autocomplete/jquery.autocomplete.css" />
<script src="${contextPath}/assets/js/plugin/jquery.autocomplete.min.js"></script>
<script src="${contextPath}/assets/appJs/validation/party-master.js"></script>
<script src="${contextPath}/assets/appJs/validation/invoice.js"></script>
<style>
body {
	font-family: Arial, sans-serif;
	margin: 20px;
}

.product-list {
	margin-bottom: 20px;
}

.form-control {
	margin-right: 10px;
	margin-bottom: 10px;
}

.btn-add-product {
	margin-top: 10px;
	padding: 10px 20px;
	background-color: #007bff;
	color: #fff;
	border: none;
	cursor: pointer;
}

.btn-add-product:hover {
	background-color: #0056b3;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-top: 20px;
}

th, td {
	border: 1px solid #ddd;
	padding: 8px;
}

th {
	background-color: #1c985f;
	text-align: left;
}

body {
	font-family: Arial, sans-serif;
	background-color: #f5f5f5;
	margin: 0;
	padding: 0;
}

.container {
	max-width: 800px;
	margin: 50px auto;
	background: #fff;
	padding: 20px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

header {
	text-align: center;
	margin-bottom: 20px;
}

h1 {
	font-size: 24px;
	margin: 0;
}

.form-group {
	margin-bottom: 15px;
}

label {
	display: block;
	margin-bottom: 5px;
}

input[type="text"], input[type="date"], select {
	width: 100%;
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
}

.product-list {
	margin: 20px 0;
}

.product-item {
	display: flex;
	gap: 10px;
	margin-bottom: 10px;
}

.product-item input {
	flex: 1;
}

.totals {
	background: #f9f9f9;
	padding: 10px;
	margin: 20px 0;
}
.error-border {
	border: 2px solid red !important;
}

.total-item {
	display: flex;
	justify-content: space-between;
	padding: 5px 0;
}

button[type="button"] {
	background: #007bff;
	color: #fff;
	border: none;
	padding: 10px 20px;
	border-radius: 5px;
	cursor: pointer;
}

button[type="submit"] {
	background: #28a745;
	color: #fff;
	border: none;
	padding: 10px 20px;
	border-radius: 5px;
	cursor: pointer;
	display: block;
	width: 100%;
	margin-top: 20px;
}

button:hover {
	opacity: 0.9;
}

.remove-btn {
    background-color: #dc3545 !important; 
    border-color: #dc3545 !important; 
    color: white !important; 
}

.remove-btn:hover {
    background-color: #c82333; /* Darker red on hover */
    border-color: #bd2130; /* Darker border on hover */
}

</style>

<script>
	$(function()
	{
		$('#datatable-default').dataTable({
			"bSort": false,
			"autoWidth": false
		});
	})
</script>

<div class="container-fluid">
<!-- Start::row-1 -->
<div class="row">
	<div class="col-xl-12">
		<div class="card custom-card">
			<div class="top-left"></div>
			<div class="top-right"></div>
			<div class="bottom-left"></div>
			<div class="bottom-right"></div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-12">
						<section class="panel">
							<header class="panel-heading">
								<div>
									<div id="c" tabindex="1"></div>
								</div>
								<h4 class="panel-title">
									<span>Invoice Collection</span>
								</h4>
								<!-- <jsp:include page="/WEB-INF/views/message.jsp" /> -->
							</header>
						<div class="panel-body" id="partyDtlsInRequest">
							<div class="col-md-12">
								<form class="form-horizontal form-bordered" id="paymentForm" 
									action="${contextPath}/invoiceCollection/manage" method="post" >

                                      <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                                      <input type="hidden" id="paymentId" name="paymentId" value="" />
										<div class="row">
											<div class="col-md-5">
												<label class="col-md-12 required" for="inputDefault"><spring:message
														code="LABEL.ACCOUNTS.INVOICE.PARTY.CODENAME" /></label>
												<div class="col-md-12">
													<input type="text" class="form-control"
														name="billingFromPartyName" id="billingFromPartyName" value="${invoiceDetails.partyDetails.partyName}"> 
														
													<input type="hidden"
														name="partyId" id="partyId" value="${invoiceDetails.partyDetails.partyId}">
												</div>
											</div>

											<div class="col-md-2">
												<div class="form-group">
													<label for="invoice-id">Total Amount</label> 
													<input type="text" class="form-control text-end amount-field"
														name="totalAmount" id="totalAmount" value="">
												</div>
											</div>

											<div class="col-md-2">
												<div class="form-group">
													<label for="invoice-id">Payment Mode</label> 
													<select class="form-select required" name="instrumentType" id="instrumentType" data-plugin-selectTwo >
													<option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT"/></option>
													<c:forEach items="${instrumentType}" var="Instrument">
														<option value="${Instrument.receiptModeId}" >
															${Instrument.receiptMode} 
														</option>
													</c:forEach>
												</select>
												</div>
											</div>

											<div class="col-md-2">
												<div class="form-group">
													<label for="invoice-id">Instrument Number</label> 
													<input type="text" class="form-control"
														name="taxNumber" id="taxNumber">
												</div>
											</div>

											<div class="col-md-2">
												<div class="form-group">
													<label for="invoice-id">Instrument Date</label> 
													<input type="date" class="form-control"
														name="taxDate" id="taxDate">
												</div>
											</div>

											<div class="row">
                                     			<h6 class="panel-title"><span>Invoice Details</span></h6>
                                     		 </div>
										</div>

										<div class="table-responsive">
											<table id="product-table Data-table" >
												<thead>
													<tr>
														<th width="80px">Sl No.</th>
														<th>Invoice Number</th>
														<th>Invoice Amount</th>
														<th>Paid Amount</th>
														<th>Balance Amount</th>
														<th>Select</th>
													</tr>
												</thead>
												<tbody id="invoice-tbl-body">
																								
												</tbody>
												<tfoot>
													<tr>
														<td colspan="3" class="text-end"><strong>Total Paid Amount:</strong></td>
														<td><input type="text" id="totalPaidAmount" class="form-control text-end" readonly></td>
														<td></td>
														<td></td>
													</tr>
												</tfoot>
											</table>
										</div>
											
								</form>
							</div>
								<div class="row">
									<div class="col-sm-12" style="margin-top: 30px;">
										<div class="form-group text-center">
											<input type="button" class="btn btn-success"
												onclick="formSubmit()" value="SAVE" />
												
												<a href="${contextPath}/invoiceCollection/list">
													<input type="button" class="btn btn-danger" value="Back">
												</a>
										</div>
									</div>
								</div>
							</div>
						</section>
					</div>
				<hr>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>




<script>
var url='${contextPath}';

$(document).ready(function() {

	var existingPartyId = '${invoiceDetails.partyDetails.partyId}';

	// amount format initializing when page loads for first 
	$('.amount-format').on('blur', function () {
        let value = parseFloat($(this).val());
        if (!isNaN(value)) {
            // Format the value to two decimal places
            $(this).val(value.toFixed(2));
        } else {
            // If the input is not a valid number, clear the field
            $(this).val('');
        }
    });

	if(!existingPartyId){
			$("input[name^='billingFromPartyName']").autocomplete({
			serviceUrl: '${contextPath}/inv/findPartyDetailByAutocomplete.htm',
			paramName: "clientcode",
			delimiter: ",",
			width: '150px',
			transformResult: function(response) {
				return {
					suggestions: $.map($.parseJSON(response), function(item) {
						return {
							value: item.clientcode,
							data: item.clientid
						};
					})
				};
			},
			onSelect: function (suggestion) {
				var selectedRow = parseInt(this.parentNode.parentNode.rowIndex) - 1;
				document.getElementById("partyId").value = suggestion.data;
				console.log(suggestion.data);

				// fetch invoice details by party 
				fetchInvoiceDetailsByPartyId(suggestion.data);
			}
		});
	}else{
		fetchInvoiceDetailsByPartyId(existingPartyId);
	}

	
});


function fetchInvoiceDetailsByPartyId(partyId) {
	debugger;
    $.ajax({
        url: url+ '/invoiceCollection/invoiceDetailsByParty',
        type: 'GET',
        data: { partyId: partyId },
        success: function(response) {
			debugger;
            if (response.outcome) {
				populateExistingData(response.result);
                populateInvoiceTable(response.result.invoiceDtoList);
            } else {
				emptyTable();
                alert('Invoice details not found');
            }
        },
        error: function() {
            alert('Error fetching invoice details.');
        }
    });
}



function populateExistingData(response) {
    // Ensure debugger only triggers when needed
    // debugger;

    const { paymentMasterId: paymentReceiptId, totalAmount, transactionNumber: txnNumber, transactionDate: txnDate , instrumentTypeId: instrumentType} = response;

    // Check if valid data is present
    if (paymentReceiptId && totalAmount && totalAmount !== '0.00') {
        $('#totalAmount').val(parseFloat(totalAmount).toFixed(2));  // Ensure 2 decimal places
        $('#taxNumber').val(txnNumber);

		$('#instrumentType').val(instrumentType);

         // Extract date portion (YYYY-MM-DD) from txnDate (which is in YYYY-MM-DD HH:MM:SS.S format)
		const dateOnly = txnDate.split(' ')[0];  // Get the date part before the space
		$('#taxDate').val(dateOnly);  // Set the date to the input field

		$('#paymentId').val(paymentReceiptId);
    }
	else{
		$('#totalAmount').val('0.00');  // Ensure 2 decimal places
        $('#taxNumber').val('');
		$('#taxDate').val('');
		$('#instrumentType').val('');
		$('#paymentId').val('');
	}
}

function populateInvoiceTable(invoiceDtoList) {
    let tableBody = $('#invoice-tbl-body');
    tableBody.empty();  // Clear any existing rows
	let totalPaid = 0;  // Initialize the total paid amount
	$('#totalPaidAmount').val('0.00');

    if (invoiceDtoList.length === 0) {
        emptyTable();
    } else {
        invoiceDtoList.forEach((invoice, index) => {
			var existingAmount = invoice.paidAmount ? parseFloat(invoice.paidAmount) : '';
			var detailsId = invoice.paymentDetailsId ? invoice.paymentDetailsId : '';
            var invoiceAmount = parseFloat(invoice.invoiceAmount);
            var balanceAmount = invoiceAmount - (existingAmount || 0);  // Set initial balance
			var readOnly = balanceAmount === 0 ? 'readonly' : '';

			// Disable checkbox if balance is zero
            var checkboxDisabled = balanceAmount === 0 ? 'disabled' : '';

			debugger;
			totalPaid += existingAmount;  // Add to the total paid amount
            let row = '<tr ' + (balanceAmount === 0 ? 'style="background-color:#1c985f7d"' : '') + '>' +
							'<td>' + (index + 1) + '</td>' +
							'<td>' + invoice.invoiceNumber + '</td>' +
							'<td class="text-end">' + invoice.invoiceAmount + '</td>' +
							'<td>' +
								'<input type="hidden" name="paymentInvoiceDtoList[' + index + '].invoiceId" value="' + invoice.invoiceId + '">' +
								'<input type="hidden" name="paymentInvoiceDtoList[' + index + '].paymentDetailId" value="' + detailsId + '">' +
								'<input type="text" class="form-control text-end amount-field receive-amount" name="paymentInvoiceDtoList[' + index + '].receivedAmount" id="receivedAmount' + index + '" placeholder="Enter amount" value="' + existingAmount + '" oninput="updateBalance(' + index + ', ' + invoiceAmount + ')" ' + readOnly + '>' +
							'</td>' +
							'<td>' +
								'<input type="text" class="form-control text-end amount-field" id="balanceAmount' + index + '" value="' + balanceAmount + '" readonly>' +
							'</td>' +
							'<td>' +
								'<input type="checkbox" id="checkbox' + index + '" onchange="toggleReceiveAmount(' + index + ')" ' + checkboxDisabled + '>' +
							'</td>' +
						'</tr>';

            tableBody.append(row);

			 // Initially make the "receive amount" field readonly
			 if (balanceAmount !== 0) {
                $('#receivedAmount' + index).prop('readonly', true);
            }
        });

		 // Update total paid amount in the tfoot after all rows are populated
		 $('#totalPaidAmount').val(totalPaid.toFixed(2));
		 $('#totalAmount').val(totalPaid.toFixed(2));
    }
}




// Function to toggle the "receive amount" field based on the checkbox
function toggleReceiveAmount(index) {
    let checkbox = $('#checkbox' + index);
    let receiveAmountField = $('#receivedAmount' + index);

    // Enable or disable the receive amount field based on the checkbox state
    if (checkbox.is(':checked')) {
        receiveAmountField.prop('readonly', false); // Enable the field
    } else {
        receiveAmountField.prop('readonly', true); // Disable the field
    }
}



function updateBalance(index, invoiceAmount) {
    // Get the current value of the paid amount
    let paidAmount = parseFloat($('#receivedAmount' + index).val()) || 0;

	// Validate that the paid amount does not exceed the invoice amount
    if (paidAmount > invoiceAmount) {
        bootbox.alert('Paid amount cannot exceed the invoice amount. Please enter a valid amount.');
        $('#receivedAmount' + index).val('0.00'); // Reset to the invoice amount
		return false;
    }
    
    // Calculate the new balance
    let balanceAmount = invoiceAmount - paidAmount;

    // Update the balance field
    $('#balanceAmount' + index).val(balanceAmount.toFixed(2));

	// Recalculate the total paid amount after updating the balance
	updateTotalPaidAmount();
}

function updateTotalPaidAmount() {
    let totalPaid = 0;

    // Iterate through all the paid amount fields and sum their values
    $('.receive-amount').each(function() {
        let paidAmount = parseFloat($(this).val()) || 0;
        totalPaid += paidAmount;
    });

    // Update the total paid amount in the tfoot
    $('#totalPaidAmount').val(totalPaid.toFixed(2));
	//$('#totalAmount').val(totalPaid.toFixed(2));
}



function emptyTable(){
	let tableBody = $('#invoice-tbl-body');
	tableBody.empty();
	let noDataRow = '<tr>' +
				'<td colspan="4" class="text-center">No data found</td>' +
			'</tr>';
	tableBody.append(noDataRow);
}


//  submitting form  
function formSubmit() {
    let isValid = true; // Initialize isValid to true
    const rowCount = document.getElementById("invoice-tbl-body").rows.length; // Get the number of rows
    const partyId = $('#partyId').val();
	const totalAmount = $('#totalAmount').val();

    // Reset previous error styles
    $('error-border').removeClass('error-border');

    $('#invoice-tbl-body textarea, #tbd input').removeClass('error-border');

    // Validate expenditure type
    if (partyId === '') {
        bootbox.alert("Please select a party");
        $('#billingFromPartyName').addClass('error-border');
        isValid = false;
		return isValid;
    }

	if (totalAmount === '' || totalAmount === '0.00') {
        bootbox.alert("Total amount can not be zero");
        $('#totalAmount').addClass('error-border');
        isValid = false;
		return isValid;
    }
	

    // Validate each row
	if(rowCount == 0){
		bootbox.alert('Invoices not found against selected party');
		isValid = false;
		return isValid;
	}
    for (let i = 0; i < rowCount; i++) {
        const amountField = document.getElementById("receivedAmount" + i);

        // Remove previous error styles
        $(amountField).removeClass('error-border');

        // Check if fields are empty
        if (amountField.value.trim() === "" || amountField.value.trim() === "0") {
            bootbox.alert("Please fill in all mandatory fields ");
            $(amountField).addClass('error-border');
            isValid = false;
			return isValid;
            break;
        }
    }

    // If isValid is still true, proceed with further processing of dataList
    if (isValid) {
        const flag = window.confirm("Do you want to save the data?");
        if (flag) {
            $("#paymentForm").submit();
        }
    } 
}




</script>