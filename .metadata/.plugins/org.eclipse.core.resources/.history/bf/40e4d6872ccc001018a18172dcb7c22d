<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<style>

.view-btn {
    /* background: linear-gradient(135deg, #007bff, #0056b3); */
     background-color: #17A589;
    color: #fff;
    border: none;
    padding: 2px 8px;   /* smaller padding */
    font-size: 10px;     /* smaller text */
    font-weight: 500;
    border-radius: 4px;  /* less rounded */
    cursor: pointer;
    transition: all 0.25s ease-in-out;
}

.imagae-view-btn,.select-site-btn {
  /*   background: linear-gradient(135deg, #007bff, #0056b3); */
   background-color:   #E67E22;
    color: #fff;
    border: none;
   	padding: 4px 12px; /* smaller padding */ 
   	font-size: 12px; /* smaller text */
    font-weight: 500;
    border-radius: 4px;  /* less rounded */
    cursor: pointer;
    transition: all 0.25s ease-in-out;
}

.view-btn:hover {
    background: linear-gradient(135deg, #0056b3, #003f7f);
}

.view-btn:active {
    transform: scale(0.95);
}


</style>


<!-- Modal -->
<div class="modal fade" id="viewSiteImageModal" tabindex="-1" aria-labelledby="viewSiteImageModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content shadow-lg border-0 rounded-3">
			<div class="modal-header bg-light text-white">
				<h5 class="modal-title fw-bold" id="viewSiteImageModalLabel">
					<i class="fas fa-image"></i>
					Inspected Site Image
				</h5>

				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body bg-light">
				<div class="row g-4">
					<c:choose>
						<c:when test="${not empty siteInspectionImageList}">
							<c:forEach var="image" items="${siteInspectionImageList}">
								<div class="col-md-12 text-center">
									<div class="card border-0 shadow-sm p-3 bg-white rounded">
										<img 
										  src="${pageContext.request.contextPath}/document/viewDocuments?moduleName=SITE_INSPECTION_IMAGE&filePath=${image.siteInspectionImagePath}" 
										  class="img-fluid rounded mb-2" 
										  alt="Site Image" 
										  style="max-height: 400px; object-fit: contain;" />
			
										<div class="mt-2 small">
											<i class="fas fa-map-marker-alt text-danger"></i>
											<span class="fw-bold text-success">Latitude:</span> 
											<span class="text-dark">${image.latitude}</span> | 
											<span class="fw-bold text-success">Longitude:</span> 
											<span class="text-dark">${image.longitude}</span>
										</div>
									</div>
								</div>
							</c:forEach>
						</c:when>
						<c:otherwise>
							<div class="col-md-12 text-center">
								<div class="alert alert-warning shadow-sm rounded">
									<i class="fas fa-exclamation-circle"></i> No site images available for this inspection.
								</div>
							</div>
						</c:otherwise>
					</c:choose>
				</div>
			</div>
			<div class="modal-footer bg-light">
				<button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>



<div class="container-fluid">

    <div class="breadcrumb_conatiner">
        <div class="col-md-6">
            <h4 class="change-color">Site Selection</h4>
        </div>
        <div class="col-md-6">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb float-md-end mb-0">
                    <li class="breadcrumb-item">
                        <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">View Site Selection</li>
                </ol>
            </nav>
        </div>
    </div>

   <!-- Filter Form -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Filter Sites</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Financial Year -->
                    <div class="col-md-3">
                        <label for="financialYearId" class="form-label">Select Financial Year</label>
                        <select id="financialYearId" name="financialYearId" class="form-select" onchange="siteSelection(null)">
                            <option value="">-- Select Financial Year --</option>
                            <c:forEach var="fy" items="${financialYearList}">
                                <option value="${fy.financialYearId}" ${fy.financialYearId == selectedFinancialYear ? 'selected' : ''}>
                                    ${fy.financialYear}
                                </option>
                            </c:forEach>
                        </select>
                    </div>
                    <!-- isSiteSelected -->
                    <div class="col-md-3">
                        <label for="isSiteSelected" class="form-label">Site Selected</label>
                        <select id="isSiteSelected" name="isSiteSelected" class="form-select" onchange="siteSelection(null)">
                            <option value="" selected disabled>-- Select a type --</option>
                            <option value="true" ${isSiteSelected eq true ? 'selected' : ''}>Selected</option>
                            <option value="false" ${isSiteSelected eq false ? 'selected' : ''}>Not Selected</option>
                        </select>
                    </div>
                    <!-- Project -->
                    <div class="col-md-3">
<!--                         <label for="projectId" class="form-label">Select Project</label> -->
                        <label for="projectId" class="form-label">Select Building</label>
                        <select id="projectId" name="projectId" class="form-select select2" onchange="siteSelection(null)">
                            <option value="">-- Select a Project --</option>
                            <c:forEach var="project" items="${projectList}">
                                <option value="${project.projectId}" ${project.projectId == selectedProject ? 'selected' : ''}>
                                    ${project.projectName}
                                </option>
                            </c:forEach>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Site Inspection Cards -->
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Select Final Site</h5>
            </div>
            <div class="card-body">
                <div class="row flex-nowrap overflow-auto">
                    <c:choose>
                        <c:when test="${not empty siteInspectionList}">
                            <c:forEach var="dto" items="${siteInspectionList}">
                                <div class="col-md-4  mb-3">
                                    <div class="card h-100 border-primary shadow-sm">
                                    	<div class="card-header bg-light">
							                <h5 class="card-title">
                                                Site Inspection ${dto.siteInspectionId}
                                            </h5>
                                            <c:choose>
											    <c:when test="${dto.isFinalSelectedSite and dto.isFinaProject}">
											        <button class="select-site-btn ms-2">Selected Site</button>
											    </c:when>
											    <c:when test="${!dto.isFinalSelectedSite and !dto.isFinaProject}">
											        <button class="select-site-btn ms-2" onclick="finalizedSiteSelection('${dto.siteInspectionId}')">Select Final Site</button>
											    </c:when>
											</c:choose>
							            </div>
                                        <div class="card-body">
                                            <p><strong>Area:</strong> ${dto.area}</p>
                                            <p><strong>Landmark:</strong> ${dto.landmark}</p>
                                            <p><strong>Flood Area:</strong> 
                                                <c:choose>
                                                    <c:when test="${dto.isFloodArea}">Yes</c:when>
                                                    <c:otherwise>No</c:otherwise>
                                                </c:choose>
                                            </p>
                                            <p><strong>Earthquake Area:</strong> 
                                                <c:choose>
                                                    <c:when test="${dto.isEarthquakeArea}">Yes</c:when>
                                                    <c:otherwise>No</c:otherwise>
                                                </c:choose>
                                            </p>
                                            <c:if test="${not empty dto.siteInspectionDate}">
                                                <p><strong>Inspection Date:</strong>
                                                    <fmt:formatDate value="${dto.siteInspectionDate}" pattern="dd-MMM-yyyy" />
                                                </p>
                                            </c:if>

                                            <!-- Documents -->
											<c:if test="${not empty dto.soilTestReportPath}">
											    <p><strong>Soil Test Report:</strong>
											        <button type="button"
											                class="view-btn ms-2"
											                onclick="viewDocument('${dto.soilTestReportPath}','SITE_INSPECTION_DOCUMENT')"
											                title="View Soil Test Report">
											            View
											        </button>
											    </p>
											</c:if>
											
											<c:if test="${not empty dto.lanRecordReportPath}">
											    <p><strong>Land Record Report:</strong>
											        <button type="button"
											                class="view-btn ms-2"
											                onclick="viewDocument('${dto.lanRecordReportPath}','SITE_INSPECTION_DOCUMENT')"
											                title="View Land Record Report">
											            View
											        </button>
											    </p>
											</c:if>
											
											<c:if test="${not empty dto.landClearanceReportPath}">
											    <p><strong>Land Clearance Report:</strong>
											        <button type="button"
											                class="view-btn ms-2"
											                onclick="viewDocument('${dto.landClearanceReportPath}','SITE_INSPECTION_DOCUMENT')"
											                title="View Land Clearance Report">
											            View
											        </button>
											    </p>
											</c:if>
											
											<c:if test="${not empty dto.environmentClearanceReportPath}">
											    <p><strong>Environment Clearance Report:</strong>
											        <button type="button"
											               class="view-btn ms-2"
											                onclick="viewDocument('${dto.environmentClearanceReportPath}','SITE_INSPECTION_DOCUMENT')"
											                title="View Environment Clearance Report">
											            View
											        </button>
											    </p>
											</c:if>


                                            <p class="remark">
                                                <strong>Remark:</strong> ${fn:escapeXml(dto.remark)}
                                            </p>
                                        </div>
                                        <div class="card-footer text-end">
	                                        <button class="imagae-view-btn ms-2" onclick="siteSelection('${dto.siteInspectionId}')">View Site Image</button>
                                        </div>
                                    </div>
                                </div>
                            </c:forEach>
                        </c:when>
                        <c:otherwise>
                            <div class="col-12">
                                <div class="alert alert-warning text-center">
                                    No site inspections available for the selected project.
                                </div>
                            </div>
                        </c:otherwise>
                    </c:choose>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<form action="${pageContext.request.contextPath}/site/viewSiteSelection" method="get" id="siteSelection">
	<input type="hidden" name="cipherText" id="viewSiteCipherText">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="financialYearId" id="financialYearIdHidden">
	<input type="hidden" name="projectId" id="projectIdHidden">
    <input type="hidden" name="siteInspectionId" id="siteInspectionIdHidden">
    <input type="hidden" name="isSiteSelected" id="isSiteSelectedHidden">
</form>

<form action="${pageContext.request.contextPath}/site/finalizedSiteSelection" method="get" id="finalizedSite">
	<input type="hidden" name="cipherText" id="finalizedSiteCipherText">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="financialYearId" id="financialYearIdFinal">
	<input type="hidden" name="projectId" id="projectIdFinal">
    <input type="hidden" name="siteInspectionId" id="siteInspectionIdFinal">
</form>

<form action = "${contextPath}/document/viewDocuments" method="get" id="documentFormView" enctype="multipart/form-data" target="_blank">
	<input type="hidden" name="moduleName" id="moduleName"/>
	<input type="hidden" name="filePath" id="filePath"/>
</form>

<c:if test="${openImageModal}">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var myModal = new bootstrap.Modal(document.getElementById('viewSiteImageModal'));
            myModal.show();
        });
    </script>
</c:if>

<script>

function viewDocument(filePath,moduleName){
	debugger
	 $('#moduleName').val(moduleName);
	 $('#filePath').val(filePath);
	 $('#documentFormView').submit();
	}
	
function siteSelection(siteInspectionId) {
    debugger;
    var financialYear = $("#financialYearId").val(); 
    var project = $("#projectId").val(); 
    var isSiteSelected = $("#isSiteSelected").val(); 

    $('#financialYearIdHidden').val(financialYear);
    $('#projectIdHidden').val(project);
    $('#siteInspectionIdHidden').val(siteInspectionId);
    $('#isSiteSelectedHidden').val(isSiteSelected);

    showLoader();

    var bizContent = $("#siteSelection").serializeArray();
    $("#viewSiteCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    $("#siteSelection").submit();
}

function finalizedSiteSelection(siteInspectionId) {
    debugger;
    var financialYear = $("#financialYearId").val(); 
    var project = $("#projectId").val();            

    $('#financialYearIdFinal').val(financialYear);
    $('#projectIdFinal').val(project);
    $('#siteInspectionIdFinal').val(siteInspectionId);

    showLoader();

    var bizContent = $("#finalizedSite").serializeArray();
    $("#finalizedSiteCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    $("#finalizedSite").submit();
}

</script>