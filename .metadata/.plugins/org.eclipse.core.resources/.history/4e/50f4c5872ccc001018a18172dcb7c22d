<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<style>
.add-more {
    padding: 0;
    height: 18px;
    width: 18px;
    background: green;
    border: 0px;
    color: #fff;
    line-height: 18px;
    text-align: center;
    border-radius: 50px;
    margin-left: 2px;
    font-size: 9px;
   }
   .freez {
	pointer-events: none;
	background: #f5f5f5;
	color: #000;
	cursor: not-allowed;
}
.action_btn .btn{
	padding: 3px 5px 3px 5px;
}
.action_btn .btn .fa{
	font-size: 12px;
}
.main {
    min-height: 100vh;
}
.btnholder {
    margin-top: 0px;
}
.text-center {
    text-align: left !important;
}
</style>
		 <%-- <div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">Raise Query</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <!-- <li class="breadcrumb-item"><a href="#">Human Resource</a></li> -->
                    <li class="breadcrumb-item active" aria-current="page">Raise Query</li>
                  </ol>
                </nav>
              </div>
            </div> --%>
            
            <div class="row mt-3">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Raise Query</h5>
                    </div>
                    <div class="card-body">
		            <div class="row">

						<form action="${contextPath}/saveGrievence" id="grievenceId" class="row" enctype="multipart/form-data" method="post" >
							<input type="hidden" name="${_csrf.parameterName}"
								value="${_csrf.token}" /> 
								<%-- <input type="hidden" name="securityId" value="${securityId}" id="securityId" /> --%>
								<input type="hidden" name="grvId" value="${grievance.grvId}" id="grvId"  />
								<input type="hidden" name="errorCategoryId" value="${err.errorCategoryId}" id="errorCategoryId"  />
								<input type="hidden" name="categoryCode"  id="categoryCode"  />
								<input type="hidden" name="errorType.errorTypeId"/> 

								<div class="col-md-3" id="">
									<div class="form-group">
										<label class="required">ORG Label :<span class="requiredFieldStarMark">*</span></label>
										<div class="">
											<c:choose>
											<c:when test="${grievance eq null}">
												<!-- if gribance there then add class freez -->
												<select name="objectIdAndType"  required="required" id="orgIdAndOrgLevel" name="orgIdAndOrgLevel" onchange="getStageButtonReset()" class="form-control form-select">
													<option value="" aria-selected="false">--Select--</option>
													<c:forEach items="${level}" var="err">
														<option value="${err.combineTwo}">${err.organizationName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<select name="objectIdAndType"  required="required" id="orgIdAndOrgLevel" name="orgIdAndOrgLevel" onchange="" class="form-control form-control-sm freez selectpicker" data-live-search="true" >
													<option value="${grievance.objectIdAndType}" selected>${grievance.objectType}</option>
												</select>
											</c:otherwise>
										</c:choose>

										</div>
									</div>
								</div>


                       <div class="col-md-3" id="errorTypeDiv">
								<div class="form-group">
									<label class="required">Query Category :</label>
									<div class="">
										<select name="errorCategoryId" id="errorType"
											class="form-control form-control form-control-sm ${not empty grievance ? 'frezee' : ''}" required="required"  onchange="getCategoryDescByErrorCategoryId(this.value);" data-live-search="true" >
											<option value="" aria-selected="false" >--Select--</option>
											 <c:forEach items="${error}" var="err">
												<option value="${err.errorCategoryId}" ${err.errorCategoryId eq  grievance.errorMapGrievance.mstGrvErrorCategory.errorCategoryId ? 'selected' : ''}>${err.categoryType}</option>
											</c:forEach>
										</select>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="required">Query Sub-Category :</label>
									<div class="">
										<select class="form-control form-select form-control-sm getStageButtonsOnForm ${not empty grievance ? 'frezee' : ''}" name="errorMapGrievance.errorCategoryMapId" id="errorCategoryMapId" onchange="">
											<option value="0" aria-selected="false">select</option>
											<c:forEach items="${errorCategList}" var="errCat">
												<option value="${errCat.errorCategoryMapId}" ${errCat.errorCategoryMapId eq  grievance.errorMapGrievance.errorCategoryMapId ? 'selected' : ''}>${errCat.categoryDescType}</option>
											</c:forEach>
										</select>
									</div>
								</div>
							</div>
                          	<div class="col-md-3">
								<div class="form-group">
									<label class="required ">Complainant Name :</label>
									<input type="text" name="complainantName" id="complainantName" class="form-control form-control-sm " maxlength="50" required="required" value="${grievance.complainantName}">
								</div>
							</div>
                         	<div class="col-md-3">
								<div class="form-group">
									<label class="required">Contact No. :</label>
									<input type="text" 
									       name="contactNo" 
									       id="contactNo" 
									       class="form-control form-control-sm validPhoneNo NumbersOnly" 
									       maxlength="10" 
									       required="required" 
									       value="${grievance.contactNo}" 
									       onblur="validateMobileNumber(this)">
								</div>
							</div>

							<div class="col-md-3">
								<div class="form-group">
									<label class="required ">Email Id :</label>
									<input type="text" name="emailId" rows="2" cols="20" id="emailId" class="form-control form-control-sm validEmail" maxlength="50" required="required" value="${grievance.emailId}">
								</div>
							</div>


							<c:choose>
								<c:when test="${grievance != null}">
									<div class="col-md-3">
										<!-- View Icon -->
										<div class="form-group action_btn">
											<label class="required col-12">Identity Proof :</label>
											<a href="${contextPath}/view-documents?doc=${grievance.identityCardPath}&module=IdentityCard" target="_blank" class="btn btn-sm btn-primary"><i class="fa fa-eye"></i></a>
										</div>
									</div>
								</c:when>
								<c:otherwise>
									<div class="col-md-3">
										<div class="form-group">
										  <label class="required">Identity Proof :</label>
										  <input name ="identityCard" id ="identityCardPath" type="file" class="form-control form-control-sm"  onchange="imagePDFCheck(this);">
										</div>
									</div>
								</c:otherwise>
							</c:choose>

						  <div class="col-md-3">
							<div class="form-group">
							  <label class="required">Remarks :</label>
							  <textarea name="remarks" rows="2" cols="20" id="editor" class="form-control" maxlength="200" required="required">${grievance.remarks}</textarea>
  <!--                             <div name="remarks" id="editor"></div> -->
							</div>
						  </div>
                          <div class="col-md-12">
                          	<div class="row align-items-end" id="existingElement">
								<div class="col-md-3 action_btn" >
									<div class="form-group" style="position:relative;">
										<label class="smallInput" for="">Grievance Related Document : </label>
										<c:choose>
											<c:when test="${grievance != null}">
												<c:forEach items="${grievanceDocListDto}" var="doc" varStatus="status">
													<a href="${contextPath}/view-documents?doc=${doc.filePath}&module=GRV-CARD" target="_blank" class="btn btn-sm btn-primary"><i class="fa fa-eye"></i></a>
												</c:forEach>
											</c:when>
											<c:otherwise>
												<button onclick="appendBut()" type="button" class="btn btn-primary" style="position: absolute; bottom: 0; right: 0; padding: 7px 8px !important; border: none;"><i class="fa-solid fa-plus"></i></button>
												<input type="file" class="form-control form-control-sm inputPathName" id="filePath" onchange = "imagePDFCheck(this);" name="grievenceDocList[0].grvDocWeb">
											</c:otherwise>
										</c:choose>
									</div>
								</div>
                        	 </div>
                         </div>
                         <div class="row mt-3">
                            <div class="col-md-12 d-flex gap-2 justify-content-end">
                                <div class="d-flex gap-2" id="ajaxDynamicButtonsId">


                                </div>
                					<a href="javascript:void();" onclick="history.back();" type="button" class="btn btn-warning btn-sm"><i class="fa-solid fa-rotate-left"></i> Back</a>
                            </div>
                         </div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>


<script>
	
	var count=0;
	function appendBut() {
		debugger;
	    count++;
	    var supportDocumentHtml = '<div class="col-md-3"><div class="form-group mt-2" style="position:relative;">' +
	                                '<input type="file"  class="form-control form-control-sm" id="filePath' + count + '" name="grievenceDocList[' + count + '].grvDocWeb" onchange="imagePDFCheck(this)">' +
	                                '<button class="btn btn-sm btn-danger removeButton" style="position:absolute; bottom:1px;right:0; padding:6px 8px;"><i class="fa-solid fa-minus"></i></button>' +
	                              '</div></div>';
	
	    $('#existingElement').append(supportDocumentHtml);
	}


// Use event delegation for dynamically added elements
$('#existingElement').on('click', '.removeButton', function() {
  // Remove the clicked form group
  $(this).closest('.col-md-4').remove();
});


function isPdfOrJpg(file) {
    const allowedTypes = ["application/pdf", "image/jpeg", "image/jpg", "application/vnd.ms-excel", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"];
    return allowedTypes.includes(file.type);
}

function submitFormData(stageId) {
    var documentFiles = $("#filePath").prop('files');
  //  var invalidFiles = [];
    var documentFiless = document.getElementsByClassName('inputPathName')
    var errorType = $("#errorType").val();
    var email = $("#emailId").val();
    var userType = $("#userType").val();
    var errorCategoryMapId = $("#errorCategoryMapId").val();
    var complainantName = $("#complainantName").val();
    var sectorId = $("#sectorId").val();
    var fileInputs = document.getElementsByClassName('inputFileName');
    var isValid = false;
    
    if ($("#errorType").val() === "") {
        bootbox.alert("Please Select Grievance Category");
        return false;
    }  
    if (errorCategoryMapId === "" || errorCategoryMapId === null || errorCategoryMapId === 0) {
        bootbox.alert("Please Select Grievance Sub-Category");
        return false;
    } 
    if ($("#complainantName").val() == "") {
        bootbox.alert("Please Enter Complainant Name");
        return false;
    }
    if ($("#contactNo").val() == "") {
        bootbox.alert("Please Enter Contact No");
        return false;
    }
    if (email === '') {
        bootbox.alert('Please provide an Email address.');
        return false;
    		}
    if ($("#identityCardPath").val() == "" ) {
		bootbox.alert("Please Attach Identity Proof");
		return false;
		}
    else if ($("#editor").val() == "") {
        bootbox.alert("Please Enter The Remark.");
        return false;
    }
       else {
		bootbox.confirm({
			message : "Are you sure you want to submit?",
			buttons : {
				confirm : {
					label : 'Yes',
					className : 'btn-success'
				},
				cancel : {
					label : 'No',
					className : 'btn-danger'
				}
			},
			callback : function(result) {
				if (result) {
					saveWorkFlowStage("grievenceId", stageId);
        			$('#grievenceId').submit();
				}
			}
		});
    }
}
function validateEmail(email) {
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
		</script>
		
		<script>
		$(function () {
			  $('.multiselect_dd').each(function () {
			    $(this).select2({
			      theme: 'bootstrap4',
			      width: 'style',
			      placeholder: $(this).attr('placeholder'),
			      allowClear: Boolean($(this).data('allow-clear')),
			    });
			  });
			});
		
		function checkSelectValue() {
	        var selectedValues = $('#errorType').val();

	        // Check if option value 12 is selected
	        if (selectedValues && selectedValues.includes('12')) {
	            // Show the text area
	            $('#textareaContainer').show();
	        } else {
	            // Hide the text area
	            $('#textareaContainer').hide();
	        }
	    }
//TODO		
		$('.NumbersOnly').on(
				'keypress',
				function(event) {
					var regex = new RegExp("^[0-9]+$");
					var key = String.fromCharCode(!event.charCode ? event.which
							: event.charCode);
					if (!regex.test(key)) {
						event.preventDefault();
						return false;
					}
				});
		
		</script>
		
  
  <script>
  function getMobNo()
	{
		var mobno=$("#contactNo").val();
		var pattern=/^[6789][0-9]{9}$/
		
		if(!pattern.test(mobno)){
			bootbox.alert("mobile number is not valid ");
			$("#contactNo").val('');
			return false;
		}
 
	}
	</script>
	<script>
	function checkPdfFmt(input, index) {
	    if (index === '0') {
	        if (confirm("This attachment cannot be deleted after submit. Are you sure you want to continue?")) {
	        } else {
	            input.value = '';
	        }
	    }
	}
	function getCategoryDescByErrorCategoryId(errorCategoryId) {
		if (errorCategoryId != '') {
			$.ajax({
						type : "GET",
						url : '${contextPath}/findGrvDescrTypeListByCategoryId',
						dataType : "json",
						data : {
							"errorCategoryId" : errorCategoryId,
						},
						success : function(response) {
							var html = "<option value='' selected>-Select-</option>";
							var data = response;
							if (data != "" && data != null && data.length > 0) {
								$.each(data,function(index, value) {
									html = html + "<option  value="+value.errorCategoryMapId+">"+ value.categoryDescType+ "</option>";
								});
							}
							$('#errorCategoryMapId').empty().append(html);
							$('#errorCategoryId').empty().append(html);
//	 						$('#awhName').val(employeeName);
						},
						error : function(error) {
							bootbox.alert("CategoryDescType list not found");
						}
					});
		} else {
			bootbox.alert("Please Select CategoryType");
			var html = "<option value='' selected>-Select-</option>";
			$('#errorCategoryMapId').empty().append(html);
			return false;
		}
	}
	function validateImageFormat(input) {
        const allowedExtensions = ['jpg', 'jpeg', 'png', 'doc', 'docx', 'pdf'];
        const errorText = document.getElementById('errorText')  ;
        const errorText1 = document.getElementById('errorText1')  ;
        var eventType = $("#eventType").val();
        const file = input.files[0];

        if (file) {
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            if (allowedExtensions.includes(fileExtension)) {
                errorText.textContent = '';
            } else {
                if(eventType == "PROMOTION"){
                  errorText.textContent = 'Invalid image format. Allowed formats: JPG, JPEG, PNG, DOC, DOCX, PDF.';
                  $("#upldDocId").val("");
                }else if(eventType == "DEMOTION"){
                  errorText1.textContent = 'Invalid image format. Allowed formats: JPG, JPEG, PNG, DOC, DOCX, PDF.';
                   $("#dmupldDocId").val("");
                }
            }
        }
    }
	function getStageButtonReset(){
		var html='<option value="">--Select--</option>';
		$("#errorType").val("");
		$("#errorCategoryMapId").empty().append(html);
		$("#ajaxDynamicButtonsId").empty();

	}
	function unfrezzFormBycanTakeAction(formId){
    		$('#'+formId).find('input, textarea, button, select').removeClass('frezzFormBycanTakeAction');
    	}
	
	function validateMobileNumber(mobileField) {
	    if (!mobileField) 
	    	return false;

	    const mobile = mobileField.value.trim();

	    if (mobile === "") 
	    	return true;
	    const mobileRegex = /^[6-9][0-9]{9}$/;

	    if (!mobileRegex.test(mobile)) {
	        bootbox.alert("Mobile number must be 10 digits and start with 6 to 9.");
	        mobileField.value = '';
	        return false;
	    }

	    return true;
	}
	</script>