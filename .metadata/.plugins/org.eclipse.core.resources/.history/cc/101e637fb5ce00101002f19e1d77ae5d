<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib uri="http://tiles.apache.org/tags-tiles" prefix="tiles"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="keywords" content="CMC-SWP">
    <meta name="description" content="Building & Asset Management System">
    <meta name="author" content="Aashdit Technologies">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="cache-control" content="max-age=0, no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">

    <title>Setup project</title>
    <link rel="shortcut icon" href="${contextPath}/assets/img/favicon.png" type="image/x-icon">

    <!-- Google Font: Rajdhani (Modern & Professional) -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome 5 (Your existing version - safe & working) -->
    <link href="${contextPath}/assets/fonts/css/all.min.css" rel="stylesheet">

    <!-- Bootstrap 5 + All Vendor CSS -->
    <link href="${contextPath}/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/bootstrap-selectpicker/bootstrap-select.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/datatable/datatables.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/datepicker/jquery.datepick.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/jquery_autocomplete/jquery.autocomplete.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/magnific-popup/magnific-popup.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/full-calender/fullcalendar.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/vendor/select2/select2.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/css/flatpickr.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/owlslider/owl.carousel.min.css" rel="stylesheet">
    <link href="${contextPath}/assets/owlslider/owl.theme.default.min.css" rel="stylesheet">

    <!-- Custom Project CSS (Always Last) -->
    <link href="${contextPath}/assets/css/style.css" rel="stylesheet">

    <!-- CRITICAL: Load jQuery + Bootbox + Encryption FIRST -->
    <script src="${contextPath}/assets/js/jquery.js"></script>
    <script src="${contextPath}/assets/vendor/bootbox/bootbox.all.min.js"></script>
    <script src="${contextPath}/assets/utilsJs/dataEncryption.js"></script>

    <style>
        :root {
            --primary: #36a2eb;
            --dark: #0f0e47;
            --light: #f8f9fa;
            --accent: #00ffff;
        }

        body {
            font-family: 'Rajdhani', 'Segoe UI', sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        .main {
            flex: 1;
            background: var(--light);
            transition: margin-left 0.3s ease;
        }

        .content {
            padding: 20px;
            min-height: calc(100vh - 100px);
        }

        /* Bootbox Cancel Button Style Fix */
        .bootbox .bootbox-cancel {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
        }

        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
    </style>
</head>

<body class="body" id="body">
    <div class="wrapper">
        <!-- Loader -->
        <%@ include file="/WEB-INF/views/newLoader.jsp" %>

        <!-- Sidebar Menu -->
        <tiles:insertAttribute name="menu" />

        <!-- Main Content Area -->
        <div class="main" id="main">
            <!-- Header -->
            <tiles:insertAttribute name="header" />

            <!-- Page Content -->
            <main class="content pb-5">
                <%@ include file="/WEB-INF/views/message.jsp"%>
                <tiles:insertAttribute name="body" />
            </main>
        </div>
    </div>

    <!-- Hidden Forms -->
    <form id="moduleForm" action="${contextPath}/moduleDirectory" method="post">
        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
        <input type="hidden" name="moduleCode" id="moduleId" />
    </form>

    <form action="${contextPath}/document/viewDocuments" method="get" id="documentFormView" target="_blank">
        <input type="hidden" name="moduleName" id="moduleName"/>
        <input type="hidden" name="filePath" id="filePath"/>
    </form>

    <!-- ==================== ALL SCRIPTS (LOADED AFTER JQUERY) ==================== -->
    <script src="${contextPath}/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="${contextPath}/assets/vendor/bootstrap-selectpicker/bootstrap-select.min.js"></script>
    <script src="${contextPath}/assets/vendor/datatable/datatables.min.js"></script>
    <script src="${contextPath}/assets/vendor/datepicker/jquery.plugin.min.js"></script>
    <script src="${contextPath}/assets/vendor/datepicker/jquery.datepick.min.js"></script>
    <script src="${contextPath}/assets/js/moment.js"></script>
    <script src="${contextPath}/assets/js/flatpickr.js"></script>
    <script src="${contextPath}/assets/vendor/ckeditor/ckeditor.js"></script>
    <script src="${contextPath}/assets/vendor/jquery_autocomplete/jquery.autocomplete.min.js"></script>
    <script src="${contextPath}/assets/vendor/magnific-popup/jquery.magnific-popup.min.js"></script>
    <script src="${contextPath}/assets/owlslider/owl.carousel.min.js"></script>
    <script src="${contextPath}/assets/vendor/full-calender/fullcalendar.min.js"></script>
    <script src="${contextPath}/assets/vendor/select2/select2.min.js"></script>

    <!-- Custom Utilities -->
    <script>
        window.ctxPath = '${contextPath}';
        window.contextPath = '${contextPath}';
    </script>

    <script src="${contextPath}/assets/js/custom.js"></script>
    <script src="${contextPath}/assets/utilsJs/commonFunctions.js"></script>
    <script src="${contextPath}/assets/utilsJs/helperFunctionsScripts.js"></script>
    <script src="${contextPath}/assets/utilsJs/validate.js"></script>
    <script src="${contextPath}/assets/utilsJs/common-utils.js"></script>
    <script src="${contextPath}/assets/js/bams/common-function.js"></script>

    <!-- Encryption Libraries -->
    <script src="${contextPath}/assets/js/encrypt/AesUtil.js"></script>
    <script src="${contextPath}/assets/js/encrypt/aes.js"></script>
    <script src="${contextPath}/assets/js/encrypt/pbkdf2.js"></script>
    <script src="${contextPath}/assets/js/encrypt/lbase.js"></script>

    <!-- FAMS Module Scripts -->
    <script src="${contextPath}/assets/js/fams/common.js"></script>
    <script src="${contextPath}/assets/js/fams/common-utils.js"></script>
    <script src="${contextPath}/assets/js/fams/invoice.js"></script>
    <script src="${contextPath}/assets/js/fams/party-master.js"></script>
    <script src="${contextPath}/assets/js/fams/ipmsJs/ipms.js"></script>

    <!-- Global Utility Functions -->
    <script>
        var contextPath = '${pageContext.request.contextPath}';

        function Module() {
            let currentModuleCode = localStorage.getItem('currentModuleCode');
            if (currentModuleCode) {
                $('#moduleId').val(enc_password(currentModuleCode));
                $('#moduleForm').submit();
            }
        }

        function backToModule() {
            let currentModuleCode = localStorage.getItem('currentModuleCode');
            if (currentModuleCode) {
                $('#moduleId').val(enc_password(currentModuleCode));
                $('#moduleForm').submit();
            }
        }

        function showLoader() { $(".loader-div").css("display", "flex"); }
        function hideLoader() { $(".loader-div").css("display", "none"); }

        function convertFormToJSONArray(form) {
            const json = {};
            $.each(form, function () {
                if (json[this.name]) {
                    if (!json[this.name].push) json[this.name] = [json[this.name]];
                    json[this.name].push(this.value || "");
                } else if (this.name.includes("Array")) {
                    json[this.name] = [this.value];
                } else {
                    json[this.name] = this.value || "";
                }
            });
            return json;
        }
    </script>

    <!-- Flatpickr Time Picker -->
    <script>
        flatpickr(".timePicker", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "h:i K",
            time_24hr: false
        });
    </script>

    <!-- DataTables Init -->
    <script>
        $(document).ready(function() {
            $('.DataTable').DataTable({
                responsive: true,
                scrollX: true,
                scrollCollapse: true,
                fixedHeader: true,
                dom: '<"top-toolbar"lf>rtip',
                language: { processing: "Loading..." }
            });

            if ($('.table-responsive').length) {
                $(".top-toolbar").insertBefore(".table-responsive");
            } else {
                $(".top-toolbar").insertBefore(".table");
            }

            $('.select2').select2();
        });
    </script>

    <!-- Owl Carousel in Modal -->
    <script>
        $(document).on('shown.bs.modal', '#addOtherItemModal', function () {
            $(".banner_sec_sldrs, .imageSlider").owlCarousel('destroy').owlCarousel({
                items: 1,
                loop: true,
                nav: false,
                dots: true,
                autoplay: true,
                autoplayTimeout: 3000,
                autoplayHoverPause: true
            });
        });
    </script>

    <!-- FullCalendar -->
    <script>
        $(document).ready(function() {
            if ($('#calendar').length) {
                $('#calendar').fullCalendar({
                    header: { left: 'prev,next today', center: 'title', right: 'month,basicWeek,basicDay' },
                    eventRender: function(event, element) {
                        var titleEl = element.find('.fc-title');
                        if (titleEl.length) titleEl.attr('title', event.description || event.title);
                    }
                });
            }
        });
    </script>

    <!-- Input Sanitizer (XSS Protection) -->
    <script>
        (function() {
            const BLOCKED_CHARS = /[<>\/\\]/g;
            function sanitize(value) { return value.replace(BLOCKED_CHARS, ""); }
            function attach(el) {
                el.addEventListener("input", function() { this.value = sanitize(this.value); });
                el.addEventListener("paste", function(e) {
                    e.preventDefault();
                    let text = (e.clipboardData || window.clipboardData).getData("text");
                    this.value += sanitize(text);
                });
            }
            document.addEventListener("DOMContentLoaded", function() {
                document.querySelectorAll("input, textarea").forEach(attach);
                new MutationObserver(mutations => {
                    mutations.forEach(m => {
                        m.addedNodes.forEach(node => {
                            if (node.tagName === "INPUT" || node.tagName === "TEXTAREA") attach(node);
                            if (node.querySelectorAll) node.querySelectorAll("input, textarea").forEach(attach);
                        });
                    });
                }).observe(document.body, { childList: true, subtree: true });
            });
        })();
    </script>

    <!-- Form Field Encryption Handler -->
    <script>
        $(document).ready(function() {
            $("form").on("submit", function() {
                let $form = $(this);
                if ($form.find("input[name='cipherText']").length > 0) {
                    $form.find("input[name], select[name], textarea[name]").each(function() {
                        let name = $(this).attr("name");
                        let type = $(this).attr("type");
                        if (name && name !== "cipherText" && !name.startsWith("_csrf") && type !== "file" &&
                            !name.startsWith("currentWorkflowStageParam") && !name.startsWith("specificUserParam") &&
                            name !== "hdnButtonCode" && name !== "fileName" && name !== "moduleName") {
                            $(this).removeAttr("name");
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>