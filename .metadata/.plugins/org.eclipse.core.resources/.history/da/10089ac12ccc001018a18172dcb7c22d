<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<link href="${contextPath}/assets/css/dashboard.css" rel="stylesheet" type="text/css" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<!-- Breadcrumb -->
<%-- <div class="breadcrumb_conatiner">
    <div class="col-md-6"><h4 class="change-color">Asset Management List</h4></div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
                </li>
                <li class="breadcrumb-item active">Asset Management List</li>
            </ol>
        </nav>
    </div>
</div> --%>

<!-- Asset List -->
<div class="col-md-12 mt-3">
        <div class="card">
            <div class="card-header"><h5 class="card-title">Asset Management List</h5></div>

		<div class="row m-3">
			<%-- District --%>
			<div class="form-group col-md-3">
				<label for="districtId">District Name :</label> <select
					class="form-control form-control-sm form-select"
					data-live-search="true" id="districtId" name="districtId"
					onchange="LoadBlockByDistrict(this.value, 'blockId');">
					<option value="0" disabled selected>- Select -</option>
					<c:forEach var="district" items="${districtList}">
						<option value="${district.districtId}"
							${district.districtId eq selectedDistrictId ? 'selected' : ''}>
							${district.districtName}</option>
					</c:forEach>
				</select>
			</div>

			<%-- Block --%>
			<div class="form-group col-md-3">
				<label  for="blockId">Block Name :</label> <select
					id="blockId" name="blockId"
					class="form-control form-control-sm form-select"
					required="required"
					onchange="LoadGrampanchayatByBlock(this.value, 'gpId');">
					<option value="0" disabled selected>- Select -</option>
				</select>
			</div>

			<%-- Gram Panchayat --%>
			<div class="form-group col-md-3">
				<label for="gpId">GramPanchayat Name :</label> <select
					id="gpId" name="gpId"
					class="form-control form-control-sm form-select" onchange="LoadVillageByGrampanchayat(this.value, 'villageId')"
					required="required">
					<option value="0" disabled selected>- Select -</option>
				</select>
			</div>
			 <%-- Village --%>
			<div class="form-group col-md-3">
				<label class="required" for="villageId">Village Name :</label> 
				<select id="villageId" name="villageId"
					class="form-control form-control-sm form-select"
					required="required">
					<option value="0" selected disabled>- Select -</option>
				</select>
			</div>

			<div class="col-md-3">
				<div class="form-group">
					<label for="buildingType">Building Type :</label> <select
						id="buildingType" name="buildingType"
						class="form-control form-control-sm form-select"  onchange="getBuildingNameByBuildingType(this.value,'buildingId');" required>

						<option value="" selected>- Select -</option>

						<c:forEach var="buildType" items="${buildingTypeList}">
							<option value="${buildType.valueEn}"${buildType.valueEn eq selectedBuildingType ? 'selected' : ''}>
								${buildType.valueEn}</option>
						</c:forEach>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="form-group">
					<label>Building Name :</label> 
					<select
						id="buildingId" name="buildingId"
						class="form-control form-control-sm form-select" required>
						<option value="" selected>- Select -</option>						
					</select>
				</div>
			</div>
			<div class="col-md-3 text-center"> 
				<div class="form-group">
					<label style="display:block;">&nbsp;</label> 
					<button type="button" name="addManageApplicationScheme" class="btn btn-primary btn-sm" id="addManageApplicationSchemes" onclick="submitForm()"><i class="fa fa-filter"></i> Filter</button>
	<!-- 				<input type="button" name="addManageApplicationScheme" id="addManageApplicationSchemes" class="btn btn-primary btn-sm" value="Filter" onclick="submitForm()">  -->
					<a href="javascript:void()" onclick="history.back();" type="button" class="btn btn-warning btn-sm"><i class="fa-solid fa-rotate-left"></i> Back</a>
				</div>
			</div>

		</div>
		<div class="card-body">
                <div class="table-responsive">
                    <table id="basic-datatables" class="table table-bordered table-hover exportbtn">
                        <thead>
                        <tr>
                         <th class="text-center" style="width:60px">Sl.No</th>
                        <th class="">Building Type</th>
                        <th class="">Asset Category</th>
                        <th class="">No. of Rooms</th>
<!--                         <th class="thnow">Classroom Size (Sq. Ft.)</th>
 -->					<th class="">Hostel Furnished</th>
<!-- 						<th>Capacity</th>
 -->                        <th class="">Asset Condition</th>
						<th class="">Functional Date</th>
						<th class="">Handover Date</th>
						<th class="">Asset Image</th>						
                        <th class="">Action</th>
                        </tr>
                        </thead>
					<tbody>
						<c:forEach items="${assetList}" var="asset" varStatus="count">
							<tr>
								<td class="text-center">${count.count}</td>
								<td>${asset.buildingType}</td>
								<td>${asset.assetName}</td>
								<%-- <td><c:choose>
										<c:when test="${not empty asset.assetImagePath}">
											<img src="${asset.assetImagePath}" alt="Asset Image"
												width="60" height="60" style="border-radius: 5px;">
										</c:when>
										<c:otherwise>
											<span class="text-muted">No Image</span>
										</c:otherwise>
									</c:choose></td> --%>								
								<td>${asset.numberOfClassrooms}</td>
								<%-- <td>${asset.classroomSize}</td> --%>
								<td>${asset.hostelFurnished}</td>
<%-- 								<td>${asset.capacity}</td>
 --%>								<td>${asset.assetCondition}</td>
								<td>${asset.functionalDate}</td>
								<td>${asset.handoverDate}</td>
								<td class="text-center" style="position: relative;">
									<button type="button" class="btn btn-sm btn-primary"
										onclick="viewDoc('${asset.assetImagePath}','ASSET_IMG')"
										title="View Document">
										<i class="fa-solid fa-eye"></i>
									</button>
								</td>								
								<td class="text-center">
									<button class="btn btn-primary btn-sm"
										onclick="editAssetForm(${asset.assetManagementId})"
										title="Edit">
										<i class="fas fa-edit"></i>
									</button>
								</td>
							</tr>
						</c:forEach>
					</tbody>
				</table>
                </div>
            </div>
        </div>
</div>

<!-- Scripts -->
<script>

function editAssetForm(id) {
    $("#assetEditId").val(id);
    var bizContent = $("#editForm").serializeArray();
    $("#editCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    bootbox.confirm("Do You Want To Continue?", function(result) {
        if (result) {
            $("#editForm").submit();
        }
    });
}
    
     function LoadBlockByDistrict(distId, targetId) {
        $.ajax({
            type: "GET",
            url: "${contextPath}/common/fetchBlockByDistrict",
            data: { districtId: distId },
            success: function (blocks) {
                var $block = $("#" + targetId);
                $block.empty();
                $block.append('<option value="" selected disabled>- Select -</option>');
                
                $.each(blocks, function (index, blockData) {
                	 $block.append('<option value="' + blockData.blockId + '">' + blockData.blockName + '</option>');
                });              
            },
            error: function () {
                alert("Error loading blocks!");
            }
        });
    } 
          

    function LoadGrampanchayatByBlock(blockId, targetId) {
        $.ajax({
            type: "GET",
            url: "${contextPath}/common/fetchGrampanchayatByBlock",
            data: { blockId: blockId },
            success: function (grampanchayats) {
                var gp = $("#" + targetId);
                gp.empty();
                gp.append('<option value="" selected disabled>- Select -</option>');
                
                $.each(grampanchayats, function (index, grampanchayat) {
                    gp.append('<option value="' + grampanchayat.gpId + '">' + grampanchayat.gpName + '</option>');
                });
            },
            error: function () {
                alert("Error loading Grampanchayat!");
            }
        });
    }
    
    

    function LoadVillageByGrampanchayat(gpId, targetId) {
        $.ajax({
            type: "GET",
            url: "${contextPath}/common/fetchVillageByGrampanchayat",
            data: { gpId: gpId },
            success: function (villages) {
                var villageData = $("#" + targetId);
                villageData.empty();
                villageData.append('<option value="" selected disabled>- Select -</option>');
                
                $.each(villages, function (index, village) {
                    villageData.append('<option value="' + village.villageId + '">' + village.villageName + '</option>');
                });
            },
            error: function () {
                alert("Error loading Village!");
            }
        });
    }

    function submitForm() {
    	debugger;
    	var districtId = $("#districtId").val() || '';
        var blockId = $("#blockId").val() || '';
        var gpId = $("#gpId").val() || '';
        var buildingType = $("#buildingType").val() || ''; 
        var buildingId = $("#buildingId").val() || ''
        var villageId = $("#villageId").val() || ''

        $("#districtIdHdn").val(districtId);
        $("#blockIdHdn").val(blockId);
        $("#gpIdHdn").val(gpId);
        $("#buildingTypeHdn").val(buildingType);
        $("#buildingIdHdn").val(buildingId);
        $("#villageIdHdn").val(villageId);
        var bizContent = $("#filterForm").serializeArray();
        console.log(bizContent);
        $("#filterFormCipherText").val(
            enc_password(JSON.stringify(convertFormToJSONArray(bizContent)))
        );

        $("#filterForm").submit();
    	   	 
    }
   
    function viewDoc(fileName, moduleName) {
    	debugger;
    	 $("#fileName").val(fileName);
         $("#moduleName").val(moduleName);

         let jsonData = {
             fileName: fileName,
             moduleName: moduleName,
             _csrf: $("input[name='_csrf']").val()  
         };

         let encrypted = enc_password(JSON.stringify(jsonData));

         $("#cipherTextView").val(encrypted);
         $("#documentFormView").submit();
    }
    
    var selectedBuildingId = "${selectedBuildingId}";

    function getBuildingNameByBuildingType(buildingType, targetId) {
        $.ajax({
            type: "GET",
            url: "${contextPath}/manageAsset/getBuildingDetails",
            data: { buildingType: buildingType },
            success: function (buildingData) {
                var $buildingSelect = $("#" + targetId);
                $buildingSelect.empty();
                $buildingSelect.append('<option value="" selected disabled>- Select -</option>');
                
                $.each(buildingData, function (index, building) {
                    $buildingSelect.append('<option value="' + building.buildingId + '">' + building.buildingName + '</option>');
                });
                
                if (selectedBuildingId) {
                    $buildingSelect.val(selectedBuildingId);
                }
                
            },
            error: function () {
                alert("Error loading building details!");
            }
        });
    } 
    
    $(document).ready(function () {
        var selectedDistrictId = "${selectedDistrictId}";
        var selectedBlockId = "${selectedBlockId}";
        var selectedGpId = "${selectedGpId}";
        var selectedvillageId = "${selectedvillageId}"; 
        if (selectedDistrictId && selectedDistrictId !== "0") {
            $("#districtId").val(selectedDistrictId);
            LoadBlockByDistrict(selectedDistrictId, 'blockId');

            setTimeout(function () {
                if (selectedBlockId && selectedBlockId !== "0") {
                    $("#blockId").val(selectedBlockId);
                    LoadGrampanchayatByBlock(selectedBlockId, 'gpId');

                    setTimeout(function () {
                        if (selectedGpId && selectedGpId !== "0") {
                            $("#gpId").val(selectedGpId);

                            LoadVillageByGrampanchayat(selectedGpId, 'villageId');

                            setTimeout(function () {
                                if (selectedvillageId && selectedvillageId !== "0") {
                                    $("#villageId").val(selectedvillageId);
                                }
                            }, 400);

                        }
                    }, 400);
                }
            }, 400);
        }
    });


</script>

<form class="form-horizontal"
      action="${contextPath}/manageAsset/filterAssetManagement"
      method="get" id="filterForm">
    <input type="hidden" name="cipherText" id="filterFormCipherText" value="">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}">    
    <input type="hidden" name="districtId" id="districtIdHdn">
    <input type="hidden" name="blockId" id="blockIdHdn">
    <input type="hidden" name="gpId" id="gpIdHdn">
    <input type="hidden" name="buildingType" id="buildingTypeHdn">
    <input type="hidden" name="buildingId" id="buildingIdHdn"> 
    <input type="hidden" name="villageId" id="villageIdHdn">    
       
</form>

<form action="${contextPath}/manageAsset/edit" method="post" id="editForm">
    <input type="hidden" id="editCipherText" name="cipherText">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
    <input type="hidden" id="assetEditId" name="assetManagementId" />
</form>

<form action="${contextPath}/manageAsset/viewFile" method="get" id="documentFormView" target="_blank">
    <input type="hidden" name="cipherText" id="cipherTextView">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
    <input type="hidden" name="fileName" id="fileName" />
    <input type="hidden" name="moduleName" id="moduleName" />
</form>
