<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<c:set var="chargeRow" value="0" />

<section>
    <div class="mt-2">
        <form action="${contextPath}/procurement/quotation/supplier/saveRfqQuote" method="post" id="form" modelAttribute="rfqQuote">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <input type="hidden" name="rfqQuoteId" value="${rfq.rfqQuoteId}" />
            <div class="panel-body">
				<div class="row">
					<div class="col-md-12">
					<h5 class="mb-3">Requisition</h5>
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="PROC.REQ.REQNO" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.requisition.requisitionNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="PROC.QNNO" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.quoteNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.NAME" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.vendor.vendorName}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.CODE" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.vendor.vendorCode}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.MOB" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.vendor.mobileNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.EMAIL" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.vendor.email}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.ADDRS" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.vendor.vendorAddress}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="COMMON.CURRENCY" /></label>
									<div class="col-md-12">
										<select class="form-select" aria-label="Default select example" id="currency" name="currency.currencyId">
				                            <c:forEach items="${lstCur}" var="cur">
				                              <option value="${cur.currencyId}" ${cur.currencyId eq rfq.currency.currencyId ? 'selected' : ''}>${cur.currencyShortName}</option>
				                            </c:forEach>
			                          	</select>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
								<div class="col-md-12" style="text-align: right;margin-bottom: -15px;">
									<button type="button" class="btn-submit" onclick="addAdditionalCost()">Additional Cost</button>
								</div>
							</c:if>
							<div class="col-md-12">
								<table class="table table-striped table-bordered exportbtn mt-3">
									<thead>
										<tr>
											<th ><spring:message code="COMMON.SLNO" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.SUB.CAT" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.DESC" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.CODE" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.QTY" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.UNIT" /></th>
											<th><spring:message code="PROC.REQ.ITEM.DISCOUNT" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.TAX" /></th>
											<th><spring:message code="PROC.REQ.ITEM.TOTAL" /></th>
										</tr>
									</thead>
									<tbody id="itemBody">
										<c:forEach items="${rfq.rfqQuoteLines}" var="line" varStatus="count">
											<tr>
												<td>${count.count} <input type="hidden" class="NumbersOnlyWithoutDot" id="quoteLineId${count.index}" name="rfqQuoteLines[${count.index}].quoteLineId" value="${line.quoteLineId}"></td>
												<td>${line.item.subCategory.subCategoryName}</td>
												<td>${line.item.itemName}</td>
												<td>${line.item.itemCode}</td>
												<td><input type="text" class="NumbersOnlyWithoutDot supplierQuantity" id="supplierQuantity${count.index}" name="rfqQuoteLines[${count.index}].supplierQuantity" value="${line.supplierQuantity}">  </td>
												<td><input type="number" class="unitPrice" id="unitPrice${count.index}" name="rfqQuoteLines[${count.index}].unitPrice" value="${line.unitPrice}"><input type="hidden" class="subtotal" name="rfqQuoteLines[${count.index}].subTotal" id="subtotal${count.index}" value="${line.subTotal}"></td>
												<td><input type="number" class="discount" id="discountRate${count.index}" name="rfqQuoteLines[${count.index}].discountRate" value="${line.discountRate}"><input type="hidden" class="discAmt" name="rfqQuoteLines[${count.index}].discountAmount" id="discAmt${count.index}" value="${line.discountAmount}"></td>
												<td><input type="number" class="tax" id="taxRate${count.index}" name="rfqQuoteLines[${count.index}].taxRate" value="${line.taxRate}"> <input type="hidden" class="taxAmt" name="rfqQuoteLines[${count.index}].taxAmount" id="taxAmt${count.index}" value="${line.taxAmount}"></td>
												<td><input type="text" class="total" id="totalAmount${count.index}" name="rfqQuoteLines[${count.index}].totalAmount" value="${line.totalAmount}" readonly="readonly"></td>
											</tr>
										</c:forEach>
										<c:if test="${not empty rfq.rfqQuoteLines}">
											<tr>
												<td colspan="7" ></td>
												<td>Sub Total </td>
												<td><input type="text" id="subTotal" readonly="readonly"> </td>
											</tr>
											<tr>
												<td colspan="7"></td>
												<td>Discount</td>
												<td><input type="text" id="totalDiscount" readonly="readonly"> </td>
											</tr>
											<tr>
												<td colspan="7"></td>
												<td>Tax </td>
												<td><input type="text" id="totalTax" readonly="readonly"> </td>
											</tr>
											<c:if test="${not empty rfq.lstAddCost}">
												<c:forEach items="${rfq.lstAddCost}" var="addCst" varStatus="count">
													<tr id="chargeRow${count.index}">
														<td colspan="7" style="text-align:right">Enter Addtitional Cost  <input type="hidden" name="lstAddCost[${count.index}].addCostId" value="${addCst.addCostId}" ></td>
														<td><input type="text" id="chargeName${count.index}" name="lstAddCost[${count.index}].addCostName" value="${addCst.addCostName}"> </td>
														<td><input type="number" class="addCost" id="charge${count.index}" value="${addCst.addCost}" name="lstAddCost[${count.index}].addCost" >
															<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
																<i class="fa-regular fa-square-minus" style="font-size:30px;" id="rmvBtn${count.index}" onclick="removeDiv(${count.index})" ></i>
															</c:if>
														</td>
													</tr>
													<c:set var="chargeRow" value="${count.count}" />
												</c:forEach>
												<tr id="totalAddCostRow">
													<td colspan="7"></td>
													<td>Total AdditionalCost </td>
													<td><input type="text" id="totalAddCost" value="0.00" readonly="readonly"> </td>
												</tr>
											</c:if>
											<tr>
												<td colspan="7"></td>
												<td>Grand Total </td>
												<td><input type="text" id="grandTotal" readonly="readonly"> </td>
											</tr>
										</c:if>
									</tbody>
								</table>
							</div>
<%-- 							<c:if test="${not empty rfq && rfq.rfqReceived eq false}"> --%>
<!-- 								<div class="col-md-12 btnholder text-center"> -->
<%-- 									<input type="submit" class="btn btn-success" value="${not empty rfq.parentRfqQuote ? 'Revise' : 'Submit'}" onclick="">  --%>
<!-- 									<button type="reset" class="btn btn-sm btn-warning">Reset</button> -->
<!-- 								</div> -->
<%-- 							</c:if> --%>
						</div>
					</div>
				</div>
			</div>
			<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
        </form>
	</div>
</section>

<script>
	$(document).ready(function(){
		totalCalculation();
		calculateTotalAddCost();
	});

	
	var chargeCount=0+${chargeRow};
	function addAdditionalCost() {
		var html='<tr id="chargeRow'+chargeCount+'"><td colspan="7" style="text-align:right">Enter Addtitional Cost</td><td><input type="text" id="chargeName'+chargeCount+'" name="lstAddCost['+chargeCount+'].addCostName"> </td><td><input type="number" class="addCost" id="charge'+chargeCount+'" value="0.00" name="lstAddCost['+chargeCount+'].addCost" ><i class="fa-regular fa-square-minus" style="font-size:30px;" id="rmvBtn'+chargeCount+'" onclick="removeDiv('+chargeCount+')" ></i></td></tr>';
		var tbody = document.getElementById('itemBody'); 
		
		var targetIndex =0;
		if(chargeCount==0){
			targetIndex = tbody.rows.length - 1;
			var tothtml='<tr id="totalAddCostRow"><td colspan="7"></td><td>Total AdditionalCost </td><td><input type="text" id="totalAddCost" value="0.00" readonly="readonly"> </td></tr>';
			var tottempDiv = document.createElement('tbody');
			tottempDiv.innerHTML = tothtml;
			var newtotRow = tottempDiv.firstElementChild;
			tbody.insertBefore(newtotRow, tbody.rows[targetIndex]);
		}
		targetIndex = tbody.rows.length - 2;
		var tempDiv = document.createElement('tbody');
		tempDiv.innerHTML = html;
		var newRow = tempDiv.firstElementChild;
		tbody.insertBefore(newRow, tbody.rows[targetIndex]);
		
		chargeCount++;
	}
	function removeDiv(id) {
		var index=chargeCount-1;
		if(index==id){
			$("#chargeRow"+id).remove();
			chargeCount--;
			if(chargeCount==0){
				$("#totalAddCostRow").remove();
			}
		}
		
		
	}
	function convertToFloat(value){
		if(value === "" || value === undefined){
			value = 0;
		}
		return parseFloat(value);
	}
	$(document).on('keyup', '.supplierQuantity', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('supplierQuantity')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.unitPrice', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('unitPrice')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.discount', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('discountRate')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.tax', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('taxRate')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.addCost', function(){
		calculateTotalAddCost();
	});
	function calculateTotalAddCost() {
		var addCost=0;
		$('.addCost').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			addCost += parseFloat(val);
		});
		addCost=addCost.toFixed(2);
		$("#totalAddCost").val(addCost);
		totalCalculation();
	}
	function eachRowCalculation(rowNo) {
		var qty = $('#supplierQuantity'+rowNo).val() == '' || $('#supplierQuantity'+rowNo).val() == undefined ? 0 : $('#supplierQuantity'+rowNo).val();
		var price = $('#unitPrice'+rowNo).val() == '' || $('#unitPrice'+rowNo).val() == undefined ? 0 : $('#unitPrice'+rowNo).val();
		var discount = $('#discountRate'+rowNo).val() == '' || $('#discountRate'+rowNo).val() == undefined ? 0 : $('#discountRate'+rowNo).val();
		var tax = $('#taxRate'+rowNo).val() == '' || $('#taxRate'+rowNo).val() == undefined ? 0 : $('#taxRate'+rowNo).val();
		
		qty = convertToFloat(qty);
		price = convertToFloat(price);
		discount = convertToFloat(discount);
		tax = convertToFloat(tax);
		
		var subTotal=qty * price;
		var discountAmount = subTotal * (discount / 100);
		var taxAmount = (subTotal - discountAmount) * (tax / 100);
		var totalAmount=subTotal-discountAmount+taxAmount;
		totalAmount=totalAmount.toFixed(2);
		
		$("#subtotal"+rowNo).val(subTotal);
		$("#discAmt"+rowNo).val(discountAmount);
		$("#taxAmt"+rowNo).val(taxAmount);
		$("#totalAmount"+rowNo).val(totalAmount);
		totalCalculation();
	}
	function totalCalculation() {
		var subTotal = 0;
		var totalDiscount = 0;
		var totalTax = 0;
		var totalAddCost=$("#totalAddCost").val() == '' || $("#totalAddCost").val() == undefined ? 0 : $("#totalAddCost").val();
		var grandTotal = 0+parseFloat(totalAddCost);
		$('.subtotal').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			subTotal += parseFloat(val);
		});

		$('.discAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalDiscount += parseFloat(val);
		});

		$('.taxAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalTax += parseFloat(val);
		});

		$('.total').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			grandTotal += parseFloat(val);
		});
		subTotal =subTotal.toFixed(2);
		totalDiscount = totalDiscount.toFixed(2);
		totalTax = totalTax.toFixed(2);
		grandTotal = grandTotal.toFixed(2);
		
		$("#subTotal").val(subTotal);
		$("#totalDiscount").val(totalDiscount);
		$("#totalTax").val(totalTax);
		$("#grandTotal").val(grandTotal);
	}
	
</script>
<script src="${contextPath}/assets/js/commonFunctions.js"></script>