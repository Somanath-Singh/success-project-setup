<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<style>
a.visited-link {
        color: purple !important;
    }
</style>

 <div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">GRN Bill Payment</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">GRN Bill Payment</li>
                  </ol>
                </nav>
              </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">GRN Bill Payment</h5>
                    </div>
                    <div class="card-body">
	<form method="get" action="${contextPath}/procurement/purchaseOrder/billgenerate" id="form">
	    <input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
		<input type="hidden" id="genDate" value="<fmt:formatDate value='${po.poReceiptGeneratedDate}' pattern='dd/MM/yyyy'/>">
		<div class="row">
			<div class="col-md-12">
				<div class="row">
					<div class="form-group col-md-3">
						<label class="inputEmail4 required" for="text">Purchase Order:</label> 
						<select class="form-control" id="poId" name="poId" >
							<option value="0">-Select-</option>
							<c:forEach items="${lstPo}" var="po">
								<option value="${po.poId}" ${po.poId eq poId ? 'selected' :''}>${po.poNo}</option>
							</c:forEach>
						</select>
					</div>
					
					<div class="col-md-3" style="margin-top:20px;">
						<input type="button" class="btn btn-submit" value="Submit" onclick="validateForms()">
						<a class="btn btn-danger" onclick="backToModule()">Cancel</a>
					</div>
				</div>
			</div>
		</div>
		
	</form>
	
	
	
	
	<c:if test="${not empty poId}">
	<form method="post" action="${contextPath}/procurement/purchaseOrder/billgenerate" id="billForm">
	 <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
		<input type="hidden" name="poId"  value="${poId}"  />
		<input type="hidden" class="" id="encodedDatabillForm" name="encodedDatabillForm" value="" />
		<div id="chkGrn">
		
		</div>	
		<div class="row">
			<div class="col-md-12">
				<div class="row">
				<div class="col-md-10">
					<div class="form-group">
						<h6 class="inputEmail4 required" for="text" style="margin-top: 27px;">Grn List For Bill Payment:</h6>
					</div>
				</div>
				<div class="col-md-2">
					<div class="form-group">
						<label class="inputEmail4 required" for="text">Bill Generate Date :</label>
						<div class="datepicker-box ">
	                 		<input type="text" class="form-control form-control-sm requiredField generateDate"  id="billGenerateDate" value="" name="billGenerateDate" readonly /> 

	               		</div>
					</div></div>
				</div>
			</div>
		</div>
	</form>
		<div class="col-md-12">
			<div class="table-responsive">
				<table class=" table table-striped table-bordered" >
					<thead class="bagGroundColor">
						<tr>
							<th>Sl No</th>
							<th>Purchase Number</th>
							<th>Grn Number</th>
							<th>Grn Date</th>
							<th>Action</th>
						</tr>
					</thead>
					<tbody id="grnList">
						<c:forEach items="${lstGrn}" var="grnn" varStatus="status">
							<tr>
								<td>${status.count}</td>
								<td>${grnn.purchaseOrder.poNo}</td>
								<td>${grnn.grnNo}</td>
								<td><fmt:formatDate value='${grnn.grnDate}' pattern='dd/MM/yyyy'/></td>
								<td>
									<input type="hidden" id="grn${status.count}" value="${grnn.grnId}">
									<input type="checkbox" id="grnCheck${status.count}" ${grnn.paid eq true ? 'disabled' : '' } /> 
								</td>
							</tr>
						</c:forEach>
					</tbody>
				</table>
			</div>
		</div>
		<div class="col-md-12  text-center">
			<input type="button" class="btn-submit" value="Submit" onclick="validateBillForm()"> 
		</div>
		<c:if test="${not empty lstBill}">
			<h6 class="inputEmail4 required" for="text" style="">Bill Payment Invoice :</h6>
			<div class="col-md-12">
				<div class="table-responsive">
					<table class=" table table-striped table-bordered">
						<thead>
							<tr>
								<th>Sl No</th>
								<th>Bill Number</th>
								<th>Purchase Number</th>
								<th>Bill Date</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody id="billList">
							<c:forEach items="${lstBill}" var="bill" varStatus="status">
								<tr>
									<td>${status.count}</td>
									<td><a href="#" onclick="getBillInvoice(${bill.billId})">${bill.billNo}</a></td>
									<td>${bill.purchaseOrder.poNo}</td>
									<td><fmt:formatDate value='${bill.billGenerateDate}' pattern='dd/MM/yyyy'/></td>
									<td>
										<input type="hidden" id="billId${status.count}" value="${bill.billId}">
										<input type="checkbox" id="billCheck${status.count}" ${bill.isPaid eq true ? 'disabled' : '' } /> 
									</td>
								</tr>
							</c:forEach>
						</tbody>
					</table>
				
			</div>
			<div class="col-md-12  text-center">
				<input type="button" class="btn-submit" value="BulkAction" onclick="checkBillPay()"> 
			</div>
		</c:if>
	</c:if>
</div>
	</div>
	</div>
	</div>
<form method="post" action="${contextPath}/procurement/purchaseOrder/billPayment" id="billPayment">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="poId"  value="${poId}"  />
	<input type="hidden" class="" id="encodedDatabillPayment" name="encodedDatabillPayment" value="" />
	
</form>
<form method="get" action="${contextPath}/procurement/purchaseOrder/billInvoice" id="billInvoice">
    <input type="hidden" name="billId" id="billIdd"  value="${poId}"  />
    <input type="hidden" class="" id="encodedDatabillInvoice" name="billIdEncode" value="" />
</form>

<script>
function backToModule(){
       let currentModuleCode =  localStorage.getItem('currentModuleCode');
       $('#moduleId').val(enc_password(currentModuleCode));
       $('#moduleForm').submit();
    }
    function getBillInvoice(billId) {
        $("#billIdd").val(billId);
        encryptFormData("billInvoice", tableOrTbodyIDS, tableOrTbodyKeys);
        $("#billInvoice").submit();
    }
	$(function() {
		$('.generateDate').datepick({
			dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
			showTrigger: '<button type="button" class="trigger">' +
            		 '<i class="fa fa-calendar"></i></button>',
			 onSelect: function(selected) {
				 var alltDate=$('#genDate').val().split("/");
				 var modAllotDate=new Date(alltDate[1]+"/"+alltDate[0]+"/"+alltDate[2]);
				 if(modAllotDate > new Date(selected)){
					bootbox.alert('Bill Generate date sholud not be less than PO approval date.');
					$('.generateDate').val("");
				 }
			 }
		});
	});
	function validateForms() {
		var poId=$("#poId").val();
		if(poId==0){
			bootbox.alert("Please select Purchase.");
			return false;
		}else{
		    encryptFormData("form", tableOrTbodyIDS, tableOrTbodyKeys);
			$("#form").submit();
		}
	}
	function validateBillForm() {
		$("#chkGrn").empty();
		allGrnIds = [];
		$('#grnList').find('input[type="checkbox"]').each(function() {
			if (this.checked) {
				var id = this.id.replace('grnCheck', '');
				var grnId = $('#grn' + id).val();
				allGrnIds.push(grnId);
			}
		});
		if (allGrnIds.length == 0) {
			bootbox.alert("Please select atleast one grn");
			return false;
		}
		allGrnIds.map((item, index) => {
			var html='<input type="hidden" name="grnList" value="'+item+'">';
			$("#chkGrn").append(html);
		});
		var genDate=$("#billGenerateDate").val();
		if(genDate==""){
			bootbox.alert("Please select bill generate date");
			return false;
		}else{
			let isConfirm = confirm("Are you sure you want to generate bill?");
			if(isConfirm){
			    encryptFormData("billForm", tableOrTbodyIDS, tableOrTbodyKeys);
				$("#billForm").submit();
			}
			
		}
		
	}
	
	function checkBillPay() {
		allBillIds = [];
		$('#billList').find('input[type="checkbox"]').each(function() {
			if (this.checked) {
				var id = this.id.replace('billCheck', '');
				var billId = $('#billId' + id).val();
				allBillIds.push(billId);
			}
		});
		if (allBillIds.length == 0) {
			bootbox.alert("Please select atleast one bill");
			return false;
		}
		allBillIds.map((item, index) => {
			var html='<input type="hidden" name="billId" value="'+item+'">';
			$("#billPayment").append(html);
		});
		let isConfirm = confirm("Are you sure you want to proceeding payment?");
        if(isConfirm){
            encryptFormData("billPayment", tableOrTbodyIDS, tableOrTbodyKeys);
            $("#billPayment").submit()
        }
		
	}
document.addEventListener("click", function (event) {
    if (event.target.closest("#billList a")) {
        event.target.classList.add("visited-link");
    }
});
</script>