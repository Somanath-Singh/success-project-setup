<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<sec:authentication var="principal" property="principal" />
<c:set var="chargeRow" value="0" />
<c:set var="slno" value="1" />

<style>
    .btn-plus{
        background: #206ed9!important;
        width: 24px;
        height: 24px;
        text-align: center;
        padding: 0;
        font-size: 12px;
        border-radius: 5px;
        line-height: 22px;
        color: #fff;
         border: 1px solid #206ed9!important;
    }
    .btn-cross{
        background: #822347;!important;
        width: 24px;
        height: 24px;
        text-align: center;
        padding: 0;
        font-size: 12px;
        border-radius: 5px;
        line-height: 22px;
        color: #fff;
        border: 1px solid #822347;!important;
    }
    .t-inner-data #itemBody td{
        font-size: 11px !important;
        line-height: 14px !important;
    }

    @media print {
        .no-print {
            display: none;
        }
        input {
            border-color: transparent !important;
        }
        select {
            border-color: transparent !important;
        }
        td #mrnDate {
            border-color: transparent !important;
            display: none;
        }
         td textarea {
            border-color: transparent !important;
            resize: none;
        }
        td #doc{
            display: none;
        }
        .btnholder,.fa-calendar-week{
            display: none;
        }
        .invoice-form table thead th,.detailsheading {
            background: transparent !important;
            color: #000 !important;
        }
        .detailsheading{
            font-weight: 700;
        }
        .borderNone{
            border: none !important;
        }
        .card-header{
            padding-left: 0 !important;
        }

    }
    table td {
            font-size: 13px !important;
            font-weight: 500 !important;
            color: #312e2e !important;
            line-height: 20px !important;
            letter-spacing: 0.5px;
                padding: 5px;
        }
        table thead tr th {
            padding: 5px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            color: #0f0e47 !important;
        }
        table th {
            font-size: 13px;
            font-weight: 600 !important;
            line-height: 22px;
        }
        input,select{
                border: 1px solid #2c97af7a;
                border-radius: 4px !important;
                height: 25px;
        }

    .dataSection tr, #itemBody tr{
        vertical-align: baseline;
    }
    .error-message {
        color: red;
        font-weight: 400;
        margin-top: 5px;
        position: absolute;
        right: 0;
        bottom: 0;
    }

    @keyframes blinkColor {
        0% { color: red; }
        50% { color: black; }
        100% { color: red; }
    }

    .blinking-text {
        animation: blinkColor 1s infinite;
    }
</style>
<section>
	<div class="mt-2 invoice-form">
		<form action="${contextPath}/procurement/quotation/supplier/saveRfqQuote" method="post" id="form" modelAttribute="rfqQuote">
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
			<input type="hidden" name="rfqQuoteId" value="${rfq.rfqQuoteId}" />
			<input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
			<div  class="borderNone invoice-form" style="width: 900px; margin: auto; background: #fff; position: relative;padding: 10px;border: 1px solid #ddd;">
				<div style="float:left; width:50%">
				<h3 style="margin-bottom: 5px; margin-top: 5px; color: #000; font-weight: 600; padding:10px 0;"><spring:message code="PROC.RFQ.TITLE" /></h3></div>
				
				<div style="float:right; width:50%; text-align: right;">
                    <c:choose>
                        <c:when test="${!empty icon}">
                            <img src="${contextPath}/document/view-documents?doc=${icon}&module=ICON" alt="logo" class="logo" style="width: 50px;" />
                        </c:when>
                        <c:otherwise>
                            <img src="${contextPath}/assets/images/favicon.png" alt="logo" class="logo" style="width: 50px;" />
                        </c:otherwise>
                    </c:choose>
                </div>
				<div style="clear:both; margin-bottom:0"></div>
                     <div class="card-header" style="position: relative;background: #00ffff !important; ">
                        <button type="button" class="no-print" style="float: right;position: absolute;top: -3px;right: 10px;border: none;background: none;font-size: 26px;color: #5f7dcb;" onclick="window.print()">
                            <i class="fa-solid fa-print"></i>
                        </button>

                        <h4 class="detailsheading" style=" color: #0f0e47; font-size: 16px;padding-left: 2px; margin-bottom: 0px; margin-top: 0;font-weight: 600;">Contact details :</h4>
                     </div>
                <div style="clear:both; margin-bottom:0"></div>
                <div class="con" style="width: 100%; float: left;">

				<div class="col-md-6 dataSection" style="width:50% ;float: left;padding: 10px 0;" >
					<table style="font-size: 12px; line-height: 20px;">
						<tr>
							<th style="width: 40%">Vendor Name :</th>
							<td style="width: 60%">${rfq.assetVendor.vendorName}</td>
						</tr>
						<tr>
							<th style="width: 40%">Address :</th>
							<td style="width: 60%">${rfq.assetVendor.vendorAddress}</td>
						</tr>
						<tr>
							<th style="width: 40%">Mobile No. :</th>
							<td style="width: 60%">${rfq.assetVendor.mobileNo}</td>
						</tr>
						<tr>
							<th style="width: 40%">Email :</th>
							<td style="width: 60%">${rfq.assetVendor.email}</td>
						</tr>
						<tr>
							<th style="width: 40%">GSTIN :</th>
							<td style="width: 60%">${rfq.assetVendor.gstNo}</td>
						</tr>
						<tr>
							<th style="width: 40%">POC :</th>
							<td style="width: 60%">${rfq.assetVendor.pointOfContact}</td>
						</tr>
						<tr>
							<th style="width: 40%">Phone No. :</th>
							<td style="width: 60%">${rfq.assetVendor.contactNumber}</td>
						</tr>
					</table>
				</div>
				<div class="col-md-6 dataSection" style="width:50% ;float: right;padding: 10px 0;">
					<table style="font-size: 12px; line-height: 20px;">
						<tr>
							<th style="width: 40%">Company Name :</th>
							<td style="width: 60%">${orgName}</td>
						</tr>
						<tr>
							<th style="width: 40%">Quote No. :</th>
							<td style="width: 60%">${rfq.quoteNo}</td>
						</tr>
						<tr>
							<th style="width: 40%">Requisition No. :</th>
							<td style="width: 60%">${rfq.requisition.requisitionNo}</td>
						</tr>
						<tr>
							<th style="width: 40%">Requisition Date :</th>
							<td style="width: 60%"><fmt:formatDate value='${rfq.requisition.requisitionDate}' pattern='dd/MM/yyyy' /></td>
						</tr>
						<tr>
							<th style="width: 40%">GSTIN :</th>
							<td style="width: 60%">1007215ST501</td>
						</tr>
						<tr>
							<th style="width: 40%">Currency :</th>
							<td style="width: 60%">
								<select id="currency" name="currencyId" style="width: 50%" ${rfq.currency}>
									<c:forEach items="${lstCur}" var="cur">
										<option value="${cur.currencyId}" ${cur.currencyId eq rfq.currency.currencyId ? 'selected' : ''}>${cur.currencyShortName}</option>
									</c:forEach>
								</select>
							</td>
						</tr>
					</table>
				</div>
				</div>
				<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
					<div class="col-md-12" style="text-align: right;width: 100%; float: right;">
						<button type="button" class="btn-submit no-print" onclick="addAdditionalCost()" style="">Additional Cost</button>
					</div>
				</c:if>
				<div style="clear:both; margin-bottom:15px"></div>
				<div style="width: 100%; float: left;">
				<table class="t-inner-data quotetableValidation" style="font-size: 12px;width: 100%; padding:5px;">
					<thead style="background: #00ffff !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;">
						<tr>
							<th style="color: #fff;width: 52px;"><spring:message code="COMMON.SLNO" /></th>
							<th style="color: #fff;"><spring:message code="PROC.REQ.ITEM.SUB.CAT" /></th>
							<th style="color: #fff; "><spring:message code="PROC.REQ.ITEM.DESC" /></th>
							<th style="color: #fff;width: 85px;"><spring:message code="PROC.REQ.ITEM.CODE" /></th>
							<th style="color: #fff;text-align: right;"><spring:message code="PROC.REQ.ITEM.QTY" /></th>
							<th style="color: #fff;text-align: right;"><spring:message code="PROC.REQ.ITEM.UNIT" /></th>
							<th style="color: #fff;text-align: right;">Disc(%)</th>
							<th style="color: #fff;text-align: right;"><spring:message code="PROC.REQ.ITEM.TAX" />(%)</th>
							<th style="color: #fff; width: 50px; text-align: right; padding-right: 5px;"><spring:message code="PROC.REQ.ITEM.TOTAL" /></th>
							<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
								<th  class="no-print"style="color: #fff; width:65px">Action</th>
							</c:if>
						</tr>
					</thead>
					<tbody id="itemBody">
						<c:forEach items="${rfq.rfqQuoteLines}" var="line" varStatus="count">
							<c:choose>
								<c:when test="${not empty line.parentLines && not empty line.parentLines.quoteLineId }">
									<tr id="row${count.index}" class="quoteAtleastOneRowMandatory">
										<td>#
											<input type="hidden" class="NumbersOnlyWithoutDot" id="quoteLineId${count.index}" name="rfqQuoteLines[${count.index}].quoteLineId" value="${line.quoteLineId}">
										</td>
										<td>${line.item.subCategoryName}</td>
										<c:choose>
											<c:when test="${not empty rfq && rfq.rfqReceived eq false}">
												<td><input type="text" name="rfqQuoteLines[${count.index}].itemName" value="${line.item.itemName}" maxlength="50" /></td>
												<td><input type="text" value="${line.item.itemCode}" readonly="readonly"/></td>
											</c:when>
											<c:otherwise>
												<td>${line.item.itemName}</td>
												<td>${line.item.itemCode}</td>
											</c:otherwise>
										</c:choose>
										<td>
											<input type="text" class="${line.item.isFractional ? 'numberWithTwoDesimal' :'numberWithTwoDesimalButOnlyAllowZero'} supplierQuantity  onClickInput maximunLengthIs10WithDot ${not empty rfq && not empty rfq.currency && line.unitPrice eq 0 ? '' :'greaterThanZero' }" id="supplierQuantity${count.index}" name="rfqQuoteLines[${count.index}].supplierQuantity" value="${line.supplierQuantity}" style="width: 85px; text-align: right;">
										</td>
										<td>
											<input type="number" class="unitPrice  maximunLengthIs10WithDot numberWithTwoDesimal onClickInput ${not empty rfq && not empty rfq.currency && line.unitPrice eq 0 ? '' :'greaterThanZero' }" id="unitPrice${count.index}" name="rfqQuoteLines[${count.index}].unitPrice" value="${line.unitPrice}" style="width: 70px; text-align: right;">
											
										</td>
										<td>
											<input type="number" class="discount numberWithTwoDesimal onClickInput percentageOnly" id="discountRate${count.index}" name="rfqQuoteLines[${count.index}].discountRate" value="${line.discountRate}" style="width: 45px; text-align: right;"> 
											<input type="hidden" class="discAmt" name="rfqQuoteLines[${count.index}].discountAmount" id="discAmt${count.index}" value="${line.discountAmount}">
											<input type="hidden" class="subtotal" name="rfqQuoteLines[${count.index}].subTotal" id="subtotal${count.index}" value="${line.subTotal}">
										</td>
										<td>
											<input type="number" class="tax numberWithTwoDesimal onClickInput percentageOnly" id="taxRate${count.index}" name="rfqQuoteLines[${count.index}].taxRate" value="${line.taxRate}" style="width: 45px; text-align: right;">
											<input type="hidden" class="taxAmt" name="rfqQuoteLines[${count.index}].taxAmount" id="taxAmt${count.index}" value="${line.taxAmount}">
										</td>
										<td>
											<input type="text"  id="totalAmount${count.index}"  value="<fmt:formatNumber value='${line.totalAmount}' type='number' minFractionDigits='2' maxFractionDigits='2'/>" readonly="readonly" style="width: 100%; text-align: right;border:none" >
											<input type="hidden" class="total" id="totalAmountP${count.index}" name="rfqQuoteLines[${count.index}].totalAmount"  value="${line.totalAmount}">
										</td>
										<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
											<td><i class="fa-solid fa-minus btn-cross no-print" style="font-size:15px; position: relative;top: -2px;line-height: 24px;"  onclick="removeAlterLineItem(${count.index},${line.quoteLineId})"></i></td>
										</c:if>
									
									</tr>
								</c:when>
								<c:otherwise>
									<tr id="row${count.index}" class="quoteAtleastOneRowMandatory ${not empty rfq && not empty rfq.currency && line.unitPrice eq 0 ? 'disable-row' : ''}">
										<td>${slno}
											<input type="hidden" class="NumbersOnlyWithoutDot" id="quoteLineId${count.index}" name="rfqQuoteLines[${count.index}].quoteLineId" value="${line.quoteLineId}">
											<input type="hidden" id="isaltered${count.index}" name="rfqQuoteLines[${count.index}].isAltered" value="${line.isAltered}"/>
										</td>
										<td>${line.item.subCategoryName}</td>
										<td>${line.item.itemName}</td>
										<td>${line.item.itemCode}</td>
										<td>
											<input type="text" class="${line.item.isFractional ? 'numberWithTwoDesimal' :'numberWithTwoDesimalButOnlyAllowZero'} supplierQuantity onClickInput maximunLengthIs10WithDot ${not empty rfq && not empty rfq.currency && line.unitPrice eq 0 ? '' :'greaterThanZero' }" id="supplierQuantity${count.index}" name="rfqQuoteLines[${count.index}].supplierQuantity" value="${line.supplierQuantity}" style="width: 85px; text-align: right;">
										</td>
										<td>
											<input type="number" class="unitPrice  maximunLengthIs10WithDot numberWithTwoDesimal onClickInput ${not empty rfq && not empty rfq.currency && line.unitPrice eq 0 ? '' :'greaterThanZero' }" id="unitPrice${count.index}" name="rfqQuoteLines[${count.index}].unitPrice" value="${line.unitPrice}" style="width: 70px; text-align: right;">
											
										</td>
										<td>
											<input type="number" class="discount numberWithTwoDesimal onClickInput percentageOnly" id="discountRate${count.index}" name="rfqQuoteLines[${count.index}].discountRate" value="${line.discountRate}" style="width: 45px; text-align: right;"> 
											<input type="hidden" class="discAmt" name="rfqQuoteLines[${count.index}].discountAmount" id="discAmt${count.index}" value="${line.discountAmount}">
											<input type="hidden" class="subtotal" name="rfqQuoteLines[${count.index}].subTotal" id="subtotal${count.index}" value="${line.subTotal}">
										</td>
										<td>
											<input type="number" class="tax numberWithTwoDesimal onClickInput percentageOnly" id="taxRate${count.index}" name="rfqQuoteLines[${count.index}].taxRate" value="${line.taxRate}" style="width: 45px; text-align: right;">
											<input type="hidden" class="taxAmt" name="rfqQuoteLines[${count.index}].taxAmount" id="taxAmt${count.index}" value="${line.taxAmount}">
										</td>
										<td>
											<input type="text"  id="totalAmount${count.index}"  value="<fmt:formatNumber value='${line.totalAmount}' type='number' minFractionDigits='2' maxFractionDigits='2'/>" readonly="readonly" style="width: 100%; text-align: right;border:none" >
											<input type="hidden" class="total" id="totalAmountP${count.index}" name="rfqQuoteLines[${count.index}].totalAmount"  value="${line.totalAmount}">
										</td>
										<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
											<td class="btnHolder"><button type="button" class=" btn-cross no-print ${line.isAltered eq true ? 'frezz' : ''}" id="minus${count.index}" onclick="removeItem(this,${count.index})" ><i class="fa-solid fa-minus  btn-cross" style="font-size:15px; position: relative;top: -2px;line-height: 24px;"></i></button>
												<button type="button" class=" btn-plus no-print ${line.isAltered eq true || (not empty rfq && not empty rfq.currency && line.unitPrice eq 0)? 'frezz' : ''}" id="plus${count.index}" onclick="addAnotherItemmm(this,${count.index},'${line.item.subCategoryName}',${line.supplierQuantity},${line.quoteLineId},'${line.item.isFractional ? 'numberWithTwoDesimal' :'numberWithTwoDesimalButOnlyAllowZero'}')"><i class='fa-solid fa-plus' style="font-size: 15px;position: relative;top: -2px;line-height: 27px;"></i></button>
													
											</td>
										</c:if>
										<c:set var="slno" value="${slno+1}" />
									</tr>
								</c:otherwise>
							</c:choose>
							
						</c:forEach>
                        </tbody>
                        <tbody id="chargeBody">
<!-- 						<tfoot style="line-height:13px;"> -->
						<tr class="skip" style="height:15px"></tr>
						<tr class="skip" style="border-top: #999 1px solid;">
							<th colspan="8" style="text-align: right; padding-right: 12px; padding: 5px; border: none;">Sub Total :</th>
							<td style="border: none;float: right;">
								<input type="text" id="subTotal" readonly="readonly" style="width: 130px; text-align: right;" class="nobrdr boldfnt">
							</td>
							<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
								<td></td>
							</c:if>
						</tr>
						<tr class="skip">
							<th colspan="8" style="text-align: right; padding-right: 12px; padding: 5px; border: none;">Total Discount :</th>
							<td style="border: none;float: right;">
								<input type="text" id="totalDiscount" readonly="readonly" style="width: 130px; text-align: right; " class="nobrdr boldfnt">
							</td>
							<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
								<td></td>
							</c:if>
						</tr>
						<tr class="skip">
							<th colspan="8" style="text-align: right; padding-right: 12px; padding: 5px; border: none;">Total Tax :</th>
							<td style="border: none;float: right;">
								<input type="text" id="totalTax" readonly="readonly" style="width: 130px; text-align: right;" class="nobrdr boldfnt">
							</td>
							<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
								<td></td>
							</c:if>
						</tr>
						<c:if test="${not empty rfq.lstAddCost}">
							<c:forEach items="${rfq.lstAddCost}" var="addCst" varStatus="count">
								<tr id="chargeRow${count.index}" class="skip" >
									<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
										<th colspan="5" style="text-align: right" >Enter Additional Cost :
											<input type="hidden" name="lstAddCost[${count.index}].addCostId" value="${addCst.addCostId}">
										</th>
										<td colspan="3" style="text-align: right; padding-right: 12px; padding: 5px;">
											<input type="text" class="requiredField" id="chargeName${count.index}" name="lstAddCost[${count.index}].addCostName" value="${addCst.addCostName}" style="text-align: right;" maxlength="50">
										</td>
									</c:if>
									<c:if test="${not empty rfq && rfq.rfqReceived eq true}">
										<td colspan="8" style="text-align: right; padding-right: 12px; padding: 5px; border: none;"><strong>${addCst.addCostName}</strong></td>
									</c:if>
<!-- 									style="position: relative;" -->
									<td >
										<input type="number" class="addCost nobrdr boldfnt numberWithTwoDesimal onClickInput"  value="${addCst.addCost}" style="width: 100%; text-align: right;" name="lstAddCost[${count.index}].addCost" id="charge${count.index}">
									</td>
									<td>
										<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
<!-- 											position: absolute; right: -26px; top: 8px; -->
											<i class="fa-solid fa-minus btn-cross no-print" style="font-size:15px; position: relative;top: -2px;line-height: 24px;" id="rmvBtn${count.index}" onclick="removeDiv(${count.index})"></i>
										</c:if>
									</td>
								</tr>
								<c:set var="chargeRow" value="${count.count}" />
							</c:forEach>
							<tr id="totalAddCostRow" class="skip">
								<th colspan="8" style="text-align: right; padding-right: 12px; padding: 5px; border: none;">Total Additional Cost :</th>
								<td style="float: right;">
									<input type="text" id="totalAddCost" value="0.00" readonly="readonly" style="width: 130px; text-align: right;" class="nobrdr boldfnt">
								</td>
								<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
									<td></td>
								</c:if>
							</tr>
						</c:if>
						<tr class="skip">
						    <td colspan="7" style="font-weight:600; font-size:16px;     padding: 5px 15px; text-align:left"><strong>In words :</strong> <span style=" font-style:italic;" id="totalInWords"></span></td>
							<th style="text-align: right; padding-right: 12px; padding: 5px; border: none;">Total :</th>
							<td style="border: none;float: right;">
								<input type="text" id="grandTotal" readonly="readonly" style="width: 130px; text-align: right;" class="nobrdr boldfnt">
							</td>
							<c:if test="${not empty rfq && rfq.rfqReceived eq false}">
								<td></td>
							</c:if>
						</tr>
<!-- 				</tfoot> -->
					</tbody>
				</table>
</div>
				<table style="font-size: 12px; width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 0px;">
					<thead style=" font-family: sans-serif; font-size: 12px; height: 30px">
						<tr style="background: #00ffff !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;">
							<th style="padding: 4px 5px;">Remarks</th>
							<th style="width: 200px;">Delivery Date</th>
						</tr>
					</thead>
					<tbody>
						<tr style="vertical-align: baseline;">
							<td>
								<textarea class="unfreezeField requiredFieldTxtArea form-control" style="outline: none;height: 50px;"
									placeholder="Remark" id="vendorRemarks" name="vendorRemarks" maxlength="100" ${canTakeAction eq false ? 'readonly' : ''}>${rfq.vendorRemarks}</textarea>
							</td>
							<td class="">
								<ul style="display: flex; list-style: none;padding-left: 0;">
									<li class="datepicker-box" style="position: relative;">
										<input type="text" style="width: 150px; margin-right: 5px;" class="form-control form-control-sm deliveryDate" id="deliveryDate" name="deliveryDate" value="<fmt:formatDate value='${rfq.deliveryyDate}' pattern='dd/MM/yyyy'/>" readonly />
										<i style="position: absolute; top: 7px; right: 1px;font-size: 16px;" class='fa-solid fa-calendar-week'></i>
									</li>
									<li>
										<input style="width: 50px;" type="text" class="form-control" placeholder="No. of Days" id="noDays" readonly="readonly">
									</li>
								</ul>
							</td>
						</tr>
					</tbody>
				</table>

				
				<table class="footer-fix-table" style="width: 100%;">

                    <c:if test="${revised}">
                         <tbody>
                            <tr>
                                <h5 class="mt-3 text-center blinking-text">Quatation has been revised</h5>
                                <b>Remarks for revised -:</b>
                                ${rejectReason}
                            </tr>
                         </tbody>
                    </c:if>

					<tfoot>
						<tr>
							<th colspan="2">
								<ul style="color: #000;list-style: none; padding: 0; display: flex;     padding: 15px;  justify-content: space-between; align-items: flex-end; font-size: 12px;">
									<li style="margin-top: 45px;"> <small style="display: block;">&nbsp; </small>  Prepared By </li>
									<li style="margin-top: 45px;">Approved By</li>
									<li style="margin-top: 45px;">Authorized By</li>
								</ul>
							</th>
						</tr>
						<tr style="background: linear-gradient(21deg, #1e5eb5 7.42%, #2275e9 91.76%); font-size: 12px;">
							${not empty footer ? footer : ''}
						</tr>
					</tfoot>
				</table>
				<div style="clear: both; margin-bottom: 40px;"></div>
				<c:if test="${not empty isButton && isButton}">
					<c:set var="dynamicFromId" value="form" scope="request" />
					<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
				</c:if>
			</div>
		</form>
	</div>
</section>

<script type="text/javascript"> 
    window.history.forward(); 
    function noBack() { 
        window.history.forward(); 
    } 
</script> 

<script>
tableIds=['itemBody','chargeBody'];
jsonKeys=['rfqQuoteLines','lstAddCost'];
	$(function() {
		$('.deliveryDate').datepick({
			dateFormat: 'dd/mm/yyyy',minDate:0, showOnFocus: true,
			 onSelect: function(selected) {
				 var modAllotDate=new Date(selected);
				 getDayCount(new Date(),modAllotDate);
			 }
		});
	});
	$(document).ready(function(){
		var deliveryDate=$("#deliveryDate").val().split("/");
		
		getDayCount(new Date(),new Date(deliveryDate[1]+"/"+deliveryDate[0]+"/"+deliveryDate[2]));
		totalCalculation();
		calculateTotalAddCost();
	});

	function getDayCount(startDate, endDate) {
	    // Convert the dates to milliseconds
	    const startMillis = startDate.getTime();
	    const endMillis = endDate.getTime();
	    // Calculate the difference in milliseconds
	    const differenceMillis = endMillis - startMillis;
	    // Convert the difference to days
	    const dayCount = differenceMillis / (1000 * 60 * 60 * 24);

	    var day= Math.floor(dayCount); // Return the floor value to get an integer day count
	    if(day<0){
	    	day=0;
	    }else{
	    	day+=1;
	    }
	    $("#noDays").val(day);
	}
	var chargeCount=0+${chargeRow};
	function addAdditionalCost() {
		var html='<tr id="chargeRow'+chargeCount+'" style="vertical-align: baseline;"><th colspan="5" style="text-align:right">Enter Additional Cost :</th><td colspan="3" style="text-align: right; padding-right: 12px; padding:5px;position: relative;padding-bottom: 20px;"><input type="text" class="requiredField" id="chargeName'+chargeCount+'" name="lstAddCost['+chargeCount+'].addCostName" maxlength="50"> </td><td style="position: relative;"><input type="number" class="addCost numberWithTwoDesimal onClickInput" id="charge'+chargeCount+'" value="0.00" name="lstAddCost['+chargeCount+'].addCost" style="width: 100%; text-align: right;"></td><td><c:if test="${not empty rfq && rfq.rfqReceived eq false}"><i class="fa-solid fa-minus btn-cross no-print" style="font-size:15px; position: relative;top: 0px;line-height: 24px;" id="rmvBtn'+chargeCount+'" onclick="removeDiv('+chargeCount+')" ></i></td></c:if></tr>';
		var tbody = document.getElementById('chargeBody');
		
		var targetIndex =0;
		if(chargeCount==0){
			targetIndex = tbody.rows.length - 1;
			var tothtml='<tr id="totalAddCostRow"><th colspan="8" style="text-align: right; padding-right: 12px; padding:5px; border: none;">Total Additional Cost :</th><td><input type="text" id="totalAddCost" value="0.00" readonly="readonly" style="width: 100%; text-align: right;"> </td><td></td></tr>';
			var tottempDiv = document.createElement('tbody');
			tottempDiv.innerHTML = tothtml;
			var newtotRow = tottempDiv.firstElementChild;
			tbody.insertBefore(newtotRow, tbody.rows[targetIndex]);
		}
		targetIndex = tbody.rows.length - 2;
		var tempDiv = document.createElement('tbody');
		tempDiv.innerHTML = html;
		var newRow = tempDiv.firstElementChild;
		tbody.insertBefore(newRow, tbody.rows[targetIndex]);
		
		chargeCount++;
	}
	function removeDiv(id) {
		var index=chargeCount-1;
		if(index==id){
			$("#chargeRow"+id).remove();
			chargeCount--;
			if(chargeCount==0){
				$("#totalAddCostRow").remove();
			}
			calculateTotalAddCost();
		}
	}
	function convertToFloat(value){
		if(value === "" || value === undefined){
			value = 0;
		}
		return parseFloat(value);
	}
	$(document).on('keyup', '.supplierQuantity', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('supplierQuantity')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.unitPrice', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('unitPrice')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.discount', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('discountRate')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.tax', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('taxRate')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.addCost', function(){
		calculateTotalAddCost();
	});
	function calculateTotalAddCost() {
		var addCost=0;
		$('.addCost').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			addCost += parseFloat(val);
		});
		addCost=addCost.toFixed(2);
		$("#totalAddCost").val(addCost);
		totalCalculation();
	}
	function eachRowCalculation(rowNo) {
		var qty = $('#supplierQuantity'+rowNo).val() == '' || $('#supplierQuantity'+rowNo).val() == undefined ? 0 : $('#supplierQuantity'+rowNo).val();
		var price = $('#unitPrice'+rowNo).val() == '' || $('#unitPrice'+rowNo).val() == undefined ? 0 : $('#unitPrice'+rowNo).val();
		var discount = $('#discountRate'+rowNo).val() == '' || $('#discountRate'+rowNo).val() == undefined ? 0 : $('#discountRate'+rowNo).val();
		var tax = $('#taxRate'+rowNo).val() == '' || $('#taxRate'+rowNo).val() == undefined ? 0 : $('#taxRate'+rowNo).val();
		
		qty = convertToFloat(qty);
		price = convertToFloat(price);
		discount = convertToFloat(discount);
		tax = convertToFloat(tax);

		if(discount>100){
			discount=100;
		}
		if(tax>100){
			tax=100;
		}
		
		var subTotal=qty * price;
		var discountAmount = subTotal * (discount / 100);
		var taxAmount = (subTotal - discountAmount) * (tax / 100);
		var totalAmount=subTotal-discountAmount+taxAmount;
		totalAmount=totalAmount.toFixed(2);
		
		$("#subtotal"+rowNo).val(subTotal);
		$("#discAmt"+rowNo).val(discountAmount);
		$("#taxAmt"+rowNo).val(taxAmount);
		$("#totalAmount"+rowNo).val(totalAmount);
		$("#totalAmountP"+rowNo).val(totalAmount);
		totalCalculation();
	}
	function totalCalculation() {
		
		var subTotal = 0;
		var totalDiscount = 0;
		var totalTax = 0;
		var totalAddCost=$("#totalAddCost").val() == '' || $("#totalAddCost").val() == undefined ? 0 : $("#totalAddCost").val();
		var grandTotal = 0+parseFloat(totalAddCost);
		$('.subtotal').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			subTotal += parseFloat(val);
		});

		$('.discAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalDiscount += parseFloat(val);
		});

		$('.taxAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalTax += parseFloat(val);
		});

		$('.total').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			grandTotal += parseFloat(val);
		});
		subTotal =subTotal.toFixed(2);
		totalDiscount = totalDiscount.toFixed(2);
		totalTax = totalTax.toFixed(2);
		grandTotal = grandTotal.toFixed(2);
		
		$("#subTotal").val(subTotal);
		$("#totalDiscount").val(totalDiscount);
		$("#totalTax").val(totalTax);
		$("#grandTotal").val(grandTotal);
		$("#totalInWords").text(setAmountInWords(grandTotal));
	}

	// alson in page load
	$(document).ready(function(){
		var grandTotal = $("#grandTotal").val();
		$("#totalInWords").text(setAmountInWords(grandTotal));
	});
	
	function setAmountInWords(grandTotal){
		
		let fstVal = grandTotal.split(".")[0];
		let secVal = grandTotal.split(".")[1];
		let finalWord = '';
			if(secVal == undefined || secVal == '' || secVal == '00' || secVal == '0'){
				if(fstVal != '0'){
					finalWord = NumInWords(fstVal) + " only";
				}
			}else{
				finalWord = NumInWords(fstVal) + " and " + NumInWords(secVal) + "cents only";
			}
			$("#totalInWords").text(finalWord);
		
	}
	function removeItem(that,rowNo) {
		if(!$(this).hasClass('frezz')){
			var res=0;
			$("#itemBody tr").each(function() {
				if(!$(this).hasClass('skip')){
					if(!$(this).hasClass('disable-row')){
						res++;
					}
				}
			});
			if(res<=1 && !$(that).closest('tr').hasClass('disable-row')){
				alert("Atleast one item is mandatory");
				return false;
			}
			$(that).closest('tr').toggleClass('disable-row');	
			$("#unitPrice"+rowNo).toggleClass('greaterThanZero');
			$("#supplierQuantity"+rowNo).toggleClass('greaterThanZero');
			$("#plus"+rowNo).toggleClass('frezz');
			if($(that).closest('tr').hasClass('disable-row')){
				$("#subtotal"+rowNo).val(0);
				$("#discAmt"+rowNo).val(0);
				$("#taxAmt"+rowNo).val(0);
				$("#totalAmount"+rowNo).val(0);
				$("#totalAmountP"+rowNo).val(0);
				$('#unitPrice'+rowNo).val(0);
				$('#taxRate'+rowNo).val(0);
				$('#discountRate'+rowNo).val(0);
				totalCalculation();
			}
		}
	}
	var currentRowCount="${rfq.rfqQuoteLines.size()}";
	function addAnotherItemmm(that,rowNo,subCatName,qty,quoteLineId,condClass) {
		if(!$(this).hasClass('frezz')){
			$(that).closest('tr').toggleClass('disable-row');	
			$("#unitPrice"+rowNo).toggleClass('greaterThanZero');
			$("#supplierQuantity"+rowNo).toggleClass('greaterThanZero');
			
			$("#plus"+rowNo).toggleClass('frezz');
			$("#minus"+rowNo).toggleClass('frezz');
			
			$("#isaltered"+rowNo).val('true');
			
			$("#subtotal"+rowNo).val(0);
			$("#discAmt"+rowNo).val(0);
			$("#taxAmt"+rowNo).val(0);
			$("#totalAmount"+rowNo).val(0);
			$("#totalAmountP"+rowNo).val(0);
			$('#unitPrice'+rowNo).val(0);
			$('#taxRate'+rowNo).val(0);
			$('#discountRate'+rowNo).val(0);
			totalCalculation();
			
			currentRowCount=parseInt(currentRowCount);
			
			var html='<tr id="row'+currentRowCount+'" class="quoteAtleastOneRowMandatory">'+
							'<td>#'+
								'<input type="hidden" class="NumbersOnlyWithoutDot" id="parentLineId'+currentRowCount+'" name="rfqQuoteLines['+currentRowCount+'].parentLinesId" value="'+quoteLineId+'">'+
							'</td>'+
							'<td>'+subCatName+'</td>'+
							'<td><input type="text" class="requiredField" name="rfqQuoteLines['+currentRowCount+'].itemName" maxlength="50" style="width:100%;" /></td>'+
							'<td><input type="text" style="width:100%;"  readonly/></td>'+
							'<td>'+
								'<input type="text" class="supplierQuantity '+condClass+' onClickInput maximunLengthIs10WithDot greaterThanZero" id="supplierQuantity'+currentRowCount+'" name="rfqQuoteLines['+currentRowCount+'].supplierQuantity" value="'+qty+'" style="width: 85px; text-align: right;">'+
							'</td>'+
							'<td>'+
								'<input type="number" class="unitPrice  maximunLengthIs10WithDot numberWithTwoDesimal onClickInput greaterThanZero" id="unitPrice'+currentRowCount+'" name="rfqQuoteLines['+currentRowCount+'].unitPrice" value="0.00" style="width: 70px; text-align: right;">'+
							'</td>'+
							'<td>'+
								'<input type="number" class="discount numberWithTwoDesimal  onClickInput percentageOnly" id="discountRate'+currentRowCount+'" name="rfqQuoteLines['+currentRowCount+'].discountRate" value="0" style="width: 45px; text-align: right;">'+
								'<input type="hidden" class="discAmt" name="rfqQuoteLines['+currentRowCount+'].discountAmount" id="discAmt'+currentRowCount+'" value="">'+
								'<input type="hidden" class="subtotal" name="rfqQuoteLines['+currentRowCount+'].subTotal" id="subtotal'+currentRowCount+'" value="">'+
							'</td>'+
							'<td>'+
								'<input type="number" class="tax numberWithTwoDesimal onClickInput percentageOnly" id="taxRate'+currentRowCount+'" name="rfqQuoteLines['+currentRowCount+'].taxRate" value="0" style="width: 45px; text-align: right;">'+
								'<input type="hidden" class="taxAmt" name="rfqQuoteLines['+currentRowCount+'].taxAmount" id="taxAmt'+currentRowCount+'" value="">'+
							'</td>'+
							'<td>'+
								'<input type="text" class="total" id="totalAmount'+currentRowCount+'" name="rfqQuoteLines['+currentRowCount+'].totalAmount" value="0" readonly="readonly" style="width: 100%; text-align: right;border:none" >'+
							'</td>'+
							'<td><i class="fa-solid fa-minus btn-cross no-print" style="font-size:15px; position: relative;top: -2px;line-height: 24px; "  onclick="removeAlterItem('+rowNo+','+currentRowCount+')"></i></td>'+
						'</tr>';
			
			$("#row"+rowNo).after(html);
			currentRowCount++;
		}
	}
	function removeAlterItem(rowNo,currentRowCount) {
		$("#row"+currentRowCount).remove();
		$("#unitPrice"+rowNo).closest('tr').toggleClass('disable-row');	
		$("#unitPrice"+rowNo).toggleClass('greaterThanZero');
		$("#supplierQuantity"+rowNo).toggleClass('greaterThanZero');
		
		$("#plus"+rowNo).toggleClass('frezz');
		$("#minus"+rowNo).toggleClass('frezz');
		$("#isaltered"+rowNo).val('false');
		
	}
	
	function removeAlterLineItem(id,quoteLineId){
		var rowNo=parseInt(id)-1;
		$.ajax({
			url : window.ctxPath + '/ajax/deleteQuoteLineId?quoteLineId='+quoteLineId,
			success : function(response) {
				if(response){
					$("#unitPrice"+rowNo).closest('tr').toggleClass('disable-row');	
					$("#unitPrice"+rowNo).toggleClass('greaterThanZero');
					$("#supplierQuantity"+rowNo).toggleClass('greaterThanZero');
					
					$("#plus"+rowNo).toggleClass('frezz');
					$("#minus"+rowNo).toggleClass('frezz');
					$("#isaltered"+rowNo).val('false');
					
					$("#row"+id).remove();
				}
			}
		});	
	}
</script>