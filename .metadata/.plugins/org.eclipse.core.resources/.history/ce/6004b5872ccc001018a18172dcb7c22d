<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<style>
	.grid {
            width: 100%;
			position: relative;
            padding: 1px;
            border: 1px solid #ccc;
            background: #ccc;
            float: left;
            img {
                max-width: 100%;
                border: 1px solid #333;
            }
        }
        table td {
            font-size: 14px;
            font-weight: 400;
            color: #0d0c3f;
        }
</style>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />


<div class="breadcrumb_conatiner">
    <div class="col-md-6">
      <h4 class="change-color">Requisition</h4>
    </div>
	<div class="col-md-6">
	  <nav aria-label="breadcrumb">
	    <ol class="breadcrumb">
		      <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
		      <li class="breadcrumb-item">
		        	<a href="#">Procurement</a>
		      </li>
		      <li class="breadcrumb-item active" aria-current="page">Requisition</li>
		    </ol>
	  </nav>
	</div>
 </div>
            
            
            <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Requisition</h5>
                    </div>
                    <div class="card-body">
        	<form action="${contextPath}/procurement/requisition/save" method="post" id="form" modelAttribute="requisition">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <input type="hidden" name="requisitionId" value="${req.requisitionId}" />
            <input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />

          
				<div class="row">
					<div class="col-md-12">
					
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.FINYEAR" />  </label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${financialYearList.size() > 1}">
												<select class="form-control requiredField" id="finYear" name="finYear">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${financialYearList}" var="financialYear">
														<option value="${financialYear.finyearId}" ${(not empty req && req.finYear.finyearId eq financialYear.finyearId) ? 'selected' : ''}>${financialYear.finYear}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="finYear" value="${financialYearList[0].finyearId}" />
												<input type="text" class="form-control" value="${financialYearList[0].finYear}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.REQNO" />  </label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="requisitionNo" value="${not empty reqNo ? reqNo :req.requisitionNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.TYPE" />  </label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${requisitionTypeList.size() > 1}">
												<select class="form-control requiredField" id="requisitionType" name="requisitionType">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${requisitionTypeList}" var="reqType">
														<option value="${reqType.requisitionTypeId}" ${(not empty req && req.requisitionType.requisitionTypeId eq reqType.requisitionTypeId) ? 'selected' : ''}>${reqType.requisitionTypeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="requisitionType" value="${requisitionTypeList[0].requisitionTypeId}" />
												<input type="text" class="form-control" value="${requisitionTypeList[0].requisitionTypeName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.FOR" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${stockTypeList.size() > 1}">
												<select class="form-control requiredField ${not empty req && req.requisitionId ne '' ? 'frezz' : ''}" id="stockTypeId" name="stockType" onchange="emptyTable()">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${stockTypeList}" var="stockType">
														<option value="${stockType.stockTypeId}" ${(not empty req && req.stockType.stockTypeId eq stockType.stockTypeId) ? 'selected' : ''}>${stockType.stockTypeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden"  name="stockType" value="${stockTypeList[0].stockTypeId}" />
												<input type="text" class="form-control" value="${stockTypeList[0].stockTypeName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text">Store</label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${lstStore.size() > 1}">
												<select class="form-control requiredField ${not empty req && req.requisitionId ne '' ? 'frezz' : ''}" id="storeId" name="store" onchange="emptyTable()" >
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${lstStore}" var="store">
														<option value="${store.storeId}" ${(not empty req && req.store.storeId eq store.storeId) ? 'selected' : ''}>${store.storeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" id="storeId" name="store" value="${lstStore[0].storeId}" />
												<input type="text" class="form-control" value="${lstStore[0].storeName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.PRIORITY" />  </label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${priorityList.size() > 1}">
												<select class="form-control requiredField" id="priority" name="priorityLevel">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${priorityList}" var="priority">
														<option value="${priority.priorityLevelId}" ${(not empty req && req.priorityLevel.priorityLevelId eq priority.priorityLevelId) ? 'selected' : ''}>${priority.priorityLevelName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="priorityLevel" value="${priorityList[0].priorityLevelId}" />
												<input type="text" class="form-control" value="${priorityList[0].priorityLevelName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12" for="text"> Cost Center</label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${costCenterList.size() > 1}">
												<select class="form-control" name="costCenter" id="costCenterId">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${costCenterList}" var="costCenter">
														<option value="${costCenter.costCenterId}" ${req.costCenter.costCenterId eq costCenter.costCenterId ? 'selected' : ''}>${costCenter.costCenterName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="costCenter" value="${costCenterList[0].costCenterId}" />
												<input type="text" class="form-control" value="${costCenterList[0].costCenterName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.BUDGET.GENERAL.PURPOSE" />  </label>
									<div class="col-md-12">
										<textarea class="form-control AlphaNumericForText textArea unfreezeField requiredField" id="purpose" name="purpose" maxlength="200" placeholder="Please give description on general purpose of requisition" ${(not empty req && canTakeAction eq false) ? 'readonly' : ''}>${req.purpose}</textarea>
									</div>
								</div>
							</div>
							<div class="col-md-12 text-end btnholder">
								<div class="form-group">
									<button type="button" class="btn btn-submit" style="width: auto;" onclick="getItemsPaggination()">
									<i class="fa fa-plus"></i> Add Item</button>
								</div>
							</div>	
							<div class="col-md-12 ">
								<table class="table table-striped table-bordered mt-2 tableValidation">
									<thead class="">
										<tr style="">
											<th style="width: 70px;">Sl No.</th>
											<th style="width: 400px;">Item Name</th>
											<th style="width: 110px;">Req Qty</th>
											<th style="width: 70px;">UOM</th>
											<th style="width: 150px;">Avl Qty</th>
											<th style="width: 70px;">LP Cost</th>
											<c:if test="${canTakeAction}">
											<th style="width: 70px;">Action</th>
											</c:if>
										</tr>
									</thead>
									<tbody id="itemBody">
										<c:forEach items="${req.requisitionLines}" var="line" varStatus="count">
											<tr id="itemRow${count.index}">
												<td style="">${count.index + 1}</td>
												<td style="">${line.itemDto.itemName}</td>
												<td><input type="text" style="text-align:right" class="form-control onClickInput ${line.itemDto.isFractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'}  greaterThanZero maximunLengthIs10WithDot" id="reqQty${count.index}" name="requisitionLines[${count.index}].requestQuantity" value="${line.requestQuantity}" ${(not empty req && canTakeAction eq false) ? 'readonly' : ''}></td>
												<td style="">${line.itemDto.uom}</td>
												<td style="text-align:right">${line.itemDto.avlQty}</td>
												<td style="text-align:right"><fmt:formatNumber value="${line.itemDto.purchasePrice}" minFractionDigits="2" maxFractionDigits="2" /></td>
												<c:if test="${canTakeAction}">
													<td style="">
														<button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${count.index})"><i class="fa fa-trash"></i></button>
													</td>
												</c:if>
												<input type="hidden" id="objId${count.index}" name="requisitionLines[${count.index}].requisitionLineId" value="${line.requisitionLineId}">
												<input type="hidden" id="itemId${count.index}" name="requisitionLines[${count.index}].entityId" value="${line.itemDto.itemId}">
												<input type="hidden" id="itemName${count.index}"  value="${line.itemDto.itemName}">
												<input type="hidden" id="itemCode${count.index}"  value="${line.itemDto.itemCode}">
												<input type="hidden" id="description${count.index}"  value="${line.itemDto.itemDescription}">
												<input type="hidden" id="uom${count.index}" value="${line.itemDto.uom}">
												<input type="hidden" id="avlQty${count.index}"  value="${line.itemDto.avlQty}">
												<input type="hidden" id="purchasePrice${count.index}"  value="${line.itemDto.purchasePrice}">
											</tr>
										</c:forEach>
									</tbody>
								</table>
							</div>
						</div>
					</div>
			
			</div>
			<c:set var="dynamicFromId" value="form" scope="request" />
          	<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
        </form>
        </div>
        </div>
        </div>
	</div>

<%@ include file="/WEB-INF/views/assetInvProc/itemModal/itemPopUpModal.jsp"%>

<script>
tableIds=['itemBody'];
jsonKeys=['requisitionLines'];
var itemAssetList = [];
var currentRowCount = "${not empty req ? req.requisitionLines.size() : 0}";
currentRowCount = currentRowCount == "" ? 0 : currentRowCount;
currentRowCount = parseInt(currentRowCount);

// on ready function update itemAssetList
$(document).ready(function(){
	itemAssetList = getItemAssetFromTable();
});

function getItemAssetFromTable(){
	var itemAssetListFromTable = [];
	$('#itemBody tr').each(function(){
		var objId = $(this).find('input[id^="objId"]').val() || '';
		var itemId = $(this).find('input[id^="itemId"]').val();
		var itemName = $(this).find('input[id^="itemName"]').val();
		var itemCode=$(this).find('input[id^="itemCode"]').val();
		var description=$(this).find('input[id^="description"]').val();
		var uom=$(this).find('input[id^="uom"]').val();
		var isFractional=$(this).find('input[id^="isFractional"]').val();
		var avlQty = $(this).find('input[id^="avlQty"]').val();
		var lastPprice = $(this).find('input[id^="purchasePrice"]').val();
		var reqQty = $(this).find('input[id^="reqQty"]').val() || 0;
		let selectItem = {
				objId,
				itemId,
				itemName,
				itemCode,
				description,
				avlQty,
				lastPprice,
				uom,
				isFractional,
				reqQty
		};
		itemAssetListFromTable.push(selectItem);
	});
	return itemAssetListFromTable;
}

function emptyTable(){
	$('#itemBody').empty();
	itemAssetList = [];
}

function removeItem(rowId){
	$('#itemRow'+rowId).remove();
	itemAssetList.splice(rowId, 1);
	currentRowCount--;
}

function calculateTotal(rowId){
	var reqQty = $('#reqQty'+rowId).val();
	var avlQty = $('#itemRow'+rowId).find('#avlQty').val();
	if(reqQty > avlQty){
		$('#reqQty'+rowId).val(avlQty);
	}
}

function getItemsPaggination() {
	let stockType = $('#stockTypeId').val();
	let storeId = $('#storeId').val();
	if (storeId == 0 || storeId == '') {
		displayErrorMsg("storeId", "Please select store");
		return false;
	} else {
		clearError("storeId")
	}

	if (stockType == 0 || stockType == '') {
		displayErrorMsg("stockTypeId", "Please select requisition type");
		return false;
	} else {
		clearError("stockTypeId")
	}

	// those item which are already added in table should be background color #afbff7
	makeItemDivSelected();

	var url = "${contextPath}/ajax/inventory/items";
	var data = {
		page: $('#pageNo').val() == '' ? 0 : $('#pageNo').val(),
		size: 8,
		search: $('#searchKey').val() == '' ? '' : $('#searchKey').val(),
		category: $('#category').val() == 0 ? '' : $('#category').val(),
		subCategory: $('#subCateIds0').val() == 0 ? '' : $('#subCateIds0').val(),
		stockType: stockType,
		storeId: storeId
	};
	$.ajax({
		url: url,
		type: "GET",
		data: data,
		success: function (response) {
			createItemSearchDiv(response);
		},
		error: function (xhr, status, error) {
			console.log(xhr.responseText);
		}
	});
}

function makeItemDivSelected(){
	getItemAssetFromTable().map((item, index) => {
		$('#itemDiv'+item.itemId).css('background-color', '#afbff7');
	});
}

function createItemSearchDiv(data){
    var html = '';

    data.map((item, index) => {
        html += '<div class="col-lg-3 col-xs-12 mb-2">';
        html += '<div class="m-img-box" id="itemDiv'+item.itemId+'" style="'+(checkItemIsSelected(item.itemId) ? 'background-color: #afbff7;' : '')+'">';
        
			html += '<section>';
            if (item.itemImgs && item.itemImgs.length > 0) {
                html += '<div class="banner_sec_sldrs owl-carousel">';
                item.itemImgs.map((img, index) => {
                    html += '<div class="item">';
                        html += '<img class="inputMedia" alt="doc" src="data:image/png;base64 ,'+img.attachmentPath+'">';
                    html += '</div>';
                });
                html += '</div>';
            } else {
                html += '<img class="img-responsive itemImg" src="${contextPath}/assets/images/noImage.png" alt="No Image Found">';
            }
            html += '</section>';
		// 	if(item.stockType == 'ITEM'){
        //     html += '<section>';
        //     if (item.itemImgs && item.itemImgs.length > 0) {
        //         html += '<div class="banner_sec_sldrs owl-carousel">';
        //         item.itemImgs.map((img, index) => {
        //             html += '<div class="item">';
        //                 html += '<img class="inputMedia" alt="doc" src="data:image/png;base64 ,'+img.attachmentPath+'">';
        //             html += '</div>';
        //         });
        //         html += '</div>';
        //     } else {
        //         html += '<img class="img-responsive itemImg" src="${contextPath}/assets/images/noImage.png" alt="No Image Found">';
        //     }
        //     html += '</section>';
        // } else {
        //     html += '<img src="${contextPath}/assets/images/img-default.png" alt="image" class="img-responsive itemImg">';
        // }
        html += '<h4>'+item.itemName+'</h4>';
        html += '<input type="hidden" id="itemId" value="'+item.itemId+'">';
        html += '<input type="hidden" id="itemName" value="'+item.itemName+'">';
        html += '<input type="hidden" id="itemCode" value="'+item.itemCode+'">';
        html += '<input type="hidden" id="description" value="'+item.description+'">';
        html += '<input type="hidden" id="uom" value="'+item.uom+'">';
        html += '<input type="hidden" id="isFractional" value="'+item.isFractional+'">';
        html += '<input type="hidden" id="avlQty" value="'+item.avlQty+'">';
        html += '<input type="hidden" id="purchasePrice" value="'+item.purchasePrice+'">';
        html += '</div>';
        html += '</div>';
    });
    $('#itemSearchDivId').html(html);
    $('#addOtherItemModal').modal('show');
}


function checkItemIsSelected(itemId){
	var isAdded = false;
	// check item is already added or not in itemAssetList
	itemAssetList.map((item, index) => {
		if(item.itemId == itemId){
			$('#itemDiv'+itemId).css('background-color', '#afbff7');
			isAdded = true;
		}
	});
	return isAdded;
}


// on click of item div
$(document).on('click', '.m-img-box', function() {
	var objId = $(this).find('#objId').val() || '';
	var itemId = $(this).find('#itemId').val();
	var itemName = $(this).find('#itemName').val();
	var itemCode=$(this).find('#itemCode').val();
	var description=$(this).find('#description').val() || '';
	var uom=$(this).find('#uom').val();
	var isFractional=$(this).find('#isFractional').val();
	var avlQty = $(this).find('#avlQty').val();
	var lastPprice = $(this).find('#purchasePrice').val();
	var reqQty = $(this).find('#reqQty').val() || 0;
	let selectItem = {
			objId,
			itemId,
			itemName,
			itemCode,
			description,
			avlQty,
			lastPprice,
			uom,
			isFractional,
			reqQty
	};
	// check item is already added or not in itemAssetList
	var isAllredyInList = false;
	itemAssetList.map((item, index) => {
		if(item.itemId == itemId){
			itemAssetList.splice(index, 1);
			isAllredyInList = true;
		}
	});
	if(!isAllredyInList){
		itemAssetList.push(selectItem);
	}
	
	if(isAllredyInList){
		$('#itemDiv'+itemId).css('background-color', '#FFFFFF');
	}else{
		$('#itemDiv'+itemId).css('background-color', '#afbff7');
	}

});

function addItemsToRow(){
	let existingTableData = getItemAssetFromTable();
	$('#itemBody').empty();
	currentRowCount = 0;
	// loop through itemAssetList
	itemAssetList.map((item, index) => {
		// check item is in existingTableData if present then make item = existingTableData[index] else item = item
		existingTableData.map((existingItem, index) => {
			if(item.itemId == existingItem.itemId){
				item = existingItem;
			}
		});
		createItemRow(item);
	});


	$('#addOtherItemModal').modal('hide');
}

function createItemRow(item){
    var lpCost=parseFloat(item.lastPprice).toFixed(2);
	var html = '';
	html += '<tr id="itemRow'+currentRowCount+'">';	
	html += '<td style="">'+(currentRowCount+1)+'</td>';
	html += '<td style="">'+item.itemName+'</td>';
	html += '<td><input type="text" class="form-control onClickInput ';
	if(item.isFractional == 'true'){
		html +='numberWithTwoDesimal ';
	}else{
		html +='numberWithTwoDesimalButOnlyAllowZero ';
	}
		 
	html += 'greaterThanZero maximunLengthIs10WithDot" id="reqQty'+currentRowCount+'" name="requisitionLines['+currentRowCount+'].requestQuantity" value="'+item.reqQty+'"></td>';
	html += '<td style="">'+item.uom+'</td>';
	html += '<td style="text-align:right">'+item.avlQty+'</td>';
	html += '<td style="text-align:right">'+lpCost+'</td>';
	html += '<td style="">';
	html += '<button type="button" class="btn btn-danger btn-sm" onclick="removeItem('+currentRowCount+')"><i class="fa fa-trash"></i></button>';
	html += '</td>';
	html += '<input type="hidden" id="objId'+currentRowCount+'" name="requisitionLines['+currentRowCount+'].requisitionLineId" value="'+item.objId+'">';
	html += '<input type="hidden" id="itemId'+currentRowCount+'" name="requisitionLines['+currentRowCount+'].entityId" value="'+item.itemId+'">';
	html += '<input type="hidden" id="itemName'+currentRowCount+'"  value="'+item.itemName+'">';
	html += '<input type="hidden" id="itemCode'+currentRowCount+'"  value="'+item.itemCode+'">';
	html += '<input type="hidden" id="description'+currentRowCount+'"  value="'+item.description+'">';
	html += '<input type="hidden" id="uom'+currentRowCount+'"  value="'+item.uom+'">';
	html += '<input type="hidden" id="isFractional'+currentRowCount+'" value="'+item.isFractional+'">';
	html += '<input type="hidden" id="avlQty'+currentRowCount+'"  value="'+item.avlQty+'">';
	html += '<input type="hidden" id="purchasePrice'+currentRowCount+'"  value="'+item.lastPprice+'">';
	html += '</tr>';
	$('#itemBody').append(html);
	currentRowCount++;
}



</script>


