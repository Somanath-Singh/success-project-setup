<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/AadharVaidator.js"></script>
<%--<jsp:useBean id="strUtils" class="com.aashdit.demography.utils.ApplicationStringUtils"/> --%>
            	<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Manage Expenditure</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="#">Home</a></li>
				<li class="breadcrumb-item active" aria-current="page">Manage Expenditure</li>
			</ol>
		</nav>
	</div>
</div>
			
			
			
                <div class="page-inner mt--5 pb-0">
                    <div class="row mt--2">
                        <div class="col-md-12">
                            <div class="card full-height">
                                <div class="card-header">
                                    <div class="panel-actions">
                                        <a href="#" class="fa fa-caret-down"></a>
                                    </div>
                                    <h4 class="card-title">${not empty expenditure ? 'View Expenditure' : 'Create Expenditure' }</h4>
                                </div>
                                <div class="card-body">
                                
                                  <form class="form-horizontal" action="${contextPath}/fnd/expenditure/add" method="post" enctype="multipart/form-data" id="expenditureForm">
								    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
								    <input type="hidden" name="expenditureId" value="${expenditure.expenditureId}"/>
								    
                                    <div class="col-md-12">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="col-md-12 smallInput required" for="">Financial Year :</label>
                                                <div class="col-md-12">
                                                    <select class="form-control form-control-sm" id="finyearId" name="finyear.finyearId">
                                                        <option value="">--Select--</option>
                                                        <c:forEach items="${lstFinyear}" var="finyear">
															<option value="${finyear.finyearId}" ${finyear.finyearId eq expenditure.finyear.finyearId ?'selected':'' }>${finyear.finYear}</option>
														</c:forEach>
                                                        
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
										<div class="col-md-3">
											<div class="form-group">
												<label class="required">Expenditure Creation Date :</label>
												<div class="col-md-12 datepicker_con">
													<input type="text" class="form-control form-control-sm disbursDate" name="transDate" id="transDate" readonly="readonly" required="required"  value="<fmt:formatDate pattern="dd/MM/yyyy" value='${expenditure.transDate}' />" >
												</div>
											</div>
										</div>
							            <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="col-md-12 smallInput required" for="">Fund Type :</label>
                                                <div class="col-md-12">
                                                    <select class="form-control form-control-sm" id="fundTypeId" name="fundType.fundTypeId" id="fundTypeId">
                                                        <option value="">--Select--</option>
                                                        <c:forEach items="${lstFundType}" var="fundType">
															<option value="${fundType.fundTypeId}" ${fundType.fundTypeId eq expenditure.fundType.fundTypeId ?'selected':'' }>${fundType.fundTypeName}</option>
														</c:forEach>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="col-md-12 smallInput required" for="">Component Name :</label>
                                                <div class="col-md-12">
                                                    <select class="form-control form-control-sm" name="schemeId" id="schemeId" onchange="findEntityBeneficiaryMapListBySchemeIdAndBenfId()">
                                                       <option value="">--Select--</option>
                                                        <c:forEach items="${mstSchemeList}" var="mstScheme">
															<option value="${mstScheme.schemeId}" ${mstScheme.schemeId eq expenditure.entitySchemeMapping.scheme.schemeId ?'selected':'' }>${mstScheme.schemeName}</option>
														</c:forEach>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 ">
                                            <div class="form-group">
                                                <label class="col-md-12 smallInput required" for="">Entity Type  :</label>
                                                <div class="col-md-12">
                                                    <select class="form-control form-control-sm" id="entityTypeId" name="entityBeneficiaryMapping.entityBeneficiaryId" onchange="getEntityNameByEntityTypeOrDistrictId();">
                                                        <option value="">--Select--</option>
                                                         <c:forEach items="${lstEntitySchemeMapping}" var="entitySchemeMapping">
															<option value="${entitySchemeMapping.entitySchemeId}" ${entitySchemeMapping.entitySchemeId eq expenditure.entitySchemeMapping.entitySchemeId ?'selected':'' }>${entitySchemeMapping.cboType.valueEn}</option>
														</c:forEach> 
                                                    </select>
                                                </div>
                                            </div>
                                        </div>-->
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="col-md-12 smallInput required" for=""> Account Head :</label>
                                                <div class="col-md-12">
                                                    <select class="form-control form-control-sm" name="schemeId" id="headId" onchange="findSubHeadListByHeadId(this.value)">
                                                       <option value="">--Select--</option>
                                                        <c:forEach items="${lstMstHead}" var="mstHead">
															<option value="${mstHead.headId}" ${mstHead.headId eq expenditure.mstSubHead.head.headId ?'selected':'' }>${mstHead.headName}</option>
														</c:forEach>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="col-md-12 smallInput required" for=""> Account Sub Head :</label>
                                                <div class="col-md-12">
                                                    <select class="form-control form-control-sm" id="subHeadId" name="mstSubHead.subHeadId">
                                                        <option value="">--Select--</option>
                                                        <c:forEach items="${mstSubHeadList}" var="mstSubHead">
															<option value="${mstSubHead.subHeadId}" ${mstSubHead.subHeadId eq expenditure.mstSubHead.subHeadId ?'selected':'' }>${mstSubHead.subHeadName}</option>
														</c:forEach>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="required">Sanction No :</label>
                                                <div class="col-md-12">
												   <select class="form-control form-control-sm" id="sanctionNo" name="sanctionNo">
                                                        <option value="">--Select--</option>
                                                     <%--    <c:forEach items="${fundList}" var="fundList"> --%>
															<option value="${fundList1.sanctionNo}" selected>${expenditure.fund.sanctionNo}</option>
														<%-- </c:forEach> --%>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="required">Amount :</label>
                                                <div class="col-md-12">
                                                    	<input type="hidden" class="form-control form-control-sm x-turnover" id="turnover1" name="amount" value="${expenditure.amount}" maxlength="20">
												<input type="text" class="form-control form-control-sm x-turnover NumbersOnlyForAmount" id="turnover1Converted" value="${strUtils.convertAmountToINRFormat(expenditure.amount)}" maxlength="20" onchange="currencyConverter(this.value,'turnover1Converted')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mt-3 text-center">
                                        <%-- <button type="button" class="btn btn-sm btn-success" onclick="saveExpenditureForm();">${not empty expenditure ? 'Update' : 'Save'}</button> --%>
                                        <a href="${contextPath}/fnd/expenditure/list" class="btn btn-sm btn-danger">Back</a>
                                    </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
 <script>
 
 $(function() {
	 $('.disbursDate').datepick({
				onShow : $.datepick.monthOnly,
				dateFormat : 'dd/mm/yyyy',
				yearRange : "-100:+20",
				maxDate: '0',
				showOnFocus : true,
				showTrigger : '<button type="button" class="trigger">'
						+ '<i class="fa fa-calendar"></i></button>',
			   onSelect: function(selected) {
			     var date = new Date(selected);
			  
			     
					var fyear= $("#finyearId option:selected").text().split("-");
				    	var firstDate = 01 + "/" + 04 + "/" +fyear[0];
				    	var lastDate =  31 + "/" + 03 + "/" +fyear[1];	
					
					var sDate = firstDate.replace(/(\d+[/])(\d+[/])/, '$2$1');
					var tDate = lastDate.replace(/(\d+[/])(\d+[/])/, '$2$1');
					var data1 = new Date(sDate);
					var data2 = new Date(tDate);
				    if((date <= data2 && date >= data1)) {
				    //alert(this.id);
				    }else{
				    	 $("#"+this.id).val("");
				    	 bootbox.alert("Please select date between the financial year .")
				    }
			    }
			}); 
	 findEntityBeneficiaryMapListBySchemeIdAndBenfId();
}); 
 
 
 
 
 function findSubHeadListByHeadId(headId){
		$.ajax({
			type : "GET",
			url : '${contextPath}/ecashcommon/findSubHeadListByHeadId',
			dataType : "json",
			data : {
				"headId" : headId,
			},
			success : function(response) {
				var html = "<option value='' selected>-Select-</option>";
				var data = response;
				if (data != "" && data != null && data.length > 0) {
					$.each(data, function(index, value) {
						html = html + "<option value="+value.subHeadId+">"
								+ value.subHeadName + "</option>";
					});
				}
				$('#subHeadId').empty().append(html);
			},
			error : function(error) {
				bootbox.alert("Something went wrong !!!");
			}
		});
}
 

 
 function findEntityBeneficiaryMapListBySchemeIdAndBenfId(){
	 var schemeId= $("#schemeId").val();
	 $.ajax({
			type : "GET",
			url : '${contextPath}/fnd/expenditure/findEntityBeneficiaryMapListBySchemeIdAndBenfId',
			dataType : "json",
			data : {
				"schemeId" : schemeId,
			},
			success : function(response) {
				var html = "<option value='' selected>-Select-</option>";
				var data = response;
				if (data != "" && data != null && data.length > 0) {
					$.each(data, function(index, value) {
						html = html + "<option value="+value.entityBenfId+">"
								+ value.entityName + "</option>";
					});
				}
				$('#entityTypeId').empty().append(html);
				$("#entityTypeId").val('${expenditure.entityBeneficiaryMapping.entityBeneficiaryId}');
			},
			error : function(error) {
				bootbox.alert("Something went wrong !!!");
			}
		});
 }
 
 
 
 $('.NumbersOnlyForAmount').keypress(
			function(event) {
				var regex = new RegExp("^[0-9.]+$");
				var key = String.fromCharCode(!event.charCode ? event.which
						: event.charCode);
				if (!regex.test(key)) {
					event.preventDefault();
					return false;
				}
});
 

 
 function saveExpenditureForm(){
	 if($("#finyearId").val() == ""){
		bootbox.alert("Please Select Financial Year.");
		$("#accountNo").focus();
		return false;
	 }else if($("#transDate").val() == ""){
		bootbox.alert("Please select Expenditure Creation Date.");
		$("#transDate").focus();
		return false;
	 }else if($("#fundTypeId").val() == ""){
		bootbox.alert("Please select Fund Type.");
		$("#fundTypeId").focus();
		return false;
	 }else if($("#schemeId").val() == ""){
			bootbox.alert("Please select component name.");
			$("#schemeId").focus();
			return false;	
	 }else if($("#headId").val() == ""){
			bootbox.alert("Please Select Head Name.");
			$("#headId").focus();
			return false;	
	 }else if($("#subHeadId").val() == ""){
			bootbox.alert("Please Select Sub-Head Name.");
			$("#subHeadId").focus();
			return false;		
	 }else if($("#turnover1Converted").val() == "0.00"){
		bootbox.alert("Please enter amount .");
		$("#turnover1Converted").focus();
		return false;
	 }else{
		 var flag = window.confirm("Do you want to continue ?");
	  		if (flag == true) {
	  			$('#expenditureForm select').prop('disabled', false);
	  			$("#expenditureForm").submit();
	  		}else{
	  			e.preventDefault();
	  		} 
	 }
 }
 
 $(document).ready(function() {
		$("#expenditureForm input").prop("disabled", true);
		$('#expenditureForm select').prop('disabled', true);
		$(".datepick-trigger").prop('disabled', true);
	});
 </script>           
    