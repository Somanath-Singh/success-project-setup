<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<style>

.view-btn {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: #fff;
    border: none;
    padding: 2px 8px;   /* smaller padding */
    font-size: 10px;     /* smaller text */
    font-weight: 500;
    border-radius: 4px;  /* less rounded */
    cursor: pointer;
    transition: all 0.25s ease-in-out;
}

.imagae-view-btn,.select-site-btn {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: #fff;
    border: none;
   	padding: 4px 12px; /* smaller padding */ 
   	font-size: 12px; /* smaller text */
    font-weight: 500;
    border-radius: 4px;  /* less rounded */
    cursor: pointer;
    transition: all 0.25s ease-in-out;
}

.view-btn:hover {
    background: linear-gradient(135deg, #0056b3, #003f7f);
}

.view-btn:active {
    transform: scale(0.95);
}


</style>


<!-- Modal -->
<div class="modal fade" id="viewSiteImageModal" tabindex="-1" aria-labelledby="viewSiteImageModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content shadow-lg border-0 rounded-3">
			<div class="modal-header bg-light text-white">
				<h5 class="modal-title fw-bold" id="viewSiteImageModalLabel">
					<i class="fas fa-image"></i>
					Inspected Site Image
				</h5>

				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body bg-light">
				<div class="row g-4">
					<c:choose>
						<c:when test="${not empty siteInspectionImageList}">
							<c:forEach var="image" items="${siteInspectionImageList}">
								<div class="col-md-12 text-center">
									<div class="card border-0 shadow-sm p-3 bg-white rounded">
										<img 
										  src="${pageContext.request.contextPath}/document/viewDocuments?moduleName=SITE_INSPECTION_IMAGE&filePath=${image.siteInspectionImagePath}" 
										  class="img-fluid rounded mb-2" 
										  alt="Site Image" 
										  style="max-height: 400px; object-fit: contain;" />
			
										<div class="mt-2 small">
											<i class="fas fa-map-marker-alt text-danger"></i>
											<span class="fw-bold text-success">Latitude:</span> 
											<span class="text-dark">${image.latitude}</span> | 
											<span class="fw-bold text-success">Longitude:</span> 
											<span class="text-dark">${image.longitude}</span>
										</div>
									</div>
								</div>
							</c:forEach>
						</c:when>
						<c:otherwise>
							<div class="col-md-12 text-center">
								<div class="alert alert-warning shadow-sm rounded">
									<i class="fas fa-exclamation-circle"></i> No site images available for this inspection.
								</div>
							</div>
						</c:otherwise>
					</c:choose>
				</div>
			</div>
			<div class="modal-footer bg-light">
				<button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>



<div class="container-fluid">

    <div class="breadcrumb_conatiner">
        <div class="col-md-6">
            <h4 class="change-color">Site Selection</h4>
        </div>
        <div class="col-md-6">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb float-md-end mb-0">
                    <li class="breadcrumb-item">
                        <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">View Site Selection List</li>
                </ol>
            </nav>
        </div>
    </div>

   <!-- Filter Form -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Filter Sites</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Financial Year -->
                    <div class="col-md-3">
                        <label for="financialYearId" class="form-label">Select Financial Year</label>
                        <select id="financialYearId" name="financialYearId" class="form-select" onchange="siteSelection(null)">
                            <option value="">-- Select Financial Year --</option>
                            <c:forEach var="fy" items="${financialYearList}">
                                <option value="${fy.financialYearId}" ${fy.financialYearId == selectedFinancialYear ? 'selected' : ''}>
                                    ${fy.financialYear}
                                </option>
                            </c:forEach>
                        </select>
                    </div>
                    <!-- Project -->
                    <div class="col-md-3">
<!--                         <label for="projectId" class="form-label">Select Project</label> -->
                         <label for="projectId" class="form-label">Select Building</label>
                        <select id="projectId" name="projectId" class="form-select select2" onchange="siteSelection(null)">
<!--                             <option value="">-- Select a Project --</option> -->
<option value="">-- Select a Building --</option>
                            <c:forEach var="project" items="${projectList}">
                                <option value="${project.projectId}" ${project.projectId == selectedProject ? 'selected' : ''}>
                                    ${project.projectName}
                                </option>
                            </c:forEach>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Site Inspection Cards -->
<div class="row mb-4">
	<div class="col-md-12">
		<div class="card shadow-sm">
			<div class="card-header bg-light">
				<h5 class="card-title mb-0">Site Selection List</h5>
			</div>
			<div class="card-body">
				<div class="row">
				    <div class="col-md-12">
						<div class="flex-nowrap overflow-auto">
						  <c:choose>
						    <c:when test="${not empty siteInspectionList}">
						        <table class="table table-bordered table-hover shadow-sm exportbtn text-center">
						            <thead class="table-light">
						                <tr>
						                    <th>ID</th>
						                    <th>Area</th>
						                    <th>Landmark</th>
						                    <th>Flood Area</th>
						                    <th>Earthquake Area</th>
						                    <th>Inspection Date</th>
						                    <th>Soil Test Report</th>
						                    <th>Land Record Report</th>
						                    <th>Land Clearance Report</th>
						                    <th>environment Clearance Report</th>
						                    <!-- <th>Remark</th> -->
						                    <th>View Image</th>
						                    <th>Actions</th>
						                </tr>
						            </thead>
						            <tbody>
						                <c:forEach var="dto" items="${siteInspectionList}" varStatus="count">
						                    <tr>
						                        <!-- Site Inspection ID -->
						                        <td>${count.count}</td>
						                        <td>${dto.area}</td>
						                        <td>${dto.landmark}</td>
						                        <td>
						                            <c:choose>
						                                <c:when test="${dto.isFloodArea}">Yes</c:when>
						                                <c:otherwise>No</c:otherwise>
						                            </c:choose>
						                        </td>
						                        <td>
						                            <c:choose>
						                                <c:when test="${dto.isEarthquakeArea}">Yes</c:when>
						                                <c:otherwise>No</c:otherwise>
						                            </c:choose>
						                        </td>
						                        <td>
						                            <c:if test="${not empty dto.siteInspectionDate}">
						                                <fmt:formatDate value="${dto.siteInspectionDate}" pattern="dd-MMM-yyyy" />
						                            </c:if>
						                        </td>
						                        <td>
						                        	<c:if test="${not empty dto.soilTestReportPath}">
						                                <button class="btn btn-secondary" onclick="viewDocument('${dto.soilTestReportPath}','SITE_INSPECTION_DOCUMENT')">
						                                   <i class="fa-regular fa-eye" title="View"></i>
						                                </button>
						                            </c:if>
						                        </td>
						                         <td>
						                         	<c:if test="${not empty dto.lanRecordReportPath}">
						                                <button class="btn btn-secondary" onclick="viewDocument('${dto.lanRecordReportPath}','SITE_INSPECTION_DOCUMENT')">
						                                	<i class="fa-regular fa-eye" title="View"></i>
						                                </button>
						                            </c:if>
						                        </td>
						                         <td>
						                         	<c:if test="${not empty dto.landClearanceReportPath}">
						                                <button class="btn btn-secondary" onclick="viewDocument('${dto.landClearanceReportPath}','SITE_INSPECTION_DOCUMENT')">
						                                    <i class="fa-regular fa-eye" title="View"></i>
						                                </button>
						                            </c:if>
						                        </td>
						                        <td>
						                            <c:if test="${not empty dto.environmentClearanceReportPath}">
						                                <button class="btn btn-secondary" onclick="viewDocument('${dto.environmentClearanceReportPath}','SITE_INSPECTION_DOCUMENT')">
						                                    <i class="fa-regular fa-eye" title="View"></i>
						                                </button>
						                            </c:if>
						                        </td>
						                        <%-- <td>${fn:escapeXml(dto.remark)}</td> --%>
						                        <td>
				                                 	<button class="imagae-view-btn ms-2" onclick="siteSelection('${dto.siteInspectionId}')">
				                                 		<i class="fas fa-image"></i> 
				                                 	</button>
				                                </td>
						                        <td>
						                        	<span class="ms-2">
													    <i class="fas ${dto.isFinalSelectedSite ? 'fa-check-circle text-success' : 'fas fa-times-circle text-danger'}"></i><br>
													    ${dto.isFinalSelectedSite ? 'Final Site' : 'Not Selected'}
													</span>
						                         </td>
						                    </tr>
						                </c:forEach>
						            </tbody>
						        </table>
						    </c:when>
						    <c:otherwise>
						        <div class="col-12">
						            <div class="alert alert-warning text-center">
						                No site inspections available for the selected project.
						            </div>
						        </div>
						    </c:otherwise>
						</c:choose>
						</div>
					</div>
				  </div>
				</div>
			</div>
		</div>
	</div>
</div>


<form action="${pageContext.request.contextPath}/site/site-list" method="get" id="siteSelectionList">
	<input type="hidden" name="cipherText" id="listSiteCipherText">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="financialYearId" id="financialYearIdHidden">
	<input type="hidden" name="projectId" id="projectIdHidden">
    <input type="hidden" name="siteInspectionId" id="siteInspectionIdHidden">
</form>

<form action = "${contextPath}/document/viewDocuments" method="get" id="documentFormView" enctype="multipart/form-data" target="_blank">
	<input type="hidden" name="moduleName" id="moduleName"/>
	<input type="hidden" name="filePath" id="filePath"/>
</form>

<c:if test="${openImageModal}">
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var myModal = new bootstrap.Modal(document.getElementById('viewSiteImageModal'));
            myModal.show();
        });
    </script>
</c:if>

<script>

function viewDocument(filePath,moduleName){
	debugger
	 $('#moduleName').val(moduleName);
	 $('#filePath').val(filePath);
	 $('#documentFormView').submit();
	}
	
function siteSelection(siteInspectionId) {
    debugger;
    var financialYear = $("#financialYearId").val(); 
    var project = $("#projectId").val();            

    $('#financialYearIdHidden').val(financialYear);
    $('#projectIdHidden').val(project);
    $('#siteInspectionIdHidden').val(siteInspectionId);

    showLoader();

    var bizContent = $("#siteSelectionList").serializeArray();
    $("#listSiteCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    $("#siteSelectionList").submit();
}

</script>