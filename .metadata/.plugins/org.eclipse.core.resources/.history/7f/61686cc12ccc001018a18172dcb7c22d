<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />


	<div class="breadcrumb_conatiner">
		<div class="col-md-6">
			<h4 class="change-color">Purchase Order</h4>
		</div>
		<div class="col-md-6">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
					<li class="breadcrumb-item">
						<a href="#">Procurement</a>
					</li>
					<li class="breadcrumb-item active" aria-current="page">Purchase order</li>
				</ol>
			</nav>
		</div>
	</div>


	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<h5 class="card-title">Purchase Order</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-12">
							<table class=" table table-striped table-bordered  mt-3">
								<thead class="bagGroundColor">
									<tr>
										<th>SlNo.</th>
										<th>Purchase No.</th>
										<th>Purchase Date</th>
										<th>Purchase Close Date</th>
										<th>Financial Year</th>
										<th>Priority Level</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<c:forEach items="${lstPo}" var="po" varStatus="count">
										<tr>
											<td>${count.count}</td>
											<td>${po.poNo}</td>
											<td><fmt:formatDate value='${po.poReceiptGeneratedDate}' pattern='dd/MM/yyyy' /></td>
											<td>
												<c:choose>
													<c:when test="${po.poClosed eq true}">
														<fmt:formatDate value='${po.poClosingDate}' pattern='dd/MM/yyyy' />
													</c:when>
													<c:otherwise>
														N/A
													</c:otherwise>
                                                </c:choose>
											</td>
											<td>${po.finYear.finYear}</td>
											<td>${po.priorityLevel.priorityLevelName}</td>
											<td>
                                                <!-- <a onclick="closePo(${po.poId})"><i class="fa-solid fa-arrow-right"></i></a> -->
                                                <c:choose>
                                                    <c:when test="${po.poClosed eq false}">
                                                        <button type="button" class="btn btn-danger unfreezeField" data-bs-toggle="modal" title="Closed" data-bs-target="#myModal" onclick="getModal(${po.poId},'${po.poNo}','<fmt:formatDate value='${po.poReceiptGeneratedDate }' pattern='dd/MM/yyyy'/>')"><i class="fa-solid fa-xmark" style="font-size: 16px;line-height: 22px;"></i></button>
                                                    </c:when>
                                                    <c:otherwise>
														<c:choose>
															<c:when test="${not empty po.closeDoc}">
																<button type="button" class="btn btn-success" onclick="downloadDoc('${po.closeDoc}')"><i class="fa-solid fa-eye"></i></button>
															</c:when>
															<c:otherwise>
																<button type="button" class="btn btn-primary"><i class="fa-solid fa-shop-lock"></i></button>
															</c:otherwise>
														</c:choose>
                                                        
                                                        
                                                    </c:otherwise>
                                                </c:choose>
                                            </td>
										</tr>
									</c:forEach>
								</tbody>
							</table>
				
						</div>

					</div>
				</div>
			</div>
		</div>
	</div>
	
<div class="modal" id="myModal">
	<div class="modal-dialog modal-lg">
	  <div class="modal-content">
  
		<!-- Modal Header -->
		<div class="modal-header">
		  <h4 class="modal-title">Purchase Order Close</h4>
		  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		</div>
	  <form action="${contextPath}/procurement/purchaseOrder/closePurchase" method="post" id="closeform" enctype="multipart/form-data">
			  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
			  <input type="hidden" name="poId" id="poId" value="" />
			  <input type="hidden" class="" id="encodedDatacloseform" name="encodedDatacloseform" value="" />

		<!-- Modal body -->
		<div class="modal-body">
			<div class="row">
				<div class="col-md-4">
				  <div class="form-group">
					  <label class="col-md-12 required" for="text">PO No.</label>
					  <div class="col-md-12">
						  <input type="text" class="form-control" id="poNo" readonly="readonly">			
					  </div>
				  </div>
			  </div>
				<div class="col-md-3">
				  <div class="form-group">
					  <label class="col-md-12 required" for="text">Purchase Closing Date</label>
					  <div class="col-md-12">
						  <div class="datepicker-box ">
							  <input type="text" class="form-control form-control-sm requiredField closeDate"  
									id="closeDate" value="" name="closeDate" readonly /> <i class='fa fa-calendar' style="position: absolute;top: 7px;right: 7px;font-size: 18px; color: #0f67b1;"></i>
						  </div>
					  </div>
				  </div>
			  </div>
				<div class="col-md-4">
				  <div class="form-group">
					  <label class="col-md-12 required" for="text">Closing Document</label>
					  <div class="col-md-12">
						  <input type="file" class="form-control" id="closeDoc" placeholder="Enter email" name="closeDoc">		
					  </div>
				  </div>
			  </div>
			</div>
		</div>
	  </form>
		<!-- Modal footer -->
		<div class="modal-footer">
		  <button type="button" class="btn btn-submit" onclick="closePurchase()">Submit</button>
		</div>
  
	  </div>
	</div>
  </div>

  <form method="post" action="${contextPath}/document/download" id="download" target="empty">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="docPath" name="docPath" value=""> 
	<input type="hidden" id="module" name="module" value="Purchase/Close">
</form>
<script>
	var poDate='';
	function getModal(id,no,date) {
		$("#poNo").val(no);
		$("#poId").val(id);
		poDate=date;
	}
	$(function() {
		$('.closeDate').datepick({
			dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
			 onSelect: function(selected) {
				 var alltDate=poDate.split("/");
				 var modAllotDate=new Date(alltDate[1]+"/"+alltDate[0]+"/"+alltDate[2]);
				 if(modAllotDate > new Date(selected)){
					bootbox.alert('PO Closing date sholud not be less than PO creation date.');
					$('.closeDate').val("");
				 }
			 }
		});
	});
	function closePurchase() {
		var closeDate=$("#closeDate").val();
		var closeDoc=$("#closeDoc").val();
		if(closeDate==""){
			displayErrorMsg("closeDate","Please select closing date");
			return false;
		}else{
			clearError("closeDate")
		}
		if(closeDoc==""){
			displayErrorMsg("closeDoc","Please upload closing document");
			return false;
		}else{
			clearError("closeDoc")
		}

		bootbox.confirm({
			message: "Are you sure you want to close the PO?",
			buttons: {
				confirm: {
					label: 'Yes',
					className: 'btn-success'
				},
				cancel: {
					label: 'No',
					className: 'btn-danger'
				}
			},
			callback: function (result) {
				if(result){
				    var closeTable = [];
				    var closeJson =[];
				    encryptFormData("closeform", closeTable, closeJson);
					$('#closeform').submit();
				}
			}
		});

	}

	function downloadDoc(path,module){
		$("#docPath").val(path);
		$("#download").submit();
	}
</script>