<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<sec:authentication var="principal" property="principal" />
<c:set var="roleCode" value="${principal.primaryRole.roleCode}"/>
 
 
 
			<div class="breadcrumb_conatiner">
	           <div class="col-md-6">
	             <h4 class="change-color">Facility Amenities Mapping</h4>
	           </div>
	           <div class="col-md-6">
	             <nav aria-label="breadcrumb">
	             <ol class="breadcrumb">
	                 <li class="breadcrumb-item">
                        <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
                     </li>
	                 <li class="breadcrumb-item active" aria-current="page">Facility Amenities Mapping</li>
	             </ol>
	             </nav>
	           </div>
	         </div>
            

    
    
       
            <div class="card">
			    <div class="card-header"><h5 class="card-title">Facility Amenities Mapping</h5></div>
				    <div class="card-body">
				    <form action="${contextPath}/facility/saveAmenities" method="post" id="saveAmenitiesId" class="row">
			            <input type="hidden" id="cipherText" name="cipherText">
				        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
<%-- 				        <input type="hidden" name="facilityAmenitesId" value="${facilityAmenities.facilityAmenitesId}"> --%>
				        <input type="hidden" id="aminitiesIds" name="aminitiesIds">
				        
				        <c:set var="functionList" value="getOrganizationDwonEHL(this)" />
						<c:set var="upperOrDown" value="down" />
						<c:set var="functionList2" value="getFacilities(this.value)"/> <!-- getParentFacilities(this), -->
						<%@ include file="/WEB-INF/views/entityIdAndUserLevelList.jsp"%> 
							        
				        <div class="col-md-2">
				        <div class="form-group">
				            <label for="facilityId" class="col-sm-12 required">Facility :</label>
				            <select name="facilityId" id="facilityId"  class="form-control form-select requiredField" onchange="editAmenitiesData(this.value);">
				                <option value="">---select---</option>
<%-- 				                <c:forEach var="jobLocV" items="${jobLocationList}"> --%>
<%-- 				                    <option value="${jobLocV.jobLocationId}"  --%>
<%-- 				                            ${jobLocV.jobLocationId == dto.jobLocationId ? 'selected' : ''}> --%>
<%-- 				                        ${jobLocV.jobLocationName} --%>
<!-- 				                    </option> -->
<%-- 				                </c:forEach> --%>
				            </select>
				        </div>
				    </div>

				        <div class="card-body">		     			
								 <div class="tab-content"> 
										<div class="tab-pane fade show active" id="pending">
											<div class="col-md-12">
												<table
													class="datatable table table-striped table-bordered exportbtn">
													<thead>
														<tr>
															<th style="text-align: center; max-width: 35px;">Sl No</th>
															<th style="">Amenity Name</th>
															<th style="">Description</th>
						 								    <th>Select All
												              <input type="checkbox" id="selectAll" />
										                    </th>
														</tr>
													</thead>
													<tbody>
													<c:set var="pendingCount" value="1" />
														<c:forEach items="${amenitiesList}" var="aminity"	varStatus="count">
																<tr>
						 											<td style="text-align: center;">${count.count}</td>
						 											<td>${aminity.name}</td> 
																	<td>${aminity.description}</td>
						  											<td  style="width: 100px;text-align:center;">
                                              						   <input type="checkbox" class="x-check" id="empCheckBox${count.count}" value="${aminity.aminitiesId}" >
						                                            </td>
																</tr> 
																
														</c:forEach> 
													</tbody> 
						 						</table> 
						 					</div>
										</div> 
									</div>
							</div>
				        
				        <div class="form-group col-md-12 text-center mt-3">
				            <button type="button" class="btn btn-submit searchdiv" style="margin-left: 8px;" onclick="submitForm('${empty mapList ? 'SAVE' : 'UPDATE'}')" >${empty mapList ? 'Submit' : 'Update'}</button>
				            <button type="button" class="btn btn-warning searchdiv" style="margin-left: 8px;" onclick="history.back()">Back</button>
				        </div>
				    </form>
				</div>
          </div>


<!-- <div class="card cardContainerNotFirst"> -->
<!--  <div class="card-header"><h5 class="card-title">Facility Amenities Mapping List</h5></div> -->
<!-- 	 <div class="card-body"> -->

<!-- 		<table class="datatable table table-striped table-bordered exportbtn"> -->
<!-- 	    	<thead> -->
<!-- 		        <tr> -->
<!-- 		            <th>Sl.No</th> -->
<!-- 		            <th>Facility Name</th> -->
<!-- 		            <th>Amenities Name</th> -->
<!-- 		            <th>Description</th> -->
<!-- 		            <th>Action</th> -->
<!-- 		        </tr> -->
<!-- 	    	</thead> -->
<!-- 	    	<tbody> -->
<%-- 		        <c:forEach items="${facilityAmenitiesMapList}" var="mapp" varStatus="count"> --%>
<!-- 		            <tr> -->
<%-- 		                <td>${count.count}</td> --%>
<%-- 		                <td>${mapp.facilityIdEntityMap.facilityName}</td> --%>
<%-- 		                <td>${mapp.aminities.name}</td> --%>
<%-- 		                <td>${mapp.aminities.description}</td> --%>
<!-- 		                <td> -->
<%-- 						 <button type="button" onclick="editAmenitiesData('${mapp.facilityIdEntityMap.facilitiesMapId}');" title="Edit"> --%>
<!-- 								 <i class=" fa fa-pen " aria-hidden="true"></i></button> -->
<!-- 					    </td> -->
<!-- 		            </tr> -->
<%-- 		        </c:forEach> --%>
<!-- 	    	</tbody> -->
<!-- 		</table> -->
<!-- 	</div> -->
<!-- </div> -->

<form action="${contextPath}/facility/editAmenities" method="get" id="editAmenitiesId">
<input type="hidden" name="hdnFacId" id="hdnFacId">
</form>

<script>
function submitForm(status) {
	debugger
    if ($("#facilityId").val().trim() == "") {
        bootbox.alert("Please choose facilty.");
        return false;
    }else { 
    	
    	 var confMsg = '';
    	    var checked = [];
    	    var myElements = document.getElementsByClassName("x-check");
    	    var checkboxes = $('input:checkbox:checked').length;

    	    if (checkboxes == 0) {
    	        bootbox.alert("Please select at least one record.");
    	        return false;
    	    } else {
    	        for (var i = 1; i <= myElements.length; i++) {
    	            if ($("#empCheckBox" + (i)).prop('checked') == true) {
    	                checked.push(parseInt($("#empCheckBox" + (i)).val()));
    	            }
    	        }
    	    }

    	    if (checked.length == 0) {
    	        bootbox.alert("Please select at least one record.");
    	        return false;
    	    }
    	    else{
    	    	
    	    	$("#aminitiesIds").val(checked);
    	    	
    	    var message = status === 'SAVE' ? 'save' : 'update';
    		 bootbox.confirm("Do you want to "+message+" facility details ?", function (result) {
    	            if (result) {
    	                showLoader();
    	                $("#saveAmenitiesId").submit();
    	            }
    	        });
    	
    	    }
    }
}


function getFacilities(selFacId){
	debugger
	var orgId=$("#orgIdAndTypeId").val();
	var dowlLvlId=$("#upperEntityId").val();
	
	$.ajax({
		url: "${contextPath}/facility/getFacilityByOrgAndDownlvl",
		type: "GET",
		data: {
			"orgId": orgId,
			"dowlLvlId": dowlLvlId
		},
		success: function(response){
			if(response.outcome){
				var html = "<option value='' selected>--Select--</option>";
				var data = response.data;
				if(data != "" && data != null && data.length > 0){
					$.each(data, function(index, value){
// 						let selected = "";
// 						if(value.parentId == parentIdHiddenId){
// 							selected = "selected";
// 						}
						html += '<option value="' + value.parentId + '">' + value.parentName + '</option>';
					});
				}
				$('#facilityId').empty().append(html);
				if(selFacId!=''){
					$('#facilityId').val(selFacId);
				}
			}
		},
		error: function(error){
			//bootbox.alert("Failure"); 
		}
	});
	
}

function getRoleListByActualLevel(a,b){
}

function editAmenitiesData(facId){
	debugger
	
	$.ajax({
		url: "${contextPath}/facility/editAmenities",
		type: "GET",
		data: {
			"hdnFacId": facId,
		},
		success: function(response){
			// Reset all checkboxes first
	        $('input[type="checkbox"]').prop('checked', false);
			if(response!=''){
				var html = "<option value='' selected>--Select--</option>";
				var data = response;
				if(data != "" && data != null && data.length > 0){
					$.each(data, function(index, value){
						var amId = value.aminities.aminitiesId;
						$('input[value="' + amId + '"]').prop('checked', true);
					});
					
					 var totalCheckboxes = $('input[type="checkbox"]').not('#selectAll').length;
	                    var checkedCheckboxes = $('input[type="checkbox"]:checked').not('#selectAll').length;
	                    
	                    if (totalCheckboxes === checkedCheckboxes) {
	                        $("#selectAll").prop('checked', true);
	                    } else {
	                        $("#selectAll").prop('checked', false);
	                    }
				}
			}
		},
		error: function(error){
			//bootbox.alert("Failure"); 
		}
	});
	
}

$(document).ready(function() {
	var selFacId='${mapList.facilityAmenities.facilityIdEntityMap.facilitiesMapId}'
	//setTimeout(getFacilities, 2000);
	setTimeout(function() {
	    getFacilities(selFacId);
	}, 2000);

});

$(document).ready(function() {
	debugger
	var list='${mapList}';

});


$('.x-check').change(function() {
    handleCheckboxChange();
});

$('#selectAll').click(function(e) {
    var table = $(e.target).closest('table');
    $('td input:checkbox', table).prop('checked', this.checked);
    $('td input.isFreezed', table).prop('checked', false);
});

function handleCheckboxChange() {
    var allCheckboxes = $('.x-check');
    var selectAllCheckbox = $('#selectAll');
    selectAllCheckbox.prop('checked', allCheckboxes.length === allCheckboxes.filter(':checked').length);
} 
</script>


