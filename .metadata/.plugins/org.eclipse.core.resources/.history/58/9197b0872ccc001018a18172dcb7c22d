<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<style>
button.datepick-trigger {
    position: absolute;
    top: 20px;
    right: 15px;
}
button.datepick-trigger>i {
    color: #0f67b1;
    font-size: 18px;
    position: absolute;
    transform: translate(-50%, -50%);
}
#assetTable thead th{
    min-width: 200px;
}
#assetTable thead th:nth-Child(1){
    min-width: 55px;
}
#assetTable thead th:nth-Child(10){
    min-width: auto;
}
#assetTable td{
    position: relative;
}
</style>

<div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">Asset Details</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item">
                      <a href="#">Procurement</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Asset Details</li>
                  </ol>
                </nav>
              </div>
            </div>
 <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Asset Details</h5>
                    </div>
                    <div class="card-body">
				<div class="row">
					<div class="col-md-12">
					
            
						<div class="row">
							<div class="col-md-12 table-responsive">
								<table class="table table-bordered">
									<tr>
										<td class="bgtr"><label>Asset Name</label></td>
										<td>${assDtls.assetName}</td>
										<td class="bgtr"><label>Stock Type</label></td>
										<td>${assDtls.stockType.stockTypeName}</td>
									</tr>

									<tr>
										<td class="bgtr"><label>Asset Brand</label></td>
										<td>${not empty assDtls.assetBrand.brandName ? assDtls.assetBrand.brandName : 'N/A'}</td>
										<td class="bgtr"><label>Item Type</label></td>
									    <td>${assDtls.itemType.itemTypeName}</td>
									</tr>

								</table>
							</div>
						</div>
            <c:if test="${assDtls.itemType.itemTypeName eq 'Stockable'}">
						<div class="row">
							<div class="col-md-12">
                  <form action="${contextPath}/inventory/store/update/assetDetails" method="POST" id="assetsform" >
                    <button id="addRowBtn" type="button" class="btn btn-primary" style=" width: auto;"><i class="fa-solid fa-plus"></i></button>
                    <div class="table-responsive">
                      <table id="assetTable" class=" table table-striped table-bordered  mt-3">
                        <thead class="bagGroundColor">
                          <tr>
                              <th rowspan="2">Sl no.</th>
                            <th rowspan="2">Model Number</th>
                            <th rowspan="2">Serial Number</th>
                            <th rowspan="2">Manufacturing Date</th>
                            <th rowspan="2">Purchase Date</th>
                            <th rowspan="2">Price</th>
                            <th rowspan="2">Warranty Period</th>
                            <th rowspan="2">Location</th>
                            <th rowspan="2">Remarks/Others</th>
                            <th rowspan="2">Action</th>
                          </tr>
                        </thead>

                          <tbody id="myTableBody">
                                  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                                  <input type="hidden" id="assetId" name="assetsDto.assetId" value="${assDtls.assetId}" />
                          <c:forEach items="${assDtls.assetDetails}" var="asset" varStatus="loop">
                              <tr>
                                  <td style="text-align: center;">${loop.index + 1}</td>
                                  <td>
                                      <input class="form-control form-control-sm" type="hidden" id="assetDetailsId${loop.index}" name="assetDataDto[${loop.index}].assetDetailsId" value="${asset.assetDetailsId}">
                                      <input class="form-control form-control-sm required" type="text" id="modelNumber${loop.index}" title="${asset.modelNumber}" name="assetDataDto[${loop.index}].modelNumber" placeholder="Enter Model Number" value="${asset.modelNumber}" maxlength="50">
                                  </td>
                                  <td>
                                      <input class="form-control form-control-sm" type="text" id="serialNumber${loop.index}" name="assetDataDto[${loop.index}].serialNumber" placeholder="Enter Serial Number" value="${asset.serialNumber}" maxlength="50" onchange="findDuplicateOrNot(${loop.index})">
                                  </td>
                                  <td>
                                      <input class="form-control form-control-sm manufactureDate_con" type="text" id="manufacturerDate${loop.index}" name="assetDataDto[${loop.index}].manufacturerDate" placeholder="Choose Date" value="<fmt:formatDate value='${asset.manufacturerDate}' pattern='dd/MM/yyyy' />" readonly="readonly">
                                  </td>
                                  <td>
                                      <input class="form-control form-control-sm purchaseDate_con" type="text" id="purchaseDate${loop.index}" name="assetDataDto[${loop.index}].purchaseDate" placeholder="Choose Date" value="<fmt:formatDate value='${asset.purchaseDate}' pattern='dd/MM/yyyy' />" readonly="readonly">
                                  </td>
                                  <td>
                                      <input type="hidden" id="price${loop.index}" name="assetDataDto[${loop.index}].price" value="${asset.price}">
                                      <input class="form-control form-control-sm" type="text"  name="" placeholder="Enter Price" value="<fmt:formatNumber value='${asset.price}' type='number' minFractionDigits='2' maxFractionDigits='2'/>" readonly="readonly">
                                  </td>
                                  <td>
                                      <input class="form-control form-control-sm warantyPeriod_con" type="text" id="warrantyPeriod${loop.index}" name="assetDataDto[${loop.index}].warrantyPeriod" placeholder="Enter warranty Period" value="<fmt:formatDate value='${asset.warrantyPeriod}' pattern='dd/MM/yyyy'/>" readonly="readonly">
                                  </td>
                                  <td>
                                      <input class="form-control form-control-sm" type="text" id="location${loop.index}" name="assetDataDto[${loop.index}].location" placeholder="Enter location" value="${asset.location}" title="${asset.location}" >
                                  </td>
                                  <td>
                                      <textarea class="form-control form-control-sm " type="text" id="otherDetails${loop.index}" name="assetDataDto[${loop.index}].otherDetails" placeholder="Enter remarks" >${asset.otherDetails}</textarea>
                                  </td>
                                  <td>
                                  <div class="toggleTrueFalse" data-label-on="True" data-label-off="False" data-toggle-width="90" style="margin: 0px; margin-top: 5px;">
                                      <input type="checkbox" value="${asset.active}" id="parametros_MOSTRAPEDIDOS${loop.index}" class="toggleCheckBox" name="assetDataDto[${loop.index}].active" ${asset.active == 'true' ? 'checked' : ''}>
                                      <label class="clickToggle" for="parametros_MOSTRAPEDIDOS${loop.index}"></label>
                                  </div>
                              </td>

                              </tr>
                          </c:forEach>
                          </tbody>
                      </table>
                    </div>
                </form>

							</div>
						</div>
				        <div class="col-md-12  text-center mt-2">
									<input type="button" class="btn btn-submit" value="Update" onclick="validateForms()">
									<a href="${contextPath}/inventory/store/asset/add" class="btn btn-warning">Back</a>
								</div>

          </c:if>
          <c:if test="${assDtls.itemType.itemTypeName eq 'Non Stockable'}">
            <div class="row">
							<div class="col-md-12">
								<div class="table-responsive">
									<table id="assetTable" class=" table table-striped table-bordered mt-3">
										<thead class="bagGroundColor">
											<tr>
											    <th rowspan="2">Sl no.</th>
												<th rowspan="2">Grn Number</th>
												<th rowspan="2">Grn Date</th>
												<th rowspan="2">Received Quantity</th>
											</tr>
										</thead>

            				<tbody id="myTableBody">
											<c:forEach items="${lstGrn}" var="grnLines" varStatus="loop">
											    <tr>
											        <td>${loop.count}</td>
											        <td>${grnLines.grn.grnNo}</td>
                              <td><fmt:formatDate value='${grnLines.grn.grnDate}' pattern='dd/MM/yyyy' /></td>
                              <td>${grnLines.receivedQuantity}</td>
											    </tr>
											</c:forEach>
										</tbody>
									</table>
								</div>
							</div>
							<div class="col-md-12 btnholder text-center">
									<a href="${contextPath}/inventory/store/asset/add" class="btn btn-warning" style="line-height: inherit;padding: 5px 20px;height: unset;" >Back</a>
								</div>
						</div>

          </c:if>
					</div>
				</div>
			</div>
	</div>
</div>
</div>

<script>
$(function() {
	$('.manufactureDate_con').datepick({
		 dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
		 showTrigger: '<button type="button" class="trigger">' +
         		 '<i class="fa fa-calendar"></i></button>',
         onSelect: function(selectedDate) {
         debugger;
             var selectedId = $(this).attr('id');
             var id=selectedId.slice(16);
             var purDate = $('#purchaseDate'+id).datepick('getDate');
             // Convert selectedDate to a Date object
             purDate=new Date(purDate);
             selectedDate = new Date(selectedDate);
             if (purDate != null && selectedDate > purDate) {
                bootbox.alert("Manufacture Date can not be select after date of purchase date");
                $('#manufacturerDate'+id).val("");
                return false;

             }
         }
	});
	$('.purchaseDate_con').datepick({
         dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
         showTrigger: '<button type="button" class="trigger">' +
         		 '<i class="fa fa-calendar"></i></button>',
         onSelect: function(selectedDate) {
            debugger;
            var selectedId = $(this).attr('id');
            var id=selectedId.slice(12);
            var manDate = $('#manufacturerDate'+id).datepick('getDate');
            // Convert selectedDate to a Date object
             manDate=new Date(manDate);
             selectedDate = new Date(selectedDate);
             if (manDate != null && manDate > selectedDate) {
                bootbox.alert("Purchase Date can not be select previous date of manufacture date");
                $('#purchaseDate'+id).val("");
                return false;

             }
         }
    });
	$('.warantyPeriod_con').datepick({
		dateFormat: 'dd/mm/yyyy',minDate:0, showOnFocus: true,
            showTrigger: '<button type="button" class="trigger">' +
                                     '<i class="fa fa-calendar"></i></button>',
    });

});
$(document).ready(function () {
    //Visual da Section
    var $on = 'section';
    $($on).css({
        'background': 'none',
        'border': 'none',
        'box-shadow': 'none'
    });

    //
    //Ajusta tamanho dos elementos de acordo com o parametro passado
     $('.toggleTrueFalse').each(function(i) {
        var width = $(this).data('toggle-width');
        $(this).width(width);
        $(this).children('label').width(width * 0.45);
    });

    //
    $('.clickToggle').on('click',function () {
      var obj = $(this).prev();
      if ($(obj).is(":checked")) {

        $(obj).attr("value", false);
      }
      else {
        $(obj).attr("value", true);
      }
    });


    $('.toggleTrueFalse input[type=checkbox]').click(function (e) {
      e.stopPropagation();
    });
    //
});

function validateForms() {
    var tableData = checkTableContent();
    if (tableData) {
        $("#assetsform").submit();
    } else {
        alert("Please fill in the Model Number fields");
    }
}

function checkTableContent() {
    var table = document.getElementById('myTableBody');
    var isValid = true;
    document.querySelectorAll('.required').forEach(function (input) {
        if (input.value.trim() === '') {
            isValid = false;
            input.classList.add('required-error');
        } else {
            input.classList.remove('required-error');
        }
    });

    return isValid;
}

$("#addRowBtn").click(function () {
  debugger;
    const tbody = document.getElementById('myTableBody'); // Use the correct ID for the table body
    const previousRowCount = tbody.getElementsByTagName('tr').length;

    var newRow = '<tr style="vertical-align: middle;" id="row' + (previousRowCount) + '">' +
        '<td style="text-align: center;">' + (previousRowCount + 1) + '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm" type="hidden" id="assetDetailsId' + (previousRowCount) + '" name="assetDataDto[' + (previousRowCount ) + '].assetDetailsId">' +
        '   <input class="form-control form-control-sm required" type="text" id="modelNumber' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount) + '].modelNumber" placeholder="Enter Model Number" maxlength="50">' +
        '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm" type="text" id="serialNumber' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].serialNumber" placeholder="Enter Serial Number" maxlength="50" onchange="findDuplicateOrNot(' + (previousRowCount ) + ')">' +
        '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm manufactureDate_con" type="text" id="manufacturerDate' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].manufacturerDate" placeholder="Choose Date" readonly="readonly">' +
        '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm purchaseDate_con" type="text" id="purchaseDate' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].purchaseDate" placeholder="Choose Date" readonly="readonly">' +
        '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm" type="number" id="price' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].price" placeholder="Enter Price">' +
        '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm warantyPeriod_con" type="text" id="warrantyPeriod' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].warrantyPeriod" placeholder="Enter Warranty Period" readonly="readonly">' +
        '</td>' +
        '<td>' +
        '   <input class="form-control form-control-sm" type="text" id="location' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].location" placeholder="Enter location">' +
        '</td>' +
        '<td>' +
        '   <textarea class="form-control form-control-sm " type="text" id="otherDetails' + (previousRowCount ) + '" name="assetDataDto[' + (previousRowCount ) + '].otherDetails" placeholder="Enter remarks"></textarea>' +
        '</td>' +
//         '<td>' +
//         '   <div class="toggleTrueFalse" data-label-on="True" data-label-off="False" data-toggle-width="90">' +
//         '       <input type="checkbox" value="true" id="parametros_MOSTRAPEDIDOS' + (previousRowCount + 1) + '" class="toggleCheckBox" name="assetDataDto[' + (previousRowCount + 1) + '].active" checked>' +
//         '       <label class="clickToggle" for="parametros_MOSTRAPEDIDOS' + (previousRowCount + 1) + '"></label>' +
//         '   </div>' +
//         '</td>' +
        '<td class="text-center">' +
        '   <button class="btn btn-danger" style="" type="button" onclick="deleteRow(' + (previousRowCount ) + ')"><i class="fa-solid fa-trash"></i></button>' +
        '</td>' +
        '</tr>';

    $("#myTableBody").append(newRow); // Use the correct ID for the table body
    	$('.manufactureDate_con').datepick({
        		 dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
        		 showTrigger: '<button type="button" class="trigger">' +
        		  '<i class="fa fa-calendar"></i></button>',
                 onSelect: function(selectedDate) {
                 debugger;
                     var selectedId = $(this).attr('id');
                     var id=selectedId.slice(16);
                     var purDate = $('#purchaseDate'+id).datepick('getDate');
                     // Convert selectedDate to a Date object
                     purDate=new Date(purDate);
                     selectedDate = new Date(selectedDate);
                     if (purDate != null && selectedDate > purDate) {
                        bootbox.alert("Manufacture Date can not be select after date of purchase date");
                        $('#manufacturerDate'+id).val("");
                        return false;

                     }
                 }
        	});
        	$('.purchaseDate_con').datepick({
                 dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
                 showTrigger: '<button type="button" class="trigger">' +
                 		 '<i class="fa fa-calendar"></i></button>',
                 onSelect: function(selectedDate) {
                    debugger;
                    var selectedId = $(this).attr('id');
                    var id=selectedId.slice(12);
                    var manDate = $('#manufacturerDate'+id).datepick('getDate');
                    // Convert selectedDate to a Date object
                     manDate=new Date(manDate);
                     selectedDate = new Date(selectedDate);
                     if (manDate != null && manDate > selectedDate) {
                        bootbox.alert("Purchase Date can not be select previous date of manufacture date");
                        $('#purchaseDate'+id).val("");
                        return false;

                     }
                 }
            });
    	$('.warantyPeriod_con').datepick({
    		dateFormat: 'dd/mm/yyyy',minDate:0, showOnFocus: true,
    		showTrigger: '<button type="button" class="trigger">' +
                             		 '<i class="fa fa-calendar"></i></button>',
    	});
    
    $(document).ready(function () {
        //Visual da Section
        var $on = 'section';
        $($on).css({
            'background': 'none',
            'border': 'none',
            'box-shadow': 'none'
        });
      
        //
        //Ajusta tamanho dos elementos de acordo com o parametro passado
         $('.toggleTrueFalse').each(function(i) {
            var width = $(this).data('toggle-width');
            $(this).width(width);
            $(this).children('label').width(width * 0.45);
        });
      
        //
        $('.clickToggle').on('click',function () {
          var obj = $(this).prev();
          if ($(obj).is(":checked")) {

            $(obj).attr("value", false);
          }
          else {
            $(obj).attr("value", true);
          }
        });


        $('.toggleTrueFalse input[type=checkbox]').click(function (e) {
          e.stopPropagation();
        });
        //
    });
});

function deleteRow(id) {
    const tbody = document.getElementById('myTableBody'); // Use the correct ID for the table body
    const previousRowCount = tbody.getElementsByTagName('tr').length;
    var length=parseInt(previousRowCount)-1;
    if(length==id){
        $("#row"+id).remove();
    }
}
function findDuplicateOrNot(id){
    var serialNumber=$("#serialNumber"+id).val();
    var assetId=$("#assetId").val();
    if(serialNumber!=''){
        $.ajax({
            url : "${contextPath}/ajax/checkDuplicateSerialNumber",
            type : "GET",
            data : {
                "serialNumber" : serialNumber,
                "assetId":assetId
            },
            success : function(data) {
                if(data){
                    $("#serialNumber"+id).val('');
                    bootbox.alert("Serial Number Against this asset already exist");
                    return false;
                }
                const tbody = document.getElementById('myTableBody'); // Use the correct ID for the table body
                const previousRowCount = tbody.getElementsByTagName('tr').length;
                var length=parseInt(previousRowCount)-1;
                for(i=0;i<=length;i++){
                    if(i!=id){
                        var exstSlNo= $("#serialNumber"+i).val();
                        if(exstSlNo==serialNumber){
                            $("#serialNumber"+id).val('');
                            bootbox.alert("Serial Number Against this asset already exist");
                            return false;
                        }
                    }
                }
            },
            error : function(e) {
                alert("Error! " + e);
            }
        });
    }
}
</script>