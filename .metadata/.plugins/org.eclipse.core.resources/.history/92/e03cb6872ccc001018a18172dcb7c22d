<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Inventory Report</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa-solid fa-house"></i></a></li>
				<li class="breadcrumb-item">
					<a href="#">Procurement</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">Inventory Report</li>
			</ol>
		</nav>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<h5 class="card-title">Inventory Report</h5>
			</div>
			<div class="card-body">
				<form method="POST" action="${contextPath}/asset/getInventoryReport" id="form">
					<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
					<input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
					<div class="row">
						<div class="col-md-12">
							<div class="row">
								<div class="form-group col-md-2">
									<label class="inputEmail4 required" for="text">From Date: </label>
									<div class="datepicker_con ${not empty toDate ? 'frezz' : ''}">
										<input type="text" class="form-control form-control-sm datepick_con thisRequiredField from_date" id="fromDate" name="fromDate" value="${fromDate}"  readonly />
									</div>
								</div>
								<div class="form-group col-md-2">
									<label class="inputEmail4 required" for="text">To Date:</label>
									<div class="datepicker_con ${not empty toDate ? 'frezz' : ''}">
										<input type="text" class="form-control form-control-sm datepick_con thisRequiredField to_date" id="toDate" name="toDate" value="${toDate}" readonly />
									</div>
								</div>
								<div class="form-group col-md-2">
									<label class="inputEmail4 required" for="text">Store:</label>
									<select class="form-select ${not empty storeId ? 'frezz' : ''} thisRequiredField" id="storeId" name="storeId" >
                                        <option value="">-Select-</option>
                                        <c:forEach items="${storeList}" var="store">
                                            <option value="${store.storeId}" ${store.storeId eq storeId ? 'selected' : ''}>${store.storeName}</option>
                                        </c:forEach>
                                    </select>
								</div>
								<div class="form-group col-md-3 btn-div" style="margin-top: 20px;">
									<button type="button" class="btn btn-submit" onclick="validateForms()">Filter</button>
									<a type="button" class="btn btn-danger" onclick="backToModule()">Cancel</a>
									<c:if test="${not empty storeId}">
										<a type="button" href="${contextPath}/asset/getInventoryReport" class="btn btn-submit">Reset</a>
									</c:if>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<div class="row mt-3">
	<div class="col-md-12">
	   <div class="card">
            <div class="card-header">
                <h5 class="card-title">Inventory Report List</h5>
            </div>
		   <div class="card-body">
			   <div class="cardcontainer cardContainerNotFirst" style="position: relative;">
			        <div class="row">
                        <c:if test="${not empty inventoryList}">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-submit" style="float:right;width:auto;" onclick="generateReport()">Export to PDF</button>
                            </div>
                        </c:if>
                        <div class="col-md-12">
                            <table class=" table table-striped table-bordered mt-3"  style="text-align:center;">
                               <thead>
                                   <tr>
                                        <th>Sl No.</th>
                                        <th>Item Name</th>
                                        <th>Opn.Qty</th>
                                        <th>Adj.Qty</th>
                                        <th>Recd.Qty</th>
                                        <th>Issue Qty</th>
                                        <th>Close Qty</th>
                                   </tr>
                               </thead>
                               <tbody>
                                    <c:choose>
                                        <c:when test="${not empty inventoryList}">
                                            <c:forEach items="${inventoryList}" var="lst" varStatus="count">
                                                <tr>
                                                    <td>${count.count}</td>
                                                    <td>${lst[0]}</td>
                                                    <td><fmt:formatNumber value="${lst[1]}" type="number" maxFractionDigits="2" minFractionDigits="2" /></td>
                                                    <td><fmt:formatNumber value="${lst[4]}" type="number" maxFractionDigits="2" minFractionDigits="2" /></td>
                                                    <td><fmt:formatNumber value="${lst[2]}" type="number" maxFractionDigits="2" minFractionDigits="2" /></td>
                                                    <td><fmt:formatNumber value="${lst[3]}" type="number" maxFractionDigits="2" minFractionDigits="2" /></td>
                                                    <td>
                                                        <fmt:formatNumber value="${(lst[1] + lst[4] + lst[2] - lst[3]) * 1.0}" type="number" maxFractionDigits="2" minFractionDigits="2" />
                                                    </td>
                                                </tr>
                                            </c:forEach>
                                        </c:when>
                                        <c:otherwise>
                                            <tr>
                                                <td colspan="100%" style="text-align: center;">No Data Available</td>
                                            </tr>
                                        </c:otherwise>
                                    </c:choose>
                               </tbody>
                           </table>
                       </div>
                    </div>
			   </div>
		   </div>
	   </div>
   </div>
</div>
<form  method="post" action="${contextPath}/asset/generateInventoryReport" id="genRpt" target="_blank">
	<input type="hidden" id="storeIdGen" name="storeId"  value="">
	<input type="hidden" id="fromDateGen" name="fromDate"  value="">
	<input type="hidden" id="toDateGen" name="toDate"  value="">
	<input type="hidden" name="status"  value="VIEW">
	<input type="hidden" class="" id="encodedDatagenRpt" name="encodedDatagenRpt" value="" />
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
</form>
<script>
	$(function() {
		$('.from_date').datepick({
    		 dateFormat: 'dd/mm/yyyy', showOnFocus: true,
			 showTrigger: '<button type="button" class="trigger">' +
				'<i class="fa fa-calendar"></i></button>',
             onSelect: function(selectedDate) {
                 var toDate = $('#toDate').datepick('getDate');
                 // Convert selectedDate to a Date object
                 toDate=new Date(toDate);
                 selectedDate = new Date(selectedDate);
                 if (toDate != null && selectedDate > toDate) {
                    bootbox.alert("From Date can not be select after date of To Date");
                    $('#fromDate').val("");
                    return false;
                 }
             }
    	});
    	$('.to_date').datepick({
             dateFormat: 'dd/mm/yyyy', showOnFocus: true,
			 showTrigger: '<button type="button" class="trigger">' +
				'<i class="fa fa-calendar"></i></button>',
             onSelect: function(selectedDate) {
                var fromDate = $('#fromDate').datepick('getDate');
                // Convert selectedDate to a Date object
                 fromDate=new Date(fromDate);
                 selectedDate = new Date(selectedDate);
                 if (fromDate != null && fromDate > selectedDate) {
                    bootbox.alert("To Date can not be selected as previous date of From Date");
                    $('#toDate').val("");
                    return false;
                 }
             }
        });
	});
	var tableOrTbodyID=[];
	var tableOrTbodyKey=[];
	function validateForms(){
		let isRequiredValid=validateRequiredFields("thisRequiredField", 'form');
		if(isRequiredValid){
			encryptFormData("form", tableOrTbodyIDS, tableOrTbodyKeys);
			$("#form").submit();
		}
	}

	function generateReport(){
		var fromDate=$("#fromDate").val();
		var toDate=$("#toDate").val();
		var storeId=$("#storeId").val();
        $("#storeIdGen").val(storeId);
		$("#fromDateGen").val(fromDate);
		$("#toDateGen").val(toDate);
		encryptFormData("genRpt", tableOrTbodyIDS, tableOrTbodyKeys);
		$("#genRpt").submit();
	}
	function backToModule(){
       let currentModuleCode =  localStorage.getItem('currentModuleCode');
       $('#moduleId').val(enc_password(currentModuleCode));
       $('#moduleForm').submit();
    }
</script>