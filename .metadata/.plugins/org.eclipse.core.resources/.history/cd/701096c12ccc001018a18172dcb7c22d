<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<%-- <sec:authentication var="principal" property="principal" /> --%>
<%-- <c:set var="roleCode" value="${principal.primaryRole.roleCode}" /> --%>
<style>
.add-more {
    padding: 0;
    height: 18px;
    width: 18px;
    background: green;
    border: 0px;
    color: #fff;
    line-height: 18px;
    text-align: center;
    border-radius: 50px;
    margin-left: 2px;
    font-size: 9px;
   }
      .main-panel {
    position: fixed;
    top: 67px;
    left: 0px; 
    /* width: calc(100% - 265px); */
    width: 100%;
    height: 100vh;
    transition: 0.5s all;
    padding: 5px;
}

.requiredFieldStarMark {
	color: red;
	font-size: 15px;
}
textarea.form-control {
    min-height: 32px;
}
body:before {
    content: '';
    position: absolute;
    background: transparent;
    width: 100%;
    height: 60px;
    border-radius: 0;
}

th.trkgrnc_th{
	width: 200px;
}

</style>
<div class="container-fluid">
		
	<div class="breadcrumb_conatiner mt-4">
		<div class="col-md-6">
			<h4 class="change-color">Add Grievance</h4>
		</div>
		<div class="col-md-6">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
					<li class="breadcrumb-item active" aria-current="page">Add Grievance</li>
				</ol>
			</nav>
		</div>
	</div>
		
	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<h5 class="card-title">Add Grievance</h5>
				</div>
				<div class="card-body">
					
					<div class="card-body">
					    <div class="row">
                            <form action="${contextPath}/public/saveGrievance" id="grievenceId" class="row" enctype="multipart/form-data" method="post" >
                                <input type="hidden" name="${_csrf.parameterName}"value="${_csrf.token}" />
                                <!-- <input type="hidden" name="securityId" value="${securityId}" id="securityId" />  -->
                                <input type="hidden" name="grvId" value="${grvId}" id="grvId"  />
                                <input type="hidden" name="errorCategoryId" value="${err.errorCategoryId}" id="errorCategoryId"  />
                                <input type="hidden" name="categoryCode"  id="categoryCode"  />
                                <input type="hidden" name="errorType.errorTypeId"/>

                                <div class="col-md-3" id="">
                                    <div class="form-group">
                                        <label class="required">Grievance To</label>
                                        <div class="">
                                            <select name="objectIdAndType" class="form-control form-control-sm " required="required" id="orgIdAndOrgLevel" onchange="getStageButtonReset()">
                                                <option value="">--Select--</option>
                                                <c:forEach items="${level}" var="err">
                                                    <option value="${err.combineTwo}" ${err.combineTwo eq  errorCategoryId ?'selected':''}>${err.organizationName}</option>
                                                </c:forEach>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-3" id="errorTypeDiv">
                                    <div class="form-group">
                                        <label class="required">Grievance Category </label>
                                        <div class="">
                                            <select name="errorCategoryId" id="errorType"
                                                class="form-control form-control-sm " required="required"  onchange="getCategoryDescByErrorCategoryId(this.value);">
                                                <option value="">--Select--</option>
                                                <c:forEach items="${error}" var="err">
                                                    <option value="${err.errorCategoryId}"
                                                        ${err.errorCategoryId eq  errorCategoryId ?'selected':''}>${err.categoryType}</option>
                                                </c:forEach>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="required">Grievance Sub Category</label>
                                        <div class="">
                                            <select class="form-control form-control-sm getStageButtonsOnForm" name="errorMapGrievance.errorCategoryMapId" id="errorCategoryMapId" onchange="">
                                                <option value="">select</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="required ">Complainant Name</label>
                                        <input type="text" name="complainantName" rows="2" cols="20" id="complainantName"
                                        class="form-control form-control-sm " maxlength="50" required="required" value="${grievance.complainantName}">
                                    </div>
                                </div>


                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="required ">Email Id</label>
                                        <input name="emailId" id="emailId" class="form-control form-control-sm" maxlength="50" required="required">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="required ">Contact No</label>
                                        <input name="contactNo" id="contactNo" class="form-control form-control-sm NumbersOnly" maxlength="10" required="required">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="required">Identity Proof</label>
                                        <input name ="identityCard" id ="identityCardPath" type="file" class="form-control form-control-sm" onchange="imagePDFCheck(this);">
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="required">Remarks</label>
                                        <textarea name="remarks" rows="2" cols="20" id="editor" class="form-control" maxlength="200" required="required"></textarea>
                                            <!-- <div name="remarks" id="editor"></div> -->
                                    </div>
                                </div>
                                <div class="col-md-12" >
                                    <div class="row align-items-end" id="existingElement">
                                    <div class="col-md-3 form-group" style="position:relative;">
                                        <label class="smallInput" for="">Grievance Related Document:</label>
                                        <button onclick="appendBut()" type="button" class="btn-submit" style="position: absolute; top: 21px; right: 14px; padding: 3px 6px !important;"><i class="fa-solid fa-plus"></i></button>
                                        <input type="file" class="form-control form-control-sm inputPathName" id="filePath" onchange = "checkPdfFmt('','0');imagePDFCheck(this);" name="grievenceDocList[0].grvDocWeb">
                                    </div>
                                            <!-- <div class="form-group  col-lg-3">
                                                    <label class="smallInput" for="">Attachment :</label>
                                                    <button onclick="appendBut()" type="button" class="btn btn-sm btn-success" style="position:absolute; top:21px;right:0;">+</button>
                                                    <i class="fa fa-minus remove-img" id="minus${count.count-1}"></i>
                                                <input type="file" class="form-control inputPathName" id="grvDocWeb${count.count-1}" onchange = "checkPdfFmt(${count.count-1})" name="grievenceDocList[0].grvDocWeb" >
                                            </div>  -->
                                        </div>
                                </div>
                                <!-- <div class="col-md-12 text-center" style="padding: 30px 0;">
                                    <button type="button" onclick="" class="btn btn-sm btn-submit">Submit</button>
                                    <a href="${contextPath}/public/addGrievance" class="btn btn-sm btn-warning">Back</a>
                                </div> -->

                                <div class="row mt-3">
                                    <div class="col-md-12 d-flex gap-2 justify-content-center">
                                        <div class="d-flex gap-2" id="ajaxDynamicButtonsId">


                                        </div>
                                        <button type="button" class="btn btn-warning no-print unfreezeField back" onclick="goBack();">Back</button>
                                    </div>
                                </div>
                            </form>
                        </div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- A search input to search via token -->
	<div class="row mt-3">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<h5 class="card-title">Track Grievance</h5>
				</div>
				<div class="card-body">
					<div class="row">
					<div class="col-md-3">
						<div class="form-group">
							<input type="text" class="form-control" id="searchToken" placeholder="Search by token">
						</div>
					</div>
					<div class="col-md-3">
						<div class="form-group">
							<button type="button" class="btn btn-primary" onclick="searchTokenBtn()">Search</button>
						</div>
					</div>
					</div>
					<div class="col-md-12">
						<div class="card" id="data">
							<div class="card-body">
								<div class="row">
									<div class="col-md-6">
										<table class="table table-borderless">
											<tr>
												<th class="trkgrnc_th">Token No.</th>
												<td id="tokenNo"></td>
											</tr>
											<tr>
												<th class="trkgrnc_th">Issued Date</th>
												<td id="issueDate"></td> 
											</tr>
											<tr>
												<th class="trkgrnc_th">Category Name</th>
												<td id="category"></td> 
											</tr>
											<tr>
												<th class="trkgrnc_th">Sub Category Name</th>
												<td id="subCategory"></td> 
											</tr>
											
									</table>
									</div>
									<div class="col-md-6">
										<table class="table table-borderless">
											<tr>
												<th class="trkgrnc_th">Complaint Name</th>
												<td id="complaintName"></td>
											</tr>
											<tr>
												<th class="trkgrnc_th">Contact No</th>
												<td id="contact" ></td>
											</tr>
											<tr>
												<th class="trkgrnc_th">Email Id</th>
												<td id="email"></td>
											</tr>
											<tr>
												<th class="trkgrnc_th">Status</th>
												<td id="status"></td>
											</tr>
									</table>
									</div>
									<div class="col-md-12 text-center">
										<button type="button" class="btn btn-primary" title="History" data-bs-toggle="modal" data-bs-target="#trackRecord">
											<i class="fa-solid fa-route"></i>
											Track
										</button>
									</div>
								</div>
								
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<div class="modal fade" id="trackRecord" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
	  <div class="modal-content">
		<div class="modal-header">
		  <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body">
		  <div class="table-responsive">
			<table class=" table table-striped table-bordered ">
				<thead>
					<tr>
						<th>Sl No.</th>
						<th>Action</th>
						<th>Action Date</th>
					</tr>
				</thead>
				<tbody id="trackBody">
					
				</tbody>
			</table>
		  </div>
		</div>
	  </div>
	</div>
  </div>

<script>

$(document).ready(function(){
	$("#data").hide();
});
// ClassicEditor.create(document.querySelector("#editor")).catch((error) => {
//     console.error(error);
//     });


	
	var count=0;
	function appendBut() {
		debugger;
	    count++;
	    var supportDocumentHtml = '<div class="col-md-3 form-group mt-2" style="position:relative;">' +
	                                '<input type="file"  class="form-control form-control-sm" id="filePath' + count + '" name="grievenceDocList[' + count + '].grvDocWeb">' +
	                                '<button class="btn btn-sm btn-danger removeButton" style="position:absolute;top: 2px;right: 13px;padding: 6px 6px;"><i class="fa fa-trash"></i></button>' +
	                              '</div>';
	
	    $('#existingElement').append(supportDocumentHtml);
	}


// Use event delegation for dynamically added elements
$('#existingElement').on('click', '.removeButton', function() {
  // Remove the clicked form group
  $(this).closest('.form-group').remove();
});





function numbersOnly(value){
	debugger;
	const numberRegex = /^\d+$/;
	const alphabeticRegex = /^[A-Za-z]+$/;
	if(!numberRegex.test(value) && alphabeticRegex.test(value)){
		$("#affectedBen").val('');
	}
	
}


function isPdfOrJpg(file) {
    const allowedTypes = ["application/pdf", "image/jpeg", "image/jpg", "application/vnd.ms-excel", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"];
    return allowedTypes.includes(file.type);
}

function submitFormData(stageId) {
	debugger;
    var documentFiles = $("#filePath").prop('files');
  //  var invalidFiles = [];
    var documentFiless = document.getElementsByClassName('inputPathName')
    var errorType = $("#errorType").val();
    var email = $("#emailId").val();
    var userType = $("#userType").val();
    var errorCategoryMapId = $("#errorCategoryMapId").val();
    var sectorId = $("#sectorId").val();
    var fileInputs = document.getElementsByClassName('inputFileName');
    var isValid = false;
    
    if ($("#errorType").val() === "") {
        bootbox.alert("Please Select Grievance Category");
        return false;
    }  
    if (errorCategoryMapId === "" || errorCategoryMapId === null || errorCategoryMapId === 0) {
        bootbox.alert("Please Select  Grievance Sub-Category");
        return false;
    } 
    if ($("#complainantName").val() == "") {
        bootbox.alert("Please Enter Complainant Name");
        return false;
    }
    if ($("#contactNo").val() == "") {
        bootbox.alert("Please Enter Contact No");
        return false;
    }
    if (email === '') {
        bootbox.alert('Please provide an Email address.');
        return false;
    		} else if (!validateEmail(email)) {
    			debugger;
        bootbox.alert('Please provide a valid Email address.');
        return false;
    		}
    if ($("#identityCardPath").val() == "" ) {
		bootbox.alert("Please Attach Identity Proof");
		return false;
		}
    else if ($("#editor").val() == "") {
        bootbox.alert("Please Enter The Remark.");
        return false;
    }
       else {

		bootbox.confirm({
			message : "Are you sure you want to submit?",
			buttons : {
				confirm : {
					label : 'Yes',
					className : 'btn-success'
				},
				cancel : {
					label : 'No',
					className : 'btn-danger'
				}
			},
			callback : function(result) {
				if (result) {
					saveWorkFlowStage("grievenceId", stageId);
        			$('#grievenceId').submit();
				}
			}
		});

		
    }
}
function validateEmail(email) {
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
		</script>
		

  <script>

	function checkPdfFmt(input, index) {
	    if (index === '0') {
	        if (confirm("This attachment cannot be deleted after submit. Are you sure you want to continue?")) {
	        } else {
	            input.value = '';
	        }
	    }
	}
	function getCategoryDescByErrorCategoryId(errorCategoryId) {
		if (errorCategoryId != '') {
			$.ajax({
						type : "GET",
						url : '${contextPath}/public/findGrvDescrTypeListByCategoryId',
						dataType : "json",
						data : {
							"errorCategoryId" : errorCategoryId,
						},
						success : function(response) {
							var html = "<option  value='' selected>-Select-</option>";
							var data = response;
							if (data != "" && data != null && data.length > 0) {
								$.each(data,function(index, value) {
									html = html + "<option  value="+value.errorCategoryMapId+">"+ value.categoryDescType+ "</option>";
								});
							}
							$('#errorCategoryMapId').empty().append(html);
							$('#errorCategoryId').empty().append(html);
//	 						$('#awhName').val(employeeName);
						},
						error : function(error) {
							bootbox.alert("CategoryDescType list not found");
						}
					});
		} else {
			bootbox.alert("Please Select CategoryType")
			return false;
		}
	}

	function searchTokenBtn(){
		var searchToken = $("#searchToken").val();
		$("#data").hide();
		$("#trackBody").empty();

		if(searchToken != ''){
			$.ajax({
				type : "GET",
				url : '${contextPath}/public/searchToken',
				dataType : "json",
				data : {
					"searchToken" : searchToken,
				},
				success : function(response) {
					if(response.result){
						$("#data").show();
						$("#tokenNo").text(response.token);
						$("#status").text(response.status);
						$("#contact").text(response.contact);
						$("#email").text(response.email);
						$("#issueDate").text(response.issueDate);
						$("#category").text(response.category);
						$("#subCategory").text(response.subCategory);
						$("#complaintName").text(response.complaintName);
						if (Array.isArray(response.history)) {
							response.history.forEach(function(item,count) {
								var row = '<tr>'+
									'<td>'+(count+1)+'</td>'+
									'<td>'+item.stage+'</td>'+
									'<td> '+item.date+'</td>'+
								'</tr>';
								$("#trackBody").append(row);
							});
						}
					}else{
						bootbox.alert("Data not found against this token No.");
						return false;
					}
					

				},
				error : function(error) {
					bootbox.alert("No data found");
				}
			});
		} else{
			bootbox.alert("Please enter token no");
		}
	}



	function getStageButtonReset(){
		var html='<option value="">--Select--</option>';
		$("#errorType").val("");
		$("#errorCategoryMapId").empty().append(html);
		$("#ajaxDynamicButtonsId").empty();

	}
	
	</script>