<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
	<c:set var="userDetails" value="${serviceOutcome.data}"/> 
<sec:authentication var="principal" property="principal" />
<c:set var="roleCode" value="${principal.primaryRole.roleCode}" />

<style>
.mandotory::before {
  content: '* '; /* Display an asterisk followed by a space before the header text */
  color: red;    /* Optionally, set the color to red or any other desired color */
}

.required::before {
  content: '* '; /* Display an asterisk followed by a space before the header text */
  color: red;    /* Optionally, set the color to red or any other desired color */
}
.disabled-dropdown {
    pointer-events: none;
    background-color: #eee; /* Optional: Change the background color to visually indicate it's disabled */
}

.mandatory-field {
    border: 1px solid #b3432f;
/*     background-color: #ffb2a8; /* Adjust the background color as needed */ */
}

	.hidden {
    display: none;
}

</style>	
		<div class="breadcrumb_conatiner">
<!--               <div class="col-md-6"> -->
<!--                 <h4 class="change-color">Staff PAR</h4> -->
<!--               </div> -->
              <div class="col-md-12">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="${contextPath}/home">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                      <a href="#">Human Resource</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Vacancy Approval</li>
                  </ol>
                </nav>
              </div>
            </div>

					<div class="row">
<!-- 						<div class="col-md-12"> -->
					
<!-- 							<div class="card"> -->
<!-- 								<div class="card-header"> -->
<!-- 									<h5 class="card-title">Vacancy Approval</h5> -->
<!-- 								</div> -->
<!-- 								<div class="card-body"> -->
<%-- <%-- 									<%@ include file="/WEB-INF/views/message.jsp"%> --%> --%>
<!-- 										<div class="col-lg-12 mt-3"> -->
<!-- 										    <input type="hidden" id="tabId" value=""/> -->
<!-- 										    <ul class="nav nav-tabs " id="myTabs" role="tablist"> -->
<%-- 										         <c:if test="${level eq 'CORPORATE'}"> --%>
<!-- 										             <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'ownCreation' ? 'active':''}" id="ownCreation" data-toggle="tab" href="#ownCreation" onclick="filterData('ownCreation')">Created By Corp-Admin</a> --%>
<!-- 											        </li> -->
<!-- 											         <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'pending' || tabStatusId eq '' ? 'active':''}" id="pending" data-toggle="tab" href="#pending" onclick="filterData('pending')">Pending</a> --%>
<!-- 											        </li> -->
<%-- 										         </c:if> --%>
<%-- 										          <c:if test="${level ne 'CORPORATE'}"> --%>
<!-- 										            <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'draft' || tabStatusId eq '' ? 'active':''}" id="draft" data-toggle="tab" href="#draft" onclick="filterData('draft')">Draft</a> --%>
<!-- 											        </li> -->
<!-- 											         <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'pending' || tabStatusId eq '' ? 'active':''}" id="pending" data-toggle="tab" href="#pending" onclick="filterData('pending')">In-Progress</a> --%>
<!-- 											        </li> -->
<%-- 											      </c:if> --%>
<!-- 											        <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'approved' ? 'active':''}" id="approved" data-toggle="tab" href="#approved" onclick="filterData('approved')">Approved</a> --%>
<!-- 											        </li> -->
<!-- 											        <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'rejected' ? 'active':''}" id="rejected" data-toggle="tab" href="#rejected" onclick="filterData('rejected')">Rejected</a> --%>
<!-- 											        </li> -->
<!-- 											        <li class="nav-item"> -->
<%-- 											            <a class="nav-link ${tabStatusId eq 'published' ? 'active':''}" id="rejected" data-toggle="tab" href="#published" onclick="filterData('published')">Published</a> --%>
<!-- 											        </li> -->
<!-- 										   	 </ul> -->
<!-- 										</div> -->
<!-- 								</div> -->
<!-- 								<div class="row"> -->
<!-- 									<div class="col-md-12 mb-5"> -->
<!-- 										<div class="table-responsive"> -->
<!-- 											<table class="table table-bordered" id="workplanrow"> -->
<!-- 											   <thead> -->
<!-- 											      <tr> -->
<!-- 											        <th>Sl No.</th> -->
<!-- 											        <th>Vacancy Code</th> -->
<!-- 											        <th>Designation</th> -->
<!-- 											        <th>No. of Vacancy</th> -->
<!-- 											        <th>Vacancy Created By</th> -->
<!-- 											        <th>Published Date</th> -->
<!-- 											        <th>Application Deadline</th> -->
<%-- 											        <c:if test="${tabStatusId eq 'draft'  && level ne 'CORPORATE'}"> --%>
<!-- 											        <th>Update</th> -->
<%-- 											        </c:if> --%>
<%-- 											        <c:if test="${tabStatusId eq 'approved'  && level ne 'CORPORATE'}"> --%>
<!-- 											        <th>Publish Action</th> -->
<%-- 											        </c:if> --%>
<%-- 											        <c:if test="${tabStatusId eq 'ownCreation'  && level eq 'CORPORATE'}"> --%>
<!-- 											        <th>Publish Action</th> -->
<%-- 											        </c:if> --%>
<%-- 											        <c:if test="${tabStatusId eq 'pending'  && level eq 'CORPORATE'}"> --%>
<!-- 											         <th>Action -->
<!-- 											           <input type="checkbox" id="selectAll" /> -->
<!-- 											         </th> -->
<%-- 											        </c:if> --%>
<%-- 											         <c:if test="${tabStatusId eq 'draft'  && level ne 'CORPORATE'}"> --%>
<!-- 											          <th>Action -->
<!-- 											            <input type="checkbox" id="selectAll" /> -->
<!-- 											          </th> -->
<%-- 											         </c:if> --%>
<!-- 											      </tr> -->
<!-- 											   </thead> -->
<!-- 											   <tbody> -->
<%-- 											     <c:forEach items="${vacancyList}" var="vac" varStatus="count"> --%>
<!-- 											        <tr> -->
<%-- 											          <td>${count.count}</td> --%>
<%-- 											          <td>${vac.vacancyCode}</td> --%>
<%-- 											          <td>${vac.roleId.displayName}</td> --%>
<%-- 											          <td>${vac.noOfVacancy}</td> --%>
<%-- 											          <td>${vac.vacCreatedBy.firstName}</td> --%>
<!-- 											          <td> -->
<%-- 													    <c:choose> --%>
<%-- 													        <c:when test="${not empty vac.publicationDate}"> --%>
<%-- 													            <fmt:formatDate value="${vac.publicationDate}" pattern="dd/MM/yyyy" /> --%>
<%-- 													        </c:when> --%>
<%-- 													        <c:otherwise> --%>
<!-- 													            NA -->
<%-- 													        </c:otherwise> --%>
<%-- 													    </c:choose> --%>
<!-- 													</td> -->
<!-- 													<td> -->
<%-- 													    <c:choose> --%>
<%-- 													        <c:when test="${not empty vac.applicationDeadline}"> --%>
<%-- 													            <fmt:formatDate value="${vac.applicationDeadline}" pattern="dd/MM/yyyy" /> --%>
<%-- 													        </c:when> --%>
<%-- 													        <c:otherwise> --%>
<!-- 													            NA -->
<%-- 													        </c:otherwise> --%>
<%-- 													    </c:choose> --%>
<!-- 													</td> -->
<%-- 													<c:if test="${tabStatusId eq 'draft'  && level ne 'CORPORATE'}"> --%>
<!-- 													 <td> -->
<%-- 			                            		         <button title="Edit" type="button" onclick="getVacancyById('${vac.vacancyId}')" class="btn btn-xs btn-warning"> --%>
<!-- 																<i class="fas fa-edit"></i> -->
<!-- 														 </button> -->
<!-- 												 	  </td> -->
<%-- 												 	 </c:if> --%>
<%-- 												 	   <c:if test="${tabStatusId eq 'approved' && level ne 'CORPORATE' && (vac.isPublished eq false || vac.isPublished eq null)}"> --%>
<!-- 												 	    <td> -->
<%-- 														    <button type="button" class="btn btn-primary" title="Publish" onclick="publishModal(${vac.vacancyId})"> --%>
<!-- 															    <i class="fas fa-upload"></i>  -->
<!-- 															</button> -->
<!-- 													    </td> -->
<%-- 														</c:if> --%>
<%-- 														<c:if test="${tabStatusId eq 'approved' && level ne 'CORPORATE' && vac.isPublished eq true}"> --%>
<!-- 												 	    <td> -->
<%-- 														    Already published on (<fmt:formatDate value="${vac.publicationDate}" pattern="dd/MM/yyyy" />) --%>
<!-- 													    </td> -->
<%-- 														</c:if> --%>
<%-- 														<c:if test="${tabStatusId eq 'ownCreation' && level eq 'CORPORATE' && (vac.isPublished eq false || vac.isPublished eq null)}"> --%>
<!-- 												 	    <td> -->
<%-- 														    <button type="button" class="btn btn-primary" title="Publish" onclick="publishModal(${vac.vacancyId})"> --%>
<!-- 															    <i class="fas fa-upload"></i>  -->
<!-- 															</button> -->
<!-- 													    </td> -->
<%-- 														</c:if> --%>
<%-- 														<c:if test="${tabStatusId eq 'ownCreation' && level eq 'CORPORATE' && vac.isPublished eq true}"> --%>
<!-- 												 	    <td> -->
<%-- 														    Already published on (<fmt:formatDate value="${vac.publicationDate}" pattern="dd/MM/yyyy" />) --%>
<!-- 													    </td> -->
<%-- 													    </c:if> --%>
<%-- 													 <c:if test="${tabStatusId eq 'pending'  && level eq 'CORPORATE'}"> --%>
<!-- 												      <td> -->
<%--                                                            <input type="checkbox" class="x-check" id="empCheckBox${count.count}" value="${vac.vacancyId}" > --%>
<!--                                                       </td> -->
<%-- 												     </c:if> --%>
<%-- 												     <c:if test="${tabStatusId eq 'draft'  && level ne 'CORPORATE'}"> --%>
<!-- 												      <td> -->
<%--                                                            <input type="checkbox" class="x-check" id="empCheckBox${count.count}" value="${vac.vacancyId}" > --%>
<!--                                                       </td> -->
<%-- 												     </c:if> --%>
<!-- 											        </tr> -->
<%-- 											     </c:forEach> --%>
<!-- 											   </tbody> -->
<!-- 											</table> -->
<!-- 											</div> -->
<!-- 										</div> -->
<!-- 									   </div> -->
<!-- 									 <div class="col-md-12 text-center"> -->
<!-- 										<div class="form-group"> -->
<!-- 											<div class="col-md-12"> -->
<%-- 											 <c:if test="${(level ne 'CORPORATE') && (tabStatusId eq 'draft') && (not empty vacancyList)}"> --%>
<!-- 											      <button type="button" class="btn btn-primary" onclick="takeAction('sendForVerification')">Send For Verification</button> -->
<%-- 											 </c:if> --%>
<%-- 											 <c:if test="${(level eq 'CORPORATE') && (tabStatusId eq 'pending') && (not empty vacancyList)}"> --%>
<!-- 										 			<button type="button" class="btn btn-danger" onclick="takeAction('reject')">Reject</button> -->
<!-- 													<button type="button" class="btn btn-primary" onclick="takeAction('approve')">Approve</button> -->
<%-- 											</c:if> --%>
<%-- 											<a href="${contextPath}/home" class="btn btn-danger" style="margin-top: 0px;">Back</a> --%>
<!-- 										</div> -->
<!-- 									</div> -->
<!-- 							</div> -->
<!-- 						</div> -->
<!-- 					</div> -->
					
					<!-- Modal -->
					<div class="modal" id="publishModal" tabindex="-1" role="dialog">
					    <div class="modal-dialog">
					        <div class="modal-content">
					            <div class="modal-header">
					                <h5 class="modal-title" id="publishModalLabel">Publish Vacancy</h5>
					                <!-- Close button (X) -->
					                <button type="button" class="close modalClose" data-dismiss="modal" aria-label="Close">
							          <span aria-hidden="true">&times;</span>
							        </button>
					            </div>
					            <div class="modal-body">
					                <form id="publishForm">
					                    <div class="form-group datepicker_con">
					                        <label for="publishDate" class="form-label">Publish Date</label>
					                        <input type="text" class="form-control" id="publicationDate" name="publicationDate" required readonly>
					                    </div>
					                    <div class="form-group datepicker_con">
					                        <label for="applicationDeadline" class="form-label">Application Deadline</label>
					                        <input type="text" class="form-control" id="applicationDeadline" name="applicationDeadline" required readonly>
					                    </div>
					                </form>
					            </div>
					            <div class="modal-footer">
					                <!-- Close button -->
					                <button type="button" class="btn btn-secondary modalClose" data-bs-dismiss="modal">Close</button>
					                <!-- Publish button -->
					                <button type="button" form="publishForm" class="btn btn-primary" onclick="publishVac()">Publish</button>
					            </div>
					        </div>
					    </div>
					</div>


  </body>
</html>
<form action="${contextPath}/vaccancy/getVacancyList" method="POST" id="getVacancyList">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="tabStatusId" name="tabStatusId">
</form>


<form action="${contextPath}/vaccancy/setStageId" method="POST" id="setStageId">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="hdnVacIds" name="hdnVacIds">
	<input type="hidden" id="hdnStageStatus" name="hdnStageStatus">
	<input type="hidden" id="hdnRemarks" name="hdnRemarks">
</form>

<form action="${contextPath}/vaccancy/editVacancyDetails" method="post" id="editVacancyDetails">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="hiddenVacId"  id="hiddenVacId" value="">
</form>

<form action="${contextPath}/vaccancy/publishVacancy" method="post" id="publishVacancy">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="hiddenVacIdP"  id="hiddenVacIdP" value="">
	<input type="hidden" name="publishDate"  id="publishDate" value="">
	<input type="hidden" name="deadLineDate"  id="deadLineDate" value="">
</form>
<script>

function filterData(tabStatus){
	debugger
	if(tabStatus!=null && tabStatus!=''){
		$("#tabStatusId").val(tabStatus);
		$("#getVacancyList").submit();
	   
	}
}

function takeAction(stageStatus){
	debugger
	var confMsg='';
	 var checked = [];
	 var myElements = document.getElementsByClassName("x-check");
	 var checkboxes =  $('input:checkbox:checked').length;
	 if(checkboxes==0){
		 bootbox.alert("Please select atleast one vacancy."); 
		return false;
	 }else{
		    for (var i = 1; i <= myElements.length; i++) {
			    if ($("#empCheckBox" + (i)).prop('checked') == true) {
			        checked.push(parseInt($("#empCheckBox" + (i)).val()));
			    }
			}
	 }
	 
	 if(checked.length==0){
    	 bootbox.alert("Please select atleast 1 record."); 
 		return false;
     }else{
    	 $("#hdnVacIds").val(checked.toString());
       	 $("#hdnStageStatus").val(stageStatus.toString());
       	 
 		   bootbox.confirm({
 			    message: "Are you absolutely certain about taking this step? Your action will be irreversible!",
 			    buttons: {
 			        confirm: {
 			            label: 'Yes',
 			            className: 'btn-success'
 			        },
 			        cancel: {
 			            label: 'No',
 			            className: 'btn-danger'
 			        }
 			    },
 			    callback: function (result) {
 			    	if(result == true){
 			    	$("#setStageId").submit();
 			    	}
 			    }
 			}); 
        }
}  

$('.x-check').change(function() {
    handleCheckboxChange();
});

$('#selectAll').click(function(e) {
    var table = $(e.target).closest('table');
    $('td input:checkbox', table).prop('checked', this.checked);
    $('td input.isFreezed', table).prop('checked', false);
});

function handleCheckboxChange() {
    var allCheckboxes = $('.x-check');
    var selectAllCheckbox = $('#selectAll');
    selectAllCheckbox.prop('checked', allCheckboxes.length === allCheckboxes.filter(':checked').length);
}  

function getVacancyById(vacId){
	debugger
	 $("#hiddenVacId").val(vacId);
	 $("#editVacancyDetails").submit();
}

function publishModal(idforPub){
	debugger
	$("#publishModal").show();
	$("#hiddenVacIdP").val(idforPub);
}

	function publishVac() {
	    if ($("#publicationDate").val().trim() == '') {
	    	bootbox.alert("Publication Date is required when the job is published.");
	        return false;
	    }
	
	    if ($("#publicationDate").val().trim() != '' && $("#applicationDeadline").val().trim() == '') {
	    	bootbox.alert("Application Deadline is required when Publication Date is set.");
	        return false;
	    }
	
	    // Validate that publication date is less than or equal to application deadline
	    const publicationDateValue = $("#publicationDate").val().trim();
	    const applicationDeadlineValue = $("#applicationDeadline").val().trim();
	
	    if (publicationDateValue !== '' && applicationDeadlineValue !== '') {
	        const publicationDate = parseDate(publicationDateValue);
	        const applicationDeadline = parseDate(applicationDeadlineValue);
	
	        if (publicationDate > applicationDeadline) {
	        	bootbox.alert("Publication Date cannot be greater than the Application Deadline.");
	            $("#publicationDate").focus();
	            return false;
	        }
	    }
	
	    // Confirmation before submitting the form
		   const confirmation = confirm(
	        "You are about to publish this vacancy. Ensure all details are correct before proceeding.\n\n" +
	        "Publication Date: " + publicationDateValue + "\n" +
	        "Application Deadline: " + applicationDeadlineValue + "\n\n" +
	        "Do you want to continue?"
	      );
	    if (confirmation) {
	        $("#publishDate").val($("#publicationDate").val());
	        $("#deadLineDate").val($("#applicationDeadline").val());
	        $("#publishVacancy").submit();
	    } else {
	        return false;
	    }
	}


function parseDate(input) {
    const parts = input.split('/'); // Split by "/"
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1; // Months are 0-based in JavaScript
    const year = parseInt(parts[2], 10);

    return new Date(year, month, day);
}


$('.modalClose').on('click',function(){
	$('#publishModal').hide();
});
</script>