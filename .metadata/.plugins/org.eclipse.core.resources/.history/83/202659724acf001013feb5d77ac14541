package com.aashdit.construction.service;

import java.io.IOException;
import java.util.Collections;
import java.util.List;
import java.util.ResourceBundle;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.aashdit.prod.heads.common.dto.LookupValueDTO;
import com.aashdit.prod.heads.common.model.Block;
import com.aashdit.prod.heads.common.model.CommonLookupValue;
import com.aashdit.prod.heads.common.model.District;
import com.aashdit.prod.heads.common.model.FinancialYear;
import com.aashdit.prod.heads.common.model.Grampanchayat;
import com.aashdit.prod.heads.common.model.Municipality;
import com.aashdit.prod.heads.common.model.State;
import com.aashdit.prod.heads.common.model.Village;
import com.aashdit.prod.heads.common.model.Ward;
import com.aashdit.prod.heads.common.repository.BlockRepository;
import com.aashdit.prod.heads.common.repository.CommonLookupValueRepository;
import com.aashdit.prod.heads.common.repository.DistrictRepository;
import com.aashdit.prod.heads.common.repository.FinancialYearRepository;
import com.aashdit.prod.heads.common.repository.GrampanchayatRepository;
import com.aashdit.prod.heads.common.repository.MunicipalityRepository;
import com.aashdit.prod.heads.common.repository.StateRepository;
import com.aashdit.prod.heads.common.repository.VillageRepository;
import com.aashdit.prod.heads.common.repository.WardRepository;
import com.aashdit.prod.heads.common.utils.LookupValueMapper;
import com.aashdit.prod.heads.framework.core.ServiceOutcome;
import com.aashdit.prod.heads.framework.core.util.UploadFile;

import lombok.extern.slf4j.Slf4j;

@Service
@Slf4j
public class MasterCommonServiceImpl implements MasterCommonService {
	
	@Autowired
    private StateRepository stateRepository;

	@Autowired
	private DistrictRepository districtRepository;

	@Autowired
	private BlockRepository blockRepository;

	@Autowired
	private GrampanchayatRepository grampanchayatRepository;
	
	@Autowired
	private VillageRepository villageRepository;
	
	@Autowired
	private MunicipalityRepository municipalityRepository;
	
	@Autowired
	private WardRepository wardRepository;
	
	@Autowired
	private FinancialYearRepository financialYearRepository;
	
	@Autowired
    private LookupValueMapper lookupValueMapper;
	
	@Autowired
	private CommonLookupValueRepository commonLookupValueRepository;
	
    ResourceBundle rb = ResourceBundle.getBundle("application");
	
	@Override
    public ServiceOutcome<List<State>> getAllActiveStatesIdAndName() {
        ServiceOutcome<List<State>> outcome = new ServiceOutcome<>();
        try {
            List<State> states = stateRepository.findAllByIsActiveTrue()
                    .stream()
                    .map(entity -> {
                        State dto = new State();
                        dto.setStateId(entity.getStateId());
                        dto.setStateName(entity.getStateName());
                        return dto;
                    })
                    .collect(Collectors.toList());
            outcome.setData(states);
            outcome.setOutcome(true);
            outcome.setMessage("States fetched successfully");
        } catch (Exception e) {
        	log.error("Exception occured in getAllActiveStatesIdAndName() of MasterCommonServiceImpl" + e.getMessage());
        	e.printStackTrace();
        	outcome.setData(List.of());
            outcome.setOutcome(false);
            outcome.setMessage("Failed to fetch states: " + e.getMessage());
        }
        return outcome;
    }
  
  	@Override
	public ServiceOutcome<List<District>> getAllActiveDistrictIdAndName() {
		ServiceOutcome<List<District>> outcome = new ServiceOutcome<>();
		try {
			List<District> districtDropDownList = districtRepository.findAllByIsActiveTrue();
			List<District> DistrictList = districtDropDownList.stream().map(district -> {
				District dto = new District();
				dto.setDistrictId(district.getDistrictId());
				dto.setDistrictName(district.getDistrictName());
				return dto;
			}).collect(Collectors.toList());

			outcome.setData(DistrictList);
		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveDistrictIdAndName() of MasterCommonServiceImpl"+ e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}
  
    @Override
    public ServiceOutcome<List<District>> getAllActiveDistrictsIdAndNameByState(Long stateId) {
        ServiceOutcome<List<District>> outcome = new ServiceOutcome<>();
        try {
        	List<District> districtsList = districtRepository.findAllByStateIdStateIdAndIsActiveTrue(stateId);
            List<District> districtDropDownList = districtsList.stream()
                    .map(entity -> {
                    	District dto = new District();
                        dto.setDistrictId(entity.getDistrictId());
                        dto.setDistrictName(entity.getDistrictName());
                        return dto;
                    })
                    .collect(Collectors.toList());
            outcome.setData(districtDropDownList);
            outcome.setOutcome(true);
            outcome.setMessage("Districts fetched successfully");
        } catch (Exception e) {
        	log.error("Exception occured in getAllActiveDistrictsIdAndNameByState() of MasterCommonServiceImpl" + e.getMessage());
        	e.printStackTrace();
            outcome.setData(List.of());
            outcome.setOutcome(false);
            outcome.setMessage("Failed to fetch districts: " + e.getMessage());
        }
        return outcome;
    }

	@Override
	public ServiceOutcome<List<Block>> getAllActiveBlockIdAndNameByDistrict(Long districtId) {
		ServiceOutcome<List<Block>> outcome = new ServiceOutcome<>();
		try {
			List<Block> blockDropDownList = blockRepository.findAllByDistrictDistrictIdAndIsActiveTrue(districtId);
			List<Block> BlockList = blockDropDownList.stream().map(block -> {
				Block dto = new Block();
				dto.setBlockId(block.getBlockId());
				dto.setBlockNameEN(block.getBlockNameEN());
				return dto;
			}).collect(Collectors.toList());

			outcome.setData(BlockList);
		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveBlockIdAndNameByDistrict of MasterCommonServiceImpl" + e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}
	
	@Override
	public ServiceOutcome<List<Municipality>> getAllActiveMunicipalityIdAndNameByDistrict(Long districtId) {
		ServiceOutcome<List<Municipality>> outcome = new ServiceOutcome<>();
		try {
			List<Municipality> municipalityDropDownList = municipalityRepository.findAllByDistrictDistrictIdAndIsActiveTrue(districtId);
			List<Municipality> municipalityDownDtoList = municipalityDropDownList.stream().map(municipality -> {
				Municipality dto = new Municipality();
				dto.setMunicipalityId(municipality.getMunicipalityId());
				dto.setMunicipalityName(municipality.getMunicipalityName());
				return dto;
			}).collect(Collectors.toList());

			outcome.setData(municipalityDownDtoList);
		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveMunicipalityIdAndNameByDistrict of MasterCommonServiceImpl" + e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}
	
	@Override
	public ServiceOutcome<List<Ward>> getAllActiveWardIdAndNameByMunicipalityId(Long municipalityId) {
		ServiceOutcome<List<Ward>> outcome = new ServiceOutcome<>();
		try {
			List<Ward> wardDropDownList = wardRepository.findAllByMunicipalityMunicipalityIdAndIsActiveTrue(municipalityId);
			List<Ward> WardList = wardDropDownList.stream().map(ward -> {
				Ward dto = new Ward();
				dto.setWardId(ward.getWardId());
				dto.setWardName(ward.getWardName());
				return dto;
			}).collect(Collectors.toList());

			outcome.setData(WardList);
		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveWardIdAndNameByMunicipalityId of MasterCommonServiceImpl" + e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}
	
	@Override
	public ServiceOutcome<List<GramPanchayat>> getAllActiveGramPanchayatIdAndNameByBlock(Long blockId) {
		ServiceOutcome<List<GramPanchayat>> outcome = new ServiceOutcome<>();
		try {
			List<Grampanchayat> grampanchayatDropDownList = grampanchayatRepository.findAllByBlockId(blockId, true);
			List<GramPanchayat> GramPanchayatList = grampanchayatDropDownList.stream()
					.map(grampanchayat -> {
						GramPanchayat dto = new GramPanchayat();
						dto.setGpId(grampanchayat.getGpId());
						dto.setGpName(grampanchayat.getGpNameEN());
						return dto;
					}).collect(Collectors.toList());

			outcome.setData(GramPanchayatList);
		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveGramPanchayatIdAndNameByBlock of MasterCommonServiceImpl" + e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}

	@Override
	public ServiceOutcome<List<VillageDropDownDto>> getAllActiveVillageIdAndNameByGramPanchayat(Long gpId) {
		ServiceOutcome<List<VillageDropDownDto>> outcome = new ServiceOutcome<>();
		try {
			List<Village> villageDropDownList = villageRepository.findAllByGpIdGpIdAndIsActiveTrue(gpId);
			List<VillageDropDownDto> villageDropDownDtoList = villageDropDownList.stream()
					.map(village -> {
						VillageDropDownDto dto = new VillageDropDownDto();
						dto.setVillageId(village.getVillageId());
						dto.setVillageName(village.getVillageNameEn());
						return dto;
					}).collect(Collectors.toList());

			outcome.setData(villageDropDownDtoList);

		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveVillageIdAndNameByGramPanchayat of MasterCommonServiceImpl" + e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}

	@Override
	public ServiceOutcome<List<FinancialYearDropDown>> getAllActiveFinancialYear() {
		ServiceOutcome<List<FinancialYearDropDown>> outcome = new ServiceOutcome<>();
		try {
			List<FinancialYear> finYearList = financialYearRepository.findByIsActiveTrueOrderByFinYear();

			List<FinancialYearDropDown> finYearDropDownList = finYearList.stream().map(finYear -> {
				FinancialYearDropDown dto = new FinancialYearDropDown();
				dto.setFinancialYearId(finYear.getFinyearId());
				dto.setFinancialYear(finYear.getFinYear());
				return dto;
			}).collect(Collectors.toList());

			outcome.setData( finYearDropDownList);
		} catch (Exception e) {
			outcome.setData(null);
			log.error("Exception occured in getAllActiveFinancialYear() of MasterCommonServiceImpl" + e.getMessage());
			e.printStackTrace();
		}
		return outcome;
	}
	
	@Override
	public ServiceOutcome<List<LookupValueDTO>> getLookupValuesByLookupCode(String lookupCode) {
        ServiceOutcome<List<LookupValueDTO>> outcome = new ServiceOutcome<>();
        try {
        	List<CommonLookupValue> entities = commonLookupValueRepository.findByCommonLookup_LookupCodeAndIsActive(lookupCode, true);
        	 
            if (entities == null || entities.isEmpty()) {
                outcome.setData(Collections.emptyList());
                outcome.setOutcome(false);
                outcome.setMessage("No data found for lookup code: " + lookupCode);
            } else {
                List<LookupValueDTO> dtos = lookupValueMapper.toDTOList(entities);
                outcome.setData(dtos);
                outcome.setOutcome(true);
                outcome.setMessage("Data Retrieved Successfully.");
            }
        } catch (Exception e) {
            log.error("Exception occurred in getLookupValuesByLookupCode() for lookupCode: {}", lookupCode, e);
            outcome.setData(Collections.emptyList());
            outcome.setOutcome(false);
            outcome.setMessage("Error retrieving data: " + e.getMessage());
        }
        return outcome;
    }

	@Override
	public ServiceOutcome<List<FinancialYear>> getAllActiveFinancialYears() {
        ServiceOutcome<List<FinancialYear>> outcome = new ServiceOutcome<>();
        try {
            List<FinancialYear> finYearList = financialYearRepository.findByIsActiveTrueOrderByFinYear();

            if (finYearList != null && !finYearList.isEmpty()) {
                outcome.setData(finYearList);
                outcome.setMessage("Active financial years fetched successfully.");
                outcome.setOutcome(true);
            } else {
                outcome.setData(null);
                outcome.setMessage("No active financial years found.");
                outcome.setOutcome(false);
            }
        } catch (Exception e) {
            log.error("Error while fetching active financial years", e);
            outcome.setData(null);
            outcome.setMessage("Error occurred while fetching active financial years: " + e.getMessage());
            outcome.setOutcome(false);
        }
        return outcome;
    }
	
	@Override
	public String generateCode(String input, int length) {
		if (input == null || input.isEmpty()) {
			return "";
		}
		input = input.replaceAll("\\s+", ""); 
		return input.substring(0, Math.min(length, input.length())).toUpperCase();
	}
	
	//handle file upload 
	@Override
	public String handleFileUpload(MultipartFile file, String basePath, String folderName) {
		try {
			if (file == null || file.isEmpty()) {
				return null;
			}
			return UploadFile.uploadSCSTFile(file, basePath, folderName,"DOC" + RandomNumberGenerate.getRandomNumber());
		} catch (IOException e) {
			log.error("Exception occured in handleFileUpload() of MasterCommonServiceImpl" , folderName, e.getMessage());
			e.printStackTrace();
			return null;
		}
	}

	

	
 }