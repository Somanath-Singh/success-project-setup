<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<style>
    tr td input,tr td select{
                border: 1px solid #2c97af7a;
                border-radius: 4px !important;
                height: 25px;
        }
</style>

	<div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">Issue Item Disbursement</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Issue Item Disbursement</li>
                  </ol>
                </nav>
              </div>
            </div>
            
             <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Issue Item Disbursement</h5>
                    </div>
                    <div class="card-body">
        <form action="${contextPath}/inventory/issueRequest/saveDishbursement" method="post" id="form" enctype="multipart/form-data" >
        	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
        	<input type="hidden" id="reqDate" value="<fmt:formatDate value='${not empty itemDishburseMent ? itemDishburseMent.issueRequest.requestDate : issueRequest.requestDate }' pattern='dd/MM/yyyy' />">
            <input type="hidden" name="issueItemRequestId" value="${not empty itemDishburseMent ? itemDishburseMent.issueRequest.issueItemRequestId : issueRequest.issueItemRequestId }">
            <input type="hidden" name="disbursementId" value="${itemDishburseMent.disbursementId}">
            <input type="hidden" id="canTakeAction" name="canTakeAction" value="${canTakeAction}">
            <input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
				<div class="row">
					<div class="col-md-12">
						<div class="row">
							<div class="col-md-12 table-responsive">
								<div class="row">
									<div class="col-md-6">
										<caption class="table-cap">Issue Request Details :</caption>
									</div>
								</div>
								<table class="table table-bordered">
									<tr>
										<td class="bgtr"><label>Issue Request No</label></td>
										<td>${not empty itemDishburseMent ? itemDishburseMent.issueRequest.requestNumber :issueRequest.requestNumber}</td>
										<td class="bgtr"><label>Issue Request Date</label></td>
										<td><fmt:formatDate value='${not empty itemDishburseMent ? itemDishburseMent.issueRequest.requestDate : issueRequest.requestDate }' pattern='dd/MM/yyyy' /></td>
									</tr>
									<c:if test="${not empty itemDishburseMent}">
										<tr>
											<td class="bgtr"><label>Item Disburse No</label></td>
											<td>${itemDishburseMent.disbursementNumber}</td>
											<td class="bgtr"><label>Item Disburse Date</label></td>
											<td><fmt:formatDate value='${itemDishburseMent.dishbursementDate}' pattern='dd/MM/yyyy' /></td>
										</tr>
									</c:if>
									<tr>
										<td class="bgtr"><label>Store</label></td>
										<td>${not empty itemDishburseMent ? (not empty itemDishburseMent.store.storeName ? itemDishburseMent.store.storeName :"N/A"):(not empty issueRequest.store ? issueRequest.store.storeName :"N/A")}</td>
										<td class="bgtr"><label><spring:message code="PROC.REQ.FINYEAR"/></label></td>
										<td>${not empty itemDishburseMent ? itemDishburseMent.issueRequest.finYear.finYear :issueRequest.finYear.finYear}</td>
									</tr>
									<tr>
										<td class="bgtr"><label>Stock Type</label></td>
										<td>${not empty itemDishburseMent ? itemDishburseMent.issueRequest.stockType.stockTypeName : issueRequest.stockType.stockTypeName}</td>
										<td class="bgtr"><label>Cost Center</label></td>
										<td>${not empty itemDishburseMent ? itemDishburseMent.issueRequest.costCenter.costCenterName:issueRequest.costCenter.costCenterName}</td>
									</tr>
									<tr>
										<td class="bgtr"><label><spring:message code="PROC.REQ.PRIORITY"/></label></td>
										<td>${not empty itemDishburseMent ? itemDishburseMent.issueRequest.priorityLevel.priorityLevelName : issueRequest.priorityLevel.priorityLevelName}</td>
										<td class="bgtr"><label>General Purpose of Request</label></td>
										<td>${not empty itemDishburseMent ? itemDishburseMent.issueRequest.purpose : (not empty issueRequest.purpose ?issueRequest.purpose :"N/A")}</td>
									</tr>
								</table>
							</div>
						</div>
							<div class="col-md-2">
								<label>Disbursement Date :</label>
								<div class="datepicker_con">
	                     			<input type="text" class="form-control form-control-sm requiredField disDate ${empty itemDishburseMent || itemDishburseMent.stageForwardedRule.actionType.actionCode eq 'DRAFT' ? '' : 'frezz'}"  id="dishbursementDate" value="<fmt:formatDate value='${itemDishburseMent.dishbursementDate}' pattern='dd/MM/yyyy' />" name="disDate"  readonly/>
	                   			</div>
                   			</div>
						<div class="row">
							<div class="col-md-12">
								<div class="table-responsive">
									<table class=" table table-striped table-bordered  mt-3">
										<thead class="bagGroundColor">
											<tr>
												<th>SlNo.</th>
												<th>Item Name</th>
												<th>Available Quantity</th>
												<th>Remain Quantity</th>
												<th>Approve Quantity</th>
												<c:if test="${not empty itemDishburseMent && itemDishburseMent.stageForwardedRule.actionType.actionCode ne 'DRAFT'}">
													<th>Accept Quantity</th>
													<th>Reject Quantity</th>
												</c:if>
												<th>Status</th>
											</tr>
										</thead>
										<tbody id="tbody">
											<c:if test="${empty itemDishburseMent}">
												<c:forEach items="${issueRequest.requestItemsList}"  var="issue" varStatus="count">
													<tr>
														<td>${count.count}<input type="hidden" value="${issue.requestItemId }" name="dishbursementItemsList[${count.index}].requestItemId"></td>
														<td>${issue.itemName}</td>
                                                        <td>${issue.avlqty}</td>
														<td>${issue.remainQuantity}</td>
														<td><input class="form-control onClickInput ${issue.fractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'} maximunLengthIs10WithDot altleastOneGreaterThanZero" type="number" id="rcvQty${count.count}" name="dishbursementItemsList[${count.index}].receivedQuantity" value="0" onkeyup="checkQuantity(${issue.remainStock},${issue.remainQuantity},this.value,${count.count})" ${empty itemDishburseMent || itemDishburseMent.stageForwardedRule.actionType.actionCode eq 'DRAFT' ? '' : 'readonly="readonly'}></td>
														<td>
															<select disabled="disabled" id="status${count.count}">
								                                <option value="false" ${lines.poLine.isGrnClose eq false ? 'selected' : '' }>Open</option>
								                                <option value="true" ${lines.poLine.isGrnClose eq true ? 'selected' : '' }>Close</option>
								                            </select>
														</td>
													</tr>
												</c:forEach>
											</c:if>
											<c:if test="${not empty itemDishburseMent}">
												<c:forEach items="${itemDishburseMent.dishbursementItemsList}"  var="issue" varStatus="count">
													<tr>
														<td>${count.count}<input type="hidden" value="${issue.issueRqsItems.requestItemId }" name="dishbursementItemsList[${count.index}].requestItemId"></td>
														<td>${issue.itemName}<input type="hidden" value="${issue.disbursementItemId}" name="dishbursementItemsList[${count.index}].disbursementItemId"></td>
														<td>${issue.issueRqsItems.avlqty}</td>
														<td>${issue.issueRqsItems.remainQuantity}</td>
														<td>
															<input class="${issue.fractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'} maximunLengthIs10WithDot ${not empty itemDishburseMent && itemDishburseMent.stageForwardedRule.actionType.actionCode ne 'DRAFT' ? '' : 'altleastOneGreaterThanZero'}" type="number" id="rcvQty${count.count}" name="dishbursementItemsList[${count.index}].receivedQuantity" value="${issue.receivedQuantity}" onkeyup="checkQuantity(${issue.remainStock},${issue.issueRqsItems.remainQuantity},this.value,${count.count})" ${empty itemDishburseMent || itemDishburseMent.stageForwardedRule.actionType.actionCode eq 'DRAFT' ? '' : 'readonly="readonly"'} >
														</td>
														<c:if test="${not empty itemDishburseMent && itemDishburseMent.stageForwardedRule.actionType.actionCode ne 'DRAFT'}">
															<td>
																<input class="altleastOneGreaterThanZero onClickInput ${issue.fractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'} maximunLengthIs10WithDot unfreezeField " type="number" id="acptQty${count.count}" name="dishbursementItemsList[${count.index}].staffAcceptQuantity" value="${issue.staffAcceptQuantity}" ${not empty itemDishburseMent && itemDishburseMent.stageForwardedRule.actionType.actionCode ne 'PARTIAL_APPROVE' && itemDishburseMent.stageForwardedRule.actionType.actionCode ne 'APPROVE' && roleId eq itemDishburseMent.stageForwardedRule.toState ? '' : 'readonly="readonly'} onkeyup="checkQuantityDetails(${issue.receivedQuantity},this.value,${count.count})">
															</td>
															<td><input class="rejtQtyClass" type="number" id="rjctQty${count.count}" name="dishbursementItemsList[${count.index}].staffRejectQuantity" value="${issue.staffRejectQuantity}" readonly="readonly"></td>
														</c:if>
														<td>
															<select disabled="disabled" id="status${count.count}">
								                                <option value="false" ${issue.issueRqsItems.closed eq false ? 'selected' : '' }>Open</option>
								                                <option value="true" ${issue.issueRqsItems.closed eq true ? 'selected' : '' }>Close</option>
								                            </select>
														</td>
													</tr>
												</c:forEach>
											</c:if>
										</tbody>
									</table>
								</div>
								
								<c:set var="dynamicFromId" value="form" scope="request" />
          						<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
							</div>
						</div>
					</div>
				</div>
        </form>
	</div>
</div>
</div>
</div>
<form action="${contextPath}/inventory/issueRequest/itemDishbursement" method="get" id="formm" >
    <input type="hidden" class="" id="issueIdd" name="issueId" value="" />
    <input type="hidden" class="" id="encodedDataformm" name="issueIdEncoded" value="" />
</form>
<script>
tableIds=['tbody'];
jsonKeys=['dishbursementItemsList'];
$(function() {
	$('.disDate').datepick({
		dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,showTrigger: '<button type="button" class="trigger ${empty itemDishburseMent || itemDishburseMent.stageForwardedRule.actionType.actionCode eq 'DRAFT' ? '' : 'frezz'}"><i class="fa fa-calendar"></i></button>',
		 onSelect: function(selected) {
			 var alltDate=$('#reqDate').val().split("/");
			 var modAllotDate=new Date(alltDate[1]+"/"+alltDate[0]+"/"+alltDate[2]);
			 if(modAllotDate > new Date(selected)){
				bootbox.alert('Dishbursement Date should not greater than issue create date.');
				$('.disDate').val("");
			 }
		 }
	});
});

function buttonAction(that, stageId, isUserSpecificRule, isRemarksRequired, buttonCode){

	var a=1;
	if(dynamicFromId != null && dynamicFromId != undefined && dynamicFromId != ""){
		dynamicFromOfWF = $("#"+dynamicFromId);
	}else{
		dynamicFromOfWF = that.closest("form");
	}


	var requreFieldValidation = validateRequiredFields("requiredField");
	if(!requreFieldValidation){
		return;
	}

	let tableValidation = validationForTable("tableValidation");
	if(!tableValidation){
		return;
	}

	// greater than zero
	let greaterThanZero = validationForGreaterThanZero("greaterThanZero");
	if(!greaterThanZero){
		return;
	}


	// check if at least one field is greater than zero altleastOneGreaterThanZero
	let altleastOneGreaterThanZero = validationForAtleastOneGreaterThanZero("altleastOneGreaterThanZero");
	if(!altleastOneGreaterThanZero){
		return;
	}

	let isValid = true;
	// validation for at first approve or reject alter item at the stage of first approve
	let itmAprvBtn = dynamicFromOfWF.find(".altBtnapp");
	if(itmAprvBtn.length>0){
		isValid = false;
		bootbox.alert("At first approve or reject alternative item.");
		return;
	}

	// validation for atleast one item mandatory on vendor quote time
	let quoteAtleastOneRowMandatory = dynamicFromOfWF.find(".quoteAtleastOneRowMandatory");
	let isquoteAtleastOneRowMandatory = false;
	if(quoteAtleastOneRowMandatory.length != 0){
		quoteAtleastOneRowMandatory.each(function(){
			var id=this.id;
			if(!$("#"+id).hasClass('disable-row')){
				isquoteAtleastOneRowMandatory = true;
			}
		});
	}

	if(quoteAtleastOneRowMandatory.length > 0 && !isquoteAtleastOneRowMandatory){
		bootbox.alert("atleast one item is mandatory.");
		isValid = false;
	}
	var previousStageCode='${itemDishburseMent.stageForwardedRule.actionType.actionCode}';
	var isGreater=true;
	if(buttonCode == 'PARTIAL_APPROVE' || (buttonCode == 'APPROVE' && previousStageCode != 'PARTIAL_APPROVE' && previousStageCode != '')){
		let rejectInptList = dynamicFromOfWF.find(".rejtQtyClass");
		if(rejectInptList.length == 0){

		}else{
			rejectInptList.each(function(){
				let value = getFieldValue(this);
				parseFloat(value);
				if(value > 0){
					isGreater=false;
				}
			});
		}
		if(buttonCode == 'PARTIAL_APPROVE') {
			if(isGreater){
				bootbox.alert("For Partial Approve have to need some reject quantity");
				isValid=false;
			}
		}else if(buttonCode == 'APPROVE') {
			if(!isGreater){
				bootbox.alert("For Direct Approve have to need Zero reject quantity");
				isValid=false;
			}
		}
	}

	if(isValid){
        encryptFormData(dynamicFromId, tableIds, jsonKeys);
		if(isUserSpecificRule && selectedIds.length < 1){
			getAllUsersOnPerticularStage(stageId);
			$("#userSpecificRuleModal").modal("show");
		}else {
			if(isRemarksRequired){
				bootbox.prompt({
								title: 'Give a remark for Action '+ that.innerText,
								inputType: 'textarea',
								callback: function (result) {
									if(result != null){
										// create a hidden field and set the value of current stage id in this form
										submitFormWithRemarks(dynamicFromOfWF, result, stageId, selectedIds);
									}
								}
							});
			}else{
				bootbox.confirm({
					message: "Are you sure you want to "+ that.innerText +" ?",
					buttons: {
						confirm: {
							label: 'Yes',
							className: 'btn-success'
						},
						cancel: {
							label: 'No',
							className: 'btn-danger'
						}
					},
					callback: function(result) {
						if (result) {
							submitFormWithRemarks(dynamicFromOfWF, "", stageId, selectedIds);
						}
					}
				});
				}
			}
	}

}






    function getDishbursement(id) {
        $("#issueIdd").val(id);
        encryptFormData("formm", tableOrTbodyIDS, tableOrTbodyKeys);
        removeFieldsFromFormBYClass("formm","noPass");
        $("#formm").submit();
    }
	function checkQuantity(remainStock,issueRemainQty,value,id) {
		value=parseFloat(value).toFixed(2);
		issueRemainQty=parseFloat(issueRemainQty);
		remainStock=parseFloat(remainStock);
		if(value==''){
			$("#rcvQty"+id).val(0.0);
			return false;
		}
		if(value>remainStock){
			$("#rcvQty"+id).val(0.0);
			bootbox.alert("Required Quantity is not available at ware house.");
			return false;
		}
		if(value>issueRemainQty){
			$("#rcvQty"+id).val(0.0);
			bootbox.alert("Required Quantity is not greater than request remain quantity.");
			return false;
		}
		if(issueRemainQty==value){
			$("#status"+id).val('true');
		}else{
			$("#status"+id).val('false');
		}
	}
	function validateform(status) {
		var date=$("#dishbursementDate").val();
		if(date == ''){
			bootbox.alert("please select dishbursement date");
			return false;
		}

		let altleastOneGreaterThanZero = form.querySelectorAll(".altleastOneGreaterThanZero");
		let isAtleastOneGreaterThanZero = false;
		if(altleastOneGreaterThanZero.length == 0){
			isAtleastOneGreaterThanZero = true;
		}else{
			altleastOneGreaterThanZero.forEach(function(field){
				if(field.value > 0){
					isAtleastOneGreaterThanZero = true;
				}
			});
		}
		if(!isAtleastOneGreaterThanZero){
			bootbox.alert("At least one field must be greater than zero");
			return false;
		}

		$('#status').val(status);
		bootbox.confirm({
            message: "Are you sure you want to submit?",
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-success'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-danger'
                }
            },
            callback: function (result) {
                if(result){
                    encryptFormData("form", tableIds, jsonKeys);
                    $('#form').submit();
                }
            }
        });

	}
	function checkQuantityDetails(appQty,value,id) {
		appQty=parseFloat(appQty);
		value=parseFloat(value).toFixed(2);
		if(value==''){
			$("#acptQty"+id).val(0.0);
			$("#rjctQty"+id).val(appQty);
			return false;
		}
		if(value>appQty){
			$("#acptQty"+id).val(0.0);
			$("#rjctQty"+id).val(appQty);
			bootbox.alert("Accept Quantity is not greater than Ware house approved quantity.");
			return false;
		}
		var rejQty=appQty-value;
		rejQty=parseFloat(rejQty).toFixed(2);
		$("#rjctQty"+id).val(rejQty);
		if(appQty==value){
			$("#status"+id).val('true');
		}else{
			$("#status"+id).val('false');
		}
	}
	function validate() {
		var res=true;
		$('#tbody tr').each(function(){
		    var rejectQty = $(this).find('input[id^="rjctQty"]').val() || '';
			rejectQty=parseFloat(rejectQty).toFixed(2);
			if(rejectQty>0){
                res=false;
            }
		});
		if(res){
			$('#status').val("APPROVE");
		}else{
			$('#status').val("PARTIALLY");
		}
		var date=$("#dishbursementDate").val();
		if(date == ''){
			bootbox.alert("please select dishbursement date");
			return false;
		}
		let altleastOneGreaterThanZero = form.querySelectorAll(".altleastOneGreaterThanZero");
		let isAtleastOneGreaterThanZero = false;
		if(altleastOneGreaterThanZero.length == 0){
			isAtleastOneGreaterThanZero = true;
		}else{
			altleastOneGreaterThanZero.forEach(function(field){
				if(field.value > 0){
					isAtleastOneGreaterThanZero = true;
				}
			});
		}
		if(!isAtleastOneGreaterThanZero){
			bootbox.alert("At least one field must be greater than zero");
			return false;
		}
		bootbox.confirm({
            message: "Are you sure you want to submit?",
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-success'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-danger'
                }
            },
            callback: function (result) {
                if(result){
                    encryptFormData("form", tableIds, jsonKeys);
                    $('#form').submit();
                }
            }
        });

	}
</script>