<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<style>
body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.login-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    padding: 40px;
    width: 100%;
    max-width: 420px;
    text-align: center;
}

.logo-section {
    margin-bottom: 30px;
}

.logo-section img {
    max-height: 60px;
    margin-bottom: 15px;
}

.login-title {
    color: #333;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 10px;
    text-transform: uppercase;
}

.login-subtitle {
    color: #666;
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 30px;
}

.form-group {
    position: relative;
    margin-bottom: 25px;
}

.form-group i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 18px;
    z-index: 1;
}

.form-group input {
    width: 100%;
    height: 50px;
    padding: 0 15px 0 50px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    font-size: 16px;
    background: #f8f9fa;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus {
    outline: none;
    border-color: #667eea;
    background: #fff;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.captcha-group {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.captcha-input {
    flex: 1;
}

.captcha-input input {
    height: 50px;
    padding: 0 15px 0 50px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    font-size: 16px;
    background: #f8f9fa;
}

.captcha-input input:focus {
    outline: none;
    border-color: #667eea;
    background: #fff;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.captcha-image {
    width: 90px;
    height: 50px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    background: #f8f9fa;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #666;
}

.captcha-image:hover {
    border-color: #667eea;
}

.login-btn {
    width: 100%;
    height: 50px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
}

.login-btn:active {
    transform: translateY(0);
}

.footer-text {
    color: #888;
    font-size: 14px;
    margin-top: 20px;
}

@media (max-width: 480px) {
    .login-container {
        margin: 20px;
        padding: 30px 20px;
    }
    
    .captcha-group {
        flex-direction: column;
        gap: 15px;
    }
    
    .captcha-image {
        width: 100%;
        height: 50px;
    }
}
</style>

<div class="login-container">
    
    <!-- Login Form -->
    <form class="loginbox" id="login-window" method="POST" action="${contextPath}/overwrite/umt/login" autocomplete="off">
        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
        
        <!-- Username -->
        <div class="form-group">
            <i class='fa fa-user'></i>
            <input type="text" 
                   placeholder="Enter Username" 
                   id="userName" 
                   name="userName" 
                   maxlength="35" 
                   class="user"
                   required>
        </div>

        <!-- Password -->
        <div class="form-group">
            <i class='fa fa-lock'></i>
            <input type="password" 
                   placeholder="Enter Password" 
                   id="password" 
                   name="password" 
                   maxlength="30" 
                   class="password"
                   required>
        </div>

        <!-- Captcha -->
        <div class="captcha-group">
            <div class="captcha-input form-group">
                <i class='fa fa-refresh'></i>
                <input type="text" 
                       placeholder="Enter Captcha" 
                       id="captcha" 
                       class="cap" 
                       maxlength="10"
                       required>
            </div>
            <div class="captcha-image" onclick="refreshCaptcha()">
                <img src="${contextPath}/captcha/5" alt="Captcha" style="width: 100%; height: 100%; border-radius: 10px;">
            </div>
        </div>

        <!-- Login Button -->
        <button type="button" id="btn_submit" class="login-btn" onclick="userLogin()">
            <i class='fa fa-sign-in'></i> Login
        </button>
    </form>

</div>

<script type="text/javascript">

//ALL SHOULD SHOW âœ…
console.log('jQuery:', typeof $);                    // "function" âœ…
console.log('Bootbox:', typeof bootbox);             // "object" âœ…
console.log('enc_password:', typeof enc_password);   // "function" âœ…
console.log('Login Ready! ðŸŽ‰');

//Test 1: Check if assets exist
fetch('/heads-ipms/assets/js/jquery.js').then(r => console.log('jQuery:', r.status))

// Test 2: Check if security blocks
fetch('/heads-ipms/assets/js/jquery.js', {credentials: 'include'}).then(r => console.log('Security:', r.status))


$(function() {
    $('form').attr("autocomplete", "off");
});

function userLogin() {
    var username = $("#userName").val().trim();
    var password = $("#password").val().trim();
    var generateCaptcha = $("#captcha").val().trim();
    
    if (username == "") {
        bootbox.alert("Username cannot be empty.");
        $("#userName").val("").focus();
        return false;
    } else if (password == "") {
        bootbox.alert("Password cannot be empty.");
        $("#password").val("").focus();
        return false;
    } else if (generateCaptcha == "") {
        bootbox.alert("Please enter the CAPTCHA.");
        $("#captcha").val("").focus();
        return false;
    } else {
        showLoader();
        $('#userName').val(enc_password(username));
        $('#password').val(enc_password(password));
        $("#login-window").submit();
        return false;
    }
}

function refreshCaptcha() {
    var image = document.querySelector('.captcha-image img');
    image.src = '${contextPath}/captcha/5?' + new Date().getTime();
}

// Password toggle (if needed)
$(document).on('click', '.fa-eye', function() {
    var $input = $("#password");
    if ($input.attr('type') === 'password') {
        $input.attr('type', 'text');
        $(this).removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        $input.attr('type', 'password');
        $(this).removeClass('fa-eye-slash').addClass('fa-eye');
    }
});

// Block F12, Ctrl+U, etc.
document.onkeydown = function(e) {
    if(event.keyCode == 123) return false; // F12
    if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; // Ctrl+Shift+I
    if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; // Ctrl+Shift+J
    if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; // Ctrl+U
};

</script>