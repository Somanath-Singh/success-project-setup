<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Project Estimation</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa-solid fa-house"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Project Estimation</li>
			</ol>
		</nav>
	</div>
</div>
<div class="row">

	<div class="col-md-12">

		<div class="card">
			<div class="card-header">
				<h4 class="card-title">Project Estimation Data</h4>
			</div>
			<div class="card-body">
	      	<div class="row align-items-end">
	             <div class="col-md-3">
	                 <div class="form-group">
	                     <label class="smallInput required" for="">Financial Year :</label>
	                     <div class="">
	                         <select class="form-control form-control-sm form-select" id="financialYear" name="financialYearId" onchange="getProjectByFinancialYear(this.value)">
	                             <option value="0">- Select -</option>
	                             <c:forEach items="${financialYearList}" var="fy" varStatus="index">
	                                 <option value="${fy.financialYearId}" ${ fy.financialYearId eq projectEstimation.financialYearId ? 'selected' : ''}>${fy.financialYear}</option>
	                             </c:forEach>
	                         </select>
	                     </div>
	                 </div>
	             </div>
	
                <div class="col-md-3">
                       <div class="form-group">
                           <label class="smallInput required" for="">Project :</label>
                           <div class="">
                               <select class="form-control form-control-sm select2 form-select select2" id="projectId" name="projectId">
                                   <option value="0" selected disabled>- Select -</option>
                               </select>
                           </div>
                       </div>
                   </div>
                   
					<div class="col-md-3">
		                 <div class="form-group">
							<input type="button" name="add&ManageApplication" value="Filter" id="add&ManageApplications" class="btn btn-primary btn-sm" onclick="getFilteredProjectEstimationData()">
							<a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
						</div>
					</div>
				</div>
		    </div>
		  </div>
		</div>

		<div class="col-md-12 mt-3">
	
			<div class="card">
				<div class="card-header">
					<h4 class="card-title">Project Estimation List</h4>
				</div>
				<div class="card-body">
			  	<div class="row">
					<div class="col-md-12">
						<nav>
							<div class="nav nav-tabs mb-2 tabnav" id="nav-tab" role="tablist">
								<button class="nav-link active" id="nav-draft-tab" data-bs-toggle="tab" data-bs-target="#draft" type="button" role="tab" aria-controls="draft" aria-selected="true"><spring:message code="site.common.draft" text="Draft" /></button>
								<button class="nav-link" id="nav-pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="false"><spring:message code="site.common.pending" text="Pending" /></button>
								<button class="nav-link" id="nav-approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab" aria-controls="approved" aria-selected="false"><spring:message code="site.common.approved" text="Approved" /></button>
								<button class="nav-link" id="nav-rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab" aria-controls="rejected" aria-selected="false"><spring:message code="site.common.rejected" text="Rejected" /></button>
								<button class="nav-link" id="nav-reverted-tab" data-bs-toggle="tab" data-bs-target="#reverted" type="button" role="tab" aria-controls="reverted" aria-selected="false"><spring:message code="site.common.reverted" text="Reverted" /></button>
							</div>
						</nav>
		
						<div class="table-responsive">
							<table class="table table-bordered table-hover" id="tableId">
								<thead>
									<tr>
										<th class="text-center" style="min-width: 60px;">Sl.No</th>
										<th style="min-width: 150px;">Project Name</th>
										<th style="min-width: 150px;">Financial Year</th>
										<th style="min-width: 180px;">Project Estimation No</th>
										<th style="min-width: 80px;">GST %</th>
										<th style="min-width: 80px;">CGST %</th>
										<th style="min-width: 120px;">CGST Amount</th>
										<th style="min-width: 80px;">SGST %</th>
										<th style="min-width: 150px;">SGST Amount</th>
										<th style="min-width: 150px;">Estimation Amount</th>
										<th style="min-width: 150px;">Total Amount</th>
										<th class="text-center" style="min-width: 100px;">Action</th>
									</tr>
								</thead>
								<tbody>
									
								</tbody>
							</table>
						</div>
					</div>
				</div>
		      </div>
		    </div>
		  </div>
		</div>

<script>



function getProjectByFinancialYear(finYearId){
    $.ajax({
        url: "${contextPath}/common/fetch-approved-project-by-financialYear",
        type: "GET",
        data: {
        	financialYearId: finYearId
        },
        success: function (projects) {
   
            var projectSelect = $("#projectId");
            projectSelect.empty(); 
            projectSelect.append('<option value="0" selected disabled>- Select -</option>');
            
            $.each(projects, function(index, project) {
                projectSelect.append('<option value="' + project.projectId + '">' + project.projectName + '</option>');
            });
        },
        error: function () {
            bootbox.alert("Error fetching projects and estimation number.");
        }
    });
}

 function getFilteredProjectEstimationData(){
	 
    var financialYear = $("#financialYear").val();
    var projectId = $("#projectId").val();
    
    if (!financialYear || financialYear === "0") {
        bootbox.alert("Please select financial year");
        return false;
    }else if (!projectId || projectId === "0") {
        bootbox.alert("Please select project");
        return false;
    }else{
    	
    	$.ajax({
    	    url: '${contextPath}/project-estimation/fetch-plan-estimation-details',
    	    type: 'GET',
    	    data: {
    	        financialYearId: financialYear,
    	        projectId: projectId
    	    },
    	    success: function (data) {
    	        let tbody = $('table tbody');
    	        tbody.empty();

    	        if (data && data.length > 0) {
    	        	$.each(data, function (index, projectEstimation) {
    	        	    let row = '<tr>' +
    	        	        '<td class="text-center">' + (index + 1) + '</td>' +
    	        	        '<td>' + (projectEstimation.projectName || '') + '</td>' +
    	        	        '<td>' + (projectEstimation.financialYear || '') + '</td>' +
    	        	        '<td>' + (projectEstimation.planEstimationNo || '') + '</td>' +
    	        	        '<td>' + (projectEstimation.gstPercentage ?? 0) + '</td>' +
    	        	        '<td>' + (projectEstimation.cgstPercentage ?? 0) + '</td>' +
    	        	        '<td class="text-end">' + (projectEstimation.cgstAmount ?? 0) + '</td>' +
    	        	        '<td>' + (projectEstimation.sgstPercentage ?? 0) + '</td>' +
    	        	        '<td class="text-end">' + (projectEstimation.sgstAmount ?? 0) + '</td>' +
    	        	        '<td class="text-end">' + (projectEstimation.estimationAmount ?? 0) + '</td>' +
    	        	        '<td class="text-end">' + (projectEstimation.totalAmount ?? 0) + '</td>' +
    	        	        '<td class="text-center">' +
    	        	            '<button class="btn btn-warning btn-sm" id="editBtn" ' +
    	        	                'data-block-id="' + projectEstimation.prjEstId + '" ' +
    	        	                'data-toggle="tooltip" title="Edit" ' +
    	        	                'onclick="editProjectEstimation(' + projectEstimation.prjEstId + ')">' +
    	        	                '<i class="fas fa-edit"></i>' +
    	        	            '</button>' +
    	        	        '</td>' +
    	        	    '</tr>';

    	        	    tbody.append(row);
    	        	});
    	        } else {
    	            tbody.append('<tr><td colspan="12" class="text-center">No data found</td></tr>');
    	        }
    	    },
    	    error: function (xhr, status, error) {
    	        console.error('Error Fetching Plan Estimation Details:', error);
    	        bootbox.alert('Error Fetching Plan Estimation Details');
    	    }
    	});
    	
    }
 }
 
 function editProjectEstimation(id) {
	  $("#estimationIdEdit").val(id);
	  showLoader();
	  var bizContent = $("#editForm").serializeArray();
	  $("#editCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
	  $("#editForm").submit();
 }

</script>

<form action="${contextPath}/project-estimation/edit-project-estimation" method="Post" id="editForm">
<input type="hidden" id="editCipherText" name="cipherText">
<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
<input type="hidden" name="estimationId" id="estimationIdEdit" />
</form>
