<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />



<div class="breadcrumb_conatiner">
              <div class="col-md-6">
                 <h4 class="change-color">Item Disbursement</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Item Disbursement</li>
                  </ol>
                </nav>
              </div>
            </div>

		<div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Item Disbursement</h5>
                    </div>
                    <div class="card-body">

        <form action="${contextPath}/inventory/issueRequest/itemDishbursement" method="get" id="form" >
            <input type="hidden" class="" id="encodedDataform" name="issueIdEncoded" value="" />
				<div class="row">
					<div class="col-md-12">

						<div class="row">
							<div class="col-md-12 table-responsive">
								<div class="row">
									<div class="col-md-3">
										<div class="form-group">
											<label class="col-md-12 required" for="text">Issue Request</label>
											<div class="col-md-12">
												<select class="form-control requiredField" id="issueId" name="issueId" >
													<option value="0"><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${issRqst}" var="rqst">
														<option value="${rqst.issueItemRequestId}" ${rqst.issueItemRequestId eq issueRequestId ? 'selected' : ''}>${rqst.requestNumber}</option>
													</c:forEach>
												</select>
											</div>
										</div>
									</div>
									<div class="col-md-4" style="margin-top:20px;">
										<input type="button" class="btn btn-submit" value="Submit" onclick="validateForms()">
										<a  class="btn btn-danger" style=""  onclick="backToModule()">Cancel</a>
									</div>
									<div class="col-md-12">
										<c:if test="${not empty issueRequestId && !canDisable}">
											<div class="mb-3" style="float: right; font-size: 12px; color: #fff;  ">
												<button type="button" style="float: right; background: #007468; color: #fff; border: none; border-radius: 5px; width: 140px;padding: 5px !important;" class="btnadd-right" onclick="createDishbursement(${issueRequestId},0)">Add Disbursement</button>
											</div>
										</c:if>
									</div>
								</div>
							</div>
						</div>
						<c:if test="${not empty issueRequestId}">
						<div class="row">
							<div class="col-md-12">
								<div class="table-responsive">
									<table class=" table table-striped table-bordered  mt-3">
										<thead class="bagGroundColor">
											<tr>
												<th>Sl No</th>
												<th>Request No</th>
												<th>Disbursement No</th>
												<th>Disbursement Date</th>
												<th>Status</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
											<c:forEach items="${lstItmDis}" var="dis" varStatus="count">
												<tr>
													<td>${count.count}</td>
													<td>${dis.issueRequest.requestNumber}</td>
													<td>${dis.disbursementNumber }</td>
													<td><fmt:formatDate value='${dis.dishbursementDate}' pattern='dd/MM/yyyy' /></td>
													<td>
														${dis.stageForwardedRule.displayName}
													</td>
													<td><a href="#" onclick="createDishbursementt(0,${dis.disbursementId})" class="btn btn-primary" title="Link"><i class="fa-solid fa-link"></i></a></td>
												</tr>
											</c:forEach>
										</tbody>
									</table>
								</div>
							</div>
						</div>
						</c:if>
					</div>
				</div>

        </form>
        </div>
        </div>
        </div>
	</div>

<form action="${contextPath}/inventory/issueRequest/createDishbursement" method="get" id="formDis" >

	<input class="noPass" type="hidden" id="issueRequestId" name="issueId">
	<input class="noPass" type="hidden" id="dishbursementId" name="dishbursementId">
	<input type="hidden" id="encodedDataformDis" name="encodedData" value="" />
</form>
<form action="${contextPath}/inventory/issueRequest/viewDishbursement" method="get" id="formViewDis" >
	<input type="hidden" id="encodedDataViewformDis" name="encodedData" value="" />
</form>
<script>
function validateForms() {
	var issueId=$("#issueId").val();
	if(issueId==0){
		alert("select Issue Request");
		return false;
	}else{
	    encryptFormData("form", tableOrTbodyIDS, tableOrTbodyKeys);
		$("#form").submit();
	}
}
    function backToModule(){
       let currentModuleCode =  localStorage.getItem('currentModuleCode');
       $('#moduleId').val(enc_password(currentModuleCode));
       $('#moduleForm').submit();
    }
function createDishbursement(issueId , disbursementId) {
    if(issueId!=0){
        $("#issueRequestId").val(issueId);
    }
	if(disbursementId!=0){
	    $("#dishbursementId").val(disbursementId);
	}
	encryptFormData("formDis", tableOrTbodyIDS, tableOrTbodyKeys);
	removeFieldsFromFormBYClass("formDis","noPass");
	$("#formDis").submit();
}

function createDishbursementt(issueId , disbursementId) {

	if(disbursementId!=0){
	    $("#dishbursementId").val(disbursementId);
	}
	var encodeDishburse= btoa(disbursementId);
	$("#encodedDataViewformDis").val(encodeDishburse);
	$("#formViewDis").submit();
}
</script>