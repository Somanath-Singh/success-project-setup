<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<sec:authentication var="principal" property="principal" />
<c:set var="chargeRow" value="0" />


<style>
th {
    padding: 1px 12px !important;
    font-size: 13px;
}
.opnlink_btn{
    background: #38a6bf;
    text-decoration: none;
    color: #ffffff !important;
    font-weight: 500;
    font-size: 13px;
    padding: 0 8px;
    border-radius: 5px;
    height: 20px;
    display: inline-block;
    }
table thead tr th {
    padding: 5px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    color: #0f0e47 !important;
}
table th {
        font-size: 13px;
        font-weight: 600 !important;
        line-height: 22px;
    }
table td {
	    font-size: 13px !important;
        font-weight: 500 !important;
        color: #312e2e !important;
        line-height: 20px !important;
        letter-spacing: 0.5px;
            padding-left: 10px;
	}
	table tr{
	    vertical-align: baseline;
	}

@media print {
	.no-print {
		display: none;
	}
	body{
	    background: #fff;
	}
	input {
		border-color: transparent !important;
	}
	select {
		border-color: transparent !important;
	}
	td #mrnDate {
		border-color: transparent !important;
		display: none;
	}
	 td textarea {
		border-color: transparent !important;
		resize: none;
	}
	td #doc{
	display: none;
	}
	.btnholder,.fa-calendar-week{
	display: none;
	}
	.invoice-form table thead th,.detailsheading {
        background: transparent !important;
        color: #000 !important;
    }
    .detailsheading{
        font-weight: 700;
        dest-decoration: underline !important;
    }
    .btn_Group,.opnlink_btn{
        display: none;
    }
    .borderNone{
                border: none !important;
            }
            .card-header{
                    padding-left: 0 !important;
                }


}
</style>
	<div class="container mt-2 invoice-form" style="width: 100%;max-width: 900px; margin: auto; background: #fff; position: relative; padding: 10px;">
		<div style="float: left; width: 50%">
			<h3 style="margin-bottom: 5px; margin-top: 5px; color: #000;font-weight: 600; padding:10px;">Bill Invoice</h3>
		</div>
		<div style="float: right; width: 50%; text-align: right;">
			<c:choose>
                <c:when test="${!empty principal.currentUserVo.icon && principal.currentUserVo.icon.length() > 0}">
                    <c:set var="appIcon" value="${principal.currentUserVo.icon}" />
                    <img src="${contextPath}/document/view-documents?doc=${appIcon}&module=ICON" alt="logo" class="logo" style="width: 50px;" />
                </c:when>
                <c:otherwise>
                    <img src="${contextPath}/assets/images/favicon.png" alt="logo" class="logo" style="width: 50px;" />
                </c:otherwise>
            </c:choose>
		</div>
            <div style="clear:both; margin-bottom:0"></div>
                 <div class="card-header" style="position: relative; ">
                    <button type="button" class="no-print" style="float: right;position: absolute;top: -3px;right: 10px;border: none;background: none;font-size: 26px;color: #5f7dcb;" onclick="window.print()">
                        <i class="fa-solid fa-print"></i>
                    </button>
                    <h4 class="detailsheading" style=" color: #0f0e47; font-size: 16px;padding-left: 2px; margin-bottom: 0px; margin-top: 0;font-weight: 600;">Bill details :</h4>
                 </div>
            <div style="clear:both; margin-bottom:0"></div>
        <div class="row" style="">
            <div style="width:50%; float: left;padding: 10px 0;" class="">
                <table>
                    <tr>
                        <th style="width:40%">Bill No. :</th>
                        <td style="width:60%">${bill.billNo}</td>
                    </tr>
                    <tr>
                        <th style="width:40%">Bill Date :</th>
                        <td style="width:60%"><fmt:formatDate value='${bill.billGenerateDate}' pattern='dd/MM/yyyy' /></td>
                    </tr>
                    <tr>
                        <th style="width:40%">PO No. :</th>
                        <td style="width:60%"><a href="${contextPath}/procurement/purchaseOrder/supplier/poInvoice?poId=${bill.purchaseOrder.poId}" target="_blank">${bill.purchaseOrder.poNo}</a></td>
                    </tr>
                    <tr>
                        <th style="width:40%">PO Date :</th>
                        <td style="width:60%"><fmt:formatDate value='${bill.purchaseOrder.poReceiptGeneratedDate}' pattern='dd/MM/yyyy' /></td>
                    </tr>
                </table>
            </div>
            <div style="width:50%; float: right;padding: 10px 0;" class="">
                <table>
                    <tr>
                        <th style="width:40%">Vendor Name :</th>
                        <td style="width:60%">${bill.purchaseOrder.assetVendor.vendorName}</td>
                    </tr>
                    <tr>
                        <th style="width:40%">Address :</th>
                        <td style="width:60%">${bill.purchaseOrder.assetVendor.vendorAddress}</td>
                    </tr>
                    <tr>
                        <th style="width:40%">Mobile :</th>
                        <td style="width:60%">${not empty bill.purchaseOrder.assetVendor.mobileNo ? bill.purchaseOrder.assetVendor.mobileNo : 'N/A'}</td>
                    </tr>
                    <tr>
                        <th style="width:40%">Bill Status :</th>
                        <td style="width:60%">
                            <c:choose>
                                <c:when test="${bill.isPaid}">
                                    Paid
                                </c:when>
                                <c:otherwise>
                                    Not Paid
                                </c:otherwise>
                            </c:choose>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
		<table class=" table table-striped table-bordered  mt-3">
			<thead class="bagGroundColor">
				<tr style="background: #00ffff1f !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;">
					<th style="width: 65px">Sl No</th>
					<th>GRN No.</th>
					<th>GRN Date</th>
					<th>GRN Doc</th>
					<th>GRN Link</th>
				</tr>
			</thead>
			<tbody>
				<c:forEach items="${bill.billGrnMap}" var="grnList" varStatus="count">
					<tr>
						<td>${count.count}</td>
						<td>${grnList.grn.grnNo}</td>
						<td><fmt:formatDate value='${grnList.grn.grnDate}' pattern='dd/MM/yyyy' /></td>
						<td>
							<c:choose>
								<c:when test="${not empty grnList.grn.grnDoc}">
									<i class="fa-regular fa-file-lines" style="font-size: 19px" onclick="downloadDoc('${grnList.grn.grnDoc}')"></i>
								</c:when>
								<c:otherwise>
									No Doc Uploaded
								</c:otherwise>
							</c:choose>
						</td>
						<td>
							<a onclick="viewGrn(${grnList.grn.grnId})" class="opnlink_btn" target="_blank">Open link</a>
						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>

		<table class="footer-fix-table" style="width: 100%; margin-top: 100px">
			<tfoot>
				<tr style="background: #8483c7 !important; font-size: 12px;color: #fff;" class="bagGroundColor">
					<th colspan="2" style="text-align: center; padding: 8px 0; text-align: center; line-height: 16px;">
						<p style="margin: 5px 0 0 0;">If you have any question about this price quote,please inform us at</p>
						<p style="margin: 0 0 5px 0;">demo@gmail.com or call us at 2323432432</p>
						<h4 style="margin: 0;">Thank You !!!</h4>
					</th>
				</tr>
			</tfoot>
		</table>
        <form method="post" action="${contextPath}/procurement/purchaseOrder/billPayment" id="billForm">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <input type="hidden" id="" name="billId" value="${bill.billId}">
            <input type="hidden" class="" id="encodedDatabillForm" name="encodedDatabillPayment" value="" />
            <div class="text-center mt-2 btn_Group">
                <c:if test="${!bill.isPaid}">
                    <button type="button" class="btn btn-primary" style="padding: 0 12px; height: 29px; line-height: 25px" onclick="submitBill()">Payment</button>
                </c:if>
                <a href="#" onclick="backToBill(${bill.purchaseOrder.poId})"><button type="button" class="btn btn-danger" style="padding: 0 12px; height: 29px; line-height: 25px" >Back</button></a>
            </div>
        </form>
	</div>
</div>
<form action="${contextPath}/procurement/purchaseOrder/viewGrn" method="get" id="viewGrn">
	<input type="hidden" class="" id="encodedDataviewGrn" name="grnIdEncoded" value="" />
</form>
<form method="post" action="${contextPath}/document/download" id="download" target="empty">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="docPath" name="docPath" value="">
	<input type="hidden" id="module" name="module" value="Purchase/Grn">
</form>
<form method="get" action="${contextPath}/procurement/purchaseOrder/billgenerate" id="form">
    <input type="hidden" class="noPass" id="poId" name="poId" value="" />
    <input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
</form>
<script>
    function viewGrn(grnId) {
        var encodeGrn= btoa(grnId);
        $("#encodedDataviewGrn").val(encodeGrn);
        $("#viewGrn").submit();
    }
function downloadDoc(path,module){
	$("#docPath").val(path);
	$("#download").submit();
}
function submitBill() {
	let isConfirm = confirm("Are you sure you want to proceeding payment?");
	if(isConfirm){
	    encryptFormData("billForm", tableOrTbodyIDS, tableOrTbodyKeys);
		$("#billForm").submit();
	}
	
}
function backToBill(poId) {
    $("#poId").val(poId);
    encryptFormData("form", tableOrTbodyIDS, tableOrTbodyKeys);

    $("#form").submit();
}
</script>