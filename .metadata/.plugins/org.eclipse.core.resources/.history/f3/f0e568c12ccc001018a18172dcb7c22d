<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />


<div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color"><spring:message code="INV.ISSUE.REQ.TITLE" /></h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item">
                      <a href="#">Inventory</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page"><spring:message code="INV.ISSUE.REQ.TITLE" /></li>
                  </ol>
                </nav>
              </div>
            </div>
            
            
            <div class="row mt-2">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title"><spring:message code="INV.ISSUE.REQ.TITLE" /></h5>
                    </div>
                    <div class="card-body">
        <form method="post" id="issueRequest" modelAttribute="issueRequest" enctype="multipart/form-data" action="${contextPath}/inventory/issueRequest/save">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <input type="hidden" name="issueItemRequestId" value="${req.issueItemRequestId}" />
             <input type="hidden" class="" id="encodedDataissueRequest" name="encodedDataissueRequest" value="" />
				<div class="row">
					<div class="col-md-12">
<%-- 					<h5 class="mb-3"><spring:message code="INV.ISSUE.REQ.TITLE" /></h5> --%>
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.FINYEAR" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${financialYearList.size() > 1}">
												<select class="form-control requiredField" id="finYear" name="finYear">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${financialYearList}" var="financialYear">
														<option value="${financialYear.finyearId}" ${(not empty req && req.finYear.finyearId eq financialYear.finyearId) ? 'selected' : ''}>${financialYear.finYear}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="finYear" value="${not empty req ? req.finYear.finYrId : financialYearList[0].finyearId}" />
												<input type="text" class="form-control" value="${not empty req ? req.finYear.finyearId : financialYearList[0].finyearId}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="INV.ISSUE.REQ.REQNO" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="requestNumber" value="${not empty req ? req.requestNumber : reqNo}" readonly="readonly" />
									</div>
								</div>
							</div>
							
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="INV.ISSUE.REQ.FOR" /></label>
									<div class="col-md-12">
										<!-- <c:choose>
											<c:when test="${stockTypeList.size() > 1}">
												<select class="form-control requiredField" id="stockType" name="stockType" ${(not empty req && canTakeAction eq false) ? 'disabled' : ''}>
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${stockTypeList}" var="stockType">
														<option value="${stockType.stockTypeId}" ${(not empty req && req.stockType.stockTypeId eq stockType.stockTypeId) ? 'selected' : ''}>${stockType.stockTypeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="stockType" value="${not empty req ? req.stockType.stockTypeId : stockTypeList[0].stockTypeId}" />
												<input type="text" class="form-control" readonly="readonly" value="${not empty req ? req.stockType.stockTypeName : stockTypeList[0].stockTypeName}" />
											</c:otherwise>
										</c:choose> -->
										<input type="hidden" name="stockType" id="stockType" value="${not empty req ? req.stockType.stockTypeId : singleStockType.stockTypeId}" />
										<input type="text" class="form-control" readonly="readonly" value="${not empty req ? req.stockType.stockTypeName : singleStockType.stockTypeName}" />
										
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="COMMON.STORE" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${lstStore.size() > 1}">
												<select class="form-control requiredField" id="store" name="store" onchange="emptyTable()">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${lstStore}" var="store">
														<option value="${store.storeId}" ${(not empty req && req.store.storeId eq store.storeId) ? 'selected' : ''}>${store.storeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="store" id="store" value="${not empty req ? req.store.storeId : lstStore[0].storeId}" />
												<input type="text" class="form-control" readonly="readonly" value="${not empty req ? req.store.storeName : lstStore[0].storeName}" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.PRIORITY" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${priorityList.size() > 1}">
												<select class="form-control requiredField" id="priority" name="priorityLevel">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${priorityList}" var="priority">
														<option value="${priority.priorityLevelId}" ${(not empty req && req.priorityLevel.priorityLevelId eq priority.priorityLevelId) ? 'selected' : ''}>${priority.priorityLevelName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="priorityLevel" value="${not empty req ? req.priorityLevel.priorityLevelId : priorityList[0].priorityLevelId}" />
												<input type="text" class="form-control" readonly="readonly" value="${not empty req ? req.priorityLevel.priorityLevelName : priorityList[0].priorityLevelName}" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"> Cost Center</label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${costCenterList.size() > 1}">
												<select class="form-control requiredField" name="costCenter" id="costCenterId" >
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${costCenterList}" var="costCenter">
														<option value="${costCenter.costCenterId}" ${not empty req.costCenter && req.costCenter.costCenterId eq costCenter.costCenterId ? 'selected' : ''}>${costCenter.costCenterName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="costCenter" value="${not empty req ? req.costCenter.costCenterId : costCenterList[0].costCenterId}" />
												<input type="text" class="form-control" readonly="readonly" value="${not empty req ? req.costCenter.costCenterName : costCenterList[0].costCenterName}" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label class="col-md-12" for="text"><spring:message code="INV.ISSUE.REQ.GENERAL.PURPOSE" /></label>
									<div class="col-md-12">
										<textarea class="form-control AlphaNumericForText textArea unfreezeField" id="purpose" name="purpose" maxlength="200" placeholder="Please give description on general purpose of request" ${(not empty req && canTakeAction eq false) ? 'readonly' : ''}>${req.purpose}</textarea>
									</div>
								</div>
							</div>
							<c:if test="${canTakeAction}">
								<div class="col-md-12 text-end ">
									<div class="form-group">
										<button type="button" class="btn btn-submit" style="width: auto;" onclick="getItemsPaggination()">
										<i class="fa fa-plus"></i> Add Item</button>
									</div>
								</div>	
							</c:if>
							<div class="col-md-12 " style="margin-top: -20px;">
								<table class="table table-striped table-bordered mt-3 tableValidation">
									<thead class="bagGroundColor">
										<tr style="text-align: center;">
											<th style="width: 70px;">Sl No.</th>
											<th style="width: 400px;">Item Name</th>
											<th style="width: 70px;">Req Qty</th>
											<th style="width: 70px;">Uom</th>
											<c:if test="${canTakeAction}">
												<th style="width: 70px;">Action</th>
											</c:if>
										</tr>
									</thead>
									<tbody id="itemBody">
										<c:forEach items="${req.requestItemsList}" var="line" varStatus="count">
											<tr id="row${count.index}">
												<input type="hidden" id="lineItemId${count.index}" name="requestItemsList[${count.index}].requestItemId" value="${line.requestItemId}" />
												<td>${count.index+1}</td>
												<td>
													<span>${line.itemName}<br>(${line.itemCode})</span>
													<input type="hidden" id="itemId${count.index}" name="requestItemsList[${count.index}].itemId" value="${line.itemId}" readonly="readonly" />
												</td>
												<td>
													<input type="number" id="quantity${count.index}" class="quantity onClickInput ${line.fractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero' } maximunLengthIs10WithDot form-control greaterThanZero" name="requestItemsList[${count.index}].requestQuantity" value="${line.requestQuantity}" style="width: 100%;" ${canTakeAction eq false ? "readonly" : ""  } />
												</td>
												<td>
													<input type="hidden" id="uom${count.index}" name="" value="${line.itemUnit}" readonly="readonly" />
                                                    <input type="hidden" id="isFractional${count.index}" name="" value="${line.fractional}" readonly="readonly" />
													<span>${line.itemUnit}</span>
												</td>
												<c:if test="${canTakeAction}">
													<td>
														<button type="button" title="Remove" class="btn btn-danger removeBtn no-print" style="height: 23px;font-size: 22px;line-height: 4px;" onclick="removeOtherItem(${count.index})">-</button>
													</td>
												</c:if>
											</tr>
										</c:forEach>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
	
			<c:set var="dynamicFromId" value="issueRequest" scope="request" />
          <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
        </form>
	</div>
</div>
</div>
</div>
<%@ include file="/WEB-INF/views/assetInvProc/itemModal/addItemModal.jsp"%>

<script>
tableIds=['itemBody'];
jsonKeys=['requestItemsList'];
var itemLists = [];
function addItemsToRow(){
	$('#itemBody').empty();
	var html='';
	itemLists.map((item, index) => {
		let formatter = new Intl.NumberFormat('en-IN', {
			   minimumFractionDigits: 2,
			   maximumFractionDigits: 2,
		});
		price=formatter.format(item.lastPprice);
		var slNo=index+1;
		html+='<tr id="row'+index+'">'
		html+=' <input type="hidden" id="lineItemId'+index+'" name="requestItemsList['+index+'].requestItemId" value="'+item.reqId+'">';
		html+='<td>'+slNo+'</td>';
		html+='<td><span>'+item.itemName+'<br>('+item.itemCode+')</span>';
		html+='<input type="hidden" id="itemId'+index+'" name="requestItemsList['+index+'].itemId" value="'+item.itemId+'" readonly="readonly"></td>';
		html+='<td><input type="number" id="quantity'+index+'"class="quantity onClickInput ';
		if(item.isFractional == 'true'){
            html +='numberWithTwoDesimal ';
        }else{
            html +='numberWithTwoDesimalButOnlyAllowZero ';
        }
		html+='maximunLengthIs10WithDot greaterThanZero form-control" name="requestItemsList['+index+'].requestQuantity" value="'+item.reqQty+'" style="width: 100%;" ${canTakeAction eq false ? "readonly" : ""  }></td>';
		html+='<td><input type="hidden" id="uom'+index+'" name="" value="'+item.uom+'" readonly="readonly">';
		html+='<span>'+item.uom+'</span></td>';
		html+='<c:if test="${canTakeAction}"><td>'+
			'<button type="button" title="Remove" class="btn btn-danger removeBtn no-print" style="height: 23px;font-size: 22px;line-height: 4px;" onclick="removeOtherItem('+index+')">-</button>' +
			'</td></c:if>';				
		html+='</tr>';
	});
	$('#itemBody').append(html);
	$('#addOtherItemModal').modal('hide');
}
function removeOtherItem(rowNo){
	$('#row'+rowNo).remove();
	itemLists.splice(rowNo, 1);
	$('#itemDiv'+rowNo).css('background-color', '#fff');
	addItemsToRow();
}
function emptyTable(){
	$('#itemBody').empty();
	itemLists = [];
}
function getDataFromTrAndPushIntoArrList(){
}
function 	calculateTotalAddCost(){
}


</script>