<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<link href="${contextPath}/assets/css/dashboard.css" rel="stylesheet" type="text/css" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">
			Add School
		</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home">
				<i class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Add School</li>
			</ol>
		</nav>
	</div>
</div>
<div class="card">
	<div class="card-header">
		<c:choose>
			<c:when test="${not empty school.schoolId}">
				<h5 class="card-title">Update School</h5>
			</c:when>
			<c:otherwise>
				<h5 class="card-title">Add School</h5>
			</c:otherwise>
		</c:choose>
	</div>
	<div class="card-body">
		<form action="${contextPath}/school/saveschool" id="addschoolFrm" method="post">
			<input type="hidden" id="cipherText" name="cipherText" value="">
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
			<input type="hidden" id="schoolId" name="schoolId" value="${school.schoolId}" />
			<input type="hidden" id="isActive" name="isActive" value="${school.isActive}" />
			
			<div class="row">
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="schoolName">School Name :</label>
						<div class="col-md-12">
							<input type="text" id="schoolName" name="schoolName" value="${school.schoolName}" maxlength="48" class="form-control form-control-sm AlphaNumericOnly disablecopypaste" required="required" onkeyup="changeCase(this.value,'schoolName');">
						</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12" for="schoolCode">School Code :</label>
						<div class="col-md-12">
							<input type="text" id="schoolCode" name="schoolCode" value="${school.schoolCode}" maxlength="48" readonly class="form-control form-control-sm AlphaNumericOnly disablecopypaste" required="required" onkeyup="changeCase(this.value,'schoolCode');">
						</div>
					</div>
				</div>
				<div class="col-md-3">
                    <div class="form-group">
                        <label class="col-md-12 required" for="type">School Type :</label>
                        <select class="form-control form-control-sm form-select" id="type" name="type">
                            <option value="0" selected disabled>- Select -</option>
                            <c:forEach items="${schoolTypeList}" var="schoolType" varStatus="index">
                                <option value="${schoolType.valueEn}" ${ schoolType.valueEn eq school.type ? 'selected' : ''}>${schoolType.valueEn}</option>
                            </c:forEach>
                        </select>
                    </div>
                </div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="uidsceCode">UIDSE Code :</label>
						<div class="col-md-12">
							<input type="text" id="uidsceCode" name="uidsceCode"
								value="${school.uidsceCode}" maxlength="48"
								class="form-control form-control-sm AlphaNumericOnly disablecopypaste"
								 required="required" onkeyup="changeCase(this.value,'uidsceCode');">
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="districtId">District Name :</label>
						<div class="col-md-12">
							<select class="form-control form-control-sm form-select"
								data-live-search="true" id="districtId" name="districtId" onchange="LoadBlockByDistrict(this.value)">
								<option value="0" selected disabled>- Select -</option>													
								<c:forEach var="district" items="${districtList}">
									<option value="${district.districtId}" ${district.districtId eq school.districtId?'selected':''}>${district.districtName}</option>
								</c:forEach>
							</select>
						</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="blockId">Block Name :</label>
						<div class="col-md-12">
							<select id="blockId" name="blockId" class="form-control form-control-sm form-select" required="required" onchange="LoadGrampanchayatByBlock(this.value);">
								<option value="0" selected disabled>- Select -</option>
								<c:if test="${not empty school}">
									<c:forEach var="block" items="${blockList}">
										<option value="${block.blockId}" ${block.blockId eq school.blockId?'selected':''}> ${block.blockName}</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="gpId">GramPanchayat Name :</label>
						<div class="col-md-12">
							<select id="gpId" name="gpId" class="form-control form-control-sm form-select" required="required" onchange="LoadVillageByGrampanchayat(this.value)">
								<option value="0" selected disabled>- Select -</option>
								<c:if test="${not empty school}">
									<c:forEach var="panchayat" items="${panchayatList}">
										<option value="${panchayat.gpId}" ${panchayat.gpId eq school.gpId?'selected':''}>${panchayat.gpName}</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
				</div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="gpId">Village Name :</label>
						<div class="col-md-12">
							<select id="villageId" name="villageId" class="form-control form-control-sm form-select" required="required" onchange="fetchSchoolCode();">
								<option value="0" selected disabled>- Select -</option>
								<c:if test="${not empty school}">
									<c:forEach var="village" items="${villageList}">
										<option value="${village.villageId}" ${village.villageId eq school.villageId?'selected':''}>${village.villageName}</option>
									</c:forEach>
								</c:if>
								</select>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-3">
						<div class="form-group">
							<label class="col-md-12 required" for="headMaster">HeadMaster Name:</label>
							<div class="col-md-12">
								<input type="text" id="headMaster" name="headMaster" value="${school.headMaster}" maxlength="48" class="form-control form-control-sm AlphaNumericOnly disablecopypaste" required="required" onkeyup="changeCase(this.value,'headMaster');">
						</div>
					</div>
				</div>	
				<div class="col-md-3">
					<div class="form-group">
						<label class="col-md-12 required" for="classRange">Class Range :</label>
						<div class="col-md-12">
							<input type="text" id="classRange" name="classRange" value="${school.classRange}" maxlength="12" class="form-control form-control-sm " required="required">
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-md-12">
					<div class="text-center" style="margin-top: 20px;">
						<c:choose>
							<c:when test="${not empty school}">
								<input type="button" name="add&ManageApplicationSchool" value="Update" id="add&ManageApplicationSchools" class="btn btn-success btn-sm" onclick="submitFormData()">
							<a href="${contextPath}/school/addschool" type="button" class="btn btn-warning btn-sm">Back</a>

							</c:when>
							<c:otherwise>
								<input type="button" name="add&ManageApplicationSchool" value="Submit" id="addManageApplicationSchools" class="btn btn-success btn-sm" onclick="submitFormData()">
								<a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
								<button type="reset" class="btn btn-danger btn-sm">Reset</button>
							</c:otherwise>
						</c:choose>

					</div>
				</div>
			</div>
		</form>
	</div>
</div>
<!-- <div class="col-md-12 mt-3"> -->
<%-- 	<c:if test="${empty school}"> --%>
<!-- 		<div class="card"> -->
<!-- 			<div class="card-header"> -->
<!-- 				<h5 class="card-title">School List</h5> -->
<!-- 			</div> -->
<!-- 			<div class="card-body"> -->
<!-- 				<div class="table-responsive"> -->
<!-- 					<table id="basic-datatables" -->
<!-- 						class="table table-bordered table-hover exportbtn"> -->
<!-- 						<thead> -->
<!-- 							<tr> -->
<!-- 								<th class="text-center" style="width:60px">Sl.No</th> -->
<!-- 								<th>School Name</th> -->
<!-- 								<th>School Code</th> -->
<!-- 								<th>HeadMaster Name</th> -->
<!-- 								<th>UIDSE Code</th> -->
<!-- 								<th class="text-center">Action</th> -->
<!-- 							</tr> -->
<!-- 						</thead> -->
<!-- 						<tbody> -->
<%-- 							<c:forEach var="school" items="${schoolList}" varStatus="count"> --%>
<!-- 								<tr> -->
<%-- 									<td class="text-center">${count.count}</td> --%>
<%-- 									<td>${school.schoolName}</td> --%>
<%-- 									<td>${school.schoolCode}</td> --%>
<%-- 									<td>${school.headMaster}</td> --%>
<%-- 									<td>${school.uidsceCode}</td> --%>
<!-- 									<td class="text-center"> -->
<%-- 										<button class="btn btn-warning btn-sm" id="editBtn" data-block-id="${school.schoolId}" --%>
<%-- 											data-toggle="tooltip" onclick="editSchoolForm(${school.schoolId})" title="Edit"> --%>
<!-- 											<i class="fas fa-edit"></i> -->
<!-- 										</button> -->
<!-- 									</td> -->
<!-- 								</tr> -->
<%-- 							</c:forEach> --%>
<!-- 						</tbody>  -->
<!-- 					</table> -->
<!-- 				</div> -->
<!-- 			</div> -->
<!-- 		</div> -->
<%-- 	</c:if> --%>
<!-- </div> -->
<div class="col-md-12 mt-3">
    <c:if test="${empty school}">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">School List</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="basic-datatables"
                           class="table table-bordered table-hover exportbtn">
                        <thead>
                            <tr>
                                <th class="text-center" style="width:60px">Sl.No</th>
                                <th>School Name</th>
                                <th style="width: 120px;">School Code</th>
                                <th>District</th>
                                <th>Block</th>
                                <th>GramPanchayat</th>
                                <th>Village</th>
                                <th>HeadMaster Name</th>
                                <th>UIDSE Code</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <c:forEach var="school" items="${schoolList}" varStatus="count">
                                <tr>
                                    <td class="text-center">${count.count}</td>
                                    <td>${school.schoolName}</td>
                                    <td>${school.schoolCode}</td>
                                    <td>${school.districtName}</td>
                                    <td>${school.blockName}</td>
                                    <td>${school.gpName}</td>
                                    <td>${school.villageName}</td>
                                    <td>${school.headMaster}</td>
                                    <td>${school.uidsceCode}</td>
                                    <td class="text-center">
                                        <button class="btn btn-warning btn-sm" id="editBtn" data-block-id="${school.schoolId}"
                                                data-toggle="tooltip" onclick="editSchoolForm(${school.schoolId})" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            </c:forEach>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </c:if>
</div>
<script>

	function submitFormData() {
		
		var schoolId = $("#schoolId").val();
		var schoolName = $("#schoolName").val();
		var schoolCode = $("#schoolCode").val();
		var type = $("#type").val();
		var uidsceCode = $("#uidsceCode").val();
		var districtId = $("#districtId").val();
		var blockId = $("#blockId").val();
		var gpId = $("#gpId").val();
		var villageId = $("#villageId").val();
		var headMaster = $("#headMaster").val();
		var classRange = $("#classRange").val();
		
	 	if(schoolName.trim() === ""){
			bootbox.alert("Please Enter School Name");
			return false;
		}else if(!type || type === "0"){
			bootbox.alert("Please Select School Type");
			return false;
		}else if(uidsceCode.trim() === ""){
			bootbox.alert("Please Enter Uidse Code");
			return false;
		}else if(districtId === null){
			bootbox.alert("Please Select District Name");
			return false;
		}else if(blockId === null){
			bootbox.alert("Please Select Block Name");
			return false;
		}else if(gpId === null){
			bootbox.alert("Please Select GramPanchayat Name");
			return false;
		}else if(villageId === null){
			bootbox.alert("Please Select Village Name");
			return false;
		}else if(headMaster.trim() === ""){
			bootbox.alert("Please Enter Headmaster Name");
			return false;
		}else if(classRange.trim() === ""){
			bootbox.alert("Please Enter Class Range");
			return false;
		}else {
				
			if(schoolName.trim() !== "" && uidsceCode.trim() !== "")  {
		 		
		    	$.ajax({
			        type : "GET",
			        url : "${contextPath}/school/validate-school-name",
			        data: {
			        	schoolName: schoolName,
			        	schoolId: schoolId
			        },
			        success: function (isDuplicate) {
		                if (isDuplicate === true) {
		                	bootbox.alert('School name already exists please provide another school name .');
		                    $('#schoolName').val('').focus(); 
		                    return false;
		                }else{
		                	$.ajax({
		        		        type : "GET",
		        		        url : "${contextPath}/school/validate-uidsce-code",
		        		        data: {
		        		        	uidsceCode: uidsceCode,
		        		        	schoolId: schoolId
		        		        },
		        		        success: function (isDuplicate) {
		        	                if (isDuplicate === true) {
		        	                	bootbox.alert('UIDSE Code already exists please provide another UIDSE code .');
		        	                    $('#uidsceCode').val('').focus(); 
		        	                    return false;
		        	                }else{
		        	                	//submit form
		        	                	submitForm();
		        	                }
		        	            },
		        		        error : function(error) {
		        		        }
		        		    });
		                }
		            },
			        error : function(error) {
			        }
			    });	
		    }
	   }  
	}
	
	function submitForm(){
		 //submit tha form
    	 var bizContent = $("#addschoolFrm").serializeArray();
    	 $("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    	 bootbox.confirm("Do You Want To Continue?", function (result) {
	    	 if (result) {
	    	 showLoader();
	    	 $("#addschoolFrm").submit();
	    	 }
    	 });
	}
	
	function LoadBlockByDistrict(distId) {
		
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchBlockByDistrict",
	        data: {
	        	districtId: distId,
	        },
	        success: function (blocks) {
	            var block = $('#blockId'); 
	            block.empty();
	            block.append('<option value="" selected disabled>- Select -</option>');

	            $.each(blocks, function(index, blockData) {
	            	block.append('<option value="' + blockData.blockId + '">' + blockData.blockName + '</option>');
	            });
	        },
	        error: function (error) {
	            console.error("Error fetching blocks:", error);
	        }
	    });
	}
	
	function LoadGrampanchayatByBlock(blockId) {
		
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchGrampanchayatByBlock",
	        data: {
	        	blockId: blockId,
	        },
	        success: function (grampanchayats) {
	            var gp = $('#gpId'); 
	            gp.empty();
	            gp.append('<option value="" selected disabled>- Select -</option>');

	            $.each(grampanchayats, function(index, grampanchayat) {
	            	gp.append('<option value="' + grampanchayat.gpId + '">' + grampanchayat.gpName + '</option>');
	            });
	        },
	        error: function (error) {
	            console.error("Error fetching grampanchayat:", error);
	        }
	    });
	}

	function fetchSchoolCode(){
		var districtId = $("#districtId").val();
		var blockId = $("#blockId").val();
		var gpId = $("#gpId").val();
		var villageId = $("#villageId").val();

    	$.ajax({
	        type : "GET",
	        url : "${contextPath}/school/fetchSchoolCode",
	        data : {
	        	districtId,blockId,gpId,villageId
	        },
	        success : function(response) {
	            $("#schoolCode").val(response);
	        },
	        error : function(error) {
	        }
	    });
	}
	
	function LoadVillageByGrampanchayat(gpId) {
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchVillageByGrampanchayat",
	        data: {
	        	gpId: gpId,
	        },
	        success: function (villages) {
	            var gp = $('#villageId'); 
	            gp.empty();
	            gp.append('<option value="" selected disabled>- Select -</option>');

	            $.each(villages, function(index, village) {
	            	gp.append('<option value="' + village.villageId + '">' + village.villageName + '</option>');
	            });
	        },
	        error: function (error) {
	            console.error("Error fetching village:", error);
	        }
	    });
	}
  
  function editSchoolForm(id) {
		  $("#schoolIdEdit").val(id);
		  var bizContent = $("#editForm").serializeArray();
		  $("#editCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
		  bootbox.confirm("Do you want to continue ?",function(result){
			  if(result){
				  showLoader();
				  $("#editForm").submit();
			  }
		  })
	  }
  
	$(document).ready(function () {
	    $('#uidsceCode').on('input', function () {
	        let val = $(this).val();
	        val = val.replace(/[^a-zA-Z0-9]/g, '');
	        if (val.length > 12) {
	            val = val.substring(0, 12);
	        }
	        $(this).val(val);
	    });
	});

</script>

<form action="${contextPath}/school/editschool" method="Post" id="editForm">
 <input type="hidden" id="editCipherText" name="cipherText">
 <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
 <input type="hidden" name="schoolId" id="schoolIdEdit" />
</form>
