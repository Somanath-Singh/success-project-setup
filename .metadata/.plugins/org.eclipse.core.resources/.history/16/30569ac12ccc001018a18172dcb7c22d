<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<!-- NOTE: CSS & JS should be in <head> or Tiles <put-attribute name="js"> -->
<!-- Remove <link> and <script> from here — move to Tiles layout or header -->

<!-- Breadcrumb -->
<%-- <div class="breadcrumb_conatiner">
    <div class="col-md-6">
        <h4 class="change-color">Building Planning List</h4>
    </div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="${contextPath}/home"><i class="fa fa-home"></i> Home</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Building Planning List</li>
            </ol>
        </nav>
    </div>
</div> --%>
<div class="mt-3">
	<%@ include file="/WEB-INF/views/BAMS/filter-building-page/building-common-filter.jsp"%>
</div>

<div class="card mt-3">
  <div class="card-header">
    <h5 class="card-title">Building Report Details</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-striped exportbtn" id="reportTable">
        <thead class="table-light">
          <tr>
           <th class="text-center" style="width:60px;">Sl No.</th>
           <th>Building Name</th>
           <th>Building Type</th>
           <th>Last Updated Date</th>
           <th>Current Status</th>
           <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <c:choose>
            <c:when test="${not empty buildingFilterData.reportDataList}">
              <c:forEach items="${buildingFilterData.reportDataList}" var="item" varStatus="loop">
                <tr>
                  <td class="text-center">${loop.index + 1}</td>
                  <td>${item.planningDTO.buildingName}</td>
	              <td>${item.planningDTO.buildingType}</td>
	             <td>
                   <c:choose>
                      <c:when test="${not empty item.buildingDTO.lastUpdatedOn}">
                       <fmt:parseDate value="${item.buildingDTO.lastUpdatedOn}" 
                           pattern="yyyy-MM-dd HH:mm:ss.SSS"
                           var="parsedDate" />
                       <fmt:formatDate value="${parsedDate}" pattern="dd/MM/yyyy" />
                    </c:when>
               <c:otherwise>N/A</c:otherwise>
              </c:choose>
               </td>

	             <td>
	             	<c:choose>
                        <c:when test="${not empty item.buildingDTO.currentStatus}">
                            ${item.buildingDTO.currentStatus}
                        </c:when>
                        <c:otherwise>N/A</c:otherwise>
                    </c:choose>
                  <td>
                    <button class="btn btn-sm btn-primary me-1" 
                            title="Edit"
                            onclick="editBuildingDetails(${item.buildingDTO.buildingId})">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-info text-white" 
                            title="View"
                            onclick="viewBuildingDetails(${item.buildingDTO.buildingId})">
                        <i class="fa fa-eye"></i>
                    </button>
                </td>
                </tr>
              </c:forEach>
            </c:when>
            <c:otherwise>
              <tr><td colspan="7" class="text-center text-muted">No records found for the selected criteria.</td></tr>
            </c:otherwise>
          </c:choose>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="buildingDetailsModal" tabindex="-1" aria-labelledby="modalDynamicLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="" id="modalDynamicLabel">View Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="buildingDetailsContainer"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<form action="${contextPath}/building/edit-building-planning-details" method="Post" id="editForm">
 <input type="hidden" id="editCipherText" name="cipherText">
 <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
 <input type="hidden" name="buildingId" id="buildingIdEdit" />
</form>

<script>

function editBuildingDetails(buildingId) {
	  $("#buildingIdEdit").val(buildingId);
	  var bizContent = $("#editForm").serializeArray();
	  $("#editCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
	  bootbox.confirm("Do you want to continue ?",function(result){
		  if(result){
			  showLoader();
			  $("#editForm").submit();
		  }
	  })
}

function viewBuildingDetails(buildingId) {
    $.ajax({
        type: "GET",
        url: "${contextPath}/building/get-building-all-tab-details",
        data: { buildingId: buildingId },
        success: function (building) {
            if (!building) {
                alert("No data found for this building.");
                return;
            }

            var html = "";

            // ======== Building / Planning Details ========
            var p = building.planningDTO;
            html += "<div class='card-header text-white'><h5 class='card-title'>Building Details</h5></div>";
            html += "<div class='row mb-3'>";

            if (p != null) {
            	if (p.areaType) html += "<div class='col-md-6 mb-2'><strong>Area Type:</strong> " + p.areaType + "</div>";
            	if (p.districtName) html += "<div class='col-md-6 mb-2'><strong>District Name:</strong> " + p.districtName + "</div>";
            	if (p.blockName) html += "<div class='col-md-6 mb-2'><strong>Block Name:</strong> " + p.blockName + "</div>";
            	if (p.gpName) html += "<div class='col-md-6 mb-2'><strong>Gp Name:</strong> " + p.gpName + "</div>";
            	if (p.villageName) html += "<div class='col-md-6 mb-2'><strong>Village Name:</strong> " + p.villageName + "</div>";
            	if (p.municipalityName) html += "<div class='col-md-6 mb-2'><strong>Municipality Name:</strong> " + p.municipalityName + "</div>";
            	if (p.wardName) html += "<div class='col-md-6 mb-2'><strong>Ward Name:</strong> " + p.wardName + "</div>";
                if (p.buildingName) html += "<div class='col-md-6 mb-2'><strong>Building Name:</strong> " + p.buildingName + "</div>";
                if (p.buildingType) html += "<div class='col-md-6 mb-2'><strong>Building Type:</strong> " + p.buildingType + "</div>";
                if (p.subCategory) html += "<div class='col-md-6 mb-2'><strong>Sub Category:</strong> " + p.subCategory + "</div>";
                if (p.schoolCategory) html += "<div class='col-md-6 mb-2'><strong>School Category:</strong> " + p.schoolCategory + "</div>";
                if (p.hostelType) html += "<div class='col-md-6 mb-2'><strong>Hostel Type:</strong> " + p.hostelType + "</div>";
                if (p.hostelCapacity && p.hostelCapacity != 0) html += "<div class='col-md-6 mb-2'><strong>Hostel Capacity:</strong> " + p.hostelCapacity + "</div>";
                if (p.hostelCategory) html += "<div class='col-md-6 mb-2'><strong>Hostel Category:</strong> " + p.hostelCategory + "</div>";
                if (p.udiseCode) html += "<div class='col-md-6 mb-2'><strong>UDISE Code:</strong> " + p.udiseCode + "</div>";
                if (p.locationCode) html += "<div class='col-md-6 mb-2'><strong>Location Code:</strong> " + p.locationCode + "</div>";
                if (p.buildingCode) html += "<div class='col-md-6 mb-2'><strong>Building Code:</strong> " + p.buildingCode + "</div>";
            }
            html += "</div>";

            // ======== Sanction Work ========
            var s = building.sanctionDTO;
            html += "<div class='card-header text-white'><h5 class='card-title'>Sanction Work Details</h5></div>";
            html += "<div class='row mb-3'>";
            if (s != null) {
                if (s.sanctionNumber) html += "<div class='col-md-6 mb-2'><strong>Sanction Number:</strong> " + s.sanctionNumber + "</div>";
                if (s.sanctionDate) html += "<div class='col-md-6 mb-2'><strong>Sanction Date:</strong> " + s.sanctionDate + "</div>";
                if (s.sanctionAmount && s.sanctionAmount != 0.0) html += "<div class='col-md-6 mb-2'><strong>Sanction Amount (₹):</strong> " + s.sanctionAmount + "</div>";
                if (s.sanctionAssignedTo) html += "<div class='col-md-6 mb-2'><strong>Assigned To:</strong> " + s.sanctionAssignedTo + "</div>";
                if (s.dprDate) html += "<div class='col-md-6 mb-2'><strong>DPR Date:</strong> " + s.dprDate + "</div>";
                if (s.dprAmount && s.dprAmount != 0.0) html += "<div class='col-md-6 mb-2'><strong>DPR Amount (₹):</strong> " + s.dprAmount + "</div>";
                if (s.administrativeApprovalOrder) html += "<div class='col-md-6 mb-2'><strong>Administrative Approval Order:</strong> " + s.administrativeApprovalOrder + "</div>";
                if (s.administrativeApprovalDate) html += "<div class='col-md-6 mb-2'><strong>Administrative Approval Date:</strong> " + s.administrativeApprovalDate + "</div>";
                if (s.tenderFloating) html += "<div class='col-md-6 mb-2'><strong>Tender Floating:</strong> " + s.tenderFloating + "</div>";
                if (s.tenderApproval) html += "<div class='col-md-6 mb-2'><strong>Tender Approval:</strong> " + s.tenderApproval + "</div>";
                if (s.workOrderDate) html += "<div class='col-md-6 mb-2'><strong>Work Order Date:</strong> " + s.workOrderDate + "</div>";
                if (s.workOrderNumber) html += "<div class='col-md-6 mb-2'><strong>Work Order Number:</strong> " + s.workOrderNumber + "</div>";
                if (s.completionDueDate) html += "<div class='col-md-6 mb-2'><strong>Completion Due (Days):</strong> " + s.completionDueDate + "</div>";
                if (s.completionDate) html += "<div class='col-md-6 mb-2'><strong>Completion Date:</strong> " + s.completionDate + "</div>";
                if (s.agencyContName) html += "<div class='col-md-6 mb-2'><strong>Agency Contact Name:</strong> " + s.agencyContName + "</div>";
                if (s.contractorPhone) html += "<div class='col-md-6 mb-2'><strong>Contractor Phone:</strong> " + s.contractorPhone + "</div>";
                if (s.workOrderValue && s.workOrderValue != 0.0) html += "<div class='col-md-6 mb-2'><strong>Work Order Value (₹):</strong> " + s.workOrderValue + "</div>";
                if (s.agreementDate) html += "<div class='col-md-6 mb-2'><strong>Agreement Date:</strong> " + s.agreementDate + "</div>";
            }
            html += "</div>";

            // inject data into modal
            document.getElementById("modalDynamicLabel").innerHTML = "View Details";
            document.getElementById("buildingDetailsContainer").innerHTML = html;

            var modal = new bootstrap.Modal(document.getElementById("buildingDetailsModal"));
            modal.show();
        },
        error: function (error) {
            console.error("Error fetching details:", error);
            alert("Failed to load building details.");
        }
    });
}


function openModalWithData(title, contentHtml) {
    // Set dynamic title
    document.getElementById("modalDynamicLabel").innerHTML = title;

    // Set dynamic body content
    document.getElementById("buildingDetailsContainer").innerHTML = contentHtml;

    // Show modal
    var modal = new bootstrap.Modal(document.getElementById("buildingDetailsModal"));
    modal.show();
}

	
</script>

