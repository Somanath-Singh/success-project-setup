<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/js/commonFunctions.js"></script>


 <div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">Add Assets</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Add Assets</li>
                  </ol>
                </nav>
              </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Add Assets</h5>
                    </div>
                    <div class="card-body">
	<form method="POST" action="${contextPath}/inventory/store/asset/save" id="addItemFrm" enctype="multipart/form-data">
		<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
<%-- 		<input type="hidden" id="itemId" name="itemId" value="${item.itemId }"> --%>
		<div class="row">
			<div class="col-md-12">
				<div class="row">
					<div class="form-group col-md-2">
						<label for="inputEmail4" class="required">Stock Type: </label> 
						<c:choose>
	                        <c:when test="${lstStkTyp.size() > 1}">
								<select class="form-select requiredField" aria-label="Default select example" id="stockType" name="stockType.stockTypeId" readonly>
									<option value="0">-Select-</option>
									<c:forEach items="${lstStkTyp}" var="stkTyp">
									<option value="${stkTyp.stockTypeId}" ${stkTyp.stockTypeCode eq 'EQUIPMENT' ? 'selected' :''}>${stkTyp.stockTypeName}</option>
									</c:forEach>
								</select>
							</c:when>
							<c:otherwise>
	                          <input type="hidden" name="stockType.stockTypeId" value="${lstStkTyp[0].stockTypeId}">
							  <input type="text" class="form-control form-control-sm requiredField" value="${lstStkTyp[0].stockTypeName}" readonly>
							</c:otherwise>
						</c:choose>
	                        
					</div>
					<div class="form-group col-md-2">
						<label for="inputEmail4" class="required">Category: </label> 
						<select class="form-select form-control form-control-sm requiredField" aria-label="Default select example" id="category" name="category.categoryId" onchange="getSubCategoryDetailsByCategoryiD(this.value)">
							<option value="0">-Select-</option>
							<c:forEach items="${lstCat}" var="cat">
								<option value="${cat.categoryId}" ${cat.categoryId eq item.category.categoryId ? 'selected' :''}>${cat.categoryName}</option>
							</c:forEach>
						</select>
					</div>
					<div class="form-group col-md-2">
						<label for="inputEmail4" class="required">Sub Category: </label> 
						<select class="form-select form-control form-control-sm requiredField" aria-label="Default select example" id="subcategory" name="subCategory.subCategoryId">
							<option value="0">-Select-</option>
							<c:if test="${not empty item}">
								<c:forEach items="${lstSubCat}" var="subcat">
									<option value="${subcat.subCategoryId}" ${subcat.subCategoryId eq item.subCategory.subCategoryId ? 'selected' :''}>${subcat.subCategoryName}</option>
								</c:forEach>
							</c:if>
						</select>
					</div>
					<div class="form-group col-md-2">
						<label class="col-md-12 required" for="text">Asset Name: </label> 
						<input class="form-control form-control-sm requiredField" type="text" id="assetName" name="assetName" placeholder="Enter Asset name" value="${item.itemName}" maxlength="30">
					</div>
					<div class="form-group col-md-2">
						<label class="col-md-12 required" for="text">Asset Code: </label> 
						<input class="form-control form-control-sm requiredField" type="text" name="assetCode" id="assetCode" placeholder="Enter Asset code" value="${item.itemCode}" maxlength="30">
					</div>
					<div class="form-group col-md-2">
						<label class="col-md-12 " for="text">Asset Brand:</label> 
						<input class="form-control form-control-sm" type="text" id="assetBrand" name="assetBrand.brandName" placeholder="Enter Item name" value="${item.itemName}" maxlength="30">
					</div>
					<div class="form-group col-md-2">
						<label for="inputEmail4" class="required">Asset Type: </label> 
						<c:choose>
	                        <c:when test="${lstItmTyp.size() > 1}">
								<select class="form-select  form-control form-control-sm requiredField" aria-label="Default select example" id="assetType" name="itemType.itemTypeId">
									<option value="0">-Select-</option>
									<c:forEach items="${lstItmTyp}" var="itemType">
										<option value="${itemType.itemTypeId}" ${itemType.itemTypeId eq item.itemType.itemTypeId ? 'selected' :''}>${itemType.itemTypeName}</option>
									</c:forEach>
								</select>
							</c:when>
							<c:otherwise>
	                          <input type="hidden" name="itemType.itemTypeId" value="${lstItmTyp[0].itemTypeId}">
							  <input type="text" class="form-control form-control-sm requiredField" value="${lstItmTyp[0].itemTypeName}" readonly>
							</c:otherwise>
						</c:choose>
					</div>
					<div class="form-group col-md-2">
						<label for="inputEmail4" class="required">UOM : </label>
						<select class="form-select form-control form-control-sm requiredField" aria-label="Default select example" id="uom" name="uom.uomId" >
							<option value="0">-Select-</option>
							<c:forEach items="${lstUom}" var="uom">
								<option value="${uom.uomId}" ${uom.uomCode eq 'UNIT' ? 'selected' :''}>${uom.uom}</option>
							</c:forEach>
						</select>
					</div>
					<div class="form-group col-md-4">
						<label class="col-md-12" for="text">Description:</label> 
						<textarea class="textArea form-control" name="description" id="description" placeholder="Enter Description" maxlength="100" rows="1">${item.description} </textarea>
					</div>
				</div>

				<div class="row">
					<div class="img-t-gal d-flex gap-4 zoom-gallery">
						<c:forEach items="${itemImgList}" var="urls" >
							<div class="position-relative">
								<button title="" type="button" class="float-end" onclick="removeImg(this,${urls.attachmentId})"><i class="fa-solid fa-xmark"></i></button>

								<a href="data:image/png;base64 ,${urls.attachmentPath}" class="inputFile">
										<img class="inputMedia" alt="doc" src="data:image/png;base64 ,${urls.attachmentPath}">
									</a>
							</div>
						</c:forEach>
					</div>
				</div>
				<div class="row" id="img">
					<div class="form-group col-md-3 " style="position: relative;" id="imgRow0">
						<label class="col-md-12 " for="text">Attachment File:</label>
						<input class="form-control form-control-sm " type="file" id="image0" name="itemImages[0].attachmentFile" placeholder="Enter Attachment Name" value="" maxlength="100" onchange="checkFileValidate(this)">
						<button type="button" class="btn-pluse position-absolute"
							id="btn_add_multiShop" onclick="addNewImage()" data-toggle="tooltip" data-placement="top" style="bottom: 3px;right: 15px;padding: 3px 8px;" title="Add More Image">
							<i class='fa fa-plus'></i>
						</button>
					</div>
				</div>

				<div class="col-md-12 text-center mt-3">
					<input type="button" class="btn btn-submit" value="Submit" onclick="validateForms()">
					<a  type="button" class="btn btn-sm btn-danger" onclick="backToModule()">Cancel</a>
				</div>
			</div>
		</div>
	</form>
	</div>
	</div>
	 
	<div class="col-md-12 mt-3">
	   <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Assets List</h5>
                    </div>
                    <div class="card-body">
		<div class="table-responsive">
			<table class="datatable table table-striped table-bordered exportbtn mt-3">
				<thead>
					<tr>
						<th>Sl No</th>
						<th>Asset Name</th>
						<th>Asset Code</th>
						<th>Asset Type</th>
						<th>Category</th>
						<th>Sub Category</th>
						<th>UOM</th>
						<th>Available Quantity</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody>
					<c:forEach items="${assList}" var="item" varStatus="status">
						<tr>
							<td>${status.count}</td>
							<td>${item.assetName}</td>
							<td>${item.assetCode}</td>
							<td>${item.itemType.itemTypeName}</td>
							<td>${item.category.categoryName}</td>
							<td>${item.subCategory.subCategoryName}</td>
							<td>${item.uom.uom}</td>
							<td>${item.avlQuality}</td>
 							<td>
								    <c:choose>
                                        <c:when test="${item.itemType.itemTypeName eq 'Stockable'}">
                                            <a href="${contextPath}/inventory/store/asset/add?assetId=${item.assetId}" class=" button-success btn btn-success btn-sm" data-toggle="tooltip" title="Asset Details"><i class="fa fa-eye" aria-hidden="true"></i></a>
                                        </c:when>
                                        <c:otherwise>
                                            <a href="${contextPath}/procurement/purchaseOrder/assetDetails?assetId=${item.assetId}" class="btn btn-success button-success btn-sm" data-toggle="tooltip" title="Asset Details"><i class="fa fa-eye" aria-hidden="true"></i></a>
                                        </c:otherwise>
                                    </c:choose>
 							</td>
						</tr>
					</c:forEach>
				</tbody>
			</table>
		</div>
	</div>
	</div>
	</div>
	</div>
	</div>
	
</section>
<script>
var brandArray = [];
$(document).ready(function(){
	<c:forEach items="${lstBrnd}" var="brand" varStatus="status">
		brandArray.push('${brand.brandName}');
	</c:forEach>
});
    function backToModule(){
       let currentModuleCode =  localStorage.getItem('currentModuleCode');
       $('#moduleId').val(enc_password(currentModuleCode));
       $('#moduleForm').submit();
    }
function validateForms(){
	// validate the form which have class "requiredField"
	var form = $("#addItemFrm");
	let requiredFields = form[0].querySelectorAll(".requiredField");
	var isValid = requiredFieldValidation(requiredFields);

	if(isValid){
		bootbox.confirm({
			message: "Are you sure you want to submit?",
			buttons: {
				confirm: {
					label: 'Yes',
					className: 'btn-success'
				},
				cancel: {
					label: 'No',
					className: 'btn-danger'
				}
			},
			callback: function (result) {
				if(result){
					form.submit();
				}
			}
		});
	}


}

var imageLine=0;
function addNewImage(){
	var html='';
	if(imageLine!=0){
		$("#imgminus"+imageLine).attr('disabled', true);	
	}
	imageLine++;
	html=html+'<div class="form-group col-md-3" id="imgRow'+imageLine+'" style="position:relative;margin-top:19px;"><input class="form-control form-control-sm " type="file" id="image'+imageLine+'" name="itemImages['+imageLine+'].attachmentFile" placeholder="Enter Attachment Name" value="" maxlength="100" onchange="checkFileValidate(this)"><button type="button" class="btn-minus position-absolute" style="bottom: 3px;right: 15px;padding: 3px 8px;"  id="imgminus'+imageLine+'"  onclick="removeImage('+imageLine+')" data-toggle="tooltip" data-placement="top" title="Add More Attachment"> <i class="fa fa-trash" style="line-height: inherit;"></i></button></div>';
	$("#img").append(html);
}
function removeImage(id){
	var preVal = id-1;
	$($("#imgRow"+id).closest("div")).remove();
	$("#imgminus"+preVal).attr('disabled', false);
	imageLine--;
}
function checkFileValidate(that) {
	const file = that.files[0];
	if (file) {
		const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
		if (!validImageTypes.includes(file.type)) {
			alert('Only image files (JPEG, PNG, GIF, WEBP) are allowed.');
			that.value = ''; // Clear the input if the file is not valid
		}
	}
}

</script>


<script>
// $('#assetBrand').autocomplete({
//     // serviceUrl: '/autosuggest/service/url',
//     //lookup: countriesString,
//     lookup: brandArray,
//     lookupFilter: function(suggestion, originalQuery, queryLowerCase) {
//         var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
//         return re.test(suggestion);
//     },
//     onSelect: function(suggestion) {
//         $('#selction-ajax').html('You selected: ' + suggestion.value + ', ' + suggestion.data);
//     },
//     onHint: function (hint) {
//         $('#autocomplete-ajax-x').val(hint);
//     },
//     onInvalidateSelection: function() {
//         $('#selction-ajax').html('You selected: none');
//     }
// });
</script>