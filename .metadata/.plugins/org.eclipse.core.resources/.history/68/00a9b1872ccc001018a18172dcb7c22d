<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<sec:authentication var="principal" property="principal" />
<c:set var="chargeRow" value="0" />


<style>

@media print {
    body{
        background: #fff !important;
    }
	.no-print {
		display: none;
	}
	input {
		border-color: transparent !important;
	}
	select {
		border-color: transparent !important;
	}
	td #mrnDate {
		border-color: transparent !important;
		display: none;
	}
	 td textarea {
		border-color: transparent !important;
		resize: none;
	}
	td #doc{
	display: none;
	}
	.btnholder,.fa-calendar-week{
	display: none;
	}
	.invoice-form table thead th,.detailsheading {
        background: transparent !important;
        color: #000 !important;
    }
    .detailsheading{
        font-weight: 600;
        dest-decoration: underline !important;
    }
    .borderNone{
            border: none !important;
        }
    .card-header{
        padding-left: 0 !important;
    }
	
}
.datepicker-box .fa-calendar-week{
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 16px;
}
.invoice-form table thead th{
    color: #0f0e47
}
.print-div {
	width: 750px;
	padding: 19px;
	background: #fff;
	margin-left: auto;
	margin-right: auto;
	margin-top: 10px;
	height: 700px;
}

.print-div td input, .print-div td select {
	width: 76px;
	border: 1px solid #ddd;
	border-radius: 6px;
}

.print-div td textarea {
	border: 1px solid #ddd;
}

.print-div td textarea {
	border: 1px solid #ddd;
}
table th {
    font-size: 14px;
    font-weight: 600 !important;
    line-height: 24px;
}
table td {
	    font-size: 13px !important;
        font-weight: 500 !important;
        color: #312e2e !important;
        line-height: 24px !important;
        letter-spacing: 0.5px;
	}
   

input:focus {
	outline: none;
}
.fleettable tr{
    vertical-align: baseline;
}
textarea:focus {
	outline: none;
}
table thead tr th {
    padding: 5px !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    color: #0f0e47;
}
table td{
    padding: 5px;
}
 input,select{
            border: 1px solid #2c97af7a;
            border-radius: 4px !important;
            height: 25px;
    }
</style>

<section>
	<div class="mt-2">
		<form action="${contextPath}/procurement/purchaseOrder/saveGrn" class="invoice-form" method="post" id="form" enctype="multipart/form-data">
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
			<input type="hidden" name="grnId" value="${grn.grnId}" /> 
			<input type="hidden" id="mrnDate" value="<fmt:formatDate value='${hasMrn eq true ? grn.mrn.mrnDate : grn.purchaseOrder.poReceiptGeneratedDate}' pattern='dd/MM/yyyy'/>" />
			<input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
			<div class="borderNone" style="width: 900px; margin: auto; background: #fff; position: relative;padding: 10px;border: 1px solid #ddd;">
				<div style="float: left; width: 50%">
					<h3 style="margin-bottom: 5px; margin-top: 5px; color: #000;
    font-weight: 600; padding:10px 0;">GRN</h3>
				</div>
				<div style="float: right; width: 50%; text-align: right;">
					<c:choose>
                        <c:when test="${!empty principal.currentUserVo.icon && principal.currentUserVo.icon.length() > 0}">
                            <c:set var="appIcon" value="${principal.currentUserVo.icon}" />
                            <img src="${contextPath}/document/view-documents?doc=${appIcon}&module=ICON" alt="logo" class="logo" style="width: 50px;" />
                        </c:when>
                        <c:otherwise>
                            <img src="${contextPath}/assets/images/favicon.png" alt="logo" class="logo" style="width: 50px;" />
                        </c:otherwise>
                    </c:choose>
				</div>
				<div style="clear: both; margin-bottom: 0"></div>
				<div class="card-header" style="position: relative;background: #00ffff !important;">
                    <button type="button" class="no-print unfreezeField" style="float: right;position: absolute;top: -3px;right: 10px;border: none;background: none;font-size: 26px;color: #5f7dcb;" onclick="window.print()">
                        <i class="fa-solid fa-print"></i>
                    </button>

                    <h4 class="detailsheading" style=" color: #0f0e47; font-size: 16px;padding-left: 2px; margin-bottom: 0px; margin-top: 0;font-weight: 600;">Contact details :</h4>
                </div>

				<div style="width: 50%; float: left;padding: 10px 0;">
					<table style="font-size: 12px; line-height: 15px; width: 100%" class="fleettable">
						<tr>
							<th style="width: 40%; font-weight: 600">Vendor Name :</th>
							<td style="width: 70%">${grn.purchaseOrder.assetVendor.vendorName}</td>
						</tr>
						<tr>
							<th style="width: 40%; font-weight: 600">GSTIN :</th>
							<td style="width: 70%">${grn.purchaseOrder.assetVendor.gstNo}</td>
						</tr>

						<tr>
							<th style="width: 40%; font-weight: 600">Phone No :</th>
							<td style="width: 70%">${grn.purchaseOrder.assetVendor.mobileNo}</td>
						</tr>
						<tr>
							<th style="width: 40%; font-weight: 600">Email :</th>
							<td style="width: 70%">${grn.purchaseOrder.assetVendor.email}</td>
						</tr>
						<tr style="vertical-align: top;">
							<th style="width: 40%; font-weight: 600">Address :</th>
							<td style="width: 70%"> ${grn.purchaseOrder.assetVendor.vendorAddress}</td>
						</tr>
						<tr>
							<th style="width: 40%; font-weight: 600">POC :</th>
							<td style="width: 70%">${grn.purchaseOrder.assetVendor.pointOfContact}</td>
						</tr>
						<tr>
							<th style="width: 40%; font-weight: 600">Contact No :</th>
							<td>${grn.purchaseOrder.assetVendor.contactNumber}</td>
						</tr>
					</table>
				</div>
				<div style="width: 50%; float: right;padding: 10px 0;" class="fleettable">
					<table style="font-size: 12px; line-height:20px; width: 100%">
						<tr>
							<th style="width: 25%; font-weight: 600">GRN Ref :</th>
							<td style="width: 75%">${grn.grnNo}</td>
						</tr>
						<tr>
							<th style="width: 25%; font-weight: 600">GRN Date :</th>
							<td style="width: 75%"><fmt:formatDate value='${grn.grnDate}' pattern='dd/MM/yyyy' /></td>
						</tr>
						<tr>
							<th style="width: 25%;">PO Ref :</th>
							<td style="width: 75%">${grn.purchaseOrder.poNo}</td>
						</tr>
						<tr>
							<th style="width: 25%; font-weight: 600">PO Date :</th>
							<td style="width: 75%"><fmt:formatDate value='${grn.purchaseOrder.poReceiptGeneratedDate}' pattern='dd/MM/yyyy' /></td>
						</tr>
						<!--                     <tr> -->
						<!--                         <td style="width:50%">Customer Code:</td> -->
						<!--                         <td style="width:50%">TR1011296</td> -->
						<!--                     </tr> -->

					</table>
				</div>
				<div style="clear: both; margin-bottom: 30px;"></div>
                    <table class="t-inner-data" style="font-size: 12px; width: 100%;">
                        <thead>
                            <tr   style="background: #00ffff !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;">
                                <th>Sub Category</th>
                                <th style="width: 260px">Item Name</th>
                                <c:choose>
                                    <c:when test="${hasMrn eq true}">
                                        <th style="text-align: end;">MRN Qty</th>
                                    </c:when>
                                    <c:otherwise>
                                        <th style="text-align: end;">Po Remain Qty</th>
                                    </c:otherwise>
                                </c:choose>
                                <th style="text-align: end;">GRN Remain Qty</th>
                                <th style="text-align: end;">Qty Accepted</th>
                                <th style="text-align: end;">Qty Rejected</th>
                                <!-- <th>Sale Price</th>
                            <th>Margin</th> -->
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="itemBody">

                            <c:forEach items="${grn.grnLines}" var="lines" varStatus="count">
                                <tr>
                                    <td>
                                        ${lines.poLine.item.subCategoryName}
                                        <input type="hidden" name="grnLines[${count.index}].poLineId" value="${lines.poLine.poLineId}">
                                    </td>
                                    <td>
                                        ${lines.poLine.item.itemName}
                                        <input type="hidden" name="grnLines[${count.index}].grnLineId" value="${lines.grnLineId}">
                                    </td>
                                    <c:choose>
                                        <c:when test="${hasMrn eq true}">
                                            <td>
                                                <input type="text" id="mrnQty"  style="width: 80px; text-align: right;float: right;" value="${lines.mrnLine.receivedQuantity}" readonly="readonly">
                                            </td>
                                        </c:when>
                                        <c:otherwise>
                                            <td>
                                                <input type="text" id="mrnQty"  style="width: 80px; text-align: right;float: right;" value="${lines.poLine.poRmnQuantity}" readonly="readonly">
                                            </td>
                                        </c:otherwise>
                                    </c:choose>
                                    <td>
                                        <input type="text" id="grnRmnQty" style="width: 80px; text-align: right;float: right;" value="${lines.poLine.grnRmnQuantity}" readonly="readonly">
                                    </td>
                                    <td>
                                        <input class="altleastOneGreaterThanZero ${lines.poLine.item.isFractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'} maximunLengthIs10WithDot onClickInput" type="text" id="rcvQty${count.count}" name="grnLines[${count.index}].receivedQuantity" style="width: 80px; text-align: right;float: right;" value="${lines.receivedQuantity}" onkeyup="checkQty(${hasMrn eq true ? lines.mrnLine.receivedQuantity : lines.poLine.poRmnQuantity},${lines.poLine.grnRmnQuantity},this.value,'${hasMrn eq true ?'Mrn' :'Po'}',${count.count})" ${lines.poLine.isGrnClose eq true || canTakeAction eq false ? 'readonly="readonly"' : '' }>
                                    </td>
                                    <td>
                                        <input type="text" id="rejQty${count.count}" name="grnLines[${count.index}].rejectedQuantity" style="width: 80px; text-align: right;float: right;" value="${lines.rejectedQuantity}" readonly="readonly">
                                    </td>
                                    <td>
                                        <select disabled="disabled" id="status${count.count}">
                                            <option value="false" ${lines.poLine.isGrnClose eq false ? 'selected' : '' }>Open</option>
                                            <option value="true" ${lines.poLine.isGrnClose eq true ? 'selected' : '' }>Close</option>
                                        </select>
                                    </td>
                                </tr>
                            </c:forEach>
                        </tbody>
                    </table>
				<table style="font-size: 12px; width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 0px;">
					<thead style="">
						<tr style="background: #00ffff !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;">
							<th style="padding: 4px 5px;">Remarks</th>
							<th style="padding: 4px 5px;">Received Date</th>
							<th style="padding: 4px 5px;">GRN Document</th>
						</tr>
					</thead>
					<tbody>
						<tr style="vertical-align: baseline;">
							<td style="">
								<textarea class="unfreezeField form-control" style="height: 50px;" placeholder="" maxlength="100" name="remarks" ${lines.poLine.isGrnClose eq true || canTakeAction eq false ? 'readonly="readonly"' : '' }>${grn.remarks}</textarea>
							</td>
							<td style="width: 25%;" class="datepicker-box position-relative">
									<input type="text" style="" class="form-control form-control-sm datepicker_grn requiredField" id="grdate" name="grdate" value="<fmt:formatDate value='${grn.grnDate}' pattern='dd/MM/yyyy'/>" ${lines.poLine.isGrnClose eq true || canTakeAction eq false ? 'readonly="readonly"' : '' } readonly/>
									<i style="" class='fa-solid fa-calendar-week'></i>

							</td>
							<td style="width: 25%; position: relative;">
								<c:choose>
									<c:when test="${lines.poLine.isGrnClose eq true || canTakeAction eq false}">
										<c:choose>
											<c:when test="${not empty grn.grnDoc}">
												<i class='fa-solid fa-file-export' style="font-size: 25px;position: absolute;top: 10px;" onclick="downloadDoc('${grn.grnDoc}')"></i>
											</c:when>
											<c:otherwise>
				            					No Doc Uploaded
				            				</c:otherwise>
										</c:choose>
									</c:when>
									<c:otherwise>
										<input type="file" id="doc" name="doc"
											style="border: #ddd 1px solid; position: relative; top: -9px">
									</c:otherwise>
								</c:choose>
							</td>
						</tr>
					</tbody>
				</table>

				<table class="footer-fix-table" style="width: 100%;">
					<tfoot>
						<tr>
							<th colspan="2">
								<ul style="list-style: none; padding: 0; display: flex; justify-content: space-between; align-items: flex-end; font-size: 12px;  color: #000;">
									<li style="margin-top: 45px;"><small style="display: block;">&nbsp; </small> Prepared By</li>
									<li style="margin-top: 45px;">Approved By</li>
									<li style="margin-top: 45px;">Authorized By</li>
								</ul>
							</th>
						</tr>
						<tr style="background: #8483c7 !important; font-size: 12px;color: #fff;">
							<th colspan="2" style="text-align: center; padding: 8px 0; text-align: center; line-height: 16px;">
								<p style="margin: 5px 0 0 0;">If you have any question about this price quote,please inform us at</p>
								<p style="margin: 0 0 5px 0;">demo@gmail.com or call us at 2323432432</p>
								<h4 style="margin: 0;">Thank You !!!</h4>
							</th>
						</tr>
					</tfoot>
				</table>
				<div style="clear: both; margin-bottom: 40px;"></div>
				<c:set var="dynamicFromId" value="form" scope="request" />
				<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
			</div>
		</form>
	</div>
</section>


<form method="post" action="${contextPath}/document/download"
	id="download" target="empty">
	<input type="hidden" name="${_csrf.parameterName}"
		value="${_csrf.token}" /> <input type="hidden" id="docPath"
		name="docPath" value=""> <input type="hidden" id="module"
		name="module" value="Purchase/Grn">
</form>
<script>
tableIds=['itemBody'];
jsonKeys=['grnLines'];
	var edit='${canTakeAction}';
	$(document).ready(function(){
		if(edit=='true'){
			$("#form").attr("action", "${contextPath}/procurement/purchaseOrder/saveGrn");
		}else {
			$("#form").attr("action", "${contextPath}/procurement/purchaseOrder/approveGrn");
		}
	});

	$(function() {
		$('.datepicker_grn').datepick({
			dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
			 onSelect: function(selected) {
				 var alltDate=$('#mrnDate').val().split("/");
				 var modAllotDate=new Date(alltDate[1]+"/"+alltDate[0]+"/"+alltDate[2]);
				 if(modAllotDate > new Date(selected)){
					bootbox.alert('Grn date sholud not be less than Mrn or PO approval date.');
					$('.datepicker_grn').val("");
				 }
			 }
		});
	});
	function checkQty(rqstQty,grnQty,curVal,type,lineNo){
		if(isNaN(curVal)){
			curVal=0.0;
		}
		rqstQty=parseFloat(rqstQty);
		grnQty=parseFloat(grnQty);
		curVal=parseFloat(curVal).toFixed(2);
		if(rqstQty<curVal){
			$("#rejQty"+lineNo).val(rqstQty);
			$("#rcvQty"+lineNo).val(0.0);
			bootbox.alert("Can't exceed than quantity of "+type);
			return false;
		}else if(grnQty<curVal){
			$("#rejQty"+lineNo).val(rqstQty);
			$("#rcvQty"+lineNo).val(0.0);
			bootbox.alert("Can't exceed than remain quantity of Grn");
			return false;
		}else if(curVal==''){
			$("#rejQty"+lineNo).val(0);
			$("#rcvQty"+lineNo).val(0.0);
			$("#status"+lineNo).val('false');
		}else{
			var rejQty=(rqstQty-curVal).toFixed(2);
			$("#rejQty"+lineNo).val(rejQty);
			if(rejQty==0){
				$("#status"+lineNo).val('true');
			}else{
				$("#status"+lineNo).val('false');
			}
		}
	}
	function downloadDoc(path){
		$("#docPath").val(path);
		var a=$("#docPath").val();
		$("#download").submit();
	}
</script>