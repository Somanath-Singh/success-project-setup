<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
	<c:set var="userDetails" value="${serviceOutcome.data}"/> 
<sec:authentication var="principal" property="principal" />
<c:set var="roleCode" value="${principal.primaryRole.roleCode}" />

<style>
.mandotory::before {
  content: '* '; /* Display an asterisk followed by a space before the header text */
  color: red;    /* Optionally, set the color to red or any other desired color */
}

.required::before {
  content: '* '; /* Display an asterisk followed by a space before the header text */
  color: red;    /* Optionally, set the color to red or any other desired color */
}
.disabled-dropdown {
    pointer-events: none;
    background-color: #eee; /* Optional: Change the background color to visually indicate it's disabled */
}

.mandatory-field {
    border: 1px solid #b3432f;
/*     background-color: #ffb2a8; /* Adjust the background color as needed */ */
}

	.hidden {
    display: none;
}

</style>	
		<div class="breadcrumb_conatiner">
               <div class="col-md-6">
                 <h4 class="change-color">Selected Candidate</h4>
               </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Selected Candidate</li>
                  </ol>
                </nav>
              </div>
            </div>

					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<h5 class="card-title">Selected Candidate</h5>
								</div>
								<div class="card-body">
										<div class="col-lg-12 mt-3">
										<!-- New Select Field -->
									        <div class="row mb-3">
									            <div class="col-md-4">
									                <label for="statusFilter">Designation :</label>
									                <select class="form-control form-select validId3 require" name="roleId" id="roleSelect" data-plugin-selectTwo onchange="getVacDetails(this.value)">
													    <option value=""><spring:message code="label.common.select" /></option>
													    <c:forEach var="role" items="${roleList}">
													        <option value="${role[3]}" ${vacancyIdHdn eq role[3]?'selected':'' }>${role[1]} | ${role[2]}</option>
													    </c:forEach>
													</select>
									            </div>
<!-- 									            <div class="col-md-2" id="publicationDateContainer"> -->
<!-- 												    <div class="form-group"> -->
<!-- 												        <label for="publicationDate">Publication Date :</label> -->
<!-- 												        <div class="form-group "> -->
<%-- 												            <input type="text" name="publicationDate" id="publicationDate" value="${publicationDateHdn}" class="form-control" required readonly> --%>
<!-- 												        </div> -->
<!-- 												    </div> -->
<!-- 												</div> -->
<!-- 									            <div class="col-md-2" id="publicationDateContainer"> -->
<!-- 											        <div class="form-group"> -->
<!-- 											            <label for="applicationDeadline">Application Deadline :</label> -->
<!-- 											            <div class="form-group "> -->
<%-- 											            	<input type="text" name="applicationDeadline" id="applicationDeadline" class="form-control" value="${applicationDeadlineHdn}" readonly> --%>
<!-- 											            </div> -->
<!-- 											        </div> -->
<!-- 											    </div> -->
									        </div>
										    <input type="hidden" id="tabStatus" name="tabStatus" value=""/>
										     <!-- Tabs -->
											<ul class="nav nav-tabs" id="interviewRoundsTabs" role="tablist">
											        <li class="nav-item">
											            <a class="nav-link ${tabStatusId eq 'selectedCandidate' ? 'active':''}" id="selectedCandidate" data-toggle="tab" href="#selectedCandidate" onclick="filterData('selectedCandidate')">Selected Candidate</a>
											        </li>
										            <li class="nav-item">
											            <a class="nav-link ${tabStatusId eq 'offerLetterSent' || tabStatusId eq '' ? 'active':''}" id="offerLetterSent" data-toggle="tab" href="#offerLetterSent" onclick="filterData('offerLetterSent')">Offer Letter Sent</a>
											        </li>
											        <li class="nav-item">
											            <a class="nav-link ${tabStatusId eq 'rejected' ? 'active':''}" id="rejected" data-toggle="tab" href="#rejected" onclick="filterData('rejected')">Rejected</a>
											        </li>
											</ul>

								</div>
								<div class="row">
								    <div class="col-md-12 mb-5">
								        <div class="table-responsive">
								            <table class="table table-bordered" id="offerTable">
											    <thead>
											        <tr>
											            <th>Applicant Name</th>
											            <th>Registration code</th>
											            <th>Mobile No</th>
											            <th>Email</th>
											            <th>Salary Package (In Lakhs)</th>
											            <th>Joining Date</th>
											            <th>Remarks</th>
											            <c:if test="${tabStatusId ne 'rejected' && tabStatusId ne 'offerLetterSent'}">
											            <th>Action</th>
											            </c:if>
											            <c:if test="${tabStatusId eq 'rejected' || tabStatusId eq 'offerLetterSent'}">
											            <th>View</th>
											            </c:if>
											        </tr>
											    </thead>
											    <tbody>
											        <c:forEach items="${details}" var="regd" varStatus="count">
											            <tr>
											                <td>${regd.name}</td>
											                <td>${regd.code}</td>
											                <td>${regd.mobileNo}</td>
											                <td>${regd.mailId}</td>
											                <td>${empty regd.salaryPackage ? 'NA' : regd.salaryPackage}</td>
															<td>${empty regd.joiningDate ? 'NA' : regd.joiningDate}</td>
															<td>${empty regd.additionalNotes ? 'NA' : regd.additionalNotes}</td>

											                <td>
											               <c:if test="${empty regd.additionalNotes}"> 
											                    <!-- Send for Approval Button (Icon) -->
											                    <button class="btn btn-success btn-sm" 
											                            onclick="sendForApproval('${regd.regdId}', '${vacancyIdHdn}')">
											                        <i class="fas fa-paper-plane"></i>
											                    </button>
										                    </c:if>
										                    <c:if test="${not empty regd.additionalNotes}"> 
											                    <button class="btn btn-success btn-sm" 
											                            onclick="sendForApproval('${regd.regdId}', '${vacancyIdHdn}')">
											                        <i class="fas fa-eye"></i>
											                    </button>
										                    </c:if> 
											                </td>
											            </tr>
											        </c:forEach>
											    </tbody>
											</table>

								        </div>
								    </div>
								</div>
								</div>
							</div>
						</div>	
					<!-- Modal -->
<div class="modal"  id="publishModal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="publishModalLabel">Publish Vacancy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="publishForm">
                    <div class="form-group datepicker_con">
                        <label for="publishDate" class="form-label">Publish Date</label>
                        <input type="text" class="form-control" id="publicationDate" name="publicationDate" required>
                    </div>
                    <div class="form-group datepicker_con">
                        <label for="applicationDeadline" class="form-label">Application Deadline</label>
                        <input type="text" class="form-control" id="applicationDeadline" name="applicationDeadline" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" form="publishForm" class="btn btn-primary" onclick="publishVac()">Publish</button>
            </div>
        </div>
    </div>
</div>

  </body>
</html>
<form action="${contextPath}/getFinalSelectedCandidate" method="POST" id="getFinalSelectedCandidate">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="tabStatusId" name="tabStatusId">
	<input type="hidden" id="vacancyIdHdn" name="vacancyIdHdn">
	<input type="hidden" id="publicationDateHdn" name="publicationDateHdn">
	<input type="hidden" id="applicationDeadlineHdn" name="applicationDeadlineHdn">
	<input type="hidden" id="interviewSchedule" name="interviewSchedule" value="intervRound">
</form>


<form action="${contextPath}/sendOfferLetter" method="POST" id="sendOfferLetter">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
    <input type="hidden" id="hdnRegdIds" name="hdnRegdIds">
    <input type="hidden" id="vacancyIdHdn2" name="vacancyIdHdn2">
    <input type="hidden" id="hdnStageStatus" name="hdnStageStatus">
    <input type="hidden" id="hdnTabStatus" name="hdnTabStatus">
    <input type="hidden" id="hdnOfferDetails" name="hdnOfferDetails"> 
</form>


<form action="${contextPath}/vaccancy/editVacancyDetails" method="post" id="editVacancyDetails">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="hiddenVacId"  id="hiddenVacId" value="">
</form>

<form action="${contextPath}/vaccancy/publishVacancy" method="post" id="publishVacancy">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="hiddenVacIdP"  id="hiddenVacIdP" value="">
	<input type="hidden" name="publishDate"  id="publishDate" value="">
	<input type="hidden" name="deadLineDate"  id="deadLineDate" value="">
</form>

<form action="${contextPath}/getApplicantAllDetails" method="get" id="getApplicantAllDetails">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="regiId"  id="regiId" value="">
</form>


<form action="${contextPath}/getOfrLetterAprvlPage" method="get" id="sendForOfrLetter">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="regdIdHdn"  id="regdIdHdn">
	<input type="hidden" name="vacancyIdHdn3"  id="vacancyIdHdn3">
</form>
<script>

function setTabStatus(tabId, roundType) {
    console.log(`tabStatusId: ${tabId}, Value: ${roundType}`);

    document.getElementById('tabStatus').value = tabId; // Example: Set a hidden input value
}

function filterData(tabStatus){
debugger
	if($("#roleSelect").val()==''){
		bootbox.alert("Please select designation.");
		return false;
	}
	else{
		if(tabStatus!=null && tabStatus!=''){
			$("#tabStatusId").val(tabStatus);
			$("#vacancyIdHdn").val($("#roleSelect").val());
			$("#publicationDateHdn").val($("#publicationDate").val());
			$("#applicationDeadlineHdn").val($("#applicationDeadline").val());
			$("#getFinalSelectedCandidate").submit();
		   
		}
	}
}

function sendSelectedCandidatesForOffer(stageStatus) {
    debugger;
    var confMsg = '';
    var checked = [];
    var offerDetails = [];
    var myElements = document.getElementsByClassName("x-check");

    if ($('input:checkbox:checked').length === 0) {
        bootbox.alert("Please select at least one candidate.");
        return false;
    }

    // Collect all checked rows
    for (var i = 0; i < myElements.length; i++) {
        if (myElements[i].checked) {
            var regdId = myElements[i].value; // Registration ID
            var rowIndex = $(myElements[i]).data('row-index'); // Row Index (count.count)
            checked.push({ regdId, rowIndex });
        }
    }

    if (checked.length === 0) {
        bootbox.alert("Please select at least one record.");
        return false;
    }

	    // Validate fields for all selected rows
	    for (var i = 0; i < checked.length; i++) {
	    var rowIndex = checked[i].rowIndex;
	    var regdId = checked[i].regdId;
	
	  //  var designation = $("#designation" + rowIndex).val();
	    var salaryPackage = $("#salaryPackage" + rowIndex).val();
	    var joiningDate = $("#joiningDate" + rowIndex).val();
	    var jobLocation = $("#jobLocation" + rowIndex).val();
	    var additionalNotes = $("#additionalNotes" + rowIndex).val();
	
	 if(stageStatus=='SENT'){
		 if (!salaryPackage || !joiningDate || !jobLocation) {
		        bootbox.alert("All fields are mandatory for the selected records.");
		        return false;
		    }
	 } else{
		 if (!additionalNotes) {
		        bootbox.alert("Remarks fields are mandatory for the selected records.");
		        return false;
		    }
	 }  
	   
	
	    offerDetails.push({
	        regdId: regdId,
	      //  designation: designation,
	        salaryPackage: salaryPackage,
	        joiningDate: joiningDate,
	        jobLocation: jobLocation,
	        additionalNotes: additionalNotes,
	    });
	}

    $("#hdnRegdIds").val(checked.map(item => item.regdId).toString());
    $("#hdnStageStatus").val(stageStatus.toString());
    $("#vacancyIdHdn2").val($("#roleSelect").val());
    $("#hdnOfferDetails").val(JSON.stringify(offerDetails));
    $("#hdnTabStatus").val('${tabStatusId}');

    if (stageStatus === 'SENT') {
    	confMsg = `You are about to send offer letters to candidates. This action cannot be undone. Do you want to proceed?`;
    } else if (stageStatus === 'REJECTED') {
    	confMsg = `You are about to reject candidates. This action cannot be undone. Do you want to proceed?`;
    } 
    bootbox.confirm({
        message: confMsg,
        buttons: {
            confirm: {
                label: 'Yes',
                className: 'btn-success'
            },
            cancel: {
                label: 'No',
                className: 'btn-danger'
            }
        },
        callback: function (result) {
            if (result === true) {
                $("#sendOfferLetter").submit();
            }
        }
    });
}

  

$('.x-check').change(function() {
    handleCheckboxChange();
});

$('#selectAll').click(function(e) {
    var table = $(e.target).closest('table');
    $('td input:checkbox', table).prop('checked', this.checked);
    $('td input.isFreezed', table).prop('checked', false);
});

function handleCheckboxChange() {
    var allCheckboxes = $('.x-check');
    var selectAllCheckbox = $('#selectAll');
    selectAllCheckbox.prop('checked', allCheckboxes.length === allCheckboxes.filter(':checked').length);
}  

function getVacancyById(vacId){
	debugger
	 $("#hiddenVacId").val(vacId);
	 $("#editVacancyDetails").submit();
}

function publishModal(idforPub){
	debugger
	$("#publishModal").show();
	$("#hiddenVacIdP").val(idforPub);
}

function publishVac(){
	
	 if ($("#publicationDate").val().trim()=='') {
		 bootbox.alert("Publication Date is required when the job is published.");
 	     return false;
     }
	
	if ($("#publicationDate").val().trim()!='' && $("#applicationDeadline").val().trim()=='') {
		bootbox.alert("Application Deadline is required when Publication Date is set.");
	     return false;
	 }
	 
	//// Validate that publication date is less than or equal to application deadline
	const publicationDateValue = $("#publicationDate").val().trim();
	const applicationDeadlineValue = $("#applicationDeadline").val().trim();

		   if (publicationDateValue !== '' && applicationDeadlineValue !== '') {
		    const publicationDate = parseDate(publicationDateValue);
		    const applicationDeadline = parseDate(applicationDeadlineValue);
		
		    if (publicationDate > applicationDeadline) {
		    	bootbox.alert("Publication Date cannot be greater than the Application Deadline.");
		        $("#publicationDate").focus();
		        return false;
		    }else{
		    	$("#publishDate").val($("#publicationDate").val());
		    	$("#deadLineDate").val($("#applicationDeadline").val());
		    	$("#publishVacancy").submit();
		    }
		}
}

function parseDate(input) {
    const parts = input.split('/'); // Split by "/"
    const day = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1; // Months are 0-based in JavaScript
    const year = parseInt(parts[2], 10);

    return new Date(year, month, day);
}


function getVacDetails(vacHdnId){
	debugger
	 $.ajax({
	        url: "${contextPath}/vaccancy/getVacDetails",
	        type: "GET",
	        data: {
	            "vacHdnId": vacHdnId,
	        },

	        success: function (response) {
	            if (response != '') {
	                  $("#publicationDate").val(formatDateToDDMMYYYY(response.publicationDate));
	                  $("#applicationDeadline").val(formatDateToDDMMYYYY(response.applicationDeadline));
	            } 
	        }
	    });
}


function formatDateToDDMMYYYY(dateInput) {
    if (!dateInput) return ''; // Handle null or undefined date

    // Check if the input is a timestamp (number)
    if (typeof dateInput === 'number') {
        const date = new Date(dateInput); // Convert timestamp to Date object
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        const year = date.getFullYear();
        return day + '/' + month + '/' + year; ;
    }

    // If input is already a string, handle string-based dates (e.g., "YYYY-MM-DD")
    if (typeof dateInput === 'string') {
        const dateParts = dateInput.split(' ')[0].split('-'); // Split date and remove time
        const year = dateParts[0];
        const month = dateParts[1];
        const day = dateParts[2];
        return day + '/' + month + '/' + year;
    }

    // Fallback in case of unexpected input
    return '';
}

function getApplicantAllDetails(regdId){
	$("#regiId").val(regdId);
	$("#getApplicantAllDetails").submit();
}


function sendForApproval(regdId, vacancyId) {
	debugger
	$("#vacancyIdHdn3").val(vacancyId);
	$("#regdIdHdn").val(regdId);
	$("#sendForOfrLetter").submit();
}

</script>