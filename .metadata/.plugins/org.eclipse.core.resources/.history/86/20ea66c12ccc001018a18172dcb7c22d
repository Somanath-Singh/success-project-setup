<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script type="text/javascript"
	src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<style>
.freeze {
	pointer-events: none;
}
</style>
<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Add Work Order</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
             	<c:if test="${empty workOrder}">
           	 		<li class="breadcrumb-item active" aria-current="page">Add Work Order</li>
             	</c:if>
             	<c:if test="${not empty workOrder}">
           	 		<li class="breadcrumb-item active" aria-current="page">Update Work Order</li>
             	</c:if>
			</ol>
		</nav>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
		<div class="card-header">
			<c:if test="${empty workOrder}">
          	 		<h5 class="card-title">Work Order</h5>
            	</c:if>
            	<c:if test="${not empty workOrder}">
          	 		<h5 class="card-title">Update Work Order</h5>
            	</c:if>
		</div>
		<div class="card-body">
      		<form class="form-horizontal" action="${contextPath}/wrk/save" method="POST" id="projectMstForm">
				<input type="hidden" id="cipherText" name="cipherText" value="">
				<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
				<input type="hidden" name="workOrderId" value="${workOrder.workOrderId}">
				<input type="hidden" name="workOrderCode" value="${workOrder.workOrderCode}">
				<input type="hidden" name="isActive" value="${workOrder.isActive}">	
				<input type="hidden" id="buttonCode" name="buttonCode">	
				<div class="row">
				<div class="col-md-3">
                      <div class="form-group">
                          <label class="smallInput required" for="financialYear">Financial Year :</label>
                          <div class="">
                              <select class="form-control form-control-sm form-select" id="financialYear" name="financialYearId" onchange="getProjectByFinancialYear(this.value)">
                                  <option value="0" selected disabled>- Select -</option>
                                  <c:forEach items="${financialYearList}" var="fy" varStatus="index">
                                     <option value="${fy.financialYearId}" ${ fy.financialYearId eq workOrder.financialYearId ? 'selected' : ''}>${fy.financialYear}</option>
                                  </c:forEach>
                             </select>
                         </div>
                     </div>
                 </div>
                 <div class="col-md-3">
                       <div class="form-group">
<!--                            <label class="smallInput required" for="projectId">Project :</label> -->
                           <label class="smallInput required" for="projectId">Building :</label>
                           <div class="">
                               <select class="form-control form-control-sm select2 form-select" id="projectId" name="projectId" onchange="LoadProjectEstimationByProjectId(this.value)">
                                   <option value="0" selected disabled>- Select -</option>
                                 	<c:if  test="${not empty workOrder}">
                                 	<c:forEach items="${projectList}" var="project">
                                        <option value="${project.projectId}" ${ project.projectId eq workOrder.projectId ? 'selected' : ''}>
                                            ${project.projectName}
                                        </option>
                                   	</c:forEach>
                                 	</c:if>
                               </select>
                           </div>
                       </div>
                   </div>
             		<div class="col-md-3">
						<div class="form-group">
							<label class="col-md-12 required" for="projectEstimationId">Plan Estimation :</label>
							<div class="col-md-12">
								<select id="projectEstimationId" name="projectEstimationId" class="form-control form-control-sm form-select select2" required="required" onchange="existEstimationByProjectAndEstimation()">
									<option value="0" selected disabled>- Select -</option>
									<c:if test="${not empty workOrder}">
										<c:forEach items="${projectEstimationList}" var="estimation">
	                                 		<option value="${estimation.estimationId}" ${estimation.estimationId eq workOrder.projectEstimationId ? 'selected' : ''}>${estimation.estimationNo}</option>
	                             	 	</c:forEach>
									</c:if>
								</select>
							</div>
						</div>
					</div>	
					<div class="col-md-3">
						<div class="form-group">
							<label class="col-md-12 required" for="agencyId">Select Agency :</label>
							<div class="col-md-12">
								<select id="agencyId" name="agencyId" class="form-control form-control-sm form-select select2" required>
									<option value="0">- Select -</option>
									<c:forEach items="${agencyList}" var="agency">
										<option value="${agency.agencyId}" ${agency.agencyId eq workOrder.agencyId ? 'selected' : '' }>${agency.agencyName}</option>
									</c:forEach>
								</select>
							</div>
						</div>
					</div>	
				</div>
			
				<div class="row">
					<div class="col-md-3">
						<div class="form-group">
							<label class="required">Work Order Name : </label>
							<div class="col-md-12">
								<input type="text" id="workOrderName" name="workOrderName" class="form-control form-control-sm" required maxlength="100" value="${workOrder.workOrderName}">
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<label class="required">Work Order Amount : </label>
						<div class="col-md-12">
							<input type="text" id="workOrderAmt" name="workOrderAmt" class="form-control form-control-sm text-end NumbersOnly" required readonly maxlength="12" value="${workOrder.workOrderAmt}">
						</div>
					</div>
					<div class="col-md-3">
						<label class="required">Start Date : </label>
						<div class="datepicker-box">
							<input type="text" id="startDate" name="startDate" class="form-control form-control-sm datepicker " required 
							value="${workOrder.startDate}" readonly>
						</div>
					</div>
					<div class="col-md-3">
						<label class="required"> End Date : </label>
						<div class="datepicker-box">
							<input type="text" id="endDate" name="endDate" class="form-control form-control-sm datepicker " required 
							value="${workOrder.endDate}" readonly>
						</div>
					</div>
				</div>
				
				<%--<c:if test="${empty workOrder}">
					<div class="row mt-4">
						<div class="col-md-12 text-center">
							<button type="button" class="btn btn-success" onclick="submitForm()">Save</button>
							<a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
						</div>
					</div>
				</c:if>
				
				<c:if test="${not empty workOrder}">
					<div class="row mt-4">
						<div class="col-md-12 text-center">
							<button type="button" class="btn btn-success" onclick="submitForm()">Update</button>
							<a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
						</div>
					</div>
				</c:if>
			--%>
			<c:set var="dynamicFromId" value="projectMstForm" scope="request" />
	        <c:set var="wonFunction" value="submitForm()" />
	        <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp" %>
			
		  </form>     
		</div>
	</div>
  </div>
</div>

<script>


function submitForm() {
	
    const buttonCode = $("#hdnButtonCode").val();
    const projectId = $("#projectId").val();
    const projectEstimationId = $("#projectEstimationId").val();
    const agencyId = $("#agencyId").val();
    const workOrderName = $("#workOrderName").val().trim();
    const workOrderAmt = $("#workOrderAmt").val().trim();
    const startDate = $("#startDate").val();
    const endDate = $("#endDate").val();
    
    const start = parseDate(startDate);
    const end = parseDate(endDate);

    if (!projectId || projectId === "0") {
       bootbox.alert("Please select project.");
       return false;
    }else if (!projectEstimationId || projectEstimationId === "0") {
        bootbox.alert("Please select a project estimation.");
        return false;
    }else if (!agencyId || agencyId === "0") {
    	  bootbox.alert("Please select an agency.");
          return false;
    }else if (!workOrderName) {
    	  bootbox.alert("Work Order Name is required.");
          return false;
    }else if (!workOrderAmt || isNaN(workOrderAmt) || parseFloat(workOrderAmt) <= 0) {
    	  bootbox.alert("Enter a valid Work Order Amount.");
          return false;
    }else if (!startDate) {
    	  bootbox.alert("Start Date is required.");
          return false;
    }else if (!endDate) {
    	  bootbox.alert("End Date is required.");
          return false;
    }else if (start && end && start > end) {
        bootbox.alert("Start Date must be before or equal to End Date.");
        return false;
    }else{
    	 $("#buttonCode").val(buttonCode);
   		 //submit tha form
   	   	 var bizContent = $("#projectMstForm").serializeArray();
   	   	 $("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
   	   	 bootbox.confirm("Do You Want To Continue?", function (result) {
   	    	 if (result) {
   	    	 showLoader();
   	    	 $("#projectMstForm").submit();
   	    	 }
   	   	 });
    	}
}


function parseDate(input) {
    const parts = input.split("-");
    if (parts.length !== 3) return null;
    const date = new Date(parts[2], parts[1] - 1, parts[0]);
    return isNaN(date) ? null : date;
}


function getProjectByFinancialYear(finYearId){
    $.ajax({
        url: "${contextPath}/common/fetch-approved-project-by-financialYear",
        type: "GET",
        data: {
        	financialYearId: finYearId
        },
        success: function (projects) {
   
            var projectSelect = $("#projectId");
            projectSelect.empty(); 
            projectSelect.append('<option value="0" selected disabled>- Select -</option>');
            
            $.each(projects, function(index, project) {
                projectSelect.append('<option value="' + project.projectId + '">' + project.projectName + '</option>');
            });
        },
        error: function (error) {
            bootbox.alert("Error fetching projects :",error);
        }
    });
}


function LoadProjectEstimationByProjectId(projectId) {
	
    $.ajax({
        type: "GET",
        url: "${contextPath}/common/fetchApprovedProjectEstimationByProject",
        data: {
        	projectId: projectId,
        },
        success: function (estimations) {
            var projectEstimation = $('#projectEstimationId'); 
            projectEstimation.empty();
            projectEstimation.append('<option value="" selected disabled>- Select -</option>');

            $.each(estimations, function(index, estimation) {
            	projectEstimation.append('<option value="' + estimation.estimationId + '">' + estimation.estimationNo + '</option>');
            });
        },
        error: function (error) {
            console.error("Error fetching project estimation:", error);
        }
    });
}

function existEstimationByProjectAndEstimation() {
	
    const projectId = $("#projectId").val();
    const projectEstimationId = $("#projectEstimationId").val();
	
    $.ajax({
        type: "GET",
        url: "${contextPath}/wrk/checkEstimationExistByProjectAndEstimation",
        data: {
        	projectId: projectId,
        	projectEstimationId: projectEstimationId
        },
        success: function (flag) {
        	 if (flag === true || flag === "true") {
        		 bootbox.alert("This project estimation is already assigned to a work order. Please select a different one.");
                 $("#projectEstimationId").val("");
             }else{
            	 getFinalAmountByEstimationId();
             }
        },
        error: function (error) {
            console.error("Error fetching while check exist estimation:", error);
        }
    });
}


function getFinalAmountByEstimationId() {
    const projectEstimationId = $("#projectEstimationId").val();

    if (!projectEstimationId) {
    	bootbox.alert("Please select a project estimation first.");
        return;
    }

    $.ajax({
        type: "GET",
        url: `${contextPath}/wrk/getFinalAmountByEstimationId`,
        data: {
            projectEstimationId: projectEstimationId
        },
        success: function (amount) {
            if (amount !== null && amount !== undefined && amount !== '') {
                $("#workOrderAmt").val(amount);
            } else {
            	bootbox.alert("No amount found for the selected estimation.");
            }
        },
        error: function (error) {
            bootbox.alert("Failed to fetch estimation amount.");
        }
    });
}
	
$(document).ready(function () {
    $(".datepicker").datepick({
        onShow: $.datepick.monthOnly,
        dateFormat: "dd-mm-yyyy",
        yearRange: "c-20:c+10",
        showOnFocus: true,
        showTrigger: '<button type="button" class="trigger"><i class="fa fa-calendar"></i></button>',
        onSelect: function () {
            applyStartEndDateLimit();
        }
    });

    function parseDate(str) {
        if (!str) return null;
        const parts = str.split("-");
        return new Date(parts[2], parts[1] - 1, parts[0]); 
    }

    function applyStartEndDateLimit() {
        const startDate = parseDate($('#startDate').val());
        const endDate = parseDate($('#endDate').val());

        if (startDate) {
            $('#endDate').datepick('option', 'minDate', startDate);

            if (endDate && endDate < startDate) {
                $('#endDate').val('');
            }
        }
    }

    applyStartEndDateLimit();

    $('#startDate').on('change', function () {
        applyStartEndDateLimit();
    });
});



</script>