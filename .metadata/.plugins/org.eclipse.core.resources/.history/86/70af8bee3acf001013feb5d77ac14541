<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<c:set var="userDetails" value="${serviceOutcome.data}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/commonMaster.js"></script>
<style>
.freeze {
    pointer-events: none;      /* Prevent clicking */
    opacity: 0.6;              /* Dim the button */
    cursor: not-allowed;       /* Change cursor */
}

  .rounded-box {
    border-radius: 8px;
    padding: 20px;
    background-color: #ced3d687;
    margin: 20px 0;
    box-shadow: 2px 2px 6px 0px #aa6b28;
  }

</style>

<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Create Maintenance Repair</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i
						class="fa-solid fa-house"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Create Maintenance Repair</li>
			</ol>
		</nav>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<h5 class="card-title">Create Maintenance Repair</h5>
			</div>
			<div class="card-body">
				<form class="form-horizontal" action="${contextPath}/maintenance/saveMaintenanceRepairDetails" method="POST" id="saveMaintenance" enctype="multipart/form-data">
					<input type="hidden" id="cipherText" name="cipherText" value="">
					<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
					<input type="hidden" name="maintenanceRepairId" id="maintenanceRepairId" value="${maintenance.maintenanceRepairId}">

					<div class="row">
						<div class="form-group col-md-3">
<!-- 						    <label class="required">Project :</label> -->
                            <label class="required">Building :</label>
						    <div class="col-md-12">
						        <select name="projectId" id="projectId" class="form-select form-select-sm select2 ${maintenance.status eq true and maintenance.maintenanceRepairId ne null ? 'freeze' : ''}" onchange="getprojectType(this.value)">
						            <option value="">-- Select --</option>
						            <c:forEach items="${projectList}" var="pro">
						                <option value="${pro.projectId}" ${pro.projectId eq maintenance.projectId ? 'selected' : ''}>
						                    ${pro.projectName}
						                </option>
						            </c:forEach>
						        </select>
						    </div>
						</div>

						<div class="form-group col-md-3">
<!-- 						    <label class="required">Project Type :</label> -->
						    <label class="required">Building Type :</label>
						    <div class="col-md-12">
						        <input type="text" id="projectType" name="projectType" class="form-control form-control-sm" value="${maintenance.projectType}" readonly> <!-- OR use disabled -->
						    </div>
						</div>

	                     <div class="form-group col-md-3">
	 						<label class="required">Maintenance Type :</label>
							<div class="col-md-12">
								<select class="form-select ${maintenance.status eq true and maintenance.maintenanceRepairId ne null ? 'freeze' : ''}" name="maintenanceMaster" id="maintenanceMaster">
									<option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
									<c:forEach items="${masterList}" var="mast">
										<option value="${mast.maintenceId}" ${mast.maintenceId eq maintenance.mainId ? 'selected':'' }>${mast.maintenceName}</option>
									</c:forEach>
								</select>
							</div>
						</div>
						
						<div class="form-group hidden" id="partyTypeId" style="display: none;">
						</div>
						
						<div class="form-group col-md-3">
						    <label class="required">Remarks :</label>
						    <div class="col-md-12">
						        <input type="text" id="remarks" name="remarks" class="form-control form-control-sm ${maintenance.status eq true and maintenance.maintenanceRepairId ne null ? 'freeze' : ''}" value="${maintenance.remarks}" maxlength="250"> 
						    </div>
						</div>
						
						<div class="form-group col-md-3">
						    <label class="required">Upload Document :</label>
						    <div class="col-md-12 position-relative">
						        <input type="file" id="document" name="uploadDocument" class="form-control form-control-sm ${maintenance.status eq true and maintenance.maintenanceRepairId ne null ? 'freeze' : ''}" onchange="fileCheck(this);">
						 	    <c:if test="${not empty maintenance.uploadDocumentPath}">
						            <button type="button" class="btn btn-sm btn-primary position-absolute" style="right:1px;top: 1px;" onclick="viewDocument('${maintenance.uploadDocumentPath}','MAINTENANCE_REQUEST')" title="Download Document">
						                <i class="fa fa-download"></i>
						            </button> <span style="font-size: 12px;color: #7b3f00;font-weight: 600;">${maintenance.uploadDocumentPath}</span>
						        </c:if>
						        <div id="selectedFileName" class="mt-1 text-muted" style="font-size: 0.9em;"></div>
						    </div>
						</div>

					 	<div class="col-md-12 mt-2 text-center">
					 		  <c:if test="${empty maintenance}">
					 		  		<input type="button" name="add&ManageApplicationScheme" value="Save" id="add&ManageApplicationSchemes" class="btn btn-primary btn-sm"  onclick="submitForm()">
					 		  </c:if>
					 		   <c:if test="${not empty maintenance}">
					 		   	 <c:if test="${maintenance.status eq false}">
					 		   	 	<input type="button" name="add&ManageApplicationScheme" value="Update" id="add&ManageApplicationSchemes" class="btn btn-primary btn-sm"  onclick="submitForm()">
					 		   	 </c:if>
					 		  </c:if>
							  <a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a> 
	                    </div>
					</div>
				</form>
			</div>
		</div>
	</div>
 </div>
 
  <c:if test="${empty maintenance}">
  	<div class="row">
	  	<div class="col-md-12 mt-3">
			<div class="card">
				<div class="card-header">
					<h6 class="card-title">Maintenance Request List</h6>
				</div>
				<div class="card-body">
					<div class="table-rrsponsive">
						<table class="datatable table table-striped table-bordered exportbtn" id="tableId1">
							<thead>
								<tr>
									<th style="min-width: 10px;" class="text-center">Sl.No.</th>
<!-- 								        <th style="min-width: 60px;">Project Name</th> -->
<!-- 								        <th style="min-width: 60px;">Project Type</th> -->
								        <th style="min-width: 60px;">Building Name</th>
								        <th style="min-width: 60px;">Building Type</th>
								        <th style="min-width: 60px;">Maintenance Type</th>
								    	<th style="min-width: 60px;">Action</th>
								</tr>
							</thead>
							<tbody>
								<c:forEach items="${maintenanceList}" var="mas" varStatus="count">
									<tr>
										<td class="text-center">${count.count}</td>
										<td>${mas.projectName}</td>
										<td>${mas.projectType}</td>
										<td>${mas.mainName}</td>	
										<td >
									
										   
		                                   	<c:if test="${mas.status ne true}">
												<button class="btn btn-warning btn-sm" id="editBtn" data-maintenace-repair-id="${mas.maintenanceRepairId}"
													data-toggle="tooltip" onclick="editMaintenanceRepairForm(${mas.maintenanceRepairId})" title="Edit">
													<i class="fas fa-edit"></i>
												</button>
		                                   	</c:if>
	                                   		<c:if test="${mas.status eq true}">
	                                   			<button class="btn btn-warning btn-sm" id="editBtn" data-maintenace-repair-id="${mas.maintenanceRepairId}"
													data-toggle="tooltip" onclick="editMaintenanceRepairForm(${mas.maintenanceRepairId})" title="Edit">
													<i class="fas fa-edit"></i>
												</button>
												
												<button class="btn btn-info btn-sm" id="redirectBtn" data-redirect-id="${mas.projectId}"
												        data-toggle="tooltip" onclick="redirectToProjectPage(${mas.projectId})" title="Redirect To Project">
												  <i class="fa fa-external-link"></i>
												</button>
	                                   		</c:if>
	                                   	
										</td>
									</tr>
								</c:forEach>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
  </c:if>
	
<form action = "${contextPath}/document/viewDocuments" method="get" id="documentFormView" enctype="multipart/form-data" target="_blank">
	<input type="hidden" name="moduleName" id="moduleName"/>
	<input type="hidden" name="filePath" id="filePath"/>
</form>

<script>


$(document).ready(function () {
	debugger
    var projectIdd = '${maintenance.projectId}';

    if (projectId && projectId !== 'null' && projectId !== '') {
        getProjectTypeDetails(projectIdd);
    }
});


function submitForm() {
    debugger;
    if ($("#projectId").val().trim() == "") {
        bootbox.alert("Please Select Project.");
        $("#maintenceNameId").val('');
        return false;
    }else if ($("#maintenanceMaster").val().trim() == "") {
        bootbox.alert("Please Select Maintenance Type.");
        $("#maintenceCodeId").val('');
        return false;
    }else if ($("#remarks").val().trim() == "") {
        bootbox.alert("Please enter Remarks.");
        $("#maintenceCodeId").val('');
        return false;
    }else if('${maintenance.projectId}' ==  ""){
   	   if ($("#document").val().trim() == "") {
   	        bootbox.alert("Please upload a document (PDF).");
   	        return false;
   	    }	
    }
    
   	//submit tha form
   	var maintenanceRepairId =  $("#maintenanceRepairId").val();
    var message = (maintenanceRepairId == 0 ? 'save' : 'update');
   	var bizContent = $("#saveMaintenance").serializeArray();
   	$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
   	bootbox.confirm("Do you want to " + message + " Maintenance Repair Detials ?", function(result) {
   		if (result) {
   			showLoader();
   			$("#saveMaintenance").submit();
   		}
   	});
    
}

function getprojectType() {
	debugger
    var projectId = $("#projectId").val() || '';

    if (!projectId) return;

    $.ajax({
        type: "GET",
        url: "./getprojectType",
        data: { projectId: projectId },
        success: function(response) {
            if (response) {
                $("#projectType").val(response); // Set projectType input value
                if (response === 'Other' || response === 'Hostel' || response === 'Staff-Quarter' || response === 'School-Building' || response === 'Community-Hall') {
                    getProjectTypeDetails(projectId); // Now call this only if needed
                } else {
                    $("#partyTypeId").hide().html(""); // Hide details if not "Other"
                }
            } else {
                $("#projectType").val('');
                $("#partyTypeId").hide().html(""); // Clear if no type returned
            }
        },
        error: function() {
            alert("Failed to fetch Project Type.");
        }
    });
}


function getProjectTypeDetails(projectId) {
    if (!projectId) return;

    $.ajax({
        type: "GET",
        url: "./getOtherProjectTypeDetails",
        data: { projectId: projectId },
        success: function(response) {
            var html = "";
   		    	if (response.projectType === "Other"  || response === "Community-Hall") {
   		    	    html +=
   		    	        "<div class='rounded-box'>" +
   		    	        "  <div class='row'>" +
   		    	        "    <div class='col-md-4'>" +
   		    	        "      <table class=''>" +
   		    	        "        <tr><th>Project Code</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.projectCode || "") + "</td></tr>" +
   		    	        "        <tr><th>Estimated Cost</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.estimatedCost || "") + "</td></tr>" +
   		    	        "        <tr><th>Final Cost</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.finalCost || "") + "</td></tr>" +
   		    	        "        <tr><th>Financial Year</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.financialYear || "") + "</td></tr>" +
   		    	        "      </table>" +
   		    	        "    </div>" +
   		    	        "    <div class='col-md-4'>" +
   		    	        "      <table class=''>" +
   		    	        "        <tr><th>Project Status</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.projectStatus || "") + "</td></tr>" +
   		    	        "        <tr><th>Letter No</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.letterNo || "") + "</td></tr>" +
   		    	        "        <tr><th>Letter Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.letterDate || "") + "</td></tr>" +
   		    	        "      </table>" +
   		    	        "    </div>" +
   		    	        "    <div class='col-md-4'>" +
   		    	        "      <table class=''>" +
   		    	        "        <tr><th>Confirm Letter Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.confirmLetterDate || "") + "</td></tr>" +
   		    	        "        <tr><th>Start Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.startDate || "") + "</td></tr>" +
   		    	        "        <tr><th>Completion Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.completionDate || "") + "</td></tr>" +
   		    	        "      </table>" +
   		    	        "    </div>" +
   		    	        "  </div>" +
   		    	        "</div>";
   		    	}
            if (response.projectType === "Hostel" || response.projectType === "Staff-Quarter" || response.projectType === "School-Building") {
            	html +=
            			"<div class='rounded-box'>" +
		    	        "  <div class='row'>" +
		    	        "    <div class='col-md-4'>" +
		    	        "      <table class=''>" +
		    	        "        <tr><th>Project Code</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.projectCode || "") + "</td></tr>" +
		    	        "        <tr><th>Estimated Cost</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.estimatedCost || "") + "</td></tr>" +
		    	        "        <tr><th>Final Cost</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.finalCost || "") + "</td></tr>" +
		    	        "        <tr><th>Financial Year</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.financialYear || "") + "</td></tr>" +
		    	        "        <tr><th>District</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.districtName || "") + "</td></tr>" +
		    	        "        <tr><th>Village</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.villageName || "") + "</td></tr>" +
		    	        "      </table>" +
		    	        "    </div>" +
		    	        "    <div class='col-md-4'>" +
		    	        "      <table class=''>" +
		    	        "        <tr><th>Project Status</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.projectStatus || "") + "</td></tr>" +
		    	        "        <tr><th>Letter No</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.letterNo || "") + "</td></tr>" +
		    	        "        <tr><th>Letter Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.letterDate || "") + "</td></tr>" +
		    	        "        <tr><th>School Name</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.schoolName || "") + "</td></tr>" +
		    	        "        <tr><th>Block</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.blockName || "") + "</td></tr>" +
		    	        "        <tr><th>School Type</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.type || "") + "</td></tr>" +
		    	        "      </table>" +
		    	        "    </div>" +
		    	        "    <div class='col-md-4'>" +
		    	        "      <table class=''>" +
		    	        "        <tr><th>Confirm Letter Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.confirmLetterDate || "") + "</td></tr>" +
		    	        "        <tr><th>Start Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.startDate || "") + "</td></tr>" +
		    	        "        <tr><th>Completion Date</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.completionDate || "") + "</td></tr>" +
		    	        "        <tr><th>School Code</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.schoolCode || "") + "</td></tr>" +
		    	        "        <tr><th>Gram Panchayat</th><td style='width:30px;text-align:center;'>:</td><td>" + (response.gpName || "") + "</td></tr>" +
		    	        "      </table>" +
		    	        "    </div>" +
		    	        "  </div>" +
		    	        "</div>";
            }

            if (html) {
                $("#partyTypeId").show().html(html);
            } else {
                $("#partyTypeId").hide().html("");
            }
        },
        error: function() {
            alert("Failed to load project type details.");
            $("#partyTypeId").hide().html("");
        }
    });
}

function fileCheck(that){
	debugger
	var ValidFileExtension = ['pdf'];

if($(that).val().split('.').length == 2 ) {
	  if ($.inArray($(that).val().split('.').pop().toLowerCase(), ValidFileExtension) == -1) {
			bootbox.alert("Sorry! allowed format is pdf only.");
			$(that).val("");
			return false;
		}
		if ((that.files[0].size) > 2097152) {
			bootbox.alert("File size exceeds maximum file size of 2 MB!");
			$(that).val("");
			return false;
		}
	}else{
  	   bootbox.alert("Unsupported file format,Please check your file extension");
  	   $(that).val("");
 }
}

function viewDocument(filePath,moduleName){
	debugger
	 $('#moduleName').val(moduleName);
	 $('#filePath').val(filePath);
	 $('#documentFormView').submit();
	}
	
function editMaintenanceRepairForm(id) {
	  $("#maintenceEditRepairId").val(id);
	  showLoader();
	  var bizContent = $("#editForm").serializeArray();
	  $("#editCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
	  $("#editForm").submit();
}

function redirectToProjectPage(projectId) {
	  $("#redirectProjectId").val(projectId);
	  $("#checkMaintenance").val(true);
	  showLoader();
	  var bizContent = $("#redirectToProject").serializeArray();
	  $("#redirectCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
	  $("#redirectToProject").submit();
 }
 
</script>

<form action="${contextPath}/maintenance/editMaintenanceRepair" method="Post" id="editForm">
 <input type="hidden" id="editCipherText" name="cipherText" />
 <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
 <input type="hidden" name="maintenceRepairId" id="maintenceEditRepairId" />
</form>

<form action="${contextPath}/project/addProject" method="GET" id="redirectToProject">
  <input type="hidden" id="redirectCipherText" name="cipherText" />
  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
  <input type="hidden" name="redirectProjectId" id="redirectProjectId" />
  <input type="hidden" name="checkMaintenance" id="checkMaintenance" />
</form>

