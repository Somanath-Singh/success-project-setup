<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<c:set var="userDetails" value="${serviceOutcome.data}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/commonMaster.js"></script>
<link rel="stylesheet" href="${contextPath}/assets/vendor/DataTablesNet/datatables.min.css" rel="stylesheet">
<script src="${contextPath}/assets/vendor/DataTablesNet/datatables.min.js"></script>
<style>
.freeze {
    pointer-events: none;
}

.rounded-box {
    border-radius: 8px;
    padding: 20px;
    background-color: #ced3d687;
    margin: 20px 0;
    box-shadow: 2px 2px 6px 0px #aa6b28;
}
</style>
<div class="breadcrumb_conatiner">
    <div class="col-md-6">
        <h4 class="change-color">Maintenance Request View</h4>
    </div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="${contextPath}/home"><i
                        class="fa-solid fa-house"></i></a></li>
                <li class="breadcrumb-item active" aria-current="page">Maintenance Request View</li>
            </ol>
        </nav>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Maintenance Request View</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="form-group col-md-3">
                        <label class="">Project :</label>
                        <div class="col-md-12">
                            <select class="form-select form-select-sm select2" name="projectId" id="projectIId">
                                <option value="">-- Select --</option>
                                <c:forEach items="${projectList}" var="pro">
                                    <option value="${pro.projectId}"${pro.projectId eq projectId ? 'selected':'' }>${pro.projectName}</option>
                                </c:forEach>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-3">
                        <label class="">Maintenance Type :</label>
                        <div class="col-md-12">
                            <select class="form-select" name="maintenanceMaster" id="maintenanceMaster">
                                <option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
                                <c:forEach items="${masterList}" var="mast">
                                    <option value="${mast.maintenceId}" ${mast.maintenceId eq maintenanceMaster ? 'selected':'' }>${mast.maintenceName}</option>
                                </c:forEach>
                            </select>
                        </div>
                    </div>
		             <div class="col-md-3">
						<label class="required">From Date:</label>
						<div class="datepicker-box">
							<input type="text" name="fromDate" id="fDatee" class="form-control form-control-sm datepicker " required readonly>
						</div>
					</div>
					<div class="col-md-3">
						<label class="required">To Date:</label>
						<div class="datepicker-box">
							<input type="text" name="toDate" id="tDatee" class="form-control form-control-sm datepicker " required  readonly>
						</div>
					</div>
					
                    <div class="col-md-12 mt-2 text-center">
                        <input type="button" name="addManageApplicationScheme" id="addManageApplicationSchemes"
                            class="btn btn-primary btn-sm" value="Filter" onclick="getFilteredMaintenanceRequestData()">
                        <a href="${contextPath}/moduleDirectory" type="button" class="btn btn-warning btn-sm">Back</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
     <div class="col-md-12 mt-3">
        <div class="card">
    <div class="card-body">
        <form method="get" action="${actionUrl}" id="formId">
            <input type="hidden" name="cipherText" id="formCipherText" value="">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <div class="row align-items-center">
                <div class="col-md-12">
                    <ul class="nav nav-pills navtab-btn gap-2" role="tablist" style="border-bottom:none;">
                        <c:forEach items="${genericDataViewDto.viewStatusList}" var="sts">
                            <li role="presentation" class="nav-item "><a class="nav-link ${sts.statusCode eq genericDataViewDto.status ? 'active' : ''}" href="#home" aria-controls="home" role="tab" data-toggle="tab" id="${sts.statusCode}TabId" onclick="getTableHeaderWithData('${sts.viewStatusId}')">${sts.displayName}</a></li>
                        </c:forEach>
                    </ul>
                </div>
            </div>

            <div class="mt-2">
                <input type="hidden" name="status" id="statusId" value="${genericDataViewDto.statusId}" />
                <input type="hidden" name="pageNo" id="pageNoId" value="${genericDataViewDto.pageNo}" />
                <input type="hidden" name="pageSize" id="pageSizeId" value="${genericDataViewDto.pageSize}" />
                <input type="hidden" name="entityClassName" id="entityClassNameId" value="${genericDataViewDto.entityClassName}" />
                <input type="hidden" name="conTextUrl" id="conTextUrlId" value="${genericDataViewDto.conTextUrl}" />

                <div class="row align-items-end">
                    <div class="col-md-12">
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane active" id="home">
                                <div class="row" id="dataSectionxx">
                                    <div class="col-md-12">
                                        <div class="table-responsive">
                                            <table class=" table table-striped table-bordered mt-3" id="tableId">
                                                <thead class="text-center bagGroundColorRvr" style="color: var(--black);" id="tableHeaderId">
                                                    <c:forEach items="${genericDataViewDto.theadList}" var="hd">
                                                        <c:if test="${hd.isHidden eq false}">
                                                            <th style="">${hd.thName}</th>
                                                        </c:if>
                                                    </c:forEach>
                                                </thead>
                                                <tbody class="" id="tableBodyId">
                                                    <c:forEach items="${genericDataViewDto.dataValueList}" var="data">
                                                        <tr>
                                                            <c:forEach items="${data}" var="value">
                                                                <td>${value}</td>
                                                            </c:forEach>
                                                        </tr>
                                                    </c:forEach>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    </div>
    </div>
</div>

<!-- Encryption Forms -->
<form action="${contextPath}/maintenance/getMaintenceRequestList" method="get" id="maintenanceListForm">
    <input type="hidden" name="cipherText" id="listCipherText" value="">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
    <input type="hidden" name="projectId" id="projectIdData"> 
    <input type="hidden" name="maintenanceMaster" id="maintenanceMasterData"> 
    <input type="hidden" name="fromDate" id="fromDateData"> 
    <input type="hidden" name="toDate" id="toDateData"> 
    <input type="hidden" name="status" id="statusData"> 
    <input type="hidden" name="projectName" id="projectNameData"> 
    <input type="hidden" name="pageNo" value="0" id="pageNoData" /> 
    <input type="hidden" name="pageSize" value="10" id="pageSizeData" />
</form>

<form action="${actionUrl}" method="get" id="tabChangeForm">
    <input type="hidden" name="cipherText" id="tabCipherText" value="">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
    <input type="hidden" name="projectId" id="tabProjectId"> 
    <input type="hidden" name="maintenanceMaster" id="tabMaintenanceMaster"> 
    <input type="hidden" name="fromDate" id="tabFromDate"> 
    <input type="hidden" name="toDate" id="tabToDate"> 
    <input type="hidden" name="status" id="tabChangeStatusId" /> 
    <input type="hidden" name="pageNo" value="0" id="tabPageNoData" /> 
    <input type="hidden" name="pageSize" id="tabPageSizeData" />
</form>

<form action="${contextPath}/document/viewDocuments" method="get" id="documentFormView" enctype="multipart/form-data" target="_blank">
    <input type="hidden" name="moduleName" id="moduleName"/>
    <input type="hidden" name="filePath" id="filePath"/>
</form>

<script>
// Encryption functions
function convertFormToJSONArray(formArray) {
    var returnArray = {};
    for (var i = 0; i < formArray.length; i++) {
        returnArray[formArray[i]['name']] = formArray[i]['value'];
    }
    return returnArray;
}

// Main filter function with encryption
function getFilteredMaintenanceRequestData() {
    var projectId = $("#projectIId").val();
    var maintenanceMaster = $("#maintenanceMaster").val();
    var fromDate = $("#fDatee").val();
    var toDate = $("#tDatee").val();
    var projectName = $("#projectIId option:selected").text();
    var status = '${status}' || '';
    
    // Validation
//     if (!projectId || projectId.trim() === "") {
//         bootbox.alert("Please Select Project.");
//         return false;
//     } else if (!maintenanceMaster || maintenanceMaster.trim() === "") {
//         bootbox.alert("Please Select Maintenance Type.");
//         return false;
//     } else if (!fromDate || fromDate.trim() === "") {
//         bootbox.alert("Please Select From Date.");
//         return false;
//     } else if (!toDate || toDate.trim() === "") {
//         bootbox.alert("Please Select To Date.");
//         return false;
        
        
     // Validation for date fields only
     if (!fromDate || fromDate.trim() === "") {
            bootbox.alert("Please Select From Date.");
            return false;
        } else if (!toDate || toDate.trim() === "") {
            bootbox.alert("Please Select To Date.");
            return false; 
    } else {
        // Convert to Date objects for validation
        var fromParts = fromDate.split('-');
        var toParts = toDate.split('-');
        
        var fromDateObj = new Date(fromParts[2], fromParts[1] - 1, fromParts[0]);
        var toDateObj = new Date(toParts[2], toParts[1] - 1, toParts[0]);

        if (toDateObj < fromDateObj) {
            bootbox.alert("Invalid date range. 'To Date' must be the same as or after 'From Date'.");
            return false;
        }

        // Set values in hidden fields
        $("#projectIdData").val(projectId);
        $("#maintenanceMasterData").val(maintenanceMaster);
        $("#fromDateData").val(fromDate);
        $("#toDateData").val(toDate);
        $("#statusData").val(status);
        $("#projectNameData").val(projectName);

        // Serialize and encrypt the form data
        var bizContent = $("#maintenanceListForm").serializeArray();
        $("#listCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
        
        // Submit the encrypted form
        $("#maintenanceListForm").submit();
    }
}

// Tab change with encryption
function getTableHeaderWithData(status) {
    var projectId = $("#projectIId").val();
    var maintenanceMaster = $("#maintenanceMaster").val();
    var fromDate = $("#fDatee").val();
    var toDate = $("#tDatee").val();
    let pageSize = $("#tableId_length select").val();
    
    $("#tabProjectId").val(projectId);
    $("#tabMaintenanceMaster").val(maintenanceMaster);
    $("#tabFromDate").val(fromDate);
    $("#tabToDate").val(toDate);
    $("#tabPageSizeData").val(pageSize);
    $("#tabChangeStatusId").val(status);
     
    // Serialize and encrypt the form data
    var bizContent = $("#tabChangeForm").serializeArray();
    $("#tabCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    $("#tabChangeForm").submit();
}

// Document ready with DataTable initialization
$(document).ready(function(){
    let totalRecords = '${genericDataViewDto.totalRecords}';
    let pageNo = '${genericDataViewDto.pageNo}';
    let pageSize = '${genericDataViewDto.pageSize}';
    
    // DataTable initialization
    let dataTable = new DataTable("#tableId", {
        "paging": true,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "pageLength": parseInt(pageSize),
        "language": {},
        "drawCallback": function(settings) {
            let api = this.api();
            let pageInfo = api.page.info();
            
            $('.dataTables_info').html('Showing ' + (pageInfo.start + 1) + ' to ' + (pageInfo.end) + ' of ' + totalRecords + ' entries');
            
            let pageSizes = $("#tableId_length select").val();
            let totalPages = Math.ceil(totalRecords / pageSizes);
            
            let paginationContainer = $('.dataTables_paginate');
            paginationContainer.empty(); 
            let paginationHtml = "";
            paginationHtml += '<li class="paginate_button page-item previous" id="tableId_previous"><a href="#" aria-controls="tableId" data-dt-idx="0" tabindex="0" class="page-link">Previous</a></li>';
            for(let i = 1; i <= totalPages; i++){
                paginationHtml += '<li class="paginate_button page-item"><a href="#" aria-controls="tableId" data-dt-idx="'+i+'" tabindex="0" class="page-link">'+i+'</a></li>';
            }
            paginationHtml += '<li class="paginate_button page-item next" id="tableId_next"><a href="#" aria-controls="tableId" data-dt-idx="3" tabindex="0" class="page-link">Next</a></li>';
            paginationContainer.append(paginationHtml);

            let currentPage = parseInt(pageNo);
            if(currentPage == 1){
                $(".previous").addClass("disabled");
            }else{
                $(".previous").removeClass("disabled");
            }
            if(currentPage == totalPages){
                $(".next").addClass("disabled");
            }else{
                $(".next").removeClass("disabled");
            }

            $(".paginate_button").removeClass("current");
            $(".paginate_button").each(function(){
                if(parseInt($(this).find("a").text()) == currentPage){
                    $(this).addClass("current");
                }
            });
        }
    });
});

// Pagination click event with encryption
$(document).on("click", ".paginate_button", function(e){
    e.preventDefault();
    if($(this).hasClass("disabled")) return;

    let page = 0;
    let currentPage = parseInt($("#pageNoId").val());
    let totalPages = Math.ceil(parseInt('${genericDataViewDto.totalRecords}') / parseInt('${genericDataViewDto.pageSize}'));
    
    if($(this).hasClass("previous") && currentPage > 1){
        page = currentPage - 1;
    }else if($(this).hasClass("next") && currentPage < totalPages){
        page = currentPage + 1;
    }else{
        page = parseInt($(this).find("a").text());
    }
    
    $("#pageNoId").val(page);
    $("#pageSizeId").val($("#tableId_length select").val());

    // Encrypt and submit
    let bizContent = $("#formId").serializeArray();
    $("#formCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    $("#formId").submit();
});

// Page size change event with encryption
$(document).on("change", "#tableId_length select", function(e){
    let status = $("#statusId").val();
    let pageSize = $(this).val();

    $("#tabChangeStatusId").val(status);
    $("#tabPageSizeData").val(pageSize);

    let tabContent = $("#tabChangeForm").serializeArray();
    $("#tabCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(tabContent))));
    $("#tabChangeForm").submit();
});

// Other functions remain the same
function viewDocument(filePath, moduleName) {
    $('#moduleName').val(moduleName);
    $('#filePath').val(filePath);
    $('#documentFormView').submit();
}

function fetchMaintenanceImage(mainViewId) {
    if (!mainViewId) {
        bootbox.alert("Invalid maintenance ID.");
        return;
    }$.ajax({
        type: "GET",
        url: "${contextPath}/maintenance/fetchMaintenanceImageByMainViewId",
        data: { mainViewId: mainViewId },
        xhrFields: {
            responseType: 'blob'
        },
        beforeSend: function(xhr) {
            xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
        },
        success: function (blob) {
            if (blob && blob.size > 0) {
                const mimeType = blob.type || 'image/jpeg'; // use 'image/png' if needed
                const imageBlob = new Blob([blob], { type: mimeType });
                const url = URL.createObjectURL(imageBlob);

                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 2000);
            } else {
                bootbox.alert("Image is empty or not available.");
            }
        },
        error: function (xhr, status, error) {
            console.error("Error fetching maintenance image:", error);
            const errorMessage = xhr.responseText || "Image not found or could not be loaded.";
            bootbox.alert(errorMessage);
        }
    });
}

function callJavaScriptFunction(modelClassWithId){
    // split the string by ## to get model class and id
    var modelClassWithIdArray = modelClassWithId.split("##");
    var modelClass = modelClassWithIdArray[0];
    var id = modelClassWithIdArray[1];

    // ajax call to get the history table data
    $.ajax({
        url: "${pageContext.request.contextPath}/stageConfig/get-workFlow-history",
        type: "GET",
        data: {
            "entityClassName": modelClass,
            "entityId": parseInt(id)
        },
        success: function(response){
            console.log(response);
            var historyTableBody = $("#historyTableBodyId");
            historyTableBody.empty();
            if(response != null && response != undefined && response != "" && response.length > 0){
                let html = "";
                $.each(response, function(index, value){
                    html += "<tr>";
                    html += "<td>"+(index+1)+"</td>";
                    html += "<td>"+value.stageName+"</td>";
                    html += "<td>"+value.actionTakenByName+"</td>";
                    html += "<td>"+value.actionTakenOnRoleName+"</td>";
                    html += "<td>"+value.remark+"</td>";
                    html += "<td>"+value.actionTakenDate+"</td>";
                    html += "</tr>";
                });
                historyTableBody.append(html);
            }
            // show the modal
            $("#historyTableRemarksModal").modal("show");
        },
        error: function(response){
            console.log(response);
        }
    });
}

document.addEventListener("click", function (event) {
    if (event.target.closest("td a")) {
        event.target.classList.add("visited-link");
    }
});

// Datepicker initialization
$(document).ready(function () {
    var today = new Date();
    var oneMonthAgo = new Date();
    oneMonthAgo.setMonth(today.getMonth() - 1);
    
    $(".datepicker").datepick({
        dateFormat: "dd-mm-yyyy",                
        onShow: $.datepick.monthOnly,
        yearRange: "c-20:c+10",
        showOnFocus: true,
        showTrigger: '<button type="button" class="trigger"><i class="fa fa-calendar"></i></button>',
    });
    
    $('#fDatee').datepick('setDate', oneMonthAgo);
    $('#tDatee').datepick('setDate', today);
});

// Table header modification
document.addEventListener("DOMContentLoaded", function () {
    const table = document.getElementById("tableId");
    const headerRow = table.querySelector("thead tr");

    const lastHeader = headerRow.lastElementChild;
    lastHeader.remove();
    ["Action", "View Image"].forEach(name => {
        const th = document.createElement("th");
        th.textContent = name;
        th.style.textAlign="center";
        headerRow.appendChild(th);
    });

    table.querySelectorAll("tbody tr").forEach(row => {
        const lastCell = row.lastElementChild;
        const anchors = lastCell.querySelectorAll("a"); 
        lastCell.remove();
        anchors.forEach(a => {
            const td = document.createElement("td");
            td.style.textAlign="center";
            td.appendChild(a); 
            row.appendChild(td);
        });
    });
});
</script>