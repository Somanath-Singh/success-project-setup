<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<sec:authentication var="principal" property="principal" />
<c:set var="chargeRow" value="0" />

<style>
body {
	overflow: scroll;
	background: #ffffff !important;
}
.fa-calendar-week{
	position: absolute;
	top: 12px;
	right: 10px;
	font-size: 16px;
}
@media print {
	.no-print {
		display: none;
	}
	input {
		border-color: transparent !important;
	}
	select {
		border-color: transparent !important;
	}
	/* td #grdate {
		border-color: transparent !important;
		display: none;
	} */
	 td textarea {
		border-color: transparent !important;
		resize:none;
	}
	td #doc{
	display: none;
	}
}
.invoice-form table thead th{
    color: #0f0e47
}

.print-div {
	width: 750px;
	padding: 19px;
	background: #fff;
	margin-left: auto;
	margin-right: auto;
	margin-top: 10px;
	height: 700px;
}

.print-div td input, .print-div td select {
	width: 76px;
	border: 1px solid #ddd;
	border-radius: 6px;
}

.print-div td textarea {
	border: 1px solid #ddd;
}

.print-div td textarea {
	border: 1px solid #ddd;
}
table th {
    font-size: 14px;
    font-weight: 600 !important;
}
table td {
	    font-size: 12px !important;
        font-weight: 500 !important;
        color: #312e2e !important;
        line-height: 20px !important;
        letter-spacing: 0.5px;
	}


input:focus {
	outline: none;
}

textarea:focus {
	outline: none;
}
.t-inner-data thead tr th {
    padding: 5px !important;
    font-size: 12px !important;
    font-weight: 600 !important;
}
table td{
    padding: 5px;
}
.dataSection tr{
    vertical-align: baseline;
}
.fa-calendar-week{
 	position: absolute; 
 	top: 12px;
 	right: 10px;
 	font-size: 16px;
 }
@media print{
 #myFile,.datepicker_grn{
 	margin-top: 18px !important;
 }
.fa-calendar-week{
 	display:none !important;
 }
 .datepicker_grn{
 	text-align: center !important;
 }
}
</style>

<section>
	<div class="mt-2">
	 	<form action="${contextPath}/procurement/purchaseOrder/saveGrn" class="invoice-form" method="post" id="form" enctype="multipart/form-data">
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
			<input type="hidden" name="mrnId" value="${hasMrn eq true ?  mrn.mrnId : ''}" />
			<input type="hidden" name="poId" value="${hasMrn eq true ?  mrn.purchaseOrder.poId : po.poId}" />
			<input type="hidden" id="mrnDate" value="<fmt:formatDate value='${hasMrn eq true ? mrn.mrnDate : po.poReceiptGeneratedDate}' pattern='dd/MM/yyyy'/>" />
     		 <input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />

     		 <div  style="width: 900px; margin: auto; background: #fff; position: relative;padding: 10px;border: 1px solid #ddd;">
            <div style="float:left; width:50%"><h3 style="margin-bottom: 5px; margin-top: 5px; color: #000;
    font-weight: 600; padding:10px;">GRN</h3></div>
          
            
             <div style="float:right; width:50%;text-align: right;">
                <c:choose>
                    <c:when test="${!empty principal.currentUserVo.icon && principal.currentUserVo.icon.length() > 0}">
                        <c:set var="appIcon" value="${principal.currentUserVo.icon}" />
                        <img src="${contextPath}/document/view-documents?doc=${appIcon}&module=ICON" alt="logo" class="logo" style="width: 50px;" />
                    </c:when>
                    <c:otherwise>
                        <img src="${contextPath}/assets/images/favicon.png" alt="logo" class="logo" style="width: 50px;" />
                    </c:otherwise>
                </c:choose>
             </div>
          <div style="clear:both; margin-bottom:0"></div>
            
             <div class="card-header" style="position: relative;background: #00ffff !important; ">
                 <button type="button" class="no-print" style="float: right;position: absolute;top: -3px;right: 10px;border: none;background: none;font-size: 26px;color: #5f7dcb;" onclick="window.print()">
                     <i class="fa-solid fa-print"></i>
                 </button>
                 <h4 class="detailsheading" style=" color: #0f0e47; font-size: 16px;padding-left: 2px; margin-bottom: 0px; margin-top: 0;font-weight: 600;">Contact details :</h4>
             </div>
            <div style="width: 50%; float: left;padding:10px 0;" class="dataSection">
                <table style="font-size: 12px; line-height:20px; width: 100%">
                    <tr>
                        <th style="width:40%; font-weight:700">Vendor Name :</th>
                        <td style="width:60%">${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.vendorName : po.assetVendor.vendorName}</td>
                    </tr>
                    <tr>
                        <th style="width:40%; font-weight:700">GSTIN :</th>
                        <td style="width:60%">
                            ${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.gstNo : po.assetVendor.gstNo}</td>
                    </tr>

                    <tr>
                        <th style="width:40%; font-weight:700">Phone No :</th>
                        <td style="width:60%">${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.mobileNo : po.assetVendor.mobileNo}</td>
                    </tr>
                    <tr>
                        <th style="width:40%; font-weight:700">Email :</th>
                        <td style="width:60%">${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.email : po.assetVendor.email}</td>
                    </tr>
                    <tr style="vertical-align: top;">
                        <th style="width:40%; font-weight:700">Address :</th>
                        <td style="width:60%">
                            ${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.vendorAddress : po.assetVendor.vendorAddress}</td>
                    </tr>
                    <tr>
                        <th style="width:40%; font-weight:700">POC :</th>
                        <td style="width:60%">${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.pointOfContact : po.assetVendor.pointOfContact}</td>
                    </tr>
                    <tr>
                        <th style="width:40%; font-weight:700">Contact No:</th>
                        <td style="width:60%">${hasMrn eq true ?  mrn.purchaseOrder.assetVendor.contactNumber : po.assetVendor.contactNumber}</td>
                    </tr>
                </table>
            </div>
            <div style="width: 50%; float: right;  padding:10px 0;" class="dataSection">
                <table
                    style="font-size: 12px; line-height:20px;width:100%">
                    <tr>
                        <th style="width:30%; font-weight:700">GRN Ref :</th>
                        <td style="width:70%"></td>
                    </tr>
                    <tr>
                        <th style="width:30%; font-weight:700">GRN Date :</th>
                        <td style="width:70%"></td>
                    </tr>
                    <tr>
                        <th style="width:30%; font-weight:700">PO Ref :</th>
                        <td style="width:70%">${hasMrn eq true ?  mrn.purchaseOrder.poNo : po.poNo}</td>
                    </tr>
                    <tr>
                        <th style="width:30%; font-weight:700">PO Date :</th>
                        <td style="width:70%"> <fmt:formatDate value='${hasMrn eq true ? mrn.purchaseOrder.poReceiptGeneratedDate : po.poReceiptGeneratedDate}' pattern='dd/MM/yyyy'/></td>
                    </tr>
<!--                     <tr> -->
<!--                         <td style="width:40%">Customer Code :</td> -->
<!--                         <td style="width:60%">TR1011296</td> -->
<!--                     </tr> -->

                </table>
            </div><div style="clear: both; margin-bottom:10px;"></div>

            <table class="t-inner-data" style="font-size: 12px;width:100%; ">
                <thead>
                    <tr style="background: #00ffff !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;">
                        <th>Sub Category</th>
                        <th style="width:260px">Item Name</th>
                        <c:choose>
                        	<c:when test="${hasMrn eq true}">
                        		<th style="text-align: right;">MRN Qty</th>
                        	</c:when>
                        	<c:otherwise>
                        		<th style="text-align: right;">Po Qty</th>
                        	</c:otherwise>
                        </c:choose>
						<th style="text-align: right;">GRN Remain Qty</th>
                        <th style="text-align: right;">Qty Accepted</th>
                        <th style="text-align: right;">Qty Rejected</th>
                        <!-- <th>Sale Price</th>
                        <th>Margin</th> -->
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="itemBody">
                	<c:choose>
                    	<c:when test="${hasMrn eq true}">
                    		<c:forEach items="${mrn.mrnLines}" var="lines" varStatus="count">
                    			<tr>
                    				<td>${lines.poLine.item.subCategoryName} <input type="hidden" name="grnLines[${count.index}].poLineId" value="${lines.poLine.poLineId}"> </td>
                    				<td>${lines.poLine.item.itemName} <input type="hidden" name="grnLines[${count.index}].mrnLineId" value="${lines.mrnLineId}"> </td>
                    				<td><input type="text" class="form-control" id="mrnQty"  style="width:100%;text-align:right;" value="${lines.receivedQuantity}" readonly="readonly"></td>
                    				<td><input type="text" class="form-control" id="grnRmnQty" style="width:100%;text-align:right;" value="${lines.poLine.grnRmnQuantity}" readonly="readonly"></td>
                    				<td><input class="text-end form-control altleastOneGreaterThanZero ${lines.poLine.item.isFractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'}  maximunLengthIs10WithDot onClickInput" type="text" id="rcvQty${count.count}" name="grnLines[${count.index}].receivedQuantity" style="width:100%" value="0" onkeyup="checkQty(${lines.receivedQuantity},${lines.poLine.grnRmnQuantity},this.value,'Mrn',${count.count},true)" ${lines.poLine.isGrnClose eq true ? 'readonly="readonly"' : '' } ></td>
                    				<td><input type="text" id="rejQty${count.count}" name="grnLines[${count.index}].rejectedQuantity" value="${lines.receivedQuantity}" style="width:100%;"class="text-end form-control " value="0" readonly="readonly"></td>
                    				<td>
                    					<select disabled="disabled" id="status${count.count}">
			                                <option value="false" ${lines.poLine.isGrnClose eq false ? 'selected' : '' }>Open</option>
			                                <option value="true" ${lines.poLine.isGrnClose eq true ? 'selected' : '' }>Close</option>
			                            </select>
                    				</td>
                    			</tr>
                    		</c:forEach>
                    	</c:when>
                    	<c:otherwise> 
                    		<c:forEach items="${po.poLines}" var="lines" varStatus="count">
                    			<tr>
                    				<td>${lines.item.subCategoryName} <input type="hidden" name="grnLines[${count.index}].poLineId" value="${lines.poLineId}"> </td>
                    				<td>${lines.item.itemName}</td>
                    				<td><input type="text" id="poQty"  style="width:50px" value="${lines.supplierQuantity}" readonly="readonly"></td>
                    				<td><input type="text" id="grnRmnQty"  style="width:50px" value="${lines.grnRmnQuantity}" readonly="readonly"></td>
                    				<td><input class="${lines.item.isFractional ? 'numberWithTwoDesimal' : 'numberWithTwoDesimalButOnlyAllowZero'} maximunLengthIs10WithDot ${lines.isGrnClose eq true ? '' : 'altleastOneGreaterThanZero'} onClickInput" type="text" id="rcvQty${count.count}" name="grnLines[${count.index}].receivedQuantity" style="width:50px" value="0" onkeyup="checkQty(${lines.supplierQuantity},${lines.grnRmnQuantity},this.value,'Po',${count.count},false)" ${lines.isGrnClose eq true ? 'readonly="readonly"' : '' } ></td>
                    				<td><input type="text" id="rejQty${count.count}" name="grnLines[${count.index}].rejectedQuantity" value="${lines.supplierQuantity}" style="width:50px" value="0" readonly="readonly"></td>
                    				<td>
                    					<select disabled="disabled" id="status${count.count}">
			                                <option value="false" ${lines.isGrnClose eq false ? 'selected' : '' }>Open</option>
			                                <option value="true" ${lines.isGrnClose eq true ? 'selected' : '' }>Close</option>
			                            </select>
                    				</td>
                    			</tr>
                    		</c:forEach>
                    	</c:otherwise>
                 	</c:choose>
                </tbody>
            </table>
            <table class="mt-4 t-inner-data" style="font-size: 12px;width: 100%;">
                <thead>
                    <tr style="background: #00ffff !important;color: #0f0e47 !important;border-bottom: 1px solid #ebebeb;"  >
                        <th style="">Remarks</th>
                        <th style="">Received Date</th>
                        <th style="">GRN Document</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="vertical-align: baseline;">
                        <td style="width: 50%;">
                            <textarea style="outline: none;height: 60px;" class="form-control" maxlength="100" placeholder="" name="remarks"></textarea>
                        </td>
                        <td style="width: 25%;" class="position-relative datepicker-box">
                            <input type="text" style="margin-right: 5px;" class="form-control form-control-sm datepicker_grn requiredField" id="grdate" name="grdate" value="<fmt:formatDate value='${hasMrn eq true ? mrn.mrnDate : po.poReceiptGeneratedDate}' pattern='dd/MM/yyyy'/>" readonly/>
                            <i style="" class='fa-solid fa-calendar-week'></i>
                        </td>
                        <td style="width: 25%;">
                                <input type="file" id="myFile" name="doc" style="" class="form-control">
                            </td>
                    </tr>
                </tbody>
            </table>

            <table class="footer-fix-table" style="width: 100%;">
                <tfoot>
                    <tr>
                        <th colspan="2">
                            <ul
                                style="list-style: none;padding: 0;display: flex; justify-content: space-between; 
                                align-items: flex-end; font-size: 12px;color: #000;">
                                <li style="margin-top: 45px;"><small
                                        style="display: block;">&nbsp; </small>
                                    Prepared By </li>
                                <li style="margin-top: 45px;">Approved By </li>
                                <li style="margin-top: 45px;">Authorized By
                                </li>
                            </ul>
                        </th>
                    </tr>
                    <tr style="background: #8483c7 !important; font-size: 12px;color: #fff;">
                        <th colspan="2" style="text-align:center;padding: 8px 0; text-align: center;  line-height: 16px;">
                            <p style="margin: 5px 0 0 0;">If you have any question about this price quote,please inform us at</p>
                            <p style="margin: 0 0 5px 0;">demo@gmail.com or call us at 2323432432</p>
                            <h4 style="margin: 0;">Thank You !!!</h4>
                        </th>
                    </tr>
                </tfoot>
            </table><div style="clear: both; margin-bottom:40px;"></div>
			<c:set var="dynamicFromId" value="form" scope="request" />
             <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
             </div>
     	</form>
     
	</div>
</section>


<script>
tableIds=['itemBody'];
jsonKeys=['grnLines'];
	$(function() {
		$('.datepicker_grn').datepick({
			dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
			 onSelect: function(selected) {
				 var alltDate=$('#mrnDate').val().split("/");
				 var modAllotDate=new Date(alltDate[1]+"/"+alltDate[0]+"/"+alltDate[2]);
				 if(modAllotDate > new Date(selected)){
					alert('Grn date sholud not be less than Mrn or PO approval date.');
					$('.datepicker_grn').val("");
				 }
			 }
		});
	});
	function checkQty(rqstQty,grnQty,curVal,type,lineNo,result){
        rqstQty=parseFloat(rqstQty);
        grnQty=parseFloat(grnQty);
        curVal=parseFloat(curVal).toFixed(2);
        if(isNaN(curVal)){
			curVal=0.0;
		}
		if(rqstQty<curVal){
			$("#rejQty"+lineNo).val(rqstQty);
			$("#rcvQty"+lineNo).val(0);
			alert("Can't exceed than quantity of "+type);
			return false;
		}else if(grnQty<curVal){
			$("#rejQty"+lineNo).val(rqstQty);
			$("#rcvQty"+lineNo).val(0);
			alert("Can't exceed than remain quantity of Grn");
			return false;
		}else if(curVal==''){
			$("#rejQty"+lineNo).val(rqstQty);
			$("#rcvQty"+lineNo).val(0.0);
			$("#status"+lineNo).val('false');
		}else{
			var rejQty=0;
			if(result==false){
				rejQty=(grnQty-curVal).toFixed(2);
				
			}else{
				rejQty=(rqstQty-curVal).toFixed(2);
			}
			
			$("#rejQty"+lineNo).val(rejQty);
			if(rejQty==0){
				$("#status"+lineNo).val('true');
			}else{
				$("#status"+lineNo).val('false');
			}
		}
	}

	

	
</script>