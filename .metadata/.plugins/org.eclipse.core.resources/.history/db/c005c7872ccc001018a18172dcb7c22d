<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />


<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Work Inspection</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa-solid fa-house"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Work Inspection</li>
			</ol>
		</nav>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<h4 class="card-title">Work Inspection</h4>
			</div>
			<div class="card-body">
				<div class="row align-items-end">
					<div class="col-md-3">
						<div class="form-group">
<!-- 							<label class="smallInput required" for="">Project :</label> -->
                            <label class="smallInput required" for="">Building :</label>
							<div class="">
								<select class="form-control form-control-sm select2 form-select select2" id="projectId" name="projectId"
									onchange="LoadProjectEstimationByProjectId(this.value)">
									<option value="0">- Select -</option>
									<c:forEach items="${projectList}" var="project">
										<option value="${project.projectId}" ${ project.projectId eq projectId ? 'selected' : ''}>${project.projectName}</option>
									</c:forEach>
								</select>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="form-group">
							<label class="col-md-12 required" for="estimationId">Project Estimation :</label>
							<div class="col-md-12">
								<select id="estimationId" name="estimationId" class="form-control form-control-sm form-select select2"
									required="required" onchange="getWorkOrderCodeByProjectEstimationId(this.value)">
									<option value="0" selected disabled>- Select -</option>
								</select>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="form-group">
							<label class="smallInput required" for="workOrder">Work Order :</label> 
							<input type="text" id="workOrderCode" name="workOrderCode" class="form-control form-control-sm"
								readonly> <input type="hidden" id="workOrderId"
								name="workOrderId" class="form-control form-control-sm">
						</div>
					</div>
					<div class="col-md-3">
						<div class="form-group">
							<label class="col-md-12" for="phaseFilter">Construction Phase :</label> 
							<select class="form-control form-control-sm form-select" id="phaseFilter" name="phaseFilter">
								<option value="0" selected>- Select Phase -</option>
								<%--  <option value="1" ${phaseFilter eq '1' ? 'selected' : ''}>Before Construction</option>
                                <option value="2" ${phaseFilter eq '2' ? 'selected' : ''}>During Construction</option>
                                <option value="3" ${phaseFilter eq '3' ? 'selected' : ''}>After Construction</option> --%>
								<option value="1" ${phaseFilter eq '1' ? 'selected' : ''}>Before Work Start</option>
								<option value="2" ${phaseFilter eq '2' ? 'selected' : ''}>Work In Progress</option>
								<option value="3" ${phaseFilter eq '3' ? 'selected' : ''}>Work Completed</option>
							</select>
						</div>
					</div>
				</div>
				<div class="container text-center mt-4">
					<input type="button" name="add&ManageApplication" value="Filter" id="add&ManageApplications" class="btn btn-primary btn-sm"
						onclick="getFilteredWorkInspectionData(this.value)"> 
					<a href="${contextPath}/home" type="button"
						class="btn btn-warning btn-sm">Back</a>
				</div>
			</div>
		</div>
	</div>
	
	<div class="col-md-12 mt-3">
		<div class="card">
		<!-- 	<div class="card-header">
				<h4 class="card-title">Work Inspection</h4>
			</div> -->
	<div class="card-body">
		<form method="get" action="${actionUrl}" id="formId">
			<div class="row align-items-center">
				<div class="col-md-12">
					<ul class="nav nav-pills navtab-btn gap-2" role="tablist" style="border-bottom: none;">
						<c:forEach items="${genericDataViewDto.viewStatusList}" var="sts">
							<li role="presentation" class="nav-item ">
							<a class="nav-link ${sts.statusCode eq genericDataViewDto.status ? 'active' : ''}"
								href="#home" aria-controls="home" role="tab" data-toggle="tab"
								id="${sts.statusCode}TabId"
								onclick="getTableHeaderWithData('${sts.viewStatusId}')">${sts.displayName}</a></li>
						</c:forEach>
					</ul>
				</div>
			</div>

			<div class="mt-2">
				<input type="hidden" name="cipherText" id="formCipherText" value="">
				<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
				<input type="hidden" name="status" id="statusId" value="${genericDataViewDto.statusId}" /> 
				<input type="hidden" name="pageNo" id="pageNoId" value="${genericDataViewDto.pageNo}" /> 
				<input type="hidden" name="pageSize" id="pageSizeId" value="${genericDataViewDto.pageSize}" />
		<%-- <input type="hidden" name="entityClassName" id="entityClassNameId" value="${genericDataViewDto.entityClassName}" />
			<input type="hidden" name="conTextUrl" id="conTextUrlId" value="${genericDataViewDto.conTextUrl}" /> --%>

				<div class="row align-items-end">
					<div class="col-md-12">
						<div class="tab-content">
							<div role="tabpanel" class="tab-pane active" id="home">
								<div class="row" id="dataSectionxx">
									<div class="col-md-12">
										<div class="table-responsive">
											<table class=" table table-striped table-bordered mt-3"
												id="tableId">
												<thead class="text-center bagGroundColorRvr" style="color: var(- -black);" id="tableHeaderId">
													<c:forEach items="${genericDataViewDto.theadList}" var="hd" varStatus="loop">
														<c:if test="${hd.isHidden eq false}">
															<th>${hd.thName}</th>
														</c:if>
													</c:forEach>
												</thead>
												<tbody id="tableBodyId">
													<c:forEach items="${genericDataViewDto.dataValueList}" var="row">
														<tr>
															<c:forEach items="${row}" var="value">
																<td>${value}</td>
															</c:forEach>
														</tr>
													</c:forEach>
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	</div>
	</div>
</div>

<form action="${contextPath}/document/viewDocuments" method="get" id="documentFormView" enctype="multipart/form-data" target="_blank">
	<input type="hidden" name="moduleName" id="moduleName" /> 
	<input type="hidden" name="filePath" id="filePath" />
</form>

<form action="${actionUrl}" method="get" id="tabChangeForm">
	<input type="hidden" name="cipherText" id="tabCipherText" value="">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" name="projectId" id="tabProjectId"> 
	<input type="hidden" name="estimationId" id="tabEstimationId"> 
	<input type="hidden" name="workOrderId" id="tabWorkOrderId"> 
	<input type="hidden" name="phaseId" id="tabPhaseId"> 
	<input type="hidden" name="status" id="tabChangeStatusId" /> 
	<input type="hidden" name="pageNo" value="0" id="tabPageNoData" /> 
	<input type="hidden" name="pageSize"id="tabPageSizeData" />
</form>

<form action="${contextPath}/inspection/getInspectionlist" method="get"
	id="inspectionListForm">
	<input type="hidden" name="cipherText" id="listCipherText" value="">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" name="projectId" id="projectIdData"> 
	<input type="hidden" name="estimationId" id="estimationIdData"> 
	<input type="hidden" name="workOrderId" id="workOrderIdData"> 
	<input type="hidden" name="phaseId" id="phaseIdData"> 
	<input type="hidden" name="status" id="statusData"> 
	<input type="hidden" name="pageNo" value="0" id="pageNoData" /> 
	<input type="hidden" name="pageSize" value="10" id="pageSizeData" />
</form>

<script>

	document.addEventListener("DOMContentLoaded", function () {
	    const table = document.getElementById("tableId");
	    const headerRow = table.querySelector("thead tr");
	
	    const lastHeader = headerRow.lastElementChild;
	    lastHeader.remove();
	
	    table.querySelectorAll("tbody tr").forEach((row, index) => {
	        const lastCell = row.lastElementChild;
	        const anchors = lastCell.querySelectorAll("a");
	        lastCell.remove();
	
	        if (index === 0) {
	            if (anchors.length === 3) {
	                ["Action", "View Image", "History"].forEach(name => {
	                    const th = document.createElement("th");
	                    th.textContent = name;
	                    th.style.textAlign = "center";
	                    headerRow.appendChild(th);
	                });
	            } else {
	                const th = document.createElement("th");
	                th.textContent = "Action";
	                th.style.textAlign = "center";
	                headerRow.appendChild(th);
	            }
	        }
	
	        anchors.forEach(a => {
	            const td = document.createElement("td");
	            td.style.textAlign = "center";
	            td.appendChild(a);
	            row.appendChild(td);
	        });
	
	        if (anchors.length === 0) {
	            const td = document.createElement("td");
	            td.style.textAlign = "center";
	            td.textContent = "NA";
	            row.appendChild(td);
	        }
	    });
	});

    let inspectionData = {};

    function viewDocument(filePath, moduleName) {
        $('#moduleName').val(moduleName);
        $('#filePath').val(filePath);
        $('#documentFormView').submit();
    }

    function viewInspectionDetails(inspectionId) {
        console.log("Navigating to inspection details with ID: " + inspectionId);
        window.open('${contextPath}/inspection/editInspection?inspectionId=' + inspectionId, '_blank');
    }

    function LoadProjectEstimationByProjectId(projectId, estimationId) {
        $.ajax({
            type: "GET",
            url: "${contextPath}/common/fetchProjectEstimationByProject",
            data: { projectId: projectId },
            success: function(estimations) {
                var projectEstimation = $('#estimationId'); 
                projectEstimation.empty();
                projectEstimation.append('<option value="" selected disabled>- Select -</option>');
                
                $.each(estimations, function(index, estimation) {
                    projectEstimation.append(
                        '<option value="' + estimation.estimationId + '">' + estimation.estimationNo + '</option>'
                    );
                });
                // Set selected estimationId, if provided
                if (estimationId) {
                    projectEstimation.val(estimationId);
                }
            },
            error: function(error) {
                console.error("Error fetching project estimation:", error);
                bootbox.alert("Failed to fetch project estimation data.");
            }
        });
    }

    function getWorkOrderCodeByProjectEstimationId(estimationId) {
    	debugger
        $.ajax({
            type: "GET",
            url: "${contextPath}/common/fetchWorkOrderCodeByProjectEstimation",
            data: { projectEstimationId: estimationId },
            success: function(workorder) {
                $("#workOrderCode").val(workorder.workOrderCode);
                $("#workOrderId").val(workorder.workOrderId);
            },
            error: function(error) {
                console.error("Error fetching work order:", error);
                bootbox.alert("Failed to fetch work order details.");
            }
        });
    }
    
    function getFilteredWorkInspectionData() {
    	
        var projectId = $("#projectId").val();
        var estimationId = $("#estimationId").val();
        var workOrderId = $("#workOrderId").val();
        var phaseId = $("#phaseFilter").val();
        var status = '${status}' || '';
        
        if (!projectId || projectId.trim() === "") {
            bootbox.alert("Please Select Project.");
            return false;
        }else if (!estimationId || estimationId.trim() === "") {
            bootbox.alert("Please Select Project Estimation.");
            return false;
        }else if (!workOrderId || workOrderId.trim() === "") {
            bootbox.alert("Work Order Not Found.");
            return false;
        }else{
        	$("#projectIdData").val(projectId);
            $("#estimationIdData").val(estimationId);
            $("#workOrderIdData").val(workOrderId);
            $("#phaseIdData").val(phaseId);
            $("#statusData").val(status);

            //submit tha form
        	var bizContent = $("#inspectionListForm").serializeArray();
        	$("#listCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
            $("#inspectionListForm").submit();
        }
    }
    
    function getTableHeaderWithData(status) {

    	var projectId = $("#projectId").val();
        var estimationId = $("#estimationId").val();
        var workOrderId = $("#workOrderId").val();
        var phaseId = $("#phaseFilter").val();
        let pageSize = $("#tableId_length select").val();
        
    	$("#tabProjectId").val(projectId);
        $("#tabEstimationId").val(estimationId);
        $("#tabWorkOrderId").val(workOrderId);
        $("#tabPhaseId").val(phaseId);
        $("#tabPageSizeData").val(pageSize);
        $("#tabChangeStatusId").val(status);
         
       //submit tha form
     	var bizContent = $("#tabChangeForm").serializeArray();
     	$("#tabCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
        $("#tabChangeForm").submit();
         
    }
    
 // Document ready
    $(document).ready(function(){
        debugger;
        let totalRecords = parseInt('${genericDataViewDto.totalRecords}' || "0");
        let pageNo = parseInt('${genericDataViewDto.pageNo}' || "1");
        let pageSize = parseInt('${genericDataViewDto.pageSize}' || "10");

        let pro = '${projectId}';
        let est = '${estimationId}';

        // Safe checks for project & estimation
        if (pro != null && pro !== "") {
            LoadProjectEstimationByProjectId(pro, est);
        }
        if (est != null && est !== "") {
            getWorkOrderCodeByProjectEstimationId(est);
        }

        // DataTable initialization
        let dataTable = new DataTable("#tableId", {
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "pageLength": pageSize,
            "language": {},
            "drawCallback": function(settings) {
                let api = this.api();
                let pageInfo = api.page.info();

                // Update info text safely
                $('.dataTables_info').html(
                    'Showing ' + (pageInfo.start + 1) + ' to ' + (pageInfo.end) + 
                    ' of ' + totalRecords + ' entries'
                );

                let pageSizes = parseInt($("#tableId_length select").val() || "10");
                let totalPages = Math.ceil(totalRecords / pageSizes);

                // Build custom pagination
                let paginationContainer = $('.dataTables_paginate');
                paginationContainer.empty(); 
                let paginationHtml = "";
                paginationHtml += '<li class="paginate_button page-item previous" id="tableId_previous"><a href="#" aria-controls="tableId" data-dt-idx="0" tabindex="0" class="page-link">Previous</a></li>';
                
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += '<li class="paginate_button page-item"><a href="#" aria-controls="tableId" data-dt-idx="'+i+'" tabindex="0" class="page-link">'+i+'</a></li>';
                }
                
                paginationHtml += '<li class="paginate_button page-item next" id="tableId_next"><a href="#" aria-controls="tableId" data-dt-idx="3" tabindex="0" class="page-link">Next</a></li>';
                paginationContainer.append(paginationHtml);

                // Enable/disable previous/next
                let currentPage = parseInt(pageNo || "1");
                if (currentPage <= 1) {
                    $(".previous").addClass("disabled");
                } else {
                    $(".previous").removeClass("disabled");
                }
                if (currentPage >= totalPages) {
                    $(".next").addClass("disabled");
                } else {
                    $(".next").removeClass("disabled");
                }

                // Highlight active page
                $(".paginate_button").removeClass("current");
                $(".paginate_button").each(function(){
                    let pageNum = parseInt($(this).find("a").text());
                    if (pageNum === currentPage) {
                        $(this).addClass("current");
                    }
                });
            }
        });
    });

    // Pagination click event
    $(document).on("click", ".paginate_button", function(e){
        e.preventDefault();
        if ($(this).hasClass("disabled")) return;

        let page = 1;
        let currentPage = parseInt($("#pageNoId").val() || "1");
        let totalRecords = parseInt('${genericDataViewDto.totalRecords}' || "0");
        let pageSize = parseInt('${genericDataViewDto.pageSize}' || "10");
        let totalPages = Math.ceil(totalRecords / pageSize);

        if ($(this).hasClass("previous") && currentPage > 1) {
            page = currentPage - 1;
        } else if ($(this).hasClass("next") && currentPage < totalPages) {
            page = currentPage + 1;
        } else {
            page = parseInt($(this).find("a").text() || "1");
        }

        $("#pageNoId").val(page);
        $("#pageSizeId").val($("#tableId_length select").val() || "10");

        let bizContent = $("#formId").serializeArray();
        $("#formCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
        $("#formId").submit();
    });

    // Page size change event
    $(document).on("change", "#tableId_length select", function(e){
        let status = $("#statusId").val() || "";
        let pageSize = $(this).val() || "10";

        $("#tabChangeStatusId").val(status);
        $("#tabPageSizeData").val(pageSize);

        let tabContent = $("#tabChangeForm").serializeArray();
        $("#tabCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(tabContent))));
        $("#tabChangeForm").submit();
    });
  
    function callJavaScriptFunction(modelClassWithId){
    	// split the string by ## to get model class and id
    	var modelClassWithIdArray = modelClassWithId.split("##");
    	var modelClass = modelClassWithIdArray[0];
    	var id = modelClassWithIdArray[1];

    	// ajax call to get the history table data
    	$.ajax({
    		url: "${pageContext.request.contextPath}/stageConfig/get-workFlow-history",
    		type: "GET",
    		data: {
    			"entityClassName": modelClass,
    			"entityId": parseInt(id)
    		},
    		success: function(response){
    			console.log(response);
    			var historyTableBody = $("#historyTableBodyId");
    			historyTableBody.empty();
    			if(response != null && response != undefined && response != "" && response.length > 0){
    				let html = "";
    				$.each(response, function(index, value){
    					html += "<tr>";
    					html += "<td>"+(index+1)+"</td>";
    					html += "<td>"+value.stageName+"</td>";
    					html += "<td>"+value.actionTakenByName+"</td>";
    					html += "<td>"+value.actionTakenOnRoleName+"</td>";
    					html += "<td>"+value.remark+"</td>";
    					html += "<td>"+value.actionTakenDate+"</td>";
    					html += "</tr>";
    				});
    				historyTableBody.append(html);
    			}
    			// show the modal
    			$("#historyTableRemarksModal").modal("show");
    		},
    		error: function(response){
    			console.log(response);
    		}
    	});
    }

    document.addEventListener("click", function (event) {
        if (event.target.closest("td a")) {
            event.target.classList.add("visited-link");
        }
    });
    
    
    function fetchInspectionImage(dynamicValueWithModelClass) {
        // Parse dynamicValueWithModelClass (e.g., com.aashdit.construction.model.WorkInspection##34)
        var inspectionId = dynamicValueWithModelClass;
        if (dynamicValueWithModelClass.includes('##')) {
            var parts = dynamicValueWithModelClass.split('##');
            inspectionId = parts[1]; // Extract the inspectionId (e.g., 34)
        }

        $.ajax({
            type: "GET",
            url: "${contextPath}/inspection/fetchInspectionImageByInspectionId",
            data: { inspectionId: inspectionId },
            xhrFields: {
                responseType: 'blob' // Expect a binary response (image)
            },
            beforeSend: function(xhr) {
                // Include CSRF token in the request header
                xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
            },
            success: function(blob) {
                // Create a temporary URL for the blob
                var url = window.URL.createObjectURL(blob);
                // Open the image in a new tab
                window.open(url, '_blank');
                // Clean up the URL after a short delay to ensure it loads
                setTimeout(function() {
                    window.URL.revokeObjectURL(url);
                }, 1000);
            },
            error: function(xhr, status, error) {
                console.error("Error fetching inspection image:", error);
                var errorMessage = xhr.responseText || "Image not found or could not be loaded.";
                bootbox.alert(errorMessage);
            }
        });
    }
    
</script>