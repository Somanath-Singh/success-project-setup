<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
	pageEncoding="ISO-8859-1"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<%-- <link rel="stylesheet"
	href="${contextPath}/assets/js/plugin/jquery_autocomplete/jquery.autocomplete.css" />
<script src="${contextPath}/assets/js/plugin/jquery.autocomplete.min.js"></script>
<script src="resources/javascripts/common.js"></script>
<script src="${contextPath}/assets/appJs/validation/party-master.js"></script>
<script src="${contextPath}/assets/appJs/validation/invoice.js"></script> --%>
<script src="${contextPath}/assets/js/fams/ipmsJs/ipms.js"></script>
<style>
table .btn.btn-info{
	padding: 8px 12px !important;
	color: #fff;
	border-bottom: 1px solid;
}
table .btn.btn-info:hover{
	border-bottom: 1px solid;
}
</style>

<div class="breadcrumb_conatiner">
    <div class="col-md-6">
        <h4 class="change-color">Manage BOQ</h4>
    </div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
	        <ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home" title="Home"><i class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Manage BOQ</li>
			</ol>
        </nav>
     </div>
</div>
<div class="row">
	<div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title">Manage BOQ</h6>
            </div>
            <div class="card-body">
                <form action="${contextPath}/boq/manage-boq" method="POST" id="boqForm" autocomplete="off" enctype="multipart/form-data">
                	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                	<input type="hidden" name="actionCode" id="actionCode" value="ADD"/>
                	<input type="hidden" name="boqMstId" id="boqMstId" value="${mainData.boqMstId}"/>
                	<input type="hidden" id="cipherText" name="cipherText">
                		<div class="row">
                		
                		<%@ include file="/WEB-INF/views/entityIdAndUserLevelListDrp.jsp"%>

                			<div class="col-md-2 col-sm-3 form-group">
                					<label for="estimationNo" class="required ">Project2</label>
                					<div class="col-md-12">
                						<select class="form-control form-select require " name="projectId"
                							id="projectId"
                							onchange="featchWorkOrdersByProject(this.value,0,'workOrder')">
                							<option value="">
                								<spring:message code="COMMON.LABEL.DROPDOWN.SELECT" />
                							</option>
                							<c:forEach items="${projectList}" var="project">
                								<option value="${project.projectId}" ${project.projectId eq mainData.projectId ? 'selected' : ''}>
                									${project.projectCode} | ${project.projectName}</option>
                							</c:forEach>
                						</select>
                				</div>
                			</div>
                			<div class="form-group col-md-2 col-sm-3">
                						<label for="workOrder" class="required">Workorder:</label>
                						<div class="col-md-12">
                							<select class="form-control form-select" name="workorderId" id="workOrder"> <!-- onchange="getBoqDataByWorkorderNo()" -->
                								<option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
                								<%-- <c:forEach items="${workList}" var="workorder">
                									<option value="${workorder.workOrderId}" ${workorder.workOrderId eq mainData.workorderId ? 'selected' : ''}>${workorder.workOrderNo}</option>
                								</c:forEach> --%>
                							</select>
                						</div>
                				</div>
                				<%-- <div class="col-md-3 col-sm-3">
                					<div class="form-group">
                						<label for="boqDoc" class="required">Upload BOQ:</label>
                						<div class="col-md-12">
                							<input type="file" class="form-control" name="boqDoc" id="boqDoc">
                						</div>
                					</div>
                				</div>
                				<div class="col-md-5 col-sm-3">
                                    <div class="row mt-3">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <input type="button" class="btn btn-success" onclick="uploadBoq()" value="Upload" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <a href="${contextPath}/boq/download-boq-excel-format"><input type="button" class="btn btn-success" onclick="" value="Download Empty Excel Format" /></a>
                                            </div>
                                        </div>
                                    </div> --%>

                				</div>
                				<div class="col-md-2 col-sm-3 mt-4">

                				</div>
                		<hr/>
                		<div class="row">
                			<h6 class="panel-title">
                				<span>BOQ Details</span>
                			</h6>
                		</div>
                		<div class="table-responsive">
			<table id="boq-table" class="table">
				<thead>
					<tr>
						<th>Sl. No.</th>
						<th class="required">Item</th>
						<th class="required">Description</th>
						<th class="required">Quantity</th>
						<th class="required">Unit</th>
						<th class="required">Rate</th>
						<th class="required">Amount (In Rupees)</th>
						<th>
							<button type="button" class="btn btn-success btn-add-product addBtn"><i class="fa-solid fa-plus"></i></button>
						</th>
					</tr>
				</thead>
	
				<tbody id="tbd" class="appendBox">
					<c:choose>
						<c:when test="${not empty mainData.boqItemList}">
							<c:forEach items="${mainData.boqItemList}" var="boqItem" varStatus="count">
							<tr class="append-box">
								<input type="hidden" class="validIdIndex" name="boqItems[${count.index}].boqItemId" id="boqItemId" value="${boqItem.boqItemId}"/>
								<td>${count.count}</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control validAreaIndex"
												name="boqItems[${count.index}].itemName" value="${boqItem.itemName}">
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<!-- 									<textarea class="form-control" name="boqItems[0].description"></textarea> -->
											<input type="text" class="form-control validFacIndex"
												name="boqItems[${count.index}].description" value="${boqItem.description}">
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control validMokIndex numberWithTwoDesimal"
												name="boqItems[${count.index}].quantity" value="${boqItem.quantity}"><!--  onkeypress="return isNumber(event);" -->
										</div>
									</div>
								</td>
								<td>
									<div class="form-group">
										<div class="col-md-12">
											<select class="form-control validDumIndex" name="boqItems[${count.index}].unitType" id="unitType">
												<option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
												<c:forEach items="${unitTypeList}" var="unit">
													<option value="${unit.unitTypeId}" ${unit.unitTypeId eq boqItem.unitType.unitTypeId ? 'selected' : ''}>${unit.unitTypeName}</option>
												</c:forEach>
											</select>
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control validRumIndex amount-field numberWithTwoDesimal"
												name="boqItems[${count.index}].ratePerUnit" value="${boqItem.ratePerUnit}">
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control validFumIndex amount-field numberWithTwoDesimal"
												name="boqItems[${count.index}].totalAmt" value="${boqItem.totalAmt}" readonly="readonly">
										</div>
									</div>
								</td>
								<td>
									<button type="button" class="btn btn-danger remove-btn removeDiv"
										onclick="removeRow(this)">-</button>
								</td>
							</tr>
							</c:forEach>
						</c:when>
						<c:otherwise>
							<tr class="append-box">
								<td>1</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control validAreaIndex"
												name="boqItems[0].itemName">
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<!-- 									<textarea class="form-control" name="boqItems[0].description"></textarea> -->
											<input type="text" class="form-control validFacIndex"
												name="boqItems[0].description">
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control validMokIndex numberWithTwoDesimal"
												name="boqItems[0].quantity" > <!-- onkeypress="return isNumber(event);" -->
										</div>
									</div>
								</td>
								<td>
									<div class="form-group">
										<div class="col-md-12">
											<select class="form-control validDumIndex" name="boqItems[0].unitType" id="unitType">
												<option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
												<c:forEach items="${unitTypeList}" var="unit">
													<option value="${unit.unitTypeId}">${unit.unitTypeName}</option>
												</c:forEach>
											</select>
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control amount-field validRumIndex numberWithTwoDesimal"
												name="boqItems[0].ratePerUnit">
										</div>
									</div>
								</td>
								<td>
									<div class="col-md-12 col-sm-12">
										<div class="form-group">
											<input type="text" class="form-control amount-field validFumIndex numberWithTwoDesimal"
												name="boqItems[0].totalAmt"  readonly="readonly">
										</div>
									</div>
								</td>
								<td>
									<button type="button" class="btn btn-danger remove-btn removeDiv"
										onclick="removeRow(this)"><i class="fa-solid fa-minus"></i></button>
								</td>
							</tr>
						</c:otherwise>
					</c:choose>
				</tbody>
	
	
			</table>
		</div>
           		<div class="row">
           			<div class="col-sm-12" style="margin-top: 30px;">
           				<div class="form-group text-center">
           				<c:set var="dynamicFromId" value="boqForm" scope="request" />
           			         <c:set var="wonFunction" value="submitFormData()"/>
           	                 <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
           <!-- 					 <input type="button" class="btn btn-success" onclick="submitFormData()" value="Save" /> -->
           <!-- 					 <input type="button" class="btn btn-danger" onclick="history.back()" value="Back" /> -->
           				</div>
           			</div>
           		</div>
                	</form>
            </div>
        </div>
    </div>
</div>



<script>

$( document ).ready(function() {
	 
		var projectId ='${mainData.projectId}' || 0 ;
		var workOrderId ='${mainData.workorderId}'||0;
		featchWorkOrdersByProject(projectId,workOrderId,'workOrder');
		
});

function submitFormData(){
	if($('#workOrder').val() == ''){
		bootbox.alert('Please select workorder.');
		return false;
	} 
	else if(validateExistingFields()){
		bootbox.confirm({
	        message: "Do you want to save all the details ?",
	        buttons: {
	            confirm: {
	                label: 'Yes',
	                className: 'btn-success'
	            },
	            cancel: {
	                label: 'No',
	                className: 'btn-danger'
	            }
	        },
	        callback: async (result) => {
	            if (result) {
	            	showLoader();
	            	/* $("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#boqForm").serializeArray())))); */
	            	tableOrTbodyIDS=['tbd'];
	                tableOrTbodyKeys=['boqItems'];
	            	if(encryptFormData('boqForm', tableOrTbodyIDS, tableOrTbodyKeys)){
	            	$("#boqForm").submit();
	            	}
	            }
	        }
	    });
	}
}

function uploadBoq(){
	if($('#workOrder').val() == ''){
		bootbox.alert('Please select workorder.');
		return false;
	} 
	else if($('#boqDoc').val() == ''){
		bootbox.alert('Please upload BOQ file.');
		return false;
	} 
	else {
		bootbox.confirm({
	        message: "Are you sure ?",
	        buttons: {
	            confirm: {
	                label: 'Yes',
	                className: 'btn-success'
	            },
	            cancel: {
	                label: 'No',
	                className: 'btn-danger'
	            }
	        },
	        callback: async (result) => {
	            if (result) {
	            	showLoader();
	            	/* $("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#boqForm").serializeArray())))); */
	            	tableOrTbodyIDS=['tbd'];
	                tableOrTbodyKeys=['boqItems'];
	            	if(encryptFormData('boqForm', tableOrTbodyIDS, tableOrTbodyKeys)){
	            	$("#boqForm").submit();
	            	}
	            }
	        }
	    });
	}
}

// function getBoqDataByWorkorderNo(){
// 	if($('#workOrder').val() != ''){
// 		$("#actionCode").val('EDIT2');
// 		showLoader();
// 		$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#boqForm").serializeArray()))));
// 		$("#boqForm").submit();
// 	}
// }

var count = '${not empty mainData.boqItemList}' == 'true' ? parseFloat('${mainData.boqItemList.size()}') : $('.append-box').length;
$(function(){
	$('.addBtn').click(function(){
		var html = '<tr class="append-box">'+
			'<input type="hidden" class="validIdIndex" name="boqItems['+count+'].boqItemId" id="boqItemId"/>'+
			'<td>'+(count+1)+'</td>'+
			'<td>'+
				'<div class="col-md-12 col-sm-12">'+
					'<div class="form-group">'+
						'<input type="text" class="form-control validAreaIndex" name="boqItems['+count+'].itemName">'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<div class="col-md-12 col-sm-12">'+
					'<div class="form-group">'+
						'<input type="text" class="form-control validFacIndex" name="boqItems['+count+'].description">'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<div class="col-md-12 col-sm-12">'+
					'<div class="form-group">'+
						'<input type="text" class="form-control validMokIndex numberWithTwoDesimal" name="boqItems['+count+'].quantity" >'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<div class="form-group">'+
					'<div class="col-md-12">'+
						'<select class="form-control validDumIndex" name="boqItems['+count+'].unitType" id="unitType">'+
							'<option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>'+
							'<c:forEach items="${unitTypeList}" var="unit">'+
								'<option value="${unit.unitTypeId}">${unit.unitTypeName}</option>'+
							'</c:forEach>'+
						'</select>'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<div class="col-md-12 col-sm-12">'+
					'<div class="form-group">'+
						'<input type="text" class="form-control validRumIndex amount-field numberWithTwoDesimal" name="boqItems['+count+'].ratePerUnit">'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<div class="col-md-12 col-sm-12">'+
					'<div class="form-group">'+
						'<input type="text" class="form-control validFumIndex amount-field numberWithTwoDesimal" name="boqItems['+count+'].totalAmt" readonly="readonly">'+
					'</div>'+
				'</div>'+
			'</td>'+
			'<td>'+
				'<button type="button" class="btn btn-danger remove-btn removeDiv" onclick="removeRow(this)"><i class="fa-solid fa-minus"></i></button>'+
			'</td>'+
		'</tr>';
		
				$.getScript('${contextPath}/assets/js/fams/common.js');
				
		$(".appendBox").append(html);
		count++;
	});
});

$(document).on('click','.removeDiv',function(){
	  if($('.removeDiv').length > 1){
		  $(this).closest('.append-box').remove();
		  count--;
		  renumberRows();
	  }
});

function renumberRows() {
    var numIdInputs = $(".validIdIndex").length;
    var numAreaInputs = $(".validAreaIndex").length;
    var numFacInputs=  $(".validFacIndex").length;
    var numMokInputs=  $(".validMokIndex").length;
    var numDumInputs=  $(".validDumIndex").length;
    var numRumInputs=  $(".validRumIndex").length;
    var numFumInputs=  $(".validFumIndex").length;
    for (var i = 0; i < numIdInputs; i++) {
        var input = $(".validIdIndex")[i];
        $(input).attr("name", "boqItems["+i+"].boqItemId");
    }
    
    for (var i = 0; i < numAreaInputs; i++) {
        var input = $(".validAreaIndex")[i];
        $(input).attr("name", "boqItems["+i+"].itemName");
    }

    for (var i = 0; i < numFacInputs; i++) {
        var input = $(".validFacIndex")[i];
        $(input).attr("name", "boqItems["+i+"].description");
    }

    for (var i = 0; i < numMokInputs; i++) {
        var input = $(".validMokIndex")[i];
        $(input).attr("name", "boqItems["+i+"].quantity");
    }

    for (var i = 0; i < numDumInputs; i++) {
        var input = $(".validDumIndex")[i];
        $(input).attr("name", "boqItems["+i+"].unitType");
    }

    for (var i = 0; i < numRumInputs; i++) {
        var input = $(".validRumIndex")[i];
        $(input).attr("name", "boqItems["+i+"].ratePerUnit");
    }

    for (var i = 0; i < numFumInputs; i++) {
        var input = $(".validFumIndex")[i];
        $(input).attr("name", "boqItems["+i+"].totalAmt");
    }

}

function validateExistingFields() {
    var isValid = true;
    $('.validAreaIndex, .validFacIndex, .validMokIndex, .validDumIndex, .validRumIndex, .validFumIndex').each(function() {
        if ($(this).val().trim() === "") {
        	$(this).val('');
            isValid = false;
            $(this).addClass("is-invalid");
            bootbox.alert('Please fill all required filds.');
            return false;
        } else {
            $(this).removeClass("is-invalid");
        }
    });
    return isValid;
}

$(document).on('input', 'input[name$=".quantity"], input[name$=".ratePerUnit"]', function () {
    const rowIndex = $(this).attr('name').match(/boqItems\[(\d+)\]/)?.[1];
    if (rowIndex !== undefined) {
      const quantity = parseFloat($('input[name="boqItems['+rowIndex+'].quantity"]').val()) || 0;
      const ratePerUnit = parseFloat($('input[name="boqItems['+rowIndex+'].ratePerUnit"]').val()) || 0;
      const totalAmt = quantity * ratePerUnit;
      $('input[name="boqItems['+rowIndex+'].totalAmt"]').val((totalAmt || 0).toFixed(2));
      

    }
  });
  
</script>