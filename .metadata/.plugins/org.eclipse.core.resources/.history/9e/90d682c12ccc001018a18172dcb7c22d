<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
 
<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Get E-CashBook Details</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
           	 	<li class="breadcrumb-item active" aria-current="page">Get E-CashBook Details</li>
			</ol>
		</nav>
	</div>
</div>

<div class="card">
	<div class="card-header">
        <h5 class="card-title">E-CashBook Details</h5>
	</div>
	<div class="card-body">
		<div class="row">
			<div class="col-md-3">
				<label class="required">From Date : </label>
				<div class="datepicker-box">
					<input type="text" id="fromDate" name="fromDate" class="form-control form-control-sm datepicker " required readonly>
				</div>
			</div>
			<div class="col-md-3">
				<label class="required"> To Date : </label>
				<div class="datepicker-box">
					<input type="text" id="toDate" name="toDate" class="form-control form-control-sm datepicker " required readonly>
				</div>
			</div>
			<div class="col-md-3">
				<div class="form-group">
					<label for="schemeId">Component Name:</label> <select
						id="schemeId" name="schemeId"
						class="form-control form-control-sm form-select">
						<option value="0" disabled selected>- Select -</option>
						<c:forEach items="${schemeList}" var="scheme">
							<option value="${scheme.schemeId}">${scheme.schemeName}</option>
						</c:forEach>
					</select>
				</div>
			</div>
		</div>
	    <div class="row mt-4">
			<div class="col-md-12 text-center">
				<button type="button" class="btn btn-success" onclick="filterData()">Filter</button>
				<a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
			</div>
		</div>
   	</div>
  </div>
  
  
  <div class="card mt-4" id="expenditure-report">
    <div class="card-header">
        <h5 class="card-title">Expenditure Details</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped exportbtn" id="expenditureTable">
			    <thead>
                    <tr>
                        <th class="text-center">Sl.No.</th>
                        <th>Sanction No</th>
                        <th>Sanction Date</th>
                        <th>Fund TypeName</th>
                        <th>Expenditure Amount</th>
                        <th>Used Allocation Amount</th>
                        <th>Used Budget Amount</th>
                        <th>Remaining Amount</th>
                    </tr>
                </thead>
			    <tbody id="expenditureTableBody">
			       
			    </tbody>
			</table>
        </div>
    </div>
</div>

<script>


function filterData() {
    const fromDate = $("#fromDate").val();
    const toDate = $("#toDate").val();
    const schemeId = $("#schemeId").val();

    if (!fromDate) {
        bootbox.alert("From Date is required.");
        return false;
    } else if (!toDate) {
        bootbox.alert("To Date is required.");
        return false;
    }else{
    	getExpenditureDatByFilter(fromDate,toDate,schemeId);
    }
}

function showLoader() {
    $(".loader-div").css("display", "flex");
}

function hideLoader() {
    $(".loader-div").css("display", "none");
}

function getExpenditureDatByFilter(fromDate, toDate, schemeId) {
    showLoader();

    $.ajax({
        url: contextPath + "/report/getExpendituresReport",
        type: "GET",
        data: {
            fromDate: fromDate,
            toDate: toDate,
            schemeId: schemeId
        },
        success: function (data) {
            hideLoader();
            
            if ($.fn.DataTable.isDataTable('#expenditureTable')) {
                $('#expenditureTable').DataTable().destroy();
            }

            var html = "";

            if (!data || data.length === 0) {
                html = "<tr><td colspan='7' class='text-center text-muted'>No expenditure records found for the selected criteria.</td></tr>";
                $("#expenditureTableBody").html(html);
                return;
            }

            for (var i = 0; i < data.length; i++) {
                var record = data[i];

                html += "<tr>";
                html += "<td  class='text-center align-middle'>" + (i+1) + "</td>";
                html += "<td>" + (record.sanctionNo || "N/A") + "</td>";
                html += "<td>" + (record.sanctionDate || "N/A") + "</td>";
                html += "<td>" + (record.fundTypeName || "N/A") + "</td>";
                html += "<td class='text-end'>" + (record.expenditureAmount != null ? record.expenditureAmount.toFixed(2) : "0.00") + "</td>";
                html += "<td class='text-end'>" + (record.usedAllocationAmount != null ? record.usedAllocationAmount.toFixed(2) : "0.00") + "</td>";
                html += "<td class='text-end'>" + (record.usedBudgetAmount != null ? record.usedBudgetAmount.toFixed(2) : "0.00") + "</td>";
                html += "<td class='text-end'>" + (record.remainingAmount != null ? record.remainingAmount.toFixed(2) : "0.00") + "</td>";
                html += "</tr>";
            }

            $("#expenditureTableBody").html(html);
            
            $('#expenditureTable').DataTable({
                dom: 'Bfrtip',
                buttons: ['copy', 'excel', 'csv', 'pdf', 'print'],
                searching: true,
                paging: true,
                ordering: true,
                pageLength: 10
            });
        },
        error: function (error) {
            hideLoader();
            console.error("Error fetching data:", error);
            bootbox.alert("Error fetching expenditure records.");
        }
    });
}

$(document).ready(function () {
	var today = new Date();
    var oneMonthAgo = new Date();
    oneMonthAgo.setMonth(today.getMonth() - 1);
	$(".datepicker").datepick({
		dateFormat: "dd-mm-yyyy",                
	    onShow: $.datepick.monthOnly,
	    yearRange: "c-20:c+10",
	    showOnFocus: true,
	    showTrigger: '<button type="button" class="trigger"><i class="fa fa-calendar"></i></button>',
	});
	 $('#fromDate').datepick('setDate', oneMonthAgo);
	    $('#toDate').datepick('setDate', today);

	    getExpenditureDatByFilter(
	        $("#fromDate").val(),
	        $("#toDate").val(),
	        $("#schemeId").val()
	    );  
});
	


</script>