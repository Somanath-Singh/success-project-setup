<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
	<c:set var="userDetails" value="${serviceOutcome.data}"/> 
<sec:authentication var="principal" property="principal" />
<c:set var="roleCode" value="${principal.primaryRole.roleCode}" />

<style>
.mandotory::before {
  content: '* '; /* Display an asterisk followed by a space before the header text */
  color: red;    /* Optionally, set the color to red or any other desired color */
}

/* .required::before { */
/*   content: '* '; /* Display an asterisk followed by a space before the header text */ */
/*   color: red;    /* Optionally, set the color to red or any other desired color */ */
/* } */
.disabled-dropdown {
    pointer-events: none;
    background-color: #eee; /* Optional: Change the background color to visually indicate it's disabled */
}

.mandatory-field {
    border: 1px solid #b3432f;
/*     background-color: #ffb2a8; /* Adjust the background color as needed */ */
}

	.hidden {
    display: none;
}
legend {
    width: auto !important;
    color: #d51010 !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    margin-top: -12px !important;
    margin-left: 25px !important;
    position: absolute !important;
    border-radius: 9px !important;
    letter-spacing: 0.25px !important;
    background-color: #ffffff !important;
    padding: 1px 5px 1px 5px !important;
    font-family: 'Space Grotesk', sans-serif !important;
}
fieldset {
    border-radius: 10px !important;
    margin-bottom: 30px !important;
    background-color: #ffffff6e !important;
    border: 1.5px solid #898989 !important;
}
</style>	
		<div class="breadcrumb_conatiner">
               <div class="col-md-6">
                 <h4 class="change-color">Candidate Information</h4>
               </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Candidate Information</li>
                  </ol>
                </nav>
              </div>
            </div>
<%-- <form action="${contextPath}/sendOfferLetter" method="POST" id="sendOfferLetter"> --%>
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
     <input type="hidden" id="hdnRegdIds" name="hdnRegdIds" value="${regdIdHdn}">
     <input type="hidden" id="hiddenOfferId" name="hiddenOfferId" value="${hiddenOfferId}">
			<div class="col-md-12">
			  <div class="card">
			    <div class="card-header">
			      <h5 class="card-title">Candidate Personal Information</h5>
			    </div>
			    <div class="card-body">
			      <div class="row">
			        <div class="col-md-4">
                        <table class="w-100">
                            <tbody>
                                <tr>
                                    <th style="width: 110px;">Name</th>
                                    <td>:</td>
                                    <td>${candInfo.name}</td>
                                </tr>
                                <tr>
                                    <th style="">Code</th>
                                    <td>:</td>
                                    <td>${candInfo.code}</td>
                                </tr>
                                <tr>
                                    <th style="">Father's Name</th>
                                    <td>:</td>
                                    <td>${candInfo.fatherName}</td>
                                </tr>
                                <tr>
                                    <th style="">Mother's Name</th>
                                    <td>:</td>
                                    <td>${candInfo.motherName}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="w-100">
                            <tbody>
                                <tr>
                                    <th style="width: 95px;">Mobile No</th>
                                    <td>:</td>
                                    <td>${candInfo.mobileNo}</td>
                                </tr>
                                <tr>
                                    <th style="">Aadhaar No</th>
                                    <td>:</td>
                                    <td>${candInfo.aadhaarNo}</td>
                                </tr>
                                <tr>
                                    <th style="">Email</th>
                                    <td>:</td>
                                    <td>${candInfo.mailId}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="w-100">
                            <tbody>
                                <tr>
                                    <th style="width: 95px;">Gender</th>
                                    <td>:</td>
                                    <td>
                                        <c:choose>
                                          <c:when test="${not empty candInfo.gender}">
                                            ${candInfo.gender}
                                          </c:when>
                                          <c:otherwise>NA</c:otherwise>
                                        </c:choose>
                                    </td>
                                </tr>
                                <tr>
                                    <th style="">Date of Birth</th>
                                    <td>:</td>
                                    <td>
                                        <c:choose>
                                          <c:when test="${not empty candInfo.dob}">
                                                <fmt:formatDate value="${candInfo.dob}" pattern="dd/MM/yyyy" />
                                          </c:when>
                                              <c:otherwise>NA</c:otherwise>
                                        </c:choose>
                                    </td>
                                </tr>
                                <tr>
                                    <th style="">Age</th>
                                    <td>:</td>
                                    <td>
                                        <c:choose>
                                            <c:when test="${not empty candInfo.age}">
                                                ${candInfo.age}
                                            </c:when>
                                            <c:otherwise>NA</c:otherwise>
                                        </c:choose>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
			      </div>
			    </div>
			  </div>
			</div>
			<div class="col-md-12 mt-3">
			  <div class="card">
			    <div class="card-header">
			      <h5 class="card-title">Uploaded Documents</h5>
			    </div>
			    <div class="card-body">
			      		<table class="table table-bordered table-hover table-striped mb-none dataTable" id="datatable-svr" style="width:100%;">
									<thead>
										<tr>
										    <th style="text-align: center;width: 60px;">Sl. No</th>
										    <th>Document Name</th>
										    <th style="width: 100px;">Action</th>
										</tr>
									</thead>
									<c:forEach items="${docList}" var="data" varStatus="status">
										<tr>
											<td class="text-center">${status.count}</td>
											<td>${data.recruitmentDocument.name}</td>
											<td>
												<button type="button" class="btn btn-primary" onclick="downloadDoc('${data.candidateVacancyMapping.candId.code}/${data.candidateVacancyMapping.candId.code}${data.recruitmentDocument.code }','${data.fileName}')" style="font-size:16px" title="Download"><i class="fa fa-download"></i></button>
											</td>
										</tr>
									</c:forEach>
								</table>
			    </div>
			  </div>
			</div>
						

<div class="col-md-12 mt-3">
  <div class="card">
    <div class="card-header">
      <h5 class="card-title">Interview History</h5>
    </div>
    <div class="card-body">
            <div class="row mt-3">
              <!-- For each round, loop through the history list and display only records that match the current round -->
              <c:forEach var="history" items="${interviewHistoryList}">
              <div class="col-md-12">
                <fieldset>
                		<legend>${history.interviewRound.roundType} (${history.sequenceId})</legend>
                		<div class="row p-3">
                		    <div class="col-md-3">
                		        <table class="w-100">
                                    <tbody>
                                        <tr>
                                            <th>Interviewer</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.interviewerId}">
                                                      ${history.interviewerId.staffName}
                                                    </c:when>
                                                    <c:otherwise>
                                                        NA
                                                    </c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Interview Type</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.interviewType.typeName}">
                                                      ${history.interviewType.typeName}
                                                    </c:when>
                                                    <c:otherwise>NA</c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                		    </div>
                		    <div class="col-md-3">
                                <table class="w-100">
                                    <tbody>
                                        <tr>
                                            <th style="width: 50px;">Date</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.interviewDate}">
                                                      <fmt:formatDate value="${history.interviewDate}" pattern="dd/MM/yyyy" />
                                                    </c:when>
                                                    <c:otherwise>NA</c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Time</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.interviewTime}">
                                                      ${history.interviewTime}
                                                    </c:when>
                                                    <c:otherwise>NA</c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-3">
                                <table class="w-100">
                                    <tbody>
                                        <tr>
                                            <th>Total Mark</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.totalMarks}">
                                                      ${history.totalMarks}
                                                    </c:when>
                                                    <c:otherwise>NA</c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th style="width: 110px;">Secured Marks</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.securedMarks}">
                                                      ${history.securedMarks}
                                                    </c:when>
                                                    <c:otherwise>NA</c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-3">
                                <table class="w-100">
                                    <tbody>
                                        <tr style="vertical-align: baseline;">
                                            <th style="width: 70px;">Remarks</th>
                                            <td>:</td>
                                            <td>
                                                <c:choose>
                                                    <c:when test="${not empty history.remarks}">
                                                      ${history.remarks}
                                                    </c:when>
                                                    <c:otherwise>NA</c:otherwise>
                                                </c:choose>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                		</div>
                </fieldset>
              </div>

              </c:forEach>
            </div>
    </div>
  </div>
</div>
                <c:if test="${not empty newList}">
					<div class="col-md-12 mt-3">
					    <div class="card">
					        <div class="card-header">
					            <h5 class="card-title">Note</h5>
					        </div>
					        <div class="card-body">
					            <div class="row" style="">
								    <c:forEach var="item" items="${newList}" varStatus="status">
								      <c:if test="${item.recruitStatus.statusCode eq 'SENT' }">
								        <p style="color: #d9534f; font-weight: bold; margin-bottom: 5px;">
								            ${status.count}. This candidate is already selected for 
								            '<span style="color: #5bc0de;">${item.candVacMapId.vacancyId.roleId.displayName}</span>' 
								            designation under '<span style="color: #5bc0de;">${item.orgName}</span>' entity 
								            of organization '<span style="color: #5bc0de;">${item.entityName}</span>'
								        </p>
								       </c:if> 
								        <c:if test="${item.recruitStatus.statusCode ne 'SENT' }">
								        <p style="color: #d9534f; font-weight: bold; margin-bottom: 5px;">
								         <p style="color: #d9534f; font-weight: bold; margin-bottom: 5px;">
								            ${status.count}. This candidate rejected for 
								            '<span style="color: #5bc0de;">${item.candVacMapId.vacancyId.roleId.displayName}</span>' 
								            designation under '<span style="color: #5bc0de;">${item.orgName}</span>' entity 
								            of organization '<span style="color: #5bc0de;">${item.entityName}</span>'
								        </p>
								        </p>
								       </c:if> 
								    </c:forEach>
								</div>
					        </div>
					    </div>
					</div>
 				</c:if>
						
						
						<div class="col-md-12 mt-3">
						    <div class="card">
						        <div class="card-header">
						            <h5 class="card-title">Send Offer Letter</h5>
						        </div>
						        <div class="card-body">
						            <div class="row">
										  <!-- Salary Package Field -->
										  <div class="col-md-3 mb-3">
										    <div class="form-group">
										    <input type="hidden" class="form-control" name="selVacId" id="selVacId" value="${vacancyIdHdn}"/>
										    <input type="hidden" class="form-control" name="selRegdId" id="selRegdId" value="${regdIdHdn}"/>
										    
										    <fmt:formatDate var="formattedInterviewDate" value="${interview.interviewDate}" pattern="dd/MM/yyyy" />
										    
										     <input type="hidden" class="form-control" name="interviewDate" id="interviewDate" value="${formattedInterviewDate}"/>

										      <label for="salaryPackage1" class="col-md-12 required">Salary Package(In Lakhs) :</label>
										      <input type="text" class="form-control text-end" name="salaryPackage1" id="salaryPackage1" value="${ofrDetails.salaryPackage}" oninput="validateSalaryInput(this)" ${not empty ofrDetails.additionalNotes ? 'readonly' : ''}/>
										    </div>
										  </div>
										
										  <!-- Joining Date Field -->
										  <div class="col-md-2 mb-3">
										    <div class="form-group ${empty ofrDetails.additionalNotes ? 'recdatepicker_con':''}">
										      <label for="joiningDate1" class="col-md-12 required">Joining Date :</label>
												<input type="text" name="joiningDate1" id="joiningDate1" class="form-control" 
												    value="<fmt:formatDate value='${ofrDetails.joiningDate}' pattern='dd/MM/yyyy'/>" 
												    ${not empty ofrDetails.additionalNotes ? 'readonly' : ''}/>
										    </div>
										  </div>
										
										  <!-- Additional Notes Field -->
										  <div class="col-md-7 mb-3">
										    <div class="form-group">
										      <label for="additionalNotes1" class="col-md-12 required">Remarks :</label>
										       <textarea class="form-control" name="additionalNotes1" id="additionalNotes1" 
												    ${not empty ofrDetails.additionalNotes ? 'readonly' : ''} maxlength="200">${ofrDetails.additionalNotes}</textarea>
										    </div>
										  </div>
										</div>
                                <c:if test="${empty ofrDetails }">
						            <div class="col-md-12 text-center">
						                <div class="mt-3">
<!-- 						                    Pass the candidate's registration ID (regdIdHdn) and row index (1) -->
						                    <button class="btn btn-danger" id="sendOfferLetterBtn" onclick="sendSelectedCandidatesForOffer('${regdIdHdn}', 1, 'REJECTED')">
						                        Reject
						                    </button>
						                    <button class="btn btn-primary" id="sendOfferLetterBtn" onclick="sendSelectedCandidatesForOffer('${regdIdHdn}', 1, 'SENT')"
						                    style="width: 141px;">
						                        Send Offer Letter
						                    </button>
						                    <a href="javascript:window.history.back();" class="btn btn-danger" style="margin-top: 0px;">Back</a>
						                </div>
						            </div>
                               </c:if>
                                <c:if test="${not empty ofrDetails }">
                                <div class="col-md-12">
									  <div class="col-md-12 text-center">
						                <div class="mt-3">
						                    <a href="javascript:window.history.back();" class="btn btn-warning" style="margin-top: 0px;">Back</a>
						                </div>
						            </div>
								</div>
								</c:if>
<%-- 								<c:set var="dynamicFromId" value="sendOfferLetter" scope="request" /> --%>
<%-- 								 <c:set var="wonFunction" value="submitForm()"/> --%>
<%-- 								 <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%> --%>

						        </div>
						    </div>
						</div>
<!-- </form> -->
					<!-- Modal -->

  </body>
</html>
<form action="${contextPath}/getFinalSelectedCandidate" method="POST" id="getFinalSelectedCandidate">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="tabStatusId" name="tabStatusId">
	<input type="hidden" id="vacancyIdHdn" name="vacancyIdHdn">
	<input type="hidden" id="publicationDateHdn" name="publicationDateHdn">
	<input type="hidden" id="applicationDeadlineHdn" name="applicationDeadlineHdn">
	<input type="hidden" id="interviewSchedule" name="interviewSchedule" value="intervRound">
</form>


<form action="${contextPath}/sendOfferLetter" method="POST" id="sendOfferLetter">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
    <input type="hidden" id="hdnRegdIds" name="hdnRegdIds">
    <input type="hidden" id="vacancyIdHdn2" name="vacancyIdHdn2">
    <input type="hidden" id="hdnStageStatus" name="hdnStageStatus">
    <input type="hidden" id="hdnTabStatus" name="hdnTabStatus">
    <input type="hidden" id="hdnOfferDetails" name="hdnOfferDetails"> 
</form>


<form action="${contextPath}/getOfrLetterAprvlPage" method="get" id="sendForOfrLetter">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="regdIdHdn"  id="regdIdHdn">
	<input type="hidden" name="vacancyIdHdn3"  id="vacancyIdHdn3">
</form>

<form action="${contextPath}/download-candidate-docs" method="POST" id="downloadDocument" target="_blank">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
    <input type="hidden" id="downFileName" name="fileName">
    <input type="hidden" id="downCandidateCode" name="candidateCode">
</form>

<script>

function setTabStatus(tabId, roundType) {
    console.log(`tabStatusId: ${tabId}, Value: ${roundType}`);

    document.getElementById('tabStatus').value = tabId; // Example: Set a hidden input value
}

function filterData(tabStatus){
debugger
	if($("#roleSelect").val()==''){
		bootbox.alert("Please select vacancy.");
		return false;
	}
	else{
		if(tabStatus!=null && tabStatus!=''){
			$("#tabStatusId").val(tabStatus);
			$("#vacancyIdHdn").val($("#roleSelect").val());
			$("#publicationDateHdn").val($("#publicationDate").val());
			$("#applicationDeadlineHdn").val($("#applicationDeadline").val());
			$("#getFinalSelectedCandidate").submit();
		   
		}
	}
}


function sendSelectedCandidatesForOffer(regdId, rowIndex, stageStatus) {
	debugger
    // Retrieve values from the input fields using the rowIndex suffix.
    var salaryPackage = $("#salaryPackage" + rowIndex).val();
    var joiningDate   = $("#joiningDate" + rowIndex).val();
    var additionalNotes = $("#additionalNotes" + rowIndex).val().trim();
    
    // Validate based on the stageStatus
    if (stageStatus === 'SENT') {
        // For sending offer letter, salaryPackage and joiningDate are mandatory.
        if (!salaryPackage || !joiningDate || additionalNotes==="") {
            bootbox.alert("Please filled all required fields for sending an offer letter.");
            return false;
        }
    } else if (stageStatus === 'REJECTED') {
        // For rejection, additional notes (remarks) are mandatory.
        if (additionalNotes==="") {
            bootbox.alert("Remarks field is mandatory for rejection.");
            return false;
        }
    }
    
    // Build the offer details object (as a single record in an array)
    var offerDetails = [{
        regdId: regdId,
        salaryPackage: salaryPackage,
        joiningDate: joiningDate,
        additionalNotes: additionalNotes
    }];
    
    // Set the hidden form field values
    $("#hdnRegdIds").val(regdId);
    $("#hdnStageStatus").val(stageStatus);
    $("#vacancyIdHdn2").val('${vacancyIdHdn}');
    $("#hdnOfferDetails").val(JSON.stringify(offerDetails));
    $("#hdnTabStatus").val('${tabStatusId}');
    
    // Determine the confirmation message
    var confMsg = "";
    if (stageStatus === 'SENT') {
        confMsg = "You are about to send an offer letter. This action cannot be undone. Do you want to proceed?";
    } else if (stageStatus === 'REJECTED') {
        confMsg = "You are about to reject this candidate. This action cannot be undone. Do you want to proceed?";
    }
    
    // Show confirmation dialog and submit the form if confirmed.
    bootbox.confirm({
        message: confMsg,
        buttons: {
            confirm: { label: 'Yes', className: 'btn-success' },
            cancel: { label: 'No', className: 'btn-danger' }
        },
        callback: function (result) {
            if (result === true) {
                $("#sendOfferLetter").submit();
            }
        }
    });
}



function sendForApproval(regdId, vacancyId) {
	debugger
	$("#vacancyIdHdn3").val(vacancyId);
	$("#regdIdHdn").val(regdId);
	$("#sendForOfrLetter").submit();
}

function downloadDoc(candidateCode,fileName){
	$("#downCandidateCode").val(candidateCode);
	$("#downFileName").val(fileName);
	$("#downloadDocument").submit();
	
}


$(document).ready(function () {
$(".recdatepicker_con input").datepick({
	dateFormat: 'dd/mm/yyyy', 
    showOnFocus: true,
    minDate: '0',
	 showTrigger: '<button type="button" class="trigger">' +
	 '<i class="fa fa-calendar"></i></button>',
	 onSelect: function (selectedDate) {
		    debugger;
		    console.log("Selected Date:", selectedDate, typeof selectedDate);

		    if (Array.isArray(selectedDate) && selectedDate.length > 0) {
		        selectedDate = selectedDate[0]; // Extract the first date object
		    }

		    if (!(selectedDate instanceof Date)) {
		        console.warn("⚠️ selectedDate is not a valid Date object:", selectedDate);
		        return;
		    }

		    // Convert Date object to "dd/mm/yyyy" format
		    var day = String(selectedDate.getDate()).padStart(2, "0");
		    var month = String(selectedDate.getMonth() + 1).padStart(2, "0"); // Month is 0-based
		    var year = selectedDate.getFullYear();
		    var formattedSelectedDate = `${day}/${month}/${year}`;

		    var $inputField = $(this);
		    var row = $inputField.closest("tr");
		    var eligibleDateStr = $("#interviewDate").val();

		    if (!eligibleDateStr) {
		        console.warn("⚠️ No reference date found for validation.");
		        return;
		    }

		    // Convert eligible date string to Date object
		    var eligibleDateParts = eligibleDateStr.split("/");
		    var eligibleDate = new Date(eligibleDateParts[2], eligibleDateParts[1] - 1, eligibleDateParts[0]);

		    if (selectedDate < eligibleDate) {
		    	bootbox.alert("Joining date cannot be earlier than the last round interview date.");
		        $inputField.val(""); // Clear invalid date
		     //   $inputField.datepicker("show"); // Reopen datepicker
		    }
		}
});
});

function validateSalaryInput(input) {
	debugger
    let value = input.value;

    // Allow only digits and a single decimal point
    let regex = /^\d{0,6}(\.\d{0,2})?$/; 
    
    // Prevent multiple dots
    if ((value.match(/\./g) || []).length > 1) {
        input.value = value.substring(0, value.lastIndexOf('.')); 
        return;
    }

    // Enforce the pattern
    if (!regex.test(value)) {
        input.value = value.slice(0, -1);
    }
}
</script>