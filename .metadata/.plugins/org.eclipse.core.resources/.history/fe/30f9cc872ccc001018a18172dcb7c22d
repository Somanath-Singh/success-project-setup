<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>  
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>  
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%> 
<c:set var="contextPath" value="${pageContext.request.contextPath}"/> 
<c:set var="userDetails" value="${serviceOutcome.data}"/> 
<script type="text/javascript" src="${contextPath}/assets/utilsJs/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/commonMaster.js"></script> 
<style>
.freeze{
		pointer-events: none;
}
</style>
<div class="breadcrumb_conatiner">
    <div class="col-md-6">
        <h4 class="change-color">Add Facility</h4>
    </div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
	        <ol class="breadcrumb">
				<li class="breadcrumb-item">
				    <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">Facility</li>
			</ol>
        </nav>
     </div>
</div>

    <div class="container-fluid">
    	<div class="row mt-2">

            <div class="card">
                <div class="card-header">
                    <h6 class="card-title">Facility Details</h6>
                </div>
                <div class="card-body">
    <form class="form-horizontal" action="${contextPath}/facility/saveFacilityDetails" method="POST" id="facilityMstForm"  enctype="multipart/form-data">
        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
        <input type="hidden" name="facilitiesMapId" value="${facilityMstData.facilitiesMapId}" id="facilitiesMapId"/>
        <div class="row">
			

			<c:set var="functionList" value="getOrganizationDwonEHL(this)" />
			<c:set var="upperOrDown" value="down" />
			<c:set var="functionList2" value="getParentFacilities(this)"/>
			<%@ include file="/WEB-INF/views/entityIdAndUserLevelList.jsp"%>


            <div class="form-group col-md-2">
                <label>Facility Name<span class="requiredStarMark">*</span></label>
                <div class="col-md-12">
                    <input type="text" id="facilityName" name="facilityName" placeholder="Max 100 chars" class="form-control thisisRequiredField AlphaNumericOnly form-control-sm" required maxlength="100" value="${facilityMstData.facilityName}">
                </div>
            </div>
           <div class="form-group col-md-2">
			    <label class="required">Has Parent</label>
			    <div class="col-md-12 d-flex form-control" style="background: #e2e9ef;">
			        <div class="form-check me-2">
			            <input class="form-check-input" type="radio" name="hasParent" id="hasParentYes" value="YES" ${facilityMstData.hasParent eq 'TRUE' ? 'checked' : ''} onclick="show1()">
			            <label class="form-check-label" for="hasParentYes">
			                Yes
			            </label>
			        </div>
			        <div class="form-group">
			            <input class="form-check-input" type="radio" name="hasParent" id="hasParentNo" value="NO" ${facilityMstData.hasParent eq 'FALSE' || facilityMstData.hasParent == null ? 'checked' : ''} onclick="show1()">
			            <label class="form-check-label" for="hasParentNo">
			                No
			            </label>
			        </div>
			    </div>
			</div>
            <div class="form-group col-md-2 d-none" id="doc1">
                <label >Parent Facility<span class="requiredStarMark">*</span></label>
                <div id="hideUserId">
                    <div class="col-md-12">
						<input type="hidden" value="${facilityMstData.parentId}" id="parentIdHiddenId">
                        <select name="parentId" id="parentId" class="form-control form-select" required="required" >
                            <option value="">-select-</option>
							
                        </select>
                    </div>
                </div>
            </div>
           <div class="form-group col-md-4">
               <label class="required">Description</label>
               <div class="col-md-12">
                   <textarea type="text" id="description" name="description" placeholder="Max 250 chars" class="form-control form-control-sm" required maxlength="250" title="${facilityMstData.description}">${facilityMstData.description}</textarea>
               </div>
           </div>
        </div>
        
        <div class="col-md-12 mt-2 text-center">
            <button type="button" class="btn-submit btn" onclick="submitForm('${empty facilityMstData.facilitiesMapId ? 'SAVE' : 'UPDATE'}')"><spring:message code="${empty facilityMstData.facilitiesMapId ? 'site.common.submit' : 'site.common.update'}"/></button>
            <a href="javascript:void(0)" onclick="backFormSubmit()" type="button" class="btn btn-warning btn-sm">Back</a>
        </div>
    </form>
</div>
</div>
</div>
</div>


<div class="cardcontainer cardContainerNotFirst">
	<div class="row mt-2"> 
		<div class="col-md-12">
			<div class="card full-height">
				<div class="card-header">
					<h4 class="card-title">Facility Details</h4>
				</div>
				<div class="card-body">
					<div class="row">
						<%@ include file="/WEB-INF/views/entityIdAndUserLevelListDrp.jsp"%>
					</div>
					<div class="table-responsive">
						<table class="display table table-bordered table-hover exportbtn" style="width: 100%;table-layout: fixed;" id="tableId1">
								<thead>
									<tr>
										<th class="text-center" style="width: 60px;">Sl. No</th>
										<th>Facility Name</th>
										<th>Has Parent</th>
										<th style="width: 70px;">Action</th>
									</tr>
								</thead>
								<tbody>
									<c:forEach items="${facilityList}" var="facility" varStatus="count">    
										<tr> 
										  	<td class="text-center">${count.count}</td>
											<td>${facility.facilityName}</td>
                            				<td>${facility.hasParent ? 'YES' : 'NO'}</td>
										 	<td>
										 		<button	type="button" onclick="editFacilityDtls(${facility.facilitiesMapId})"class="btn btn-info btn-sm" title="Edit" style="height:22px; width:26px; padding: 0 7px !important;line-height: 7px"> <i class=" fa fa-edit " aria-hidden="true"></i></button>
										 		<button type="button" onclick="mapFacilityAsset(${facility.facilitiesMapId})" class="btn btn-info btn-sm" title="Map" style="height:22px; width:26px; padding: 0 7px !important; line-height:7px;">	<i class=" fa fa-map " aria-hidden="true"></i></button>
										 	</td>
										</tr>
								  	</c:forEach> 
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div> 
</div>

<form action = "${contextPath}/facility/editMappingDetails" method="get" id="editFacilityForm">
	<input type="hidden" name="mapId" id="facilityMapId">
</form>
<form action = "${contextPath}/assetFacility/mapFacilityAsset" method="get" id="mapFacilityAssetForm">
	<input type="hidden" name="mappingId" id="facilityId">
	<input type="hidden" name="parentEntityIdAndTypeIdName" value="" id="parentEntityIdAndTypeIdName">
</form>
<script>
function backFormSubmit() {
	debugger
    var $form = $('<form>', {
        'action': '${contextPath}/moduleDirectory', 
        'method': 'POST'
    });
	var moduleCode=enc_password('FACILITIES');
	$('<input>', {
        'type': 'hidden',
        'name': 'moduleCode', 
        'value': moduleCode
    }).appendTo($form);
    $('<input>', {
        'type': 'hidden',
        'name': '${_csrf.parameterName}', 
        'value': '${_csrf.token}' 
    }).appendTo($form);

    $('body').append($form);
    $form.submit();
}


function submitForm(status){
	// check if has parent is yes then check parent id is selected or not
	var hasParent = document.querySelector('input[name="hasParent"]:checked').value;
	if(hasParent == "YES"){
		var parentId = $("#parentId").val();
		if(parentId == ""){
			bootbox.alert("Please select parent facility");
			return;
		}
	}
	validateAndFormSubmit('facilityMstForm', 'thisisRequiredField');
}

function editFacilityDtls(id){
//	 $("#finYearId").val(enc_password(id));
//	 $("#editFinYearForm").append('<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />');
	 
    $("#facilityMapId").val(id);
		showLoader();
	 $("#editFacilityForm").submit();
}

function mapFacilityAsset(id){
   $("#facilityId").val(id);
	 showLoader();
	 var parentEntityIdAndTypeIdName = $("#parentEntityIdAndTypeId").val();
	 $("#parentEntityIdAndTypeIdName").val(btoa(parentEntityIdAndTypeIdName));
	 $("#mapFacilityAssetForm").submit();
}

// in ready function trigger the show1 function
$(document).ready(function(){
	show1();
});

function show1(){
	var hasParent = document.querySelector('input[name="hasParent"]:checked').value;
	if(hasParent == "YES"){
	getParentFacilities();
		$("#doc1").removeClass("d-none");
	}else{
		$("#doc1").addClass("d-none");
		$("#parentId").val('');
	}
}

function getParentFacilities(that){
	debugger;
	var value = $(that).val() || $("#upperEntityId").val();
	var facilitiesMapId = $("#facilitiesMapId").val();
	var parentIdHiddenId = $("#parentIdHiddenId").val();
	$.ajax({
		url: "${contextPath}/facility/getParentFacility",
		type: "GET",
		data: {
			"objStr": btoa(value),
			"parentIdStr": btoa(facilitiesMapId)
		},
		success: function(response){
			if(response.outcome){
				var html = "<option value='' selected>--Select--</option>";
				var data = response.data;
				if(data != "" && data != null && data.length > 0){
					$.each(data, function(index, value){
						let selected = "";
						if(value.parentId == parentIdHiddenId){
							selected = "selected";
						}
						html += '<option value="' + value.parentId + '" '+selected+'>' + value.parentName + '</option>';
					});
				}
				$('#parentId').empty().append(html);
			}
		},
		error: function(error){
			//bootbox.alert("Failure"); 
		}
	});
}

</script>
