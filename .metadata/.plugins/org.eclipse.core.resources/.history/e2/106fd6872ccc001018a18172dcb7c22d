<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<div class="breadcrumb_conatiner">
    <div class="col-md-6">
        <h4 class="change-color">Building Performance Report</h4>
    </div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                <li class="breadcrumb-item active" aria-current="page">Building Performance Report</li>
            </ol>
        </nav>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title">Building Performance Report</h5>
    </div>
    <div class="card-body">
        <c:if test="${not empty error}">
            <div class="alert alert-danger mt-3" role="alert">
                ${error}
            </div>
        </c:if>
        <div class="row">
            <div class="col-md-3">
                <label class="required">Start Date : </label>
                <div class="datepicker-box">
                    <input type="text" id="startDate" name="startDate" value="${startDateStr}" class="form-control form-control-sm datepicker" required readonly>
                </div>
            </div>
            <div class="col-md-3">
                <label class="required">End Date : </label>
                <div class="datepicker-box">
                    <input type="text" id="endDate" name="endDate" value="${endDateStr}" class="form-control form-control-sm datepicker" required readonly>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="districtId">Select District :</label>
                    <select id="districtId" name="districtId" class="form-control form-control-sm form-select">
                        <option value="0">- Select -</option>
                        <c:forEach items="${districtList}" var="district">
                            <option value="${district.districtId}" ${selectedDistrictId == district.districtId ? 'selected' : ''}>${district.districtName}</option>
                        </c:forEach>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="projectId">Select Name :</label>
                    <select id="projectId" name="projectId" class="form-control form-control-sm form-select">
                        <option value="">- Select -</option>
                        <c:forEach items="${projectDropDownList}" var="project">
                            <option value="${project.projectId}" ${selectedProjectId == project.projectId ? 'selected' : ''}>${project.projectName}</option>
                        </c:forEach>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label for="projectType">Building Project Type :</label>
                    <select id="projectType" name="projectType" class="form-control form-control-sm form-select">
                        <option value="">- Select -</option>
                        <c:forEach items="${projectTypeList}" var="type">
                            <option value="${type}" ${selectedProjectType == type ? 'selected' : ''}>${type}</option>
                        </c:forEach>
                    </select>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <button type="button" class="btn btn-success" onclick="filterData()">Filter</button>
                <a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4" id="project-performance-report">
    <div class="card-header">
        <h5 class="card-title">Building Performance Details</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped exportbtn" id="performanceTable">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">Sl.No.</th>
                        <th>Financial Year</th>
                        <th>District</th>
                        <th>Building Name</th>
                        <th>Building Type</th>
                        <th>Estimated Cost</th>
                        <th>Final Cost</th>
                        <th>Completion Date</th>
                    </tr>
                </thead>
                <tbody>
                    <c:choose>
                        <c:when test="${not empty projectList}">
                            <c:forEach items="${projectList}" var="project" varStatus="status">
                                <tr>
                                    <td class="text-center">${status.index + 1}</td>
                                    <td>${project.financialYear}</td>
                                    <td>${project.districtName}</td>
                                    <td>${project.projectName}</td>
                                    <td>${project.projectType}</td>
                                    <td class="text-end">${project.estimatedCost}</td>
                                    <td class="text-end">${project.finalCost}</td>
                                    <td>${project.completionDate}</td>
                                </tr>
                            </c:forEach>
                        </c:when>
                        <c:otherwise>
                            <tr><td colspan="8" class="text-center text-muted">No records found for the selected criteria.</td></tr>
                        </c:otherwise>
                    </c:choose>
                </tbody>
            </table>
        </div>
    </div>
</div>

 <form id="filterForm" action="${contextPath}/report/projectPerformance" method="GET">
	<input type="hidden" name="cipherText" id="hiddenCipherText">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" id="hiddenStartDate" name="startDate">
	<input type="hidden" id="hiddenEndDate" name="endDate">
	<input type="hidden" id="hiddenDistrictId" name="districtId">
    <input type="hidden" id="hiddenProjectId" name="projectId">
    <input type="hidden" id="hiddenProjectType" name="projectType">
</form>

<script>

function filterData() {
    debugger;
    var startDate = $("#startDate").val(); 
    var endDate = $("#endDate").val();    
    var districtId = $("#districtId").val(); 
    var projectId = $("#projectId").val();    
    var projectType = $("#projectType").val(); 
    
    $('#hiddenStartDate').val(startDate);
    $('#hiddenEndDate').val(endDate);
    $('#hiddenDistrictId').val(districtId);
    $('#hiddenProjectId').val(projectId);
    $('#hiddenProjectType').val(projectType);

    showLoader();

    var bizContent = $("#filterForm").serializeArray();
    $("#hiddenCipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
    $("#filterForm").submit();
}

$(document).ready(function () {
    var today = new Date();
    var oneMonthAgo = new Date();
    oneMonthAgo.setMonth(today.getMonth() - 1);

    $(".datepicker").datepick({
        dateFormat: "dd-mm-yyyy",
        onShow: $.datepick.monthOnly,
        yearRange: "c-20:c+10",
        showOnFocus: true,
        showTrigger: '<button type="button" class="trigger"><i class="fa fa-calendar"></i></button>',
    });

    if (!$("#startDate").val()) {
        $('#startDate').datepick('setDate', oneMonthAgo);
    }
    if (!$("#endDate").val()) {
        $('#endDate').datepick('setDate', today);
    }
    
    var $table = $("#performanceTable");

    if ($table.find("tbody tr td").hasClass("text-muted")) {
        $table.removeClass("exportbtn");
    } else {
        $table.addClass("exportbtn");
    }

 });

</script>
