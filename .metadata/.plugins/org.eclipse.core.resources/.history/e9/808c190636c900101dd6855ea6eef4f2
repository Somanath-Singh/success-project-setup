package com.aashdit.prod.heads.hims.ipms.controller;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.MultiValueMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.springframework.web.util.UriComponentsBuilder;

import com.aashdit.prod.heads.common.service.CommonService;
import com.aashdit.prod.heads.framework.core.ServiceOutcome;
import com.aashdit.prod.heads.hims.ipms.dto.WebsiteChildContentVO;
import com.aashdit.prod.heads.hims.ipms.service.WebsiteService;
import com.aashdit.prod.heads.hims.ipms.utils.ApplicationConstants;
import com.aashdit.prod.heads.hims.ipms.utils.DecryptCipherText;

import lombok.extern.slf4j.Slf4j;

@Controller
@Slf4j
public class HomeController {

	@Autowired
	private WebsiteService websiteService;

	@Autowired
	private CommonService commonService;

	@GetMapping(path = { "/", "/home" })
	public String home(Model model, HttpServletRequest request,
			@RequestParam(name = "collegeId", required = false) Long collegeId) {
		try {
			Long unvId = 0L;
			String cipherText = (String) request.getSession().getAttribute("cipherText");

			if (cipherText != null && !cipherText.isEmpty()) {
				request.getSession().removeAttribute("cipherText"); // Clear after use

				String realFormData = DecryptCipherText.decryptCipherTextGet(cipherText, request);
				MultiValueMap<String, String> queryParams = UriComponentsBuilder.fromUriString("?" + realFormData)
						.build().getQueryParams();

				unvId = Long.valueOf(queryParams.getFirst("universityId"));
			}

			model.addAttribute("isLoginShow", true);
			model.addAttribute("unvIdForSelected", unvId);

		} catch (Exception e) {
			log.error("Error in home controller", e);
		}
		return "site.website.home";
	}

	@GetMapping(path = { "/dashboard" })
	public String dashboard(Model model) {
		try {
			ServiceOutcome<WebsiteChildContentVO> mapList = websiteService
					.getAllChildContentData(ApplicationConstants.LOGIN_FROM_CANDIDATE);
			// List<WebsiteChildContent> mapList1=
			// mapList.getData().getChildContentList().stream().sorted((a,b)->
			// a.getPublishDate().compareTo(b.getPublishDate())).filter(a->a.getMenuId().getMenuURL().equals(ApplicationConstants.WEB_MENU_NOTIFICATON)).collect(Collectors.toList());
			// Map<Long, String> unvMapList =
			// commonService.getUniversityList().getData().stream().collect(Collectors.toMap(GenericDTO::getId,
			// GenericDTO::getName));

//					List<WebsiteChildContent> mapList1 = mapList.getData().getChildContentList().stream()
//						    .filter(a -> ApplicationConstants.WEB_MENU_NOTIFICATON.equals(a.getMenuId().getMenuURL()))
//						    .peek(a -> a.setUniversityName(unvMapList.getOrDefault(a.getObjectId(), "N/A")))
//						    .sorted(
//						        Comparator.comparing(
//						            WebsiteChildContent::getCreatedOn,
//						            Comparator.nullsLast(Comparator.naturalOrder())
//						        ).reversed()
//						    )
//						    .collect(Collectors.toList());
//
//							model.addAttribute("notificationList",mapList1);
//					if (mapList1 != null /* ?mapList1.size()>1:false */) {
//						   WebsiteChildContent latest = mapList1.get(0);
//						    model.addAttribute("latestNotification", latest.getContentNameEn());
//						    model.addAttribute("latestUniversityName", latest.getUniversityName());
//					}
		} catch (Exception e) {
			log.error("Error occurred...", e.getMessage());
			e.printStackTrace();
		}
		return "site.loggedin.homein";
	}

	// Login from college
	@GetMapping(path = { "/app/home" })
	public String apphome(Model model) {
		try {

		} catch (Exception e) {
			e.printStackTrace();
			log.error("Error occurred... in apphome", e);
		}
		return "app.home";
	}

	@GetMapping(path = "/public/filter")
	public String filter(Model model, HttpServletRequest request,
			@RequestParam(name = "cipherText", required = false) String cipherText, RedirectAttributes attr) {
		try {
			if (cipherText != null && !cipherText.isEmpty()) {
				request.getSession().setAttribute("cipherText", cipherText);
			}
		} catch (Exception e) {
			log.error("Error in filter method", e);
		}
		return "redirect:/home";
	}

}
