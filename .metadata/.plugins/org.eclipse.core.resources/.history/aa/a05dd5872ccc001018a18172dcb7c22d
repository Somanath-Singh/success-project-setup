<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Get Project Expenditure Details</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Get Project Expenditure Details</li>
			</ol>
		</nav>
	</div>
</div>

<div class="card">
	<div class="card-header">
		<h5 class="card-title">Project Expenditure Details</h5>
	</div>
	<div class="card-body">
		<div class="row">
			<div class="col-md-4">
				<div class="form-group">
					<label class="required" for="componentId">Select Component :</label>
					<select id="componentId" name="componentId" class="form-control form-control-sm form-select" required>
						<option value="0">- Select -</option>
						<c:forEach items="${componentList}" var="component">
							<option value="${component.componentId}">${component.componentName}</option>
						</c:forEach>
					</select>
				</div>
			</div>
			<div class="col-md-4">
				<div class="form-group">
					<label class="required" for="subComponentId">Select Sub-Component :</label>
					<select id="subComponentId" name="subComponentId" class="form-control form-control-sm form-select" required>
						<option value="0">- Select -</option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mt-4">
			<div class="col-md-12 text-center">
				<button type="button" class="btn btn-success" onclick="filterData()">Filter</button>
				<a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm">Back</a>
			</div>
		</div>
		<div class="row mt-4">
			<div class="col-md-12">
				<table 
				class="table table-bordered table-hover exportbtn">
					<thead>
						<tr>
							<th>Expenditure No</th>
							<th>Expenditure Date</th>
							<th>Building Name</th>
							<th>Building Code</th>
							<th>Agency</th>
							<th>Expenditure Amount</th>
							<th>Component</th>
							<th>Sub-Component</th>
						</tr>
					</thead>
					<tbody>
						<!-- Data will be populated dynamically -->
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
function filterData() {
	const componentId = $("#componentId").val();
	const subComponentId = $("#subComponentId").val();

	if (!componentId || componentId === "0") {
		bootbox.alert("Please select a component.");
		return false;
	} else if (!subComponentId || subComponentId === "0") {
		bootbox.alert("Please select a sub-component.");
		return false;
	} else {
		fetchExpenditureData(componentId, subComponentId);
	}
}

function fetchSubComponents(componentId) {
	$.ajax({
		url: "${contextPath}/common/fetch-subcomponents-by-component",
		type: "GET",
		data: {
			componentId: componentId
		},
		success: function(subComponents) {
			var subComponentSelect = $("#subComponentId");
			subComponentSelect.empty();
			subComponentSelect.append('<option value="0">- Select -</option>');
			$.each(subComponents, function(index, subComponent) {
				subComponentSelect.append('<option value="' + subComponent.subComponentId + '">' + subComponent.subComponentName + '</option>');
			});
		},
		error: function(error) {
			bootbox.alert("Error fetching sub-components: " + error);
		}
	});
}

function fetchExpenditureData(componentId, subComponentId) {
	showLoader();
	$.ajax({
		url: "${contextPath}/common/fetch-expenditure-data",
		type: "GET",
		data: {
			componentId: componentId,
			subComponentId: subComponentId
		},
		success: function(data) {
			populateTable(data);
			hideLoader();
		},
		error: function(error) {
			bootbox.alert("Error fetching expenditure data: " + error);
			hideLoader();
		}
	});
}

function populateTable(data) {
	// Destroy existing DataTable if initialized
	if ($.fn.DataTable.isDataTable("#expenditureTable")) {
		$("#expenditureTable").DataTable().destroy();
	}

	// Initialize DataTable with new data
	$("#expenditureTable").DataTable({
		dom: 'Bfrtip',
		buttons: ['excel', 'pdf', 'copy'],
		data: data,
		columns: [
			{ data: 'expenditureNo' },
			{ data: 'expenditureDate' },
			{ data: 'projectName' },
			{ data: 'projectCode' },
			{ data: 'agencyName' },
			{ data: 'expenditureAmount' },
			{ data: 'componentName' },
			{ data: 'subComponentName' }
		]
	});
}

function showLoader() {
	$(".loader-div").css("display", "flex");
}

function hideLoader() {
	$(".loader-div").css("display", "none");
}

$(document).ready(function() {
	// Initialize DataTable with empty data
	$("#expenditureTable").DataTable({
		dom: 'Bfrtip',
		buttons: ['excel', 'pdf', 'copy']
	});

	$("#componentId").on("change", function() {
		const componentId = $(this).val();
		if (componentId && componentId !== "0") {
			fetchSubComponents(componentId);
		} else {
			$("#subComponentId").empty().append('<option value="0">- Select -</option>');
		}
	});
});
</script>