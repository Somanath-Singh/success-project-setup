<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<%-- <div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Query List</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item">
				    <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
				</li>

				<li class="breadcrumb-item active" aria-current="page">Query List</li>
			</ol>
		</nav>
	</div>
</div> --%>

<div class="row mt-3">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<h5 class="card-title">Query List</h5>
			</div>
			<div class="card-body">
				
				<div class="row">
					<form action="${contextPath}/listGrievence" id="listGrievence" class="row" enctype="multipart/form-data" method="get" >
						<div class="col-md-3" id="errorTypeDiv">
							<div class="form-group">
								<label class="">Query Category :</label>
								<div class="">
									<select name="errorCategoryId" id="errorType" class="form-control form-select form-control-sm" required="required"  onchange="getCategoryDescByErrorCategoryId(this.value);" >
										<option value="">--Select--</option>
										<c:forEach items="${error}" var="err">
											<option value="${err.errorCategoryId}" ${err.errorCategoryId eq  errorCategoryId ? 'selected' : ''}>${err.categoryType}</option>
										</c:forEach>
									</select>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label class="">Query Sub-Category :</label>
								<div class="">
									<select class="form-control form-select form-control-sm" name="errorCategoryMapId" id="errorCategoryMapId" onchange="">
										<option value="">select</option>
										<c:forEach items="${errorCategList}" var="errCat">
											<option value="${errCat.errorCategoryMapId}" ${errCat.errorCategoryMapId eq  errorCategoryMapId ? 'selected' : ''}>${errCat.categoryDescType}</option>
										</c:forEach>
									</select>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label class="">Query Creation From Date :</label>
								<div class="col-md-12 datepicker_con">
									<input type="text" class="form-control form-control-sm from_date" name="creationFromDate" id="creationFromDate" readonly="readonly" required="required"  value="${creationFromDate}" >
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label class="">Query Creation To Date :</label>
								<div class="col-md-12 datepicker_con">
									<input type="text" class="form-control form-control-sm to_date" name="creationToDate" id="creationToDate" readonly="readonly" required="required"  value="${creationToDate}" >
								</div>
							</div>
						</div>
						<div class="col-md-12 text-end mt-2" >
							<button type="button" onclick="submitFormData();" class="btn btn-success"><i class="fa-solid fa-filter"></i> Filter</button>
                			<a href="javascript:void();" onclick="history.back();" type="button" class="btn btn-warning btn-sm"><i class="fa-solid fa-rotate-left"></i> Back</a>
						</div>
					</form>
				</div>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-12 ">
						<table class="datatable table table-striped table-bordered exportbtn">
							<thead>
								<tr>
									<th class="text-center" style="width: 60px;">Sl. No.</th>
									<th>Token No.</th>
									<th>Status</th>
									<th>Contact No</th>
									<th>Email Id</th>
									<th>Issued Date</th>
									<th class="text-center">Action</th>
								</tr>
							</thead>
							<tbody>
								<c:forEach items="${grievanceList}" var="file" varStatus="count">
									<tr>
										<td class="text-center">${count.count}</td>
										<td>${file.tokenNo}</td>
										<td>${file.stageForwardedRule.displayName}</td>
										<td>${file.contactNo}</td>
										<td>${file.emailId}</td>
										<td><fmt:formatDate pattern="dd-MM-yyyy" value="${file.createdAt}" /></td> 
										<td class="text-center">
											<button type="button" class="btn btn-primary btn-sm" onclick="viewGrievenceDtlsById(${file.grvId})" title="View">
												<i class="fa fa-eye" aria-hidden="true"></i>
											</button>
										</td>
									</tr>
								</c:forEach>
							</tbody>
						</table>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>
<form action="${contextPath}/viewGrievence" method="GET" id="grvEdit">
	<input type="hidden" name="grievenceId" id="grievenceId">
</form>

<script>

    $(function() {
    	$('.from_date').datepick({
    		 dateFormat: 'dd/mm/yyyy', showOnFocus: true,
    		 showTrigger: '<button type="button" class="trigger">' +
             		 '<i class="fa fa-calendar"></i></button>',
             onSelect: function(selectedDate) {
                 var toDate = $('#creationToDate').datepick('getDate');
                 // Convert selectedDate to a Date object
                 toDate=new Date(toDate);
                 selectedDate = new Date(selectedDate);
                 if (toDate != null && selectedDate > toDate) {
                    bootbox.alert("Grievance Creation From Date can not be select after date of Grievance Creation To Date");
                    $('#creationFromDate').val("");
                    return false;

                 }
             }
    	});
    	$('.to_date').datepick({
             dateFormat: 'dd/mm/yyyy', showOnFocus: true,
             showTrigger: '<button type="button" class="trigger">' +
             		 '<i class="fa fa-calendar"></i></button>',
             onSelect: function(selectedDate) {
                var fromDate = $('#creationFromDate').datepick('getDate');
                // Convert selectedDate to a Date object
                 fromDate=new Date(fromDate);
                 selectedDate = new Date(selectedDate);
                 if (fromDate != null && fromDate > selectedDate) {
                    bootbox.alert("Grievance Creation To Date can not be select previous date of Grievance Creation From Date");
                    $('#creationToDate').val("");
                    return false;

                 }
             }
        });

    });

	function getCategoryDescByErrorCategoryId(errorCategoryId) {
		if (errorCategoryId != '') {
			$.ajax({
						type : "GET",
						url : '${contextPath}/findSubCatListByCategoryId',
						dataType : "json",
						data : {
							"errorCategoryId" : errorCategoryId,
						},
						success : function(response) {
							var html = "<option value='' selected>-Select-</option>";
							var data = response;
							if (data != "" && data != null && data.length > 0) {
								$.each(data,function(index, value) {
									html = html + "<option  value="+value.errorCategoryMapId+">"+ value.categoryDescType+ "</option>";
								});
							}
							$('#errorCategoryMapId').empty().append(html);
							$('#errorCategoryId').empty().append(html);
//	 						$('#awhName').val(employeeName);
						},
						error : function(error) {
							bootbox.alert("CategoryDescType list not found");
						}
					});
		} else {
			bootbox.alert("Please Select CategoryType");
			var html = "<option value='' selected>-Select-</option>";
			$('#errorCategoryMapId').empty().append(html);
			return false;
		}
	}

	function submitFormData(){
		debugger;
		var errorType=$("#errorType").val();
		var errorCategoryMapId=$("#errorCategoryMapId").val();
		var creationToDate=$("#creationToDate").val();
		var creationFromDate=$("#creationFromDate").val();

		if(errorType!= ""){
			if(errorCategoryMapId==""){
				bootbox.alert("Please Select Grievance Sub-Category");
				return false;
			}
		}
		if(creationFromDate!="" || creationToDate !=""){
			if(creationFromDate == ""){
				bootbox.alert("Please Select Creation From Date if you choose Creation To Date");
				return false;
			}
			if(creationToDate == ""){
				bootbox.alert("Please Select Creation To Date if you choose Creation From Date");
				return false;
			}
		}
		$("#listGrievence").submit();
	}
	function viewGrievenceDtlsById(id){
		$("#grievenceId").val(id);
		$("#grvEdit").submit();
	}

</script>
