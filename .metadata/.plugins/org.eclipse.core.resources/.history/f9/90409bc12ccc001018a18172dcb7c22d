<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<script type="text/javascript" src="${contextPath}/assets/js/bams/common-function.js"></script>

<!-- ===================== BREADCRUMB ===================== -->
<div class="breadcrumb_conatiner">
  <div class="col-md-6">
    <h4 class="change-color">School Building Report</h4>
  </div>
  <div class="col-md-6">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="${contextPath}/home"><i class="fa fa-home"></i></a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          School Building Report
        </li>
      </ol>
    </nav>
  </div>
</div>

<!-- ======== Building Filter Section ======== -->
<div class="card mb-3">
    <div class="card-header bg-light fw-bold">Building Filter</div>
    <div class="card-body">

        <div class="row">

            <!-- ======== Financial Year ======== -->
            <div class="col-md-3">
                <div class="form-group">
                    <label class="smallInput required" for="financialYearId">Financial Year :</label>
                    <select class="form-control form-control-sm form-select" id="financialYearId" name="financialYearId">
                        <option value="0" >- Select -</option>
                        <c:forEach items="${financialYearList}" var="fy">
                            <option value="${fy.financialYearId}" ${fy.financialYearId eq selectedFinancialYearId ? 'selected' : ''}>
                                ${fy.financialYear}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== District ======== -->
            <div class="col-md-3">
                <div class="form-group">
                    <label class="required" for="districtId">District Name :</label>
                    <select class="form-control form-control-sm form-select" id="districtId" name="districtId"
                            onchange="LoadBlockByDistrict(this.value)">
                        <option value="" >- Select -</option>
                        <c:forEach var="district" items="${districtList}">
                            <option value="${district.districtId}" ${district.districtId eq selectedDistrictId ? 'selected' : ''}>
                                ${district.districtName}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== Block ======== -->
            <div class="col-md-3">
                <div class="form-group">
                    <label class="required" for="blockId">Block Name :</label>
                    <select class="form-control form-control-sm form-select" id="blockId" name="blockId"
                            onchange="LoadGrampanchayatByBlock(this.value)">
                        <option value="" >- Select -</option>
                        <c:forEach var="block" items="${blockList}">
                            <option value="${block.blockId}" ${block.blockId eq selectedBlockId ? 'selected' : ''}>
                                ${block.blockName}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== Gram Panchayat ======== -->
            <div class="col-md-3">
                <div class="form-group">
                    <label class="required" for="gpId">Gram Panchayat :</label>
                    <select class="form-control form-control-sm form-select" id="gpId" name="gpId"
                            onchange="LoadVillageByGrampanchayat(this.value)">
                        <option value="" >- Select -</option>
                        <c:forEach var="gp" items="${gpList}">
                            <option value="${gp.gpId}" ${gp.gpId eq selectedGpId ? 'selected' : ''}>
                                ${gp.gpName}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== Village ======== -->
            <div class="col-md-3">
                <div class="form-group">
                    <label class="required" for="villageId">Village Name :</label>
                    <select class="form-control form-control-sm form-select" id="villageId" name="villageId">
                        <option value="" >- Select -</option>
                        <c:forEach var="village" items="${villageList}">
                            <option value="${village.villageId}" ${village.villageId eq selectedVillageId ? 'selected' : ''}>
                                ${village.villageName}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>
			<div class="col-md-3">
                <div class="form-group">
                    <label class="required" for="villageId">Building Name :</label>
                    <select class="form-control form-control-sm form-select select2" id="buildingName" name="buildingName">
                        <option value="">- Select -</option>
                        <c:forEach var="buildingName" items="${buildingFilterData.buildingNameList}">
                            <option value="${buildingName}" ${buildingName eq buildingFilterData.selectedBuildingName ? 'selected' : ''}>
                                ${buildingName}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>
            <!-- ======== Building Type ======== -->
            <div class="col-md-3">
                <div class="form-group">
                    <label class="required" for="buildingType">Building Type :</label>
                    <select class="form-control form-control-sm form-select" id="buildingType" name="buildingType"
                            onchange="handleBuildingTypeChange(this.value)">
                        <option value="" >- Select -</option>
                        <c:forEach var="type" items="${buildingTypeList}">
                            <option value="${type.valueEn}" ${type.valueEn eq selectedBuildingType ? 'selected' : ''}>
                                ${type.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== Sub Category ======== -->
            <div class="col-md-3 sub-category-section" style="display: none;">
                <div class="form-group">
                    <label class="required">Sub Category :</label>
                    <select class="form-control form-control-sm form-select" id="subCategory" name="subCategory"
                            onchange="handlesSubCategoryChange(this.value)">
                        <option value="" >- Select -</option>
                        <c:forEach var="subCat" items="${residentialSubCategoryList}">
                            <option value="${subCat.valueEn}" ${subCat.valueEn eq selectedSubCategory ? 'selected' : ''}>
                                ${subCat.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== School Category ======== -->
            <div class="col-md-3 school-category-section" style="display: none;">
                <div class="form-group">
                    <label class="required">School Category :</label>
                    <select class="form-control form-control-sm form-select" id="schoolCategory" name="schoolCategory">
                        <option value="" >- Select -</option>
                        <c:forEach var="schoolCat" items="${schoolCategoryList}">
                            <option value="${schoolCat.valueEn}" ${schoolCat.valueEn eq selectedSchoolCategory ? 'selected' : ''}>
                                ${schoolCat.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== Staff Type ======== -->
            <div class="col-md-3 staff-type-section" style="display: none;">
                <div class="form-group">
                    <label class="required">Staff Type :</label>
                    <select class="form-control form-control-sm form-select" id="staffType" name="staffType">
                        <option value="" >- Select -</option>
                        <c:forEach var="staff" items="${staffTypeList}">
                            <option value="${staff.valueEn}" ${staff.valueEn eq selectedStaffType ? 'selected' : ''}>
                                ${staff.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <!-- ======== Hostel Fields ======== -->
            <div class="col-md-3 hostel-section" style="display: none;">
                <div class="form-group">
                    <label class="required">Hostel Type :</label>
                    <select class="form-control form-control-sm form-select" id="hostelType" name="hostelType">
                        <option value="" >- Select -</option>
                        <c:forEach var="hostelType" items="${hostelTypeList}">
                            <option value="${hostelType.valueEn}" ${hostelType.valueEn eq selectedHostelType ? 'selected' : ''}>
                                ${hostelType.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <div class="col-md-3 hostel-section" style="display: none;">
                <div class="form-group">
                    <label class="required">Hostel Capacity :</label>
                    <select class="form-control form-control-sm form-select" id="hostelCapacity" name="hostelCapacity">
                        <option value="" >- Select -</option>
                        <c:forEach var="hostelCapacity" items="${hostelCapacityList}">
                            <option value="${hostelCapacity.valueEn}" ${hostelCapacity.valueEn eq selectedHostelCapacity ? 'selected' : ''}>
                                ${hostelCapacity.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

            <div class="col-md-3 hostel-section" style="display: none;">
                <div class="form-group">
                    <label class="required">Hostel Category :</label>
                    <select class="form-control form-control-sm form-select" id="hostelCategory" name="hostelCategory">
                        <option value="" >- Select -</option>
                        <c:forEach var="hostelCategory" items="${hostelCategoryList}">
                            <option value="${hostelCategory.valueEn}" ${hostelCategory.valueEn eq selectedHostelCategory ? 'selected' : ''}>
                                ${hostelCategory.valueEn}
                            </option>
                        </c:forEach>
                    </select>
                </div>
            </div>

        </div>
        
        <!-- ======== Filter Button ======== -->
		<div class="text-end mt-3">
		  <button type="button" class="btn btn-primary btn-sm" onclick="applyFilter()">
		    <i class="fa fa-filter"></i> Apply Filter
		  </button>
		</div>
        

    </div>
</div>


<!-- ===================== REPORT TABLE ===================== -->
<div class="card mt-4">
  <div class="card-header">
    <h5 class="card-title">Building Report Details</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-striped exportbtn" id="reportTable">
        <thead class="table-light">
          <tr>
            <th class="text-center">Sl.No.</th>
            <th>Financial Year</th>
            <th>District</th>
            <th>Block</th>
            <th>Building Name</th>
            <th>Building Type</th>
            <th>Agency</th>
          </tr>
        </thead>
        <tbody>
          <c:choose>
            <c:when test="${not empty reportDataList}">
              <c:forEach items="${reportDataList}" var="item" varStatus="loop">
                <tr>
                  <td class="text-center">${loop.index + 1}</td>
                  <td>${item.planningDTO.financialYearName}</td>
                  <td>${item.planningDTO.districtName}</td>
                  <td>${item.planningDTO.blockName}</td>
                  <td>${item.planningDTO.buildingName}</td>
                  <td>${item.planningDTO.buildingType}</td>
                  <td>${item.agencyDTO.agencyName}</td>
                </tr>
              </c:forEach>
            </c:when>
            <c:otherwise>
              <tr><td colspan="8" class="text-center text-muted">No records found for the selected criteria.</td></tr>
            </c:otherwise>
          </c:choose>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===================== HIDDEN ENCRYPTED FORM ===================== -->
<form id="filterForm" action="${contextPath}/building/get-building-filter" method="GET">
  <!-- CSRF + Encryption -->
  <input type="hidden" name="cipherText" id="hiddenCipherText" />
  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />

  <!-- Core Filters -->
  <input type="hidden" id="hiddenFinyearId" name="finyearId" />
  <input type="hidden" id="hiddenDistrictId" name="districtId" />
  <input type="hidden" id="hiddenBlockId" name="blockId" />
  <input type="hidden" id="hiddenGpId" name="gpId" />
  <input type="hidden" id="hiddenVillageId" name="villageId" />
  <input type="hidden" id="hiddenAgencyId" name="agencyId" />
  <input type="hidden" id="hiddenBuildingType" name="buildingType" />

  <!-- Extended Filters -->
  <input type="hidden" id="hiddenBuildingName" name="buildingName" />
  <input type="hidden" id="hiddenSubCategory" name="subCategory" />
  <input type="hidden" id="hiddenSchoolCategory" name="schoolCategory" />
  <input type="hidden" id="hiddenHostelType" name="hostelType" />
  <input type="hidden" id="hiddenHostelCategory" name="hostelCategory" />
  <input type="hidden" id="hiddenHostelCapacity" name="hostelCapacity" />
  <input type="hidden" id="hiddenStaffType" name="staffType" />
</form>


<!-- ===================== JS SECTION ===================== -->
<script>

//for building type select
function handleBuildingTypeChange(selectedType, shouldReset = true) {
	
    if (shouldReset) {
        // Hide and reset all dependent form sections
        $(".sub-category-section, .school-category-section, .hostel-section, .staff-type-section")
            .hide() // Hide all dependent sections
            .find("input, select, textarea") // Find all form elements inside
            .each(function() {
                var field = $(this);

                if (field.is(":checkbox") || field.is(":radio")) {
                    field.prop("checked", false); // Uncheck all checkboxes and radios
                } else if (field.is("select")) {
                    field.prop("selectedIndex", 0); // Reset dropdown to default option
                } else {
                    field.val(""); // Clear text, number, file, and textarea fields
                }
            });
    }

	if (selectedType === "RESIDENTIAL COMPLEX") {
		$(".sub-category-section").slideDown();
	} else if (selectedType === "STANDALONE SCHOOL") {
		$(".school-category-section").slideDown();
	} else if (selectedType === "STANDALONE HOSTEL") {
		$(".hostel-section").slideDown();
	}
}

// for sub category select
function handlesSubCategoryChange(selectedType) {
	// Hide all conditional fields first
	$(".school-category-section, .hostel-section, .staff-type-section").hide();
	
	if (selectedType === "SCHOOL") {
		$(".school-category-section").slideDown();
	} else if (selectedType === "HOSTEL") {
		$(".hostel-section").slideDown();
	} else if (selectedType === "STAFF QUARTER") {
		$(".staff-type-section").slideDown();
	}
}

function applyFilter() {
	  // Collect all visible filter values
	  const finyearId = $("#finyearId").val();
	  const districtId = $("#districtId").val();
	  const blockId = $("#blockId").val();
	  const gpId = $("#gpId").val();
	  const villageId = $("#villageId").val();
	  const agencyId = $("#agencyId").val();
	  const buildingType = $("#buildingType").val();

	  const buildingName = $("#buildingName").val();
	  const subCategory = $("#subCategory").val();
	  const schoolCategory = $("#schoolCategory").val();
	  const hostelType = $("#hostelType").val();
	  const hostelCategory = $("#hostelCategory").val();
	  const hostelCapacity = $("#hostelCapacity").val();
	  const staffType = $("#staffType").val();

	  // Assign to hidden form fields
	  $("#hiddenFinyearId").val(finyearId);
	  $("#hiddenDistrictId").val(districtId);
	  $("#hiddenBlockId").val(blockId);
	  $("#hiddenGpId").val(gpId);
	  $("#hiddenVillageId").val(villageId);
	  $("#hiddenAgencyId").val(agencyId);
	  $("#hiddenBuildingType").val(buildingType);

	  $("#hiddenBuildingName").val(buildingName);
	  $("#hiddenSubCategory").val(subCategory);
	  $("#hiddenSchoolCategory").val(schoolCategory);
	  $("#hiddenHostelType").val(hostelType);
	  $("#hiddenHostelCategory").val(hostelCategory);
	  $("#hiddenHostelCapacity").val(hostelCapacity);
	  $("#hiddenStaffType").val(staffType);

	  // Show loader before encrypting & submitting
	  showLoader();

	  // Collect + encrypt all form data
	  const bizContent = $("#filterForm").serializeArray();
	  const jsonData = JSON.stringify(convertFormToJSONArray(bizContent));
	  const encrypted = enc_password(jsonData);

	  // Inject cipher text into hidden field
	  $("#hiddenCipherText").val(encrypted);

	  // Submit the secure encrypted form
	  $("#filterForm").submit();
	}

	$(document).ready(function() {
	
		const selectedBuildingType = $("#buildingType").val();
		handleBuildingTypeChange(selectedBuildingType, false);
		
		const selectedSubCategoryType = $("#subCategory").val();
		handlesSubCategoryChange(selectedSubCategoryType);
		
	});	
			
	$(document).ready(() => {
	  const $table = $("#reportTable");
	  if ($table.find("tbody tr td").hasClass("text-muted")) {
	    $table.removeClass("exportbtn");
	  } else {
	    $table.addClass("exportbtn");
	  }
	});
	
</script>
