<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<link href="${contextPath}/assets/css/login.css" rel="stylesheet" type="text/css">

<div class="container-fluid">

 <section class="build_const">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-12">
        <div class="logo-boxs d-flex align-items-center">
          <div class="logo-image me-3">
            <img src="${contextPath}/assets/images/loginPage/fab.png" class="img-fluid" style="max-height:60px;">
          </div>
          <div class="build_con">
            <h4 style="margin-bottom:5px;">Building & Asset Management System</h4>
            <p class="title-subheading mb-0">ST &amp; SC Development, Minorities and Backward Classes Welfare Department</p>
          </div>
        </div>
      </div>
     
    </div>
  </div>
</section>

        <section class="login_form">
         <div class="container">
               <div class="row">
                <div class="col-md-12">
                   <div class="form_box ">
                            <h4 class="">Login</h4>
                            <form class="form-horizontal loginbox" id="login-window" method="POST" action="${contextPath}/overwrite/umt/login" autocomplete="off">
                                 <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                                <div class="login-fild fild_set form-group mb-4">
                                    
                                     <input type="text" placeholder="Enter Username"  id="userName" name="userName" maxlength="35"  class="user">
                                      <i class='fa fa-user icon_cl'></i>
                                  
                                </div>
                                <div class="login-fild fild_set form-group mb-4">
                                   
                                      <input type="password" placeholder="Enter Password" id="password" name="password" maxlength="30" class="password">
                                    <i class='fa fa-lock icon_cl'></i>
                                   
                                    <i class="bx bx-lock icon_cl"></i>
                                    <i class="bx bx-show viewpassword icon_cl"></i>
                                </div>

                                <div class="login-fild fild_set form-group mb-4">
                                  <input type="text" placeholder="Enter Captcha" id="captcha" class="cap" maxlength="10">
                                    <i class='fa fa-refresh iconrefresh icon_cl'></i>
                                    <img src="${contextPath}/captcha/5" alt="" style="width: 90px;" class="captchaimg">

                                </div>
                                <div class="login-fild fild_set submit-btn">
                                <button type="button" id="btn_submit" class="button-style-custom" onclick="userLogin()">Login</button>
                                
                                </div>
                                <div class="login-fild mt-2">
                                    <div class="row">
                                        <div class="col-md-6" style=" margin-left: -16px;">
                                       
                      <div class="form-check" >
                            <a href="#" class="fp" data-bs-toggle="modal" data-bs-target="#proposalModal">Building Proposal</a>
                      </div>
                
                                        </div>
                                        <div class="col-md-6">
                                            <a href="#" class="fp" data-bs-toggle="modal" data-bs-target="#forgotPassModal">Forgot Password?</a>
                                             <a href="#" class="fp" data-bs-toggle="modal" data-bs-target="#faqModal">FAQ</a>
                                        </div>
                                    </div>
                                </div>
                            </form>


                        </div> 
                </div>
            </div>
         </div>
        </section>
</div>


<!-- forgot password module --> 

<div id="forgotPassModal" class="modal fade" role="dialog" tabindex="-1" aria-labelledby="forgotPassModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog" style="max-width: 380px; margin: auto;">
    <div class="modal-content" style="padding: 0px !important;border-radius: 5px !important;">
      <div class="modal-header border-0">
        <h6 class="modal-title fw-bold text-light" id="forgotPassModalLabel">Forgot Password ?</h6>
        <button type="button" class="btn-close text-danger" aria-label="Close" onclick="window.location.href='${contextPath}/login'"></button>
        <span id="SecondsUntilExpire" style="display: none"></span>
      </div>
      <div class="modal-body col-md-12">
        <div id="contents">
          <form  class="form-horizontal" id="resetform" action="${contextPath}/public/forgotPassword/user/forgot/password" onsubmit="disableButton()" method="post">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            
            <div class="col-md-12">
				<label for="username">User Name<span style="color: #ff0808;">*</span> :</label>
			</div>
			<div class="col-md-12">
				<input type="text" class="form-control" id="resetUserName" name="resetUserName" required maxlength="35">
			</div>
			
			<div class="col-md-12 mt-2">
				<button type="button" onclick="generateAndSentOTP()" id="passwordResetBtn" class="btn btn-sm btn-primary" style="background-color:#a9230b; border:none; font-size: 12px;">Sent OTP</button>
				<button type="button" class="btn btn-sm btn-danger" style="background-color: #339355; border: none; font-size: 12px;" data-bs-dismiss="modal">Cancel</button>
			</div>
						
            <div class="mb-2 otpbox" style="display:none">
			   <label>OTP</label>
			   <div class="otpholder otp-only">
				      <input type="text" class="form-control NumbersOnlyWithoutDot" maxlength="1" size="1" id="otp1" oninput="checkOtp()"/>
					  <input type="text" class="form-control NumbersOnlyWithoutDot" maxlength="1" size="1" id="otp2" oninput="checkOtp()"/>
					  <input type="text" class="form-control NumbersOnlyWithoutDot" maxlength="1" size="1" id="otp3" oninput="checkOtp()"/>
					  <input type="text" class="form-control NumbersOnlyWithoutDot" maxlength="1" size="1" id="otp4" oninput="checkOtp()"/>
					  <input type="text" class="form-control NumbersOnlyWithoutDot" maxlength="1" size="1" id="otp5" oninput="checkOtp()"/>
					  <input type="text" class="form-control NumbersOnlyWithoutDot" maxlength="1" size="1" id="otp6" oninput="checkOtp()"/>
			   </div>
			   <a href="javascript:void(0)" style="float: right; padding: 10px; text-decoration: none; color: #1f4e8d; font-weight: 500;" onclick="forgotPasswordByOtp();">Resend OTP</a>   
			</div>
			
			<div id="passwordSet" style="display:none">
				<div class="col-md-12 mb-2">
	              <label for="newPassword" class="form-label fw-semibold text-success">New Password <span class="text-danger">*</span></label>
	            </div>
	            <div class="col-md-12 mb-3">
	              <input type="text" class="form-control px-2" id="newPassword" name="txtPass" required maxlength="25" style="border-radius: 5px !important;" oninput="showSubmitBtn()" onchange="ensureStrongPassword(this);"/>
	            </div>
	            <div class="col-md-12 mb-2">
	              <label for="confirmPassword" class="form-label fw-semibold text-success">Confirm Password <span class="text-danger">*</span></label>
	            </div>
	            <div class="col-md-12 mb-3">
	              <input type="text" class="form-control px-2" id="confirmPassword" name="txtRePass" required maxlength="25" style="border-radius: 5px !important;" oninput="showSubmitBtn()"/>
	              <span id="consms" style="font-size: 14px; font-style: italic;"></span>
	            </div>
	            <div class="row">
							<div class="col-md-12 pl-2 mt-3">
								<div class="alert alert-info" id="lblPass"
									style="text-align: left;">
									Password must be between 8 - 15 characters <br /> - Must have
									one lower case alphabet. <br /> - Must have one upper case
									alphabet. <br /> - Must have one number. <br /> - Must have one
									special sign (@/*/#)
								</div>
							</div>
						</div>
            </div>
            
            <div class="col-md-12 text-center mt-3" id="passwordChangeBtns" style="display:none">
              <!-- <button type="button" onclick="passwordReset()" id="passwordResetBtn" class="btn btn-sm btn-primary" style="background-color: #339355; border: none; font-size: 12px; width:80px; height:30px;"> Submit </button> -->
              <button type="button" class="btn btn-sm btn-danger" style="background-color: #b92a2a; border: none; font-size: 12px; width:80px; height:30px;" data-bs-dismiss="modal" onclick="window.location.href='${contextPath}/login'"> Cancel </button>
            </div>
            
          </form>
        </div>
      </div>
      <div class="modal-footer">
          	<label style="font-style: italic; color: #ff0808; font-size: 12px" id="message"> </label>
			<label style="font-style: italic; color: #ff0808; font-size: 12px;">Note: Password will be sent to the registered email id.</label>
      </div>
    </div>
  </div>
</div>

<!-- OTP Verification Modal -->
<div class="modal fade" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="otpModalLabel">Request Building Proposal Verify Yourself</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="otpVerificationForm" method="post">
          <div class="row">
            <!-- Name -->
            <div class="form-group col-md-4">
              <label class="required">Name:</label>
              <input type="text" class="form-control form-control-sm" id="name" name="name" placeholder="Enter Name" required>
            </div>
            <!-- Phone -->
            <div class="form-group col-md-4">
              <label class="required">Phone:</label>
             <input type="tel" 
       class="form-control form-control-sm" 
       id="phone" 
       name="phone" 
       placeholder="Enter Phone Number" 
       pattern="[0-9]{10}" 
       maxlength="10" 
       required
       oninput="this.value = this.value.replace(/[^0-9]/g, '')">

            </div>
            <!-- OTP -->
            <div class="form-group col-md-4">
              <label class="required">OTP:</label>
              <input type="text" class="form-control form-control-sm" id="otp" name="otp" placeholder="Enter 6-digit OTP" disabled maxlength="6" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
              <div class="timer-display" id="timerDisplay"></div>
            </div>
          </div>
          <div class="success-message" id="successMessage" style="display:none;">
            OTP Successfully Verified!
          </div>
          <div class="row mt-4 mb-4">
            <div class="col-md-12 text-center">
              <button type="button" class="btn btn-success btns" id="sendOtpBtn" onclick="sendOtp()">Send OTP</button>
              <button type="submit" class="btn btn-primary btns hidden" id="submitOtpBtn">Submit OTP</button>
              <a href="${contextPath}/home" type="button" class="btn btn-warning btn-sm btns">Back</a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

function disableButton(){
	$("#passwordResetBtn").attr('disabled', true);
}
$(function() {
	$('form').attr("autocomplete", "off");
});

var errorMsg = '${err_msg}';
if(errorMsg !=""){
	setTimeout(function() {
	    $('#errorMsg').fadeOut('slow');
	}, 3000);
}

function userLogin() {
	var username = $("#userName").val().trim();
	var password = $("#password").val().trim();
	var generateCaptcha=$("#captcha").val();
    
	if (username == "") {
		bootbox.alert("Username can not be empty.");
		$("#userName").val("");
		return false;
	}else if (password == "") {
		bootbox.alert("Password can not be empty.");
		$("#password").val("");
		return false;
	}else if (generateCaptcha == "") {
		bootbox.alert("Please enter the CAPTCHA."); 
		$("#captcha").val("");
		return false;
	}else {
		showLoader();
		$('#userName').val(enc_password(username));
		$('#password').val(enc_password(password)); 
		$("#login-window").submit();
		return false;
	}
}

document.onkeydown = function(e) {
	/* Block F12 */
	if(event.keyCode == 123) {
		return false;
	}
	/* CTRL + SHIFT + I */
	if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)){
		return false;
	}
	/* CTRL + SHIFT + J */
	if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)){
		return false;
	}
	/* CTRL + SHIFT + C 
	if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)){
		return false;
	}*/
	/* CTRL + U */
	if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)){
		return false;
	}
}

$(document).on('click', '.toggle-password', function() {
    $(this).toggleClass("fa-eye");
	$(this).toggleClass("fa-eye-slash");

	var input = $("#password");
	input.attr('type') === 'password' ? input.attr('type','text') : input.attr('type','password')
});

function refreshCaptcha() {
	var image = document.getElementById("captchaImage");
	image.src = '${contextPath}/captcha/5';
}

function passwordReset(){
	showLoader();
	$("#resetform").submit();
}
</script>


<script>

function generateAndSentOTP() {
	
    var username = $("#resetUserName").val().trim();
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
    $.ajax({
        url: "${contextPath}/public/generate/otp",
        type: "POST",
        data: {
            userName: enc_password(username)
        },
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        },
        success: function (data) {
            if (data.flag) {
                //Show modal
                var myModal = new bootstrap.Modal(document.getElementById('forgotPassModal'));
                myModal.show();

                //Show OTP box
                $(".otpbox").show();
                $(".otpbox input:first").focus();

                //Display success message
                $("#message").css("color", "green").text(data.message);

                //Hide password reset box until OTP is validated
                $("#passwordSet").hide();
                $("#passwordChangeBtns").hide();
            } else {
                bootbox.alert(data.message || "Failed to send OTP. Try again.");
            }
        },
        error: function (error) {
            bootbox.alert("Error: " + error.responseText);
        }
    });
}


</script>

<script>
function sendOtp() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const otpInput = document.getElementById('otp');
    const submitOtpBtn = document.getElementById('submitOtpBtn');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const timerDisplay = document.getElementById('timerDisplay');

    // Validate name and phone
    if (!name) {
        bootbox.alert('Please enter a name.');
        console.log('Validation failed: Name is empty');
        return;
    }
    if (!phone) {
        bootbox.alert('Please enter a phone number.');
        console.log('Validation failed: Phone is empty');
        return;
    }
    if (!/^[0-9]{10}$/.test(phone)) {
        bootbox.alert('Please enter a valid 10-digit phone number.');
        console.log('Validation failed: Invalid phone number');
        return;
    }

    // Enable OTP field and show Submit button
    otpInput.disabled = false;
    submitOtpBtn.classList.remove('hidden');
    sendOtpBtn.disabled = true;
    sendOtpBtn.classList.add('frezz');
    console.log('OTP input enabled, Submit button shown, Send OTP disabled.');

    // Start timer
    let timeLeft = 30;
    timerDisplay.textContent = `Submit OTP within ${timeLeft} seconds...`;
    console.log('Timer started:', timeLeft);

    const countdown = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `Submit OTP within ${timeLeft} seconds...`;
        console.log('Timer tick:', timeLeft);

        if (timeLeft <= 0) {
            clearInterval(countdown);
            timerDisplay.textContent = 'OTP expired. Please request a new OTP.';
            otpInput.disabled = true;
            submitOtpBtn.classList.add('hidden');
            sendOtpBtn.disabled = false;
            sendOtpBtn.classList.remove('frezz');
            console.log('Timer expired.');
        }
    }, 1000);

    // Store countdown for clearing
    window.currentCountdown = countdown;
}

document.getElementById('otpVerificationForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const otp = document.getElementById('otp').value.trim();
    const successMessage = document.getElementById('successMessage');
    const otpInput = document.getElementById('otp');
    const submitOtpBtn = document.getElementById('submitOtpBtn');
    const timerDisplay = document.getElementById('timerDisplay');

    // Validate OTP
    if (!otp) {
        bootbox.alert('Please enter the OTP.');
        console.log('Validation failed: OTP is empty');
        return;
    }
    if (!/^[0-9]{6}$/.test(otp)) {
        bootbox.alert('Please enter a valid 6-digit OTP.');
        console.log('Validation failed: Invalid OTP format');
        return;
    }
    if (otp !== '123456') {
        bootbox.alert('Invalid OTP. Please enter 123456.');
        console.log('Validation failed: OTP does not match 123456');
        return;
    }
    if (timerDisplay.textContent.includes('expired')) {
        bootbox.alert('OTP has expired. Please request a new OTP.');
        console.log('Validation failed: OTP has expired');
        return;
    }

    // Clear timer and show success
    clearInterval(window.currentCountdown);
    timerDisplay.textContent = '';
    successMessage.style.display = 'block';
    otpInput.disabled = true;
    submitOtpBtn.classList.add('hidden');
    console.log('OTP verified successfully.');
  
});
</script>

