<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />


<div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">RFQ QUOTE</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="#">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                      <a href="#">Procurement</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">RFQ QUOTE</li>
                  </ol>
                </nav>
              </div>
            </div>

              <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">RFQ QUOTE</h5>
                    </div>
                    <div class="card-body">
        <form action="${contextPath}/procurement/quotation/reviseRfqQuote" method="post" id="form" modelAttribute="rfqQuote">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <input type="hidden" id="quoteIdd" name="rfqQuoteId" value="${rfq.rfqQuoteId}" />
            <input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
				<div class="row">
					<div class="col-md-12">
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="PROC.REQ.REQNO" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.requisition.requisitionNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="PROC.QNNO" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.quoteNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.NAME" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requirdField" id="reqNo" name="" value="${rfq.assetVendor.vendorName}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.CODE" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control requiredField" id="reqNo" name="" value="${rfq.assetVendor.vendorCode}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.MOB" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control " id="reqNo" name="" value="${rfq.assetVendor.mobileNo}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.EMAIL" /></label>
									<div class="col-md-12">
										<input type="text" class="form-control " id="reqNo" name="" value="${rfq.assetVendor.email}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="VENDOR.ADDRS" /></label>
									<div class="col-md-12">
										<textarea type="text" class="form-control unfreezeField" id="reqNo" name="" value="" readonly="readonly">${rfq.assetVendor.vendorAddress}</textarea>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="COMMON.CURRENCY" /></label>
									<div class="col-md-12">
										<input type="hidden" class="form-control requiredField" id="currency" name="currency.currencyId" value="${rfq.currency.currencyId}" readonly="readonly">
										<input type="text" class="form-control requiredField" value="${rfq.currency.currencyShortName}" readonly="readonly">
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 " for="text"><spring:message code="COMMON.REMARKS" /></label>
									<div class="col-md-12">
										<textarea  class="form-control unfreezeField" readonly="readonly">${rfq.vendorRemarks}</textarea>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
							<div class="table-responsive">
								<table class="table table-striped table-bordered  mt-3">
									<thead class="bagGroundColor">
										<tr>
											<th style="width:8%" ><spring:message code="COMMON.SLNO" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.SUB.CAT" /></th>
											<th  ><spring:message code="PROC.REQ.ITEM.DESC" /></th>
											<th ><spring:message code="PROC.REQ.ITEM.CODE" /></th>
											<th style="text-align: right;"><spring:message code="PROC.REQ.ITEM.QTY" /></th>
											<th style="text-align: right;"><spring:message code="PROC.REQ.ITEM.UNIT" /></th>
											<th style="text-align: right;"><spring:message code="PROC.REQ.ITEM.DISCOUNT" /></th>
											<th style="text-align: right;"><spring:message code="PROC.REQ.ITEM.TAX" />(%)</th>
											<th style="text-align:right;min-width:150px;"><spring:message code="PROC.REQ.ITEM.TOTAL" /></th>
										</tr>
									</thead>
									<tbody id="itemBody">
										<c:forEach items="${rfq.rfqQuoteLines}" var="line" varStatus="count">
											<tr ${line.unitPrice eq 0 ? 'class="disable-row"' : '' } style="vertical-align:middle;">
												<td>${count.count} <input type="hidden" class="NumbersOnlyWithoutDot" id="quoteLineId${count.index}" name="rfqQuoteLines[${count.index}].quoteLineId" value="${line.quoteLineId}"></td>
												<td style="width:20%">${line.item.subCategoryName}</td>
												<td style="width:60%">${line.item.itemName} 
													<c:if test="${line.item.isTemp eq true }">
														<ul class="altBtnapp" id="altBtn${count.index}">
															<li data-bs-toggle="modal" data-bs-target="#myModal" onclick="getItemDetails(${line.quoteLineId},'${line.item.itemName}','${line.item.itemCode}','${line.item.categoryName}','${line.item.subCategoryName}')"><i class='fa-solid fa-check' style="color: #198754"></i></li>
															<li onclick="submitForm(${line.quoteLineId},'REJ')"><i class='fa-solid fa-x' style="color: #c00"></i></li>
														</ul>
													</c:if>	
												</td>
												<td style="width:20%">${line.item.itemCode}</td>
												<td><input type="text" class="NumbersOnlyWithoutDot supplierQuantity form-control text-end" id="supplierQuantity${count.index}" name="rfqQuoteLines[${count.index}].supplierQuantity" value="${line.supplierQuantity}" readonly="readonly" style="width:80px">  </td>
												<td><input type="number" class="unitPrice form-control text-end" id="unitPrice${count.index}" name="rfqQuoteLines[${count.index}].unitPrice" value="${line.unitPrice}" readonly="readonly"   style="width:80px">
												<input type="hidden" class="subtotal form-control text-end" name="rfqQuoteLines[${count.index}].subTotal" id="subtotal${count.index}" value="${line.subTotal}"></td>
												
												<td><input type="number" class="discount form-control text-end" id="discountRate${count.index}" name="rfqQuoteLines[${count.index}].discountRate" value="${line.discountRate}" readonly="readonly"  style="width:80px"><input type="hidden" class="discAmt" name="rfqQuoteLines[${count.index}].discountAmount" id="discAmt${count.index}" value="${line.discountAmount}" ></td>
												
												<td><input type="number" class="tax form-control text-end" id="taxRate${count.index}" name="rfqQuoteLines[${count.index}].taxRate" value="${line.taxRate}" readonly="readonly"  style="width:100%">
												<input type="hidden" class="taxAmt form-control text-end" name="rfqQuoteLines[${count.index}].taxAmount" id="taxAmt${count.index}" value="${line.taxAmount}"></td>
												
												<td>
												    <input type="text" class="total form-control text-end" id="totalAmount${count.index}"  value="<fmt:formatNumber value='${line.totalAmount}' type='number' minFractionDigits='2' maxFractionDigits='2'/>" readonly="readonly"  style="text-align: right; padding-right: 8px; width:100%; text-align:right">
												    <input type="hidden" class="total" id="totalAmountP${count.index}" name="rfqQuoteLines[${count.index}].totalAmount" value="${line.totalAmount}" />
												</td>
											</tr>
										</c:forEach>
										<c:if test="${not empty rfq.rfqQuoteLines}">
											<tr class="trowbrdr">
												<td colspan="7" ></td>
												<td><label>Sub Total :</label> </td>
												<td><input type="text" id="subTotal" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px; width:100%;"> </td>
											</tr>
											<tr class="trowbrdr ">
												<td colspan="7" class="tdatabg"></td>
												<td class="tdatabg"><label>Discount :</label></td>
												<td class="tdatabg"><input type="text" id="totalDiscount" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px; width:100%;"> </td>
											</tr>
											<tr  class="trowbrdr">
												<td colspan="7"></td>
												<td><label>Tax :</label> </td>
												<td><input type="text" id="totalTax" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px; width:100%;"> </td>
											</tr>
											<c:if test="${not empty rfq.lstAddCost}">
												<c:forEach items="${rfq.lstAddCost}" var="addCst" varStatus="count">
													<tr id="chargeRow${count.index}"  class="trowbrdr">
														<td  class="tdatabg" colspan="7" style="text-align:right"></td>
														<td  class="tdatabg"><label>${addCst.addCostName} :</label></td>
														<td  class="tdatabg"><input type="number" class="addCost trowbrdr boldfnt" id="charge${count.index}" value="${addCst.addCost}" name="lstAddCost[${count.index}].addCost"  readonly="readonly"  style="text-align: right; padding-right: 8px;width:100%;"></td>
													</tr>
												</c:forEach>
												<tr id="totalAddCostRow"  class="trowbrdr">
													<td colspan="7"></td>
													<td style="min-width: 140px;"><label>Total Additional Cost :</label></td>
													<td><input type="text" id="totalAddCost" value="0.00" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px;width:100%;"> </td>
												</tr>
											</c:if>
											<tr  class="trowbrdr">
											
												<td  class="tdatabg" colspan="7" style="font-weight: 600; font-size: 16px; font-style: italic; text-align: left;">In words: <span id="totalInWords"></span></td>
												<td class="tdatabg"><label>Grand Total :</label></td>
												<td class="tdatabg"><input type="text" id="grandTotal" readonly="readonly"  class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px;width:100%;"> </td>
											</tr>
										</c:if>
									</tbody>
								</table>
								</div>
							</div>							
						</div>
					</div>
				</div>
			<c:set var="dynamicFromId" value="form" scope="request" />
			<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
        </form>
	</div>
	</div>
	</div>
	</div>



<!-- The Modal -->
<div class="modal" id="myModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Alternative Item Map</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
	<form action="${contextPath}/procurement/quotation/altItemAddOrRemove" method="post" id="altItemform" >
		<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
		<input type="hidden" id="quoteLineId" name="quoteLineId" value="${rfq.requisition.store.storeId}">
		<input type="hidden" name="quoteId" value="${rfq.rfqQuoteId}">
		<input type="hidden" id="status" name="status" value="">
		<input type="hidden" class="" id="encodedDataaltItemform" name="encodedDataaltItemform" value="" />
      <!-- Modal body -->
      <div class="modal-body">
		<div class="row">
			<div class="col-md-12">
				<div class="row">
					<div class="col-md-6">
						<label>Category Name :<span id="categoryName"></span></label>
					</div>
					<div class="col-md-6">
						<label>Sub Category Name :<span id="subcategoryName"></span></label>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div class="row">
					<div class="col-md-6">
						<label>Item Name :<span id="itemName"></span></label>
					</div>
					<div class="col-md-6">
						<label>Item Code :<span id="itemCode"></span></label>
					</div>
				</div>
			</div>
		</div>
		<hr>
		<div class="col-md-12">
        	<div class="row">
	        	<div class="col-md-3">
	        		<input type="hidden" id="storeId" value="${rfq.requisition.store.storeId}">
	        		<input type="hidden" id="stockTypeId" value="${rfq.requisition.stockType.stockTypeId}">
	        		<label>Store :</label>
	        		<input type="text" class="form-control" readonly="readonly" value="${rfq.requisition.store.storeName}">
	        	</div>
	        	 	
	        	<div class="col-md-3">
	        		<label>Category :</label>
	        		<select class="form-control" id="category" onchange="getSubCatNItem(this.value)">
	        			<option value="0">--select--</option>
	        			<c:forEach items="${lstCat}" var="cat" >
	        				<option value="${cat.categoryId}">${cat.categoryName}</option>
	        			</c:forEach>
	        		</select>
	        	</div>
	    
	        	<div class="col-md-3">
	        		<label>Sub Category :</label>
	        		<select class="form-control" id="subcategory" >
	        			<option value="0">--select--</option>
	        		</select>
	        	</div>
	        	<div class="col-md-3">
	        		<label>${rfq.requisition.stockType.stockTypeCode eq 'ITEM' ? 'Item' :'Asset' } :</label>
	        		<select class="form-control" id="item" name="itemId">
	        			<option value="0">--select--</option>
	        		</select>
	        	</div>
	        </div>
        </div>
      </div>

      <!-- Modal footer -->
      <div class="modal-footer">
      	<button type="button" class="btn btn-submit"  onclick="submitForm('','MAP')" style="width: auto;">Map With ${rfq.requisition.stockType.stockTypeCode eq 'ITEM' ? 'Item' :'Asset' }</button>
      	<button type="button" class="btn btn-success"  onclick="submitForm('','NEW')" style="width: auto;">Map As New ${rfq.requisition.stockType.stockTypeCode eq 'ITEM' ? 'Item' :'Asset' }</button>
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
      </div>
	</form>
    </div>
  </div>
</div>

<script>
	$(document).ready(function(){
		totalCalculation();
		calculateTotalAddCost();
	});

	chargeCount=0;

	function calculateTotalAddCost() {
		var addCost=0;
		$('.addCost').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			addCost += parseFloat(val);
		});
		addCost=addCost.toFixed(2);
		$("#totalAddCost").val(addCost);
		totalCalculation();
	}
	function eachRowCalculation(rowNo) {
		var qty = $('#supplierQuantity'+rowNo).val() == '' || $('#supplierQuantity'+rowNo).val() == undefined ? 0 : $('#supplierQuantity'+rowNo).val();
		var price = $('#unitPrice'+rowNo).val() == '' || $('#unitPrice'+rowNo).val() == undefined ? 0 : $('#unitPrice'+rowNo).val();
		var discount = $('#discountRate'+rowNo).val() == '' || $('#discountRate'+rowNo).val() == undefined ? 0 : $('#discountRate'+rowNo).val();
		var tax = $('#taxRate'+rowNo).val() == '' || $('#taxRate'+rowNo).val() == undefined ? 0 : $('#taxRate'+rowNo).val();
		
		qty = convertToFloat(qty);
		price = convertToFloat(price);
		discount = convertToFloat(discount);
		tax = convertToFloat(tax);
		
		var subTotal=qty * price;
		var discountAmount = subTotal * (discount / 100);
		var taxAmount = (subTotal - discountAmount) * (tax / 100);
		var totalAmount=subTotal-discountAmount+taxAmount;
		totalAmount=totalAmount.toFixed(2);
		
		$("#subtotal"+rowNo).val(subTotal);
		$("#discAmt"+rowNo).val(discountAmount);
		$("#taxAmt"+rowNo).val(taxAmount);
		$("#totalAmount"+rowNo).val(totalAmount);
		$("#totalAmountP"+rowNo).val(totalAmount);
		totalCalculation();
	}
	function totalCalculation() {
		var subTotal = 0;
		var totalDiscount = 0;
		var totalTax = 0;
		var totalAddCost=$("#totalAddCost").val() == '' || $("#totalAddCost").val() == undefined ? 0 : $("#totalAddCost").val();
		var grandTotal = 0+parseFloat(totalAddCost);
		$('.subtotal').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			subTotal += parseFloat(val);
		});

		$('.discAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalDiscount += parseFloat(val);
		});

		$('.taxAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalTax += parseFloat(val);
		});

		$('.total').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			grandTotal += parseFloat(val);
		});
		subTotal =subTotal.toFixed(2);
		totalDiscount = totalDiscount.toFixed(2);
		totalTax = totalTax.toFixed(2);
		grandTotal = grandTotal.toFixed(2);
		
		$("#subTotal").val(subTotal);
		$("#totalDiscount").val(totalDiscount);
		$("#totalTax").val(totalTax);
		$("#grandTotal").val(grandTotal);
	}

	// any change in total amount make number in words
	$(document).on("change", ".total", function(){
		var grandTotal = $("#grandTotal").val();

		let fstVal = grandTotal.split(".")[0];
        let secVal = grandTotal.split(".")[1];
        let finalWord = '';
        if(secVal == undefined || secVal == '' || secVal == '00' || secVal == '0'){
            finalWord = NumInWords(fstVal) + " only";
        }else{
            finalWord = NumInWords(fstVal) + " and " + NumInWords(secVal) + " cents only";
        }

		$("#totalInWords").text(finalWord);
	});

	// alson in page load
	$(document).ready(function(){
		var grandTotal = $("#grandTotal").val();
		let fstVal = grandTotal.split(".")[0];
        let secVal = grandTotal.split(".")[1];
        let finalWord = '';
        if(secVal == undefined || secVal == '' || secVal == '00' || secVal == '0'){
            finalWord = NumInWords(fstVal) + " only";
        }else{
            finalWord = NumInWords(fstVal) + " and " + NumInWords(secVal) + " cents only";
        }
		$("#totalInWords").text(finalWord);
		getItemList();
	});
	function getSubCatNItem(catId) {
		getSubCategoryDetailsByCategoryiD(catId);
		getItemList();
		
	}
	function getItemDetails(quoteLineId,itemName,itemCode,categoryName,subCategoryName) {
		$("#quoteLineId").val(quoteLineId);
		$("#categoryName").text(categoryName);
		$("#subcategoryName").text(subCategoryName);
		$("#itemName").text(itemName);
		$("#itemCode").text(itemCode);
	}
	function submitForm(id,status) {
		if(id!=''){
			$("#quoteLineId").val(id);
		}
		$("#status").val(status);
		
		if(status == 'MAP'){
			var itemId=$("#item").val();
			if(itemId=='' || itemId ==0){
				alert("Please select item for mapping proccess.");
				return false;
			}
		}
		var msg='';
		if(status == 'REJ'){
			msg="This is going to permanently delete. Are you sure to continue?";
		}else{
			msg="Are you sure to continue?";
		}
		bootbox.confirm({
			message:msg,
			buttons: {
				confirm: {
					label: 'Yes',
					className: 'btn-success'
				},
				cancel: {
					label: 'No',
					className: 'btn-danger'
				}
			},
			callback: function (result) {
				if(result){

				    encryptFormData("altItemform", tableIds, jsonKeys);
					$("#altItemform").submit();
				}
			}
		});
	}
	function getItemList(){
		var storeId=$("#storeId").val();
		var quoteId=$("#quoteIdd").val();
		$.ajax({
			url: "${contextPath}/ajax/getitems",
			type: 'GET',
			data: {
				category: $('#category').val() == 0 ? '' : $('#category').val(),
				subCategory: $('#subcategory').val() == 0 ? '' : $('#subcategory').val(),
				stockType:$('#stockTypeId').val() == 0 ? '' : $('#stockTypeId').val(),
				storeId:storeId,
				quoteId:quoteId
			},
			success: function(response){
				data = response;
				var html = '<option value="0">--select--</option>';
				// loop through data
				data.map((item, index) => {
					html+='<option value="'+item.itemId+'">'+item.itemName+'</option>';
				});
				$("#item").empty().append(html);
			},
			error: function(e){		
			}
		});
	}
	
</script>