<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<c:set var="chargeRow" value="0" />
<style>
.error-message {
    color: red;
    font-weight: 400;
    margin-top: 5px;
    position: absolute;
    left: 10px;
    bottom: 0;
}
input.total {
    text-align: end;
}
</style>
 <div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">Direct Purchase Order</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item">
                      <a href="#">Procurement</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Direct Purchase Order</li>
                  </ol>
                </nav>
              </div>
            </div>
            
             <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Direct Purchase Order</h5>
                    </div>
                    <div class="card-body">
        <form action="${contextPath}/procurement/purchaseOrder/saveDirectPo" method="post" id="poform" enctype="multipart/form-data">
            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            <input type="hidden" name="poId" id="poId" value="${po.poId}" />
            <input type="hidden" class="" id="encodedDatapoform" name="encodedDatapoform" value="" />
           
				<div class="row">
					<div class="col-md-12">
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.FINYEAR" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${financialYearList.size() > 1}">
												<select class="form-control form-select requiredField  " id="finYear" name="finYearId">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${financialYearList}" var="financialYear">
														<option value="${financialYear.finyearId}" ${financialYear.finyearId eq po.finYear.finyearId ? 'selected' : ''}>${financialYear.finYear}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="finYearId" value="${financialYearList[0].finyearId}" />
												<input type="text" class="form-control" value="${financialYearList[0].finYear}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.TYPE" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${requisitionTypeList.size() > 1}">
												<select class="form-control form-select requiredField  "  id="requisitionType" name="requisitionTypeId" >
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${requisitionTypeList}" var="reqType">
														<option value="${reqType.requisitionTypeId}" ${ po.requisitionType.requisitionTypeId eq reqType.requisitionTypeId ? 'selected' : ''}>${reqType.requisitionTypeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="requisitionTypeId" value="${requisitionTypeList[0].requisitionTypeId}" />
												<input type="text" class="form-control" value="${requisitionTypeList[0].requisitionTypeName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.FOR" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${stockTypeList.size() > 1}">
												<select class="form-control form-select requiredField ${not empty po ? 'frezz' : ''} " id="stockType" name="stockTypeId"  onchange="emptyTable()">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${stockTypeList}" var="stockType">
														<option value="${stockType.stockTypeId}" ${po.stockType.stockTypeId eq stockType.stockTypeId ? 'selected' : ''}>${stockType.stockTypeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden"  name="stockTypeId" value="${stockTypeList[0].stockTypeId}" />
												<input type="text" class="form-control" value="${stockTypeList[0].stockTypeName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text">Store</label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${stockTypeList.size() > 1}">
												<select class="form-control form-select requiredField  ${not empty po ? 'frezz' : ''}" id="store" name="storeId"  onchange="emptyTable()">
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${lstStore}" var="store">
														<option value="${store.storeId}" ${po.store.storeId eq store.storeId ? 'selected' : ''}>${store.storeName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="storeId" value="${lstStore[0].storeId}" />
												<input type="text" class="form-control" value="${lstStore[0].storeName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.PRIORITY" /></label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${priorityList.size() > 1}">
												<select class="form-control form-select requiredField  " id="priority" name="priorityLevelId" >
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${priorityList}" var="priority">
														<option value="${priority.priorityLevelId}" ${po.priorityLevel.priorityLevelId eq priority.priorityLevelId ? 'selected' : ''}>${priority.priorityLevelName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="priorityLevelId" value="${priorityList[0].priorityLevelId}" />
												<input type="text" class="form-control" value="${priorityList[0].priorityLevelName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"> Cost Center</label>
									<div class="col-md-12">
										<c:choose>
											<c:when test="${costCenterList.size() > 1}">
												<select class="form-control form-select requiredField  " name="costCenterId" id="costCenterId" >
													<option value=""><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${costCenterList}" var="costCenter">
														<option value="${costCenter.costCenterId}" ${po.costCenter.costCenterId eq costCenter.costCenterId ? 'selected' : ''}>${costCenter.costCenterName}</option>
													</c:forEach>
												</select>
											</c:when>
											<c:otherwise>
												<input type="hidden" name="costCenterId" value="${costCenterList[0].costCenterId}" />
												<input type="text" class="form-control" value="${costCenterList[0].costCenterName}" readonly="readonly" />
											</c:otherwise>
										</c:choose>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text">Vendor</label>
									<div class="col-md-12">
										<select class="form-control form-select requiredField  " id="vendorId" name="vendorId" >
											<option value=""><spring:message code="COMMON.SELECT" /></option>
											<c:forEach items="${lstVendor}" var="vendor">
												<option value="${vendor.vendorId}" ${vendor.vendorId eq po.assetVendor.vendorId ? 'selected' : ''} >${vendor.vendorName}</option>
											</c:forEach>
										</select>
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text"><spring:message code="PROC.REQ.CURRENCY" /></label>
									<div class="col-md-12">
										<select class="form-control form-select requiredField  " id="currencyId" name="currencyId">
											<option value=""><spring:message code="COMMON.SELECT" /></option>
											<c:forEach items="${lstCur}" var="cur">
												<option value="${cur.currencyId}" ${cur.currencyId eq po.currency.currencyId ? 'selected' : ''} >${cur.currencyShortName}</option>
											</c:forEach>
										</select>
									</div>
								</div>
							</div>

							<div class="col-md-3">
								<div class="form-group">
									<label class="col-md-12 required" for="text">Purchase Generate Date</label>
									<div class="col-md-12">
										<div class="datepicker-box date-generate">
	                      					<input type="text" class="form-control form-control-sm requiredField "  id="poGenerateDate" value="<fmt:formatDate value='${po.poCreateDate}' pattern='dd/MM/yyyy' />" name="poCreatedDate" readonly /> <i class='fa-solid fa-calendar-week' style=""></i>
	                    				</div>
									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-group">
									<label class="col-md-12" for="text"><spring:message code="COMMON.REMARKS" /></label>
									<div class="col-md-12">
										<textarea class="form-control AlphaNumericForText textArea unfreezeField" id="remarks" name="remarks" maxlength="200" placeholder="Please give remarks" ${canTakeAction eq false ? 'readonly' : ''}>${po.remarks}</textarea>
									</div>
								</div>
							</div>

							<c:if test="${not empty po && not empty po.stageForwardedRule && not empty po.stageForwardedRule.actionType && po.stageForwardedRule.actionType.actionCode eq 'APPROVE' && po.revise eq false && po.poClosed eq false}">
									<div class="col-md-3 align-self-end text-end" style="margin-bottom: 17px;">
										<input type="hidden" value="${po.poId}" id="poIdForAmendMent" />
										<button type="button" class="btn btn-submit unfreezeField" onclick="generateAmentMent()">Po Amendment</button>
									</div>
							</c:if>
							<c:if test="${po.stageForwardedRule.actionType.actionCode eq 'APPROVE'}">
								<!-- <c:if test="${role eq 'ROLE_HOD'}">
									<c:choose>
										<c:when test="${po.poClosed eq false && po.revise eq false}">
											<div class="col-md-3 align-self-end" style="margin-bottom: 17px;">
												<button type="button" class="btn btn-primary unfreezeField" data-bs-toggle="modal" data-bs-target="#myModal" style="margin-top:-10px; width: auto;" onclick="getModal(${po.poId},'${po.poNo}','<fmt:formatDate value='${po.poReceiptGeneratedDate }' pattern='dd/MM/yyyy'/>')">Close The Po </button>
											</div>
										</c:when>
										<c:otherwise> -->
											<c:if test="${po.poClosed && not empty po.closeDoc}">
												<div class="col-md-3 align-self-end" style="margin-bottom: 17px;">
													<i class='fa-regular fa-file-lines' style="font-size: 19px;color: #cc0000;top: -3px;position: relative;" onclick="downloadDoc('${po.closeDoc}')"></i>
												</div>
											</c:if>
										<!-- </c:otherwise>
									</c:choose>
								</c:if>						 -->
							</c:if>

						</div>
						<c:if test="${canTakeAction}">
							<div class="col-md-12 text-end ">
								<div class="form-group">
									<button type="button" class="btn btn-submit" style="width: auto;" onclick="getItemsPaggination()">
									<i class="fa fa-plus"></i> Add Item</button>
									<button type="button" class="btn btn-submit" style="width: auto;" onclick="addAdditionalCost()">
									<i class="fa fa-plus"></i> Additional Cost</button>

								</div>
							</div>
						</c:if>
						<div class="row">
							<div class="col-md-12" >
								<table class="table table-striped table-bordered  mt-2 tableValidation">
									<thead class="bagGroundColor">
										<tr>
											<th style="width: 50px;">Sl No.</th>
											<th style="width: 250px;">Item Name</th>
											<th style="width: 80px;">UOM</th>
											<th style="width: 100px;text-align: right;">Quantity</th>
											<th style="width: 100px;text-align: right;">Unit Price</th>
											<th style="width: 80px;text-align: right;">Discount(%)</th>
											<th style="width: 120px;text-align: right;">Tax(%)</th>
											<th style="min-width: 180px;text-align: right;">Total Price</th>
											<c:if test="${canTakeAction}">
												<th style="width: 50px;">Action</th>
											</c:if>
										</tr>
									</thead>
									<tbody id="itemBody">
										<c:forEach items="${po.poLines}" var="line" varStatus="count">
											<tr id="rowId${count.index}">
												<td ><input type="hidden" id="itemId${count.count}" value="${line.item.itemId}"><input type="hidden" id="reqId${count.count}" value="${line.poLineId }" ></td>
												<td><input type="hidden" id="itemName${count.count}"value="${line.item.itemName }" ><input type="hidden" id="itemCode${count.count}" value="${line.item.itemCode}"></td>
												<td><input type="hidden" id="reqQty${count.count}"value="${line.supplierQuantity }" ><input type="hidden" id="uom${count.count}" value="${line.item.uom }"></td>
												<td><input type="hidden" id="unitPrice${count.count}" value="${line.unitPrice }"><input type="hidden" id="isFractional${count.count}" value="${line.item.isFractional }"></td>
												<td><input type="hidden" id="dis${count.count}" value="${line.discountRate }"></td>
												<td><input type="hidden" id="disAmt${count.count}" value="${line.discountAmount }"></td>
												<td><input type="hidden" id="tax${count.count}" value="${line.taxRate }"></td>
												<td><input type="hidden" id="taxAmt${count.count}" value="${line.taxAmount }"></td>
												<td><input type="hidden" id="subTotal${count.count}" value="${line.subTotal }"></td>
												<td><input type="hidden" id="total${count.count}" value="${line.totalAmount }"></td>
											</tr>
										</c:forEach>
									</tbody>
									<tfoot id="totalBody">
										<tr class="trowbrdr">
											<td colspan="6" ></td>
											<th style="box-shadow:none;text-align: right;">Sub Total :</th>
											<td><input type="text" id="totSubTotal" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px;width:100%;" value="0.00"> </td>
<!-- 											<td></td> -->
										</tr>
										<tr class="trowbrdr ">
											<td colspan="6" class="tdatabg"></td>
											<th class="tdatabg" style="box-shadow:none;text-align: right;">Discount :</th>
											<td class="tdatabg"><input type="text" id="totalDiscount" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px; width:100%;" value="0.00"> </td>
<!-- 											<td></td> -->
										</tr>
										<tr  class="trowbrdr">
											<td colspan="6"></td>
											<th style="box-shadow:none;text-align: right;">Tax :</th>
											<td><input type="text" id="totalTax" readonly="readonly" class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px; width:100%;" value="0.00"> </td>
<!-- 											<td></td> -->
										</tr>
										<c:if test="${not empty po.lstAddCost}">
											<c:forEach items="${po.lstAddCost}" var="addCst" varStatus="count">
												<tr id="chargeRow${count.index}" style="vertical-align: middle;">
													<th colspan="5" style="text-align: right: box-shadow:none;">Enter Additional Cost :
														<input type="hidden" name="lstAddCost[${count.index}].addCostId" value="${addCst.addCostId}">
													</th>
													<td colspan="2" style="text-align: right; padding-right: 12px; padding: 5px;">
														<input type="text" class="requiredField" id="chargeName${count.index}" name="lstAddCost[${count.index}].addCostName" value="${addCst.addCostName}" style="text-align: right;" >
													</td>

													<td>
														<input type="number" class="addCost greaterThanZero nobrdr boldfnt onClickInput"  value="${addCst.addCost}" style=" width:100%;text-align: right;" name="lstAddCost[${count.index}].addCost" id="charge${count.index}" >
													</td>
													<c:if test="${canTakeAction}">
														<td>
															<button class="btn btn-danger" title="Remove"><i class="fa fa-trash no-print" style="" id="rmvBtn${count.index}" onclick="removeDiv(${count.index})"></i></button>
														</td>
													</c:if>
												</tr>
												<c:set var="chargeRow" value="${count.count}" />
											</c:forEach>
											<tr id="totalAddCostRow">
												<th colspan="7" style="text-align: right; padding-right: 12px; padding: 5px; border: none;text-shadow: none;">Total Additional Cost :</th>
												<td>
													<input type="text" id="totalAddCost" value="0.00" readonly="readonly" style=" width:100%; text-align: right;" class="nobrdr boldfnt">
												</td>
											</tr>
										</c:if>
										<tr  class="trowbrdr">
											<td  class="tdatabg" colspan="6" style="font-weight: 600; font-size: 16px; text-align: left;">In words : <span id="totalInWords" style="font-weight: 500;font-style: italic;font-size:14px;"></span></td>
											<th class="tdatabg" style="box-shadow:none;text-align: right;">Grand Total :</th>
											<td class="tdatabg"><input type="text" id="grandTotal" readonly="readonly"  class="trowbrdr boldfnt" style="text-align: right; padding-right: 8px; width:100%;" value="0.00"> </td>
<!-- 											<td></td> -->
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
					</div>
				</div>

			<c:set var="dynamicFromId" value="poform" scope="request" />
			<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
        </form>
	</div>
	</div>
	</div>
	</div>


<%@ include file="/WEB-INF/views/assetInvProc/itemModal/addItemModal.jsp"%>
<div class="modal" id="myModal">
	<div class="modal-dialog modal-lg">
	  <div class="modal-content">

		<!-- Modal Header -->
		<div class="modal-header">
		  <h4 class="modal-title">Purchase Order Close</h4>
		  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		</div>
	  <form action="${contextPath}/procurement/purchaseOrder/closePurchase" method="post" id="closeform" enctype="multipart/form-data">
			  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
			  <input type="hidden" name="poId" id="poIdd" value="" />
			  <input type="hidden" class="" id="encodedDatacloseform" name="encodedDatacloseform" value="" />
		<!-- Modal body -->
		<div class="modal-body">
			<div class="row">
				<div class="col-md-3">
				  <div class="form-group">
					  <label class="col-md-12 required" for="text">PO No.</label>
					  <div class="col-md-12">
						  <input type="text" class="form-control" id="poNo" readonly="readonly">
					  </div>
				  </div>
			  </div>
				<div class="col-md-3">
				  <div class="form-group">
					  <label class="col-md-12 required" for="text">Purchase Closing Date</label>
					  <div class="col-md-12">
						  <div class="datepicker-box ">
							  <input type="text" class="form-control form-control-sm requiredField closeDate"
									id="closeDate" value="" name="closeDate" /> <i class='fa-solid fa-calendar-week'></i>
						  </div>
					  </div>
				  </div>
			  </div>
				<div class="col-md-3">
				  <div class="form-group">
					  <label class="col-md-12 required" for="text">Closing Document</label>
					  <div class="col-md-12">
						  <input type="file" class="form-control" id="closeDoc" placeholder="Enter email" name="closeDoc">
					  </div>
				  </div>
			  </div>
			</div>
		</div>
	  </form>
		<!-- Modal footer -->
		<div class="modal-footer">
		  <button type="button" class="btn btn-danger" onclick="closePurchase()">Submit</button>
		</div>

	  </div>
	</div>
  </div>
  <form method="post" action="${contextPath}/document/download" id="download" target="empty">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" id="docPath" name="docPath" value="">
	<input type="hidden" id="module" name="module" value="Purchase/Close">
</form>

<form action="${contextPath}/procurement/purchaseOrder/revisePo" method="GET" id="poAmentMentForm" >
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
	<input type="hidden" name="poId" id="poIdForAmendMentFl" value="" />
	<input type="hidden" class="" id="encodedDatapoAmentMentForm" name="encodedDatapoAmentMentForm" value="" />

</form>
<script>
tableIds=['itemBody','totalBody'];
jsonKeys=['poLines','lstAddCost'];
$(document).ready(function() {
	var poGenerateDateField = $("#poGenerateDate");
    if ($("#poGenerateDate").val() === '') {
        var today = new Date();
        // Format the date as DD/MM/YYYY
        var formattedDate = ('0' + today.getDate()).slice(-2) + '/' + ('0' + (today.getMonth() + 1)).slice(-2) + '/' + today.getFullYear();
        $("#poGenerateDate").val(formattedDate);
        //$("#poGenerateDate").prop('readonly', true);
        poGenerateDateField.addClass('generateDate');
    }else{
    	poGenerateDateField.addClass('generateDate');
    }
});

var itemLists = [];

var poDate='';
function getModal(id,no,date) {
	$("#poNo").val(no);
	$("#poIdd").val(id);
	poDate=date;
}
$(function() {
	$('.closeDate').datepick({
		dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true,
		 onSelect: function(selected) {
			 var alltDate=poDate.split("/");
			 var modAllotDate=new Date(alltDate[1]+"/"+alltDate[0]+"/"+alltDate[2]);
			 if(modAllotDate > new Date(selected)){
				bootbox.alert('PO Closing date sholud not be less than PO creation date.');
				$('.closeDate').val("");
			 }
		 }
	});
});
function closePurchase() {
	var closeDate=$("#closeDate").val();
	var closeDoc=$("#closeDoc").val();
	if(closeDate==""){
		displayErrorMsg("closeDate","Please select closing date");
		return false;
	}else{
		clearError("closeDate")
	}
	if(closeDoc==""){
		displayErrorMsg("closeDoc","Please upload closing document");
		return false;
	}else{
		clearError("closeDoc")
	}

	bootbox.confirm({
		message: "Are you sure you want to close the PO?",
		buttons: {
			confirm: {
				label: 'Yes',
				className: 'btn-success'
			},
			cancel: {
				label: 'No',
				className: 'btn-danger'
			}
		},
		callback: function (result) {
			if(result){
			    var closeTable = [];
                var closeJson =[];
                encryptFormData("closeform", closeTable, closeJson);
				$('#closeform').submit();
			}
		}
	});

}
function downloadDoc(path,module){
	$("#docPath").val(path);
	$("#download").submit();
}
	$(function() {
		$('.generateDate').datepick({
			dateFormat: 'dd/mm/yyyy',maxDate:0, showOnFocus: true
		});
	});

	function addItemsToRow(){
		$('#itemBody').empty();
		var html='';
		itemLists.map((item, index) => {
			let formatter = new Intl.NumberFormat('en-IN', {
				   minimumFractionDigits: 2,
				   maximumFractionDigits: 2,
			});
			price=formatter.format(item.lastPprice);
			var totalPrice=formatter.format(item.total);
			var slNo=index+1;
			html+='<tr style="vertical-align:middle;" id="row'+index+'">' +
						'<td class="text-center" >'+slNo+'</td>'+
						'<td><span>'+item.itemName+'<br>('+item.itemCode+')</span>'+
							'<input type="hidden" id="itemId'+index+'" name="poLines['+index+'].entityId" value="'+item.itemId+'" readonly="readonly"></td>'+
						'<td><span>'+item.uom+'</span></td>'+
						'<td><input type="number" id="quantity'+index+'"class="quantity form-control onClickInput greaterThanZero maximunLengthIs10WithDot text-end ';
						if(item.isFractional == 'true'){
                            html +='numberWithTwoDesimal ';
                        }else{
                            html +='numberWithTwoDesimalButOnlyAllowZero ';
                        }
						html+='" name="poLines['+index+'].supplierQuantity" value="'+item.reqQty+'" style="width: 100%;" ${canTakeAction ? "" : "readonly"}></td>'+
						'<td><input type="number" id="unitPrice'+index+'"class="unitPrice form-control onClickInput greaterThanZero maximunLengthIs10WithDot numberWithTwoDesimal text-end " name="poLines['+index+'].unitPrice" value="'+item.unitPrice+'" style="width: 100%;" ${canTakeAction ? "" : "readonly"}></td>'+
						'<td><input type="number" id="discount'+index+'"class="discount form-control onClickInput numberWithTwoDesimal percentageOnly text-end " name="poLines['+index+'].discountRate" value="'+item.dis+'" style="width: 100%;" ${canTakeAction ? "" : "readonly"} >'+
						'<input type="hidden" id="disAmt'+index+'" name="poLines['+index+'].discountAmount" class="disAmt  numberWithTwoDesimal percentageOnly text-end " value="'+item.disAmt+'"></td>'+
						'<td><input type="number" id="tax'+index+'"class="tax form-control onClickInput  numberWithTwoDesimal percentageOnly text-end " name="poLines['+index+'].taxRate" value="'+item.tax+'" style="width: 100%;" ${canTakeAction ? "" : "readonly"}>'+
						'<input type="hidden" id="taxAmt'+index+'" name="poLines['+index+'].taxAmount" class="taxAmt text-end " value="'+item.taxAmt+'"></td>'+
						'<td><input type="hidden" id="subTotal'+index+'" name="poLines['+index+'].subTotal" class="subTotal text-end " value="'+item.subTotal+'">'+
						'<input type="hidden" class="total" id="totalP'+index+'" name="poLines['+index+'].totalAmount" value="'+item.total+'">'+
						'<input type="text" class=" form-control text-end " id="total'+index+'"  value="'+totalPrice+'" readonly="readonly"></td>'+
						'<c:if test="${canTakeAction}">'+
						'<td>' +
						'<button type="button" title="Remove" class="btn btn-danger removeBtn no-print" style="" onclick="removeOtherItem('+index+')"><i class="fa fa-trash" aria-hidden="true"></i></button>' +
						'</td>' +
						'</c:if>'+
					'</tr>';
		});
		$('#itemBody').append(html);
		$('#addOtherItemModal').modal('hide');
		totalCalculation();
	}
	function removeOtherItem(rowNo){
		$('#row'+rowNo).remove();
		itemLists.splice(rowNo, 1);
		$('#itemDiv'+rowNo).css('background-color', '#fff');
		addItemsToRow();
	}
	function emptyTable() {
		$('#itemBody').empty();
		itemLists = [];
	}

	var chargeCount=0+${chargeRow};
	function addAdditionalCost() {
		var html='<tr style="vertical-align: baseline;" id="chargeRow'+chargeCount+'"><th colspan="5" style="text-align:right">Enter Additional Cost :</th><td colspan="2" style="position:relative;text-align: right; padding-right: 12px; padding:5px;"><input type="text" class="requiredField form-control" id="chargeName'+chargeCount+'" name="lstAddCost['+chargeCount+'].addCostName" value="" required style="text-align: right;width: 100%;margin-bottom: 15px;"> </td><td style="position: relative;"><input type="number" class="addCost greaterThanZero onClickInput form-control" id="charge'+chargeCount+'" value="0.00" name="lstAddCost['+chargeCount+'].addCost" style="text-align: right; width:100%;"></td><td><button class="btn btn-danger" title="Remove"><i class="fa fa-trash no-print" style="" id="rmvBtn'+chargeCount+'" onclick="removeDiv('+chargeCount+')" ></i></button></td></tr>';
		var tbody = document.getElementById('totalBody');

		var targetIndex =0;
		if(chargeCount==0){
			targetIndex = tbody.rows.length - 1;
			var tothtml='<tr id="totalAddCostRow"><th colspan="7" style=" width:100%;text-align: right; padding-right: 12px; padding:5px;position:relative; border: none;box-shadow: none;">Total Additional Cost :</th><td><input type="text" id="totalAddCost" value="0.00" readonly="readonly" style="text-align: right;" class="form-control"> </td></tr>';
			var tottempDiv = document.createElement('tbody');
			tottempDiv.innerHTML = tothtml;
			var newtotRow = tottempDiv.firstElementChild;
			tbody.insertBefore(newtotRow, tbody.rows[targetIndex]);
		}
		targetIndex = tbody.rows.length - 2;
		var tempDiv = document.createElement('tbody');
		tempDiv.innerHTML = html;
		var newRow = tempDiv.firstElementChild;
		tbody.insertBefore(newRow, tbody.rows[targetIndex]);

		chargeCount++;
	}
	function removeDiv(id) {
		var index=chargeCount-1;
		if(index==id){
			$("#chargeRow"+id).remove();
			chargeCount--;
			if(chargeCount==0){
				$("#totalAddCostRow").remove();
			}
			calculateTotalAddCost();
		}
	}
	function convertToFloat(value){
		if(value === "" || value === undefined){
			value = 0;
		}
		return parseFloat(value);
	}

	$(document).on('keyup', '.quantity', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('quantity')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.unitPrice', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('unitPrice')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.discount', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('discount')[1];
		eachRowCalculation(rowNo);
	});
	$(document).on('keyup', '.tax', function(){
		// get rowNo from id="rowNo"
		var rowNo = $(this).attr('id').split('tax')[1];
		eachRowCalculation(rowNo);
	});

	$(document).on('keyup', '.addCost', function(){
		calculateTotalAddCost();
	});
	function calculateTotalAddCost() {
		var addCost=0;
		$('.addCost').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			addCost += parseFloat(val);
		});
		addCost=addCost.toFixed(2);
		$("#totalAddCost").val(addCost);
		totalCalculation();
	}

	function eachRowCalculation(rowNo) {
		var itemId=$("#itemId"+rowNo).val();
		var qty = $('#quantity'+rowNo).val() == '' || $('#quantity'+rowNo).val() == undefined ? 0 : $('#quantity'+rowNo).val();
		var price = $('#unitPrice'+rowNo).val() == '' || $('#unitPrice'+rowNo).val() == undefined ? 0 : $('#unitPrice'+rowNo).val();
		var discount = $('#discount'+rowNo).val() == '' || $('#discount'+rowNo).val() == undefined ? 0 : $('#discount'+rowNo).val();
		var tax = $('#tax'+rowNo).val() == '' || $('#tax'+rowNo).val() == undefined ? 0 : $('#tax'+rowNo).val();

		qty = convertToFloat(qty);
		price = convertToFloat(price);
		discount = convertToFloat(discount);
		tax = convertToFloat(tax);

		var subTotal=qty * price;
		var discountAmount = subTotal * (discount / 100);
		var taxAmount = (subTotal - discountAmount) * (tax / 100);
		var totalAmount=subTotal-discountAmount+taxAmount;
		
		updateValue(itemId,qty,price,tax,taxAmount,discount,discountAmount,subTotal,totalAmount);
		
		totalAmount=totalAmount.toFixed(2);
		
		$("#subTotal"+rowNo).val(subTotal);
		$("#disAmt"+rowNo).val(discountAmount);
		$("#taxAmt"+rowNo).val(taxAmount);
		$("#total"+rowNo).val(totalAmount);
		$("#totalP"+rowNo).val(totalAmount);
		totalCalculation();
	}
	function updateValue(itemId,qty,price,tax,taxAmount,discount,discountAmount,subTotal,totalAmount){
		itemLists.map(function(item){
			if(item.itemId == itemId){
				item.reqQty  = qty;
				item.unitPrice  = price;
				item.dis  = discount;
				item.disAmt  = discountAmount;
				item.tax  = tax;
				item.taxAmt  = taxAmount;
				item.subTotal  = subTotal;
				item.total  = totalAmount;
			}
		});
	}
	
	function totalCalculation() {
		var subTotal = 0;
		var totalDiscount = 0;
		var totalTax = 0;
		var totalAddCost=$("#totalAddCost").val() == '' || $("#totalAddCost").val() == undefined ? 0 : $("#totalAddCost").val();
		var grandTotal = 0+parseFloat(totalAddCost);
		$('.subTotal').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			subTotal += parseFloat(val);
		});

		$('.disAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalDiscount += parseFloat(val);
		});

		$('.taxAmt').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			totalTax += parseFloat(val);
		});

		$('.total').each(function(){
			let val = $(this).val() == '' || $(this).val() == undefined ? 0 : $(this).val();
			grandTotal += parseFloat(val);
		});
		subTotal =subTotal.toFixed(2);
		totalDiscount = totalDiscount.toFixed(2);
		totalTax = totalTax.toFixed(2);
		grandTotal = grandTotal.toFixed(2);
		
		$("#totSubTotal").val(subTotal);
		$("#totalDiscount").val(totalDiscount);
		$("#totalTax").val(totalTax);
		$("#grandTotal").val(grandTotal);
		var grandTotal = $("#grandTotal").val();

		let fstVal = grandTotal.split(".")[0];
        let secVal = grandTotal.split(".")[1];
        let finalWord = '';
        if(secVal == undefined || secVal == '' || secVal == '00' || secVal == '0'){
            finalWord = NumInWords(fstVal) + " only";
        }else{
            finalWord = NumInWords(fstVal) + " and " + NumInWords(secVal) + " cents only";
        }

		$("#totalInWords").text(finalWord);
	}
	
	
	
	
	
	
	function getDataFromTrAndPushIntoArrList() {
		$('#itemBody tr').each(function(){
			var quoteId = $(this).find('td:eq(0)').find('input').attr('id');
			var itemIndex = quoteId.substring(6);
			var itemId = $("#itemId"+itemIndex).val();
			var id = $("#id"+itemIndex).val();
			var itemName = $("#itemName"+itemIndex).val();
			var itemCode = $("#itemCode"+itemIndex).val();
			var uom=$("#uom"+itemIndex).val();
			var reqQty = $("#reqQty"+itemIndex).val();
			var unitPrice = $("#unitPrice"+itemIndex).val();
			var dis = $("#dis"+itemIndex).val();
			var disAmt = $("#disAmt"+itemIndex).val();
			var tax = $("#tax"+itemIndex).val();
			var taxAmt = $("#taxAmt"+itemIndex).val();
			var subTotal = $("#subTotal"+itemIndex).val();
			var total = $("#total"+itemIndex).val();
			var isFractional=$("#isFractional"+itemIndex).val();
			let selectItem = {
					'reqId': id,
					'itemId': itemId,
					'itemName': itemName,
					'itemCode':itemCode,
					'reqQty':reqQty,
					'uom':uom,
					'isFractional' : isFractional,
					'unitPrice':unitPrice,
					'dis':dis,
					'disAmt':disAmt,
					'tax':tax,
					'taxAmt':taxAmt,
					'subTotal':subTotal,
					'total':total,
			};
			$('#itemDiv'+itemId).css('background-color', '#AAC0CB');
			var isAllredyInList = false;
			itemLists.map((item, index) => {
				if(item.itemId == itemId){
					isAllredyInList = true;
				}
			});
			if(!isAllredyInList){
				itemLists.push(selectItem);
			}

		});
		addItemsToRow();
	}
	function generateAmentMent(){
		var poId=$('#poIdForAmendMent').val();
		$('#poIdForAmendMentFl').val(poId);
		bootbox.confirm({
			message: "Are you sure you want to generate amendment?",
			buttons: {
				confirm: {
					label: 'Yes',
					className: 'btn-success'
				},
				cancel: {
					label: 'No',
					className: 'btn-danger'
				}
			},
			callback: function (result) {
				if(result){
				    var amdTable = [];
                    var amdJson =[];
                    encryptFormData("poAmentMentForm", amdTable, amdJson);
					$('#poAmentMentForm').submit();
				}
			}
		});
	}
	
</script>

