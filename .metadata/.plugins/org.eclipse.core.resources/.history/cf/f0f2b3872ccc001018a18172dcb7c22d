<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<style>
	td.lowestPrice{
		box-shadow: inset 0 0 0 9999px hsl(127, 69%, 41%);
	}
</style>


 <div class="breadcrumb_conatiner">
              <div class="col-md-6">
                <h4 class="change-color">Quotation Comparison</h4>
              </div>
              <div class="col-md-6">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Quotation Comparison</li>
                  </ol>
                </nav>
              </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">

                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title">Quotation Comparison</h5>
                    </div>
                    <div class="card-body">

        <form action="${contextPath}/procurement/quotation/quotationComparison" method="get" id="form" modelAttribute="quotationcomparison">
                <input type="hidden" class="" id="encodedDataform" name="requisitionIdEncoded" value="" />
				<div class="row">
					<div class="col-md-12">
				
						<div class="row">
							<div class="col-md-12 table-responsive">
								<div class="row">
									<div class="col-md-3">
										<div class="form-group">
											<label class="col-md-12 required form-label" for="text"><spring:message code="PROC.REQ" /></label>
											<div class="col-md-12">
												<select class="form-control requiredField" id="requisitionId" name="requisitionId" >
													<option value="0"><spring:message code="COMMON.SELECT" /></option>
													<c:forEach items="${lstReq}" var="req">
														<option value="${req.requisitionId}" ${req.requisitionId eq requisitionId ? 'selected' : ''}>${req.requisitionNo}</option>
													</c:forEach>
												</select>
											</div>
										</div>
									</div>
									<div class="col-md-3 d-flex gap-2 align-items-center mt-3">
										<button type="button" class="btn btn-submit" onclick="validateFormss()" > Submit </button>
										<a class="btn btn-danger" style=";" onclick="backToModule()">Cancel</a>
									</div>
								</div>
								<div class="row">
									<div class="col-md-6 form-label">
										<h6 class="table-cap">Requisition Details :</h6>
									</div>
									<div class="col-md-6" style="text-align: right;">
										<c:if test="${not empty requisitionId}">
											<a  onclick="generatePurchaseOrder(${dto.requisition.requisitionId})" class="btn btn-primary">Generate PO</a>
										</c:if>
									</div>
								</div>
								<table class="table table-bordered">
									<tr>
										<td class="bgtr"><label><spring:message code="PROC.REQ.REQNO"/></label></td>
										<td>${dto.requisition.requisitionNo}</td>
										<td class="bgtr"><label><spring:message code="PROC.REQ.FINYEAR"/></label></td>
										<td>${dto.requisition.finYear.finYear}</td>
									</tr>
									
									<tr>
										<td class="bgtr"><label><spring:message code="PROC.REQ.TYPE"/></label></td>
										<td>${dto.requisition.requisitionType.requisitionTypeName}</td>
										<td class="bgtr"><label><spring:message code="PROC.REQ.DATE"/></label></td>
										<td><fmt:formatDate value='${dto.requisition.requisitionDate }' pattern='dd/MM/yyyy' /></td>
									</tr>
									<tr>
										<td class="bgtr"><label>Stock Type</label></td>
										<td>${dto.requisition.stockType.stockTypeName}</td>
										<td class="bgtr"><label>Cost Center</label></td>
										<td>${dto.requisition.costCenter.costCenterName}</td>
									</tr>
									<tr>
										<td class="bgtr"><label><spring:message code="PROC.REQ.PRIORITY"/></label></td>
										<td>${dto.requisition.priorityLevel.priorityLevelName}</td>
										<td class="bgtr"><label><spring:message code="PROC.REQ.BUDGET.GENERAL.PURPOSE"/></label></td>
										<td>${dto.requisition.purpose}</td>
									</tr>
								</table>
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<div class="table-responsive">
									<table class=" table table-striped table-bordered  mt-1" id="tableId">
										<thead class="bagGroundColor">
											<tr>
												<th rowspan="2"><spring:message code="PROC.REQ.ITEM.SUB.CAT"/></th>
												<th rowspan="2">Item Type</th>
												<th rowspan="2"><spring:message code="PROC.REQ.ITEM.DESC"/></th>
												<th rowspan="2">Unit</th>
												<th rowspan="2">Requisition Quantity</th>
												<c:forEach items="${dto.lstRfqQuote}" var="quote">
													<th colspan="4" style="text-align: center;">${quote.quoteNo}<br/><span>(${quote.assetVendor.vendorName})</span></th>
												</c:forEach>
											</tr>
											 <tr>
												<c:forEach begin = "1" end = "${dto.lstRfqQuote.size()}">
													<th>Quote Quantity</th>
													<th>Item Cost</th>
													<th>Updated Item Cost</th>
													<th>Total Cost</th>
												</c:forEach>
											</tr>									
										</thead>
										<tbody>
											<c:forEach items="${dto.itemDtls}" var="itmDtls" varStatus="status">
												<tr>
													<td>${itmDtls.subCatName }</td>
													<td>${itmDtls.itemType }</td>
													<td>${itmDtls.itemName }</td>
													<td>${itmDtls.unit }</td>
													<td>${itmDtls.qty }</td>
													<c:forEach items="${itmDtls.priceDtlsItems}" var="prcDtls">
														<td>${prcDtls.quoteQty }</td>
														<td><fmt:formatNumber type="number" minFractionDigits="2" maxFractionDigits="2" value="${prcDtls.itemCost }"/></td>
														<td class="updateCost${status.count} text-end"> <fmt:formatNumber type="number" minFractionDigits="2" maxFractionDigits="2" value="${prcDtls.updatedItemCost }"/> </td>
														<td style="border-right: 2px solid #ffa67c;"> <fmt:formatNumber type="number" minFractionDigits="2" maxFractionDigits="2" value="${prcDtls.totalCost}"/></td>
													</c:forEach>
												</tr>
											</c:forEach>
										</tbody>
									</table>
								</div>
								<div class="col-md-12 btnholder text-center">
									<a onclick="backToModule()"><button type="button" class="btn btn-warning">Back</button></a>
								</div>
							</div>
						</div>
					</div>
				</div>
	
        </form>
	</div>
	</div>
	</div>
	</div>
	
        <form action="${contextPath}/procurement/purchaseOrder/generatePurchaseOrder" method="get" id="gnrtPo" >
            <input class="noPass" type="hidden" name="requisitionId" id="gnrtPoId">
            <input type="hidden" class="" id="encodedDatagnrtPo" name="encodedDataform" value="" />
        </form>

<script>
    function generatePurchaseOrder(poId) {
        $("#gnrtPoId").val(poId);
        encryptFormData("gnrtPo", tableOrTbodyIDS, tableOrTbodyKeys);
        removeFieldsFromFormBYClass("gnrtPo","noPass");
        $("#gnrtPo").submit();
    }
	function validateFormss() {
		var requisitionId = $("#requisitionId").val();
		if(requisitionId == 0){
			alert("select requisition");
			return false;
		}else{
		    encryptFormData("form", tableOrTbodyIDS, tableOrTbodyKeys);
			$("#form").submit();
		}
	}

	$(document).ready(function() {
		calculateLowestPrice();
	});
    function backToModule(){
       let currentModuleCode =  localStorage.getItem('currentModuleCode');
       $('#moduleId').val(enc_password(currentModuleCode));
       $('#moduleForm').submit();
    }

	function calculateLowestPrice(){
		// get All tr by table id jquery
		var tr = $("#tableId tbody tr");
		quoteItemsSize = tr.length;
		if(quoteItemsSize > 0){
			for(var i=0; i<quoteItemsSize; i++){
				var td = document.getElementsByClassName("updateCost"+(i+1));
				var lowest = 0;
				for(var j=0; j<td.length; j++){
					var value = td[j].innerHTML;
					value = value.replace(/,/g, '');
					value = parseFloat(value);
					if(value != 0){
						if(lowest == 0){
							lowest = value;
							// add class to this td
							td[j].classList.add("lowestPrice");
						}else{
							// remove class from this td
							td[j].classList.remove("lowestPrice");
							if(value < lowest){
								lowest = value;
								// add class to this td
								td[j].classList.add("lowestPrice");
							}

						}
					}
				}
			}
		}
	}



</script>