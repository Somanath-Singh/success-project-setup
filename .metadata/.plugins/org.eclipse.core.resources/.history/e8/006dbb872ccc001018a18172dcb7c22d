<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/AadharVaidator.js"></script>
<%--<jsp:useBean id="strUtils" class="com.aashdit.demography.utils.ApplicationStringUtils"/> --%>


<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">${not empty fund ? 'Update Fund Allocation' : 'Add Expenditure' }</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page"> ${not empty fund ? 'Update Fund Allocation' : 'Add Expenditure' }</li>
			</ol>
		</nav>
	</div>
</div>

            
               
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <div class="card full-height">
                                <div class="card-header">
                                    <h4 class="card-title">${not empty fund ? 'Update Fund Allocation' : 'Add Expenditure' }</h4>

                                </div>
                                <div class="card-body">

                                  <form class="form-horizontal" action="${contextPath}/fnd/expenditure/add" method="post" enctype="multipart/form-data" id="form">
								    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
								    <input type="hidden" id="expenditureId" name="expenditureId" value="${expenditure.expenditureId}"/>
									<input type="hidden" id="expenditureAmt" value="${not empty expenditure ? expenditure.amount : 0}"/>
									<input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
									<input type="hidden" id="bdgDate" value=""/>
									<!-- Update in expenditure.jsp (add hidden field for workbillId inside the form) -->
									<input type="hidden" name="workBillId" value="${workBillId}" />
									<input type="hidden" name="workBillCode" value="${workBillCode}" />
									
                                    <div class="row">
										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required" for="">Financial Year</label>
												<div class="col-md-12">
													<select class="form-control form-select requiredField ${not empty expenditure.finyear.finyearId ? 'frezz' : ''}" id="finyearId" name="finyrId"   onchange="getBudgetAmount()" >
														<option value="">--Select--</option>
														<c:forEach items="${lstFinyear}" var="finyear">
															<option value="${finyear.finyearId}" ${finyear.finyearId eq expenditure.finyear.finyearId ?'selected':'' }>${finyear.finYear}</option>
														</c:forEach>
														
													</select>
												</div>
											</div>
										</div>
										<c:set var="functionList" value="getBudgetAmount()"/>
										<%@ include file="/WEB-INF/views/entityIdAndUserLevelListForMst.jsp"%>
										<!-- Budget List -->
										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required" for="">Budget List :</label>
												<div class="col-md-12">
													<select class="form-control form-select" id="budgetId" name="bdgId" onchange="getBudgetAmount()">
														<option value="">--Select--</option>
													</select>
													  <span style="color: #0043ff;font-weight: 500;font-size:11px;">( Budget : <strong id="totalBudgetAmt"></strong></span>, <span style="color: #0043ff;font-weight: 500;font-size:11px;">Allocation : <strong id="totalAllocationAmt"></strong> )</span>
												</div>
											</div>
										</div>

										<!-- Budget Cost -->
										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required" for="">Remaining Fund :<!-- <i class="fa fa-inr"></i> --></label>
												<div class="col-md-12">
													<input type="text" class="form-control form-control-sm x-turnover" id="remainingCost" readonly>
												</div>
											</div>
										</div>


										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required" for="">Fund Type :</label>
												<div class="col-md-12">
													<select class="form-control form-select requiredField" id="fundTypeId"  name="fundTypeId" onchange="getBudgetAmount()">
														<option value="">--Select--</option>
														<c:forEach items="${lstFundType}" var="fundType">
															<option value="${fundType.fundTypeId}" ${fundType.fundTypeId eq expenditure.fundType.fundTypeId ?'selected':'' }>${fundType.fundTypeName}</option>
														</c:forEach>
													</select>
												</div>
											</div>
										</div>
										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required " for="">Component Name :</label>
												<div class="col-md-12">
													<select class="form-control form-select requiredField"  id="schemeId"  name="schemeId" onchange="getBudgetAmount()">
														<option value="">--Select--</option>
														<c:forEach items="${mstSchemeList}" var="mstScheme">
															<option value="${mstScheme.schemeId}" ${mstScheme.schemeId eq expenditure.mstScheme.schemeId  ?'selected':'' }>${mstScheme.schemeName}</option>
														</c:forEach>
													</select>
												</div>
											</div>
										</div>
										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required " for=""> Account Head :</label>
												<div class="col-md-12">
													<select class="form-control form-select requiredField" id="headId" onchange="findSubHeadListByHeadId();getBudgetAmount();">
														<option value="">--Select--</option>
														<c:forEach items="${lstMstHead}" var="mstHead">
															<option value="${mstHead.headId}" ${mstHead.headId eq expenditure.mstSubHead.head.headId ?'selected':'' }>${mstHead.headName}</option>
														</c:forEach>
													</select>
												</div>
											</div>
										</div>
										<div class="col-md-3">
											<div class="form-group">
												<label class="col-md-12 smallInput required " for=""> Account Sub Head :</label>
												<div class="col-md-12">
													<select class="form-control form-select requiredField" id="subHeadId"  name="subHeadId" onchange="getBudgetAmount();">
														<option value="">--Select--</option>
														<c:forEach items="${mstSubHeadList}" var="mstSubHead">
															<option value="${mstSubHead.subHeadId}" ${mstSubHead.subHeadId eq expenditure.mstSubHead.subHeadId  ?'selected':'' }>${mstSubHead.subHeadName}</option>
														</c:forEach>
													</select>
												</div>
											</div>
										</div>
										<div class="col-md-3">
											<div class="form-group">
												<label class="required" style="font-size: 13px;">Expenditure Date :</label>
												<div class="col-md-12 datepicker_con">
													<input type="text" class="form-control form-control-sm disbursDate requiredField" name="transDateStr" id="transDate" readonly="readonly" required="required"  value="<fmt:formatDate pattern="dd/MM/yyyy" value='${expenditure.transDate}' />" >

												</div>
											</div>
										</div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label class="required">Bill No :</label>
                                                <div class="col-md-12">
                                                   <input type="hidden"  id="hdnSanctionNo" value="${fund.sanctionNo}"  >
												   <input type="text" class="form-control form-control-sm requiredField" id="sanctionNo" name="sanctionNo" maxlength="15" onchange="checkDuplicateSanctionNo();" value="${expenditure.sanctionNo}"  >
                                                </div>
                                            </div>
                                        </div>
                                        <%-- <div class="col-md-2">
                                            <div class="form-group">
                                                <label class="required">Amount :</label>
                                                <div class="col-md-12">
                                                    	<input type="hidden" class="form-control form-control-sm x-turnover" id="turnover1"   value="${expenditure.amount}" maxlength="15">
												<input type="text" class="form-control form-control-sm x-turnover greaterThanZero numberWithTwoDecimalOnly requiredField onClickInput" name="amount" id="turnover1Converted" value="${not empty expenditure ? expenditure.amount : 0}" maxlength="15"  onkeyup="checkAmount(this.value)">
                                                </div>
                                            </div>
                                        </div>  --%>
                                     <div class="col-md-3">
										    <div class="form-group">
										        <label class="required">Amount :</label>
											       <c:choose>
												    <c:when test="${not empty expend.amount}">
												        <div class="col-md-12">
												            <!-- Hidden input to hold the raw value for form submission -->
												            <input type="hidden" class="form-control form-control-sm x-turnover" id="turnover1"
												                   value="${expend.amount}" maxlength="15" />
												
												            <!-- Visible input to show the formatted amount -->
												            <input type="text" class="form-control form-control-sm x-turnover greaterThanZero numberWithTwoDecimalOnly requiredField onClickInput"
												                   name="amount" id="turnover1Converted" value="${expend.amount}" maxlength="15" onkeyup="checkAmount(this.value)"  autocomplete="off" />
												        </div>
												    </c:when>
												      <c:when test="${not empty expenditure.amount}">
												        <div class="col-md-12">
												            <!-- Hidden input to hold the raw value for form submission -->
												            <input type="hidden" class="form-control form-control-sm x-turnover" id="turnover1"
												                   value="${expenditure.amount}" maxlength="15" />
												
												            <!-- Visible input to show the formatted amount -->
												            <input type="text" class="form-control form-control-sm x-turnover greaterThanZero numberWithTwoDecimalOnly requiredField onClickInput"
												                   name="amount" id="turnover1Converted" value="${expenditure.amount}" maxlength="15" onkeyup="checkAmount(this.value)"  autocomplete="off" />
												        </div>
												    </c:when>
												     <c:otherwise>
												        <input type="text" class="form-control form-control-sm x-turnover greaterThanZero numberWithTwoDecimalOnly requiredField onClickInput"
												               name="amount" id="turnover1Converted"
												               value="${expend.amount}" maxlength="15" onkeyup="checkAmount(this.value)"  autocomplete="off"/>
												    </c:otherwise> 
												</c:choose>
										    </div>
										</div>
                                    </div>
									<c:set var="dynamicFromId" value="form" scope="request" />
									<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
									</form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
 <script>


	$(document).ready(function(){
		
		// var subHead='${empty expenditure && lstMstHead.size() < 2}';
		// if(subHead== 'true'){
		// 	findSubHeadListByHeadId();
		// }
		getBudgetAmount();
	});
 function findSubHeadListByHeadId(){
	var headId=$("#headId").val();
		$.ajax({
			type : "GET",
			url : '${contextPath}/ecashcommon/findSubHeadListByHeadId',
			dataType : "json",
			data : {
				"headId" : headId,
			},
			success : function(response) {
				var html = "<option value='' selected>-Select-</option>";
				var data = response;
				if (data != "" && data != null && data.length > 0) {
					$.each(data, function(index, value) {
						html = html + '<option value="'+value.subHeadId+'">'
								+ value.subHeadName + "</option>";
					});
				}
				$('#subHeadId').empty().append(html);
			},
			error : function(error) {
				bootbox.alert("Something went wrong !!!");
			}
		});
}
 
 
 
 $('.NumbersOnlyForAmount').keypress(
			function(event) {
				var regex = new RegExp("^[0-9.]+$");
				var key = String.fromCharCode(!event.charCode ? event.which
						: event.charCode);
				if (!regex.test(key)) {
					event.preventDefault();
					return false;
				}
});
 
 $(function() {
	 $('.disbursDate').datepick({
				onShow : $.datepick.monthOnly,
				dateFormat : 'dd/mm/yyyy',
				yearRange : "-100:+20",
				maxDate: '0',
				showOnFocus : true,
				showTrigger : '<button type="button" class="trigger ${canTakeAction eq false ? "frezz" : ""}">'
						+ '<i class="fa fa-calendar"></i></button>',
			   onSelect: function(selected) {
			     var date = new Date(selected);
					var fyear= $("#finyearId option:selected").text().split("-");
				    var firstDate = 01 + "/" + 04 + "/" +fyear[0];
				    var lastDate =  31 + "/" + 03 + "/" +fyear[1];	
					var sDate = firstDate.replace(/(\d+[/])(\d+[/])/, '$2$1');
					var tDate = lastDate.replace(/(\d+[/])(\d+[/])/, '$2$1');
					var data1 = new Date(sDate);
					var data2 = new Date(tDate);
				    if((date <= data2 && date >= data1)) {
				    //alert(this.id);
				    }else{
				    	 $("#"+this.id).val("");
				    	 bootbox.alert("Please select date between the financial year .")
				    }
				    var alltDate=$('#bdgDate').val().split("-");
                     var modAllotDate=new Date(alltDate[1]+"/"+alltDate[2]+"/"+alltDate[0]);
                     if(modAllotDate > new Date(selected)){
                        alert('Expenditure Creation Date sholud not be before than Budget Creation Date.');
                        $('.disbursDate').val("");
                     }
			    }
			}); 
	 getEntityNameByEntityTypeOrDistrictId();
}); 
 
 
 
 function checkDuplicateSanctionNo(){
	var sanctionNo=$("#sanctionNo").val();
	 if($("#hdnSanctionNo").val()!=sanctionNo) {
		 $.ajax({
    			type : "GET",
    			url : "${contextPath}/fnd/expenditure/checkDuplicateSanctionNo",
    			data : {
    				"sanctionNo" : sanctionNo,
    			},
    			success : function(response) {
    				var val = JSON.parse(response);
					var expenditureId=val.expenditureId;
					var existExpenditureId=$("#expenditureId").val();
					if(existExpenditureId== '' || existExpenditureId != expenditureId){
						if (val.duplicate == true) {
							bootbox.alert("Duplicate Bill Number Not Allowed");
							$("#sanctionNo").val("");
    					}
					}
    				
    			},
    			error : function(error) {
    				bootbox.alert("Something Went wrong"); 
    			}
    		}); 
	 }
 }


 function currencyConverter(that,fieldId){
	    debugger;
		if(that!=""){
			var value = that.replaceAll(",","");
			if(value.includes(".")){
				var splitValues = value.split(".");
				if(splitValues.length>=2){
					if(splitValues[0]==""){
						splitValues[0]="0";
					}
					value=splitValues[0]+"."+splitValues[1];
					if(splitValues[1].length==1){
						value=splitValues[0]+"."+splitValues[1]+"0";		
					}
					if(splitValues[1].length>2 || splitValues[1]==""){
						value=splitValues[0]+".00";		
					}
				}else{
					value=splitValues[0];
				}
			}else{
				value=value+".00";
			}
			//var hiddenFieldId = fieldId.split("Conv")[0];
			$("#"+fieldId+"Converted").val(value);
			value = value.replace(/(\d)(?=(\d{2})+\d\.)/g, '$1,');
			$("#"+fieldId).val(value);
		}
	}

	
	function getBudgetAmount(){
		var finyearId=$("#finyearId").val();
		var object = $("#objectIdAndTypeId").val();
		var fundTypeId=$("#fundTypeId").val();
		var schemeId=$("#schemeId").val();
		var subHeadId=$("#subHeadId").val();
		if(budgetId!="" && object!=''){
			$.ajax({
				type : "GET",
				url : "${contextPath}/fnd/fund/getBudgetAmount",
				data : {
					"object" : object,
					"finYearId" : finyearId,
					"subHeadId" : subHeadId != undefined || subHeadId != '' ? subHeadId : 0,
					"schemeId" : schemeId!= undefined || schemeId != '' ? schemeId : 0,
					"fundTypeId" : fundTypeId!= undefined || fundTypeId != '' ? fundTypeId : 0,
				},
				success : function(response) {
					if(response.outcome){
						let data = response.data;
						// stringarry to jsonArray
						let allBudgets = JSON.parse(data.allBudgets);
						let html = '';
						if(allBudgets.length > 0){
							allBudgets.forEach(budget => {
								html += '<option value="'+budget.budgetId+'">'+budget.objectName+'</option>';
							});
							$('#budgetId').empty().append(html);
							if(allBudgets.length<2){
                                var bdgDate=allBudgets[0].creationDate;
                                $('#bdgDate').val(bdgDate);
                            }
						}else{
							html="<option value=''>-Select-</option>";
							$('#budgetId').empty().append(html);
						}
						//budgetAmount, budgetRemainAmt, fundAllocateAmount, fundRemainAmt
						var remainAmt=parseFloat($("#expenditureAmt").val())+parseFloat(data.remainAmt);

						$('#totalBudgetAmt').text(data.budgetAmount.toFixed(2));
						$('#remainingCost').val(remainAmt.toFixed(2));
						$('#totalAllocationAmt').text(data.fundAllocateAmount.toFixed(2));
						
					}
				},
				error : function(error) {
					bootbox.alert("Something Went wrong"); 
				}
			}); 
		
		}
	}

	 function checkAmount(amount){
		debugger;
		var budgetAmt=parseFloat($("#remainingCost").val());
		var amt=parseFloat(amount);
		if(budgetAmt=='' || isNaN(budgetAmt)){
			var budgetId=$("#budgetId").val();
            if(budgetId!=''|| budgetId>0){
                bootbox.alert("Amount is not available for next allocation.");
                $("#turnover1Converted").val(0);
                return false;
            }else{
                bootbox.alert("First select budget.");
                $("#turnover1Converted").val(0);
                return false;
            }
		}
		if(amt>budgetAmt){
			bootbox.alert("Expenditure amount should not greater than remaining budget amount.");
			$("#turnover1Converted").val(0);
			return false;
		}
	}
	 
	 $(document).on("keypress", ".numberWithTwoDecimalOnly", function (event) {
	     let charCode = event.which ? event.which : event.keyCode;
	     let inputVal = $(this).val();

	     if (charCode === 8 || charCode === 9 || charCode === 37 || charCode === 39) {
	         return true;
	     }

	     if (charCode === 46) {
	         if (inputVal.indexOf('.') !== -1 || inputVal.length === 0) {
	             event.preventDefault();
	             return false;
	         }
	         return true;
	     }

	     if (charCode < 48 || charCode > 57) {
	         event.preventDefault();
	         return false;
	     }

	     if (inputVal.indexOf('.') !== -1) {
	         let decimalPart = inputVal.split('.')[1];
	         if (decimalPart && decimalPart.length >= 2) {
	             event.preventDefault();
	             return false;
	         }
	     }
	 });

	 $(document).on("copy paste cut drop", ".numberWithTwoDecimalOnly", function (e) {
	     e.preventDefault();
	 });

	 $(document).on("blur", ".numberWithTwoDecimalOnly", function () {
	     let val = $(this).val();
	     let regex = /^(?!0(\.0{1,2})?$)\d+(\.\d{0,2})?$/;  
	     if (!regex.test(val)) {
	         $(this).val("");  
	     }
	 });

 </script>           
    