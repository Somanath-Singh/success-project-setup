<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />

<script type="text/javascript"
	src="${contextPath}/assets/appJs/validation/common-utils.js"></script>


<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">
			<c:if test="${not empty maintenance}">
				Edit Maintenance Request
			</c:if>
			<c:if test="${empty maintenance}">
				Add Maintenance Request
			</c:if>
		</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item">
					<a href="${contextPath}/home"><i class="fa-solid fa-house"></i></a>
				</li>
				<li class="breadcrumb-item">
					<a href="${contextPath}/maintenance_request/get-maintenance-request">Maintenance Requests</a>
				</li>
			</ol>
		</nav>
	</div>
</div>


<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<h5 class="card-title">
					<c:if test="${not empty maintenance}">
						Edit Maintenance Request
					</c:if>
					<c:if test="${empty maintenance}">
						Add Maintenance Request
					</c:if>
				</h5>
			</div>
			<div class="card-body">
				<form class="form-horizontal" action="${contextPath}/maintenance_request/saveMaintenanceRequest" method="POST" id="maintenanceForm" enctype="multipart/form-data">
					<input type="hidden" id="cipherText" name="cipherText" value="">
					<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
					<input type="hidden" name="mainViewId" id="mainViewId" value="${maintenance.mainViewId}" /> 
					<input type="hidden" name="projectId" id="projectId" value="${maintenance.projectId}" /> 
					<input type="hidden" name="finyearId" id="finyearId" value="${maintenance.finyearId}" />
					<input type="hidden" name="assignId" id="assignId" value="${maintenance.assignId}" />
					<input type="hidden" id="buttonCode" name="buttonCode">	

					<div class="row">
						<div class="col-md-3">
							<div class="form-group">
								<label class="required">Project Name:</label> 
								<input type="text" id="projectName" name="projectName" class="form-control form-control-sm" value="${maintenance.projectName}" readonly />
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label class="required">Project Type:</label> 
								<input type="text" id="projectType" name="projectType" class="form-control form-control-sm" value="${maintenance.projectType}" required maxlength="100" readonly />
							</div>
						</div>
						<div class="col-md-3">
							<label class="required">From Date:</label>
							<div class="datepicker-box">
								<input type="text" id="fromDate" name="fromDate" class="form-control form-control-sm datepicker" value="${maintenance.fromDate}" required readonly />
							</div>
						</div>
						<div class="col-md-3">
							<label class="required">To Date:</label>
							<div class="datepicker-box">
								<input type="text" id="toDate" name="toDate" class="form-control form-control-sm datepicker" value="${maintenance.toDate}" required readonly />
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-3">
							<div class="form-group">
								<label>Remarks:</label>
								<textarea id="remarks" name="remarks" class="form-control form-control-sm" maxlength="500" readonly>${maintenance.remarks}</textarea>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label class="required">Financial Year:</label> 
								<input type="text" id="financialYearName" name="financialYearName" class="form-control form-control-sm" value="${maintenance.financialYearName}" readonly />
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label class="required">Assigned To:</label>
								<select class="form-control form-control-sm form-select" data-live-search="true" id="assignedUserId" name="assignedUserId">
									<c:if test="${empty maintenance}">
										<option >--Select--</option>
									</c:if>
									<c:if test="${not empty maintenance}">
										<c:forEach var="assignedUser" items="${maintenance.assignedTaskUserDto}">
											<option value="${assignedUser.userId}">${assignedUser.userName}</option>
										</c:forEach>
									</c:if>									
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label>Active Status:</label> 
								<select id="isActive" name="isActive" class="form-control form-control-sm" disabled>
									<c:if test="${empty maintenance}">
										<option >--Select--</option>
									</c:if>
									<c:if test="${not empty maintenance}">
										<option value="true" ${maintenance.isActive ? 'selected' : ''}>Active</option>
										<option value="false" ${!maintenance.isActive ? 'selected' : ''}>Inactive</option>
									</c:if>
								</select>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-3">
							<div class="form-group">
								<label for="imageUrl">Upload Image1 :</label> 
								<input type="file" class="form-control form-control-sm" value="${maintenance.imageUrl}" id="imageUrl" name="imageUrl"  onchange="uploadFileCheck(this)">
								<p style="font-size: 12px;">(.pdf, .png, .jpg, .jpeg max 500 KB)</p>
								<c:if test="${not empty maintenance.imagePath}">
									<button type="button" class="btn btn-sm btn-primary"
										title="View Maintenance Request Document"
										onclick="viewDocument('${maintenance.imagePath}', 'MAINTENANCE_REQUEST')">
										<i class="fa fa-eye"></i>
									</button>
								</c:if>
							</div>
						</div>
					</div>
					<div class="col-md-12 mt-2 text-center">
						<c:set var="dynamicFromId" value="maintenanceForm" scope="request" />
                        <c:set var="wonFunction" value="submitMaintenanceForm()" />
                        <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>					
                    </div>
				</form>
			</div>

		</div>
	</div>
</div>

<form action="${contextPath}/document/viewDocuments" method="get" id="documentFormView" enctype="multipart/form-data" target="_blank">
    <input type="hidden" name="moduleName" id="moduleName"/>
    <input type="hidden" name="filePath" id="filePath"/>
</form>

<script>

	function viewDocument(filePath, moduleName) {
	    $('#moduleName').val(moduleName);
	    $('#filePath').val(filePath);
	    $('#documentFormView').submit();
	}

    function submitMaintenanceForm() {
    	const buttonCode = $("#hdnButtonCode").val();
		$("#buttonCode").val(buttonCode);
        var projectName = $('#projectName').val().trim();
        var projectType = $('#projectType').val().trim();
        var fromDate = $('#fromDate').val().trim();
        var toDate = $('#toDate').val().trim();
        var financialYear = $('#financialYearName').val().trim();
        var remarks = $('#remarks').val().trim();
        var isActive = $('#isActive').val();
        var imageFile = $('#imageUrl')[0].files[0];

        // Project Name
        if (!projectName) {
            bootbox.alert("Please enter Project Name.");
            return false;
        }else if (!projectType) {
            bootbox.alert("Please enter Project Type.");
            return false;
        }else if (!fromDate) {
            bootbox.alert("Please enter From Date.");
            return false;
        }else if (!toDate) {
            bootbox.alert("Please enter To Date.");
            return false;
        }else if (!financialYear) {
            bootbox.alert("Please enter Financial Year.");
            return false;
        }else if (!isActive) {
            bootbox.alert("Please select Active Status.");
            return false;
        }else{
          	//submit tha form
	   		var bizContent = $("#maintenanceForm").serializeArray();
	   		$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray(bizContent))));
	   		bootbox.confirm("Do you want to " + buttonCode + " Maintenance Request Details ?", function(result) {
	   			if (result) {
	   				showLoader();
	   				$("#maintenanceForm").submit();
	   			}
	   		});
        }
    }
    
    function uploadFileCheck(that){
    	var ValidFileExtension = ['pdf','jpg', 'jpeg', 'png'];

    	if($(that).val().split('.').length == 2 ) {
    		  if ($.inArray($(that).val().split('.').pop().toLowerCase(), ValidFileExtension) == -1) {
    				bootbox.alert("Please upload only .pdf, .jpg/.jpeg/.png files.");
    				$(that).val("");
    				return false;
    			}
    		  if ((that.files[0].size) > 512000) {//500KB
    			    bootbox.alert("File size exceeds maximum file size of 500 KB!");
    			    $(that).val("");
    			    return false;
    			}
    		}else{
    	  	   bootbox.alert("Unsupported file format,Please check your file extension");
    	  	   $(that).val("");
    	 }
     }

    $(document).ready(function () {
        $(".datepicker").datepick({
            onShow: $.datepick.monthOnly,
            dateFormat: "dd-mm-yyyy",
            yearRange: "c-20:c+10",
            showOnFocus: true,
            showTrigger: '<button type="button" class="trigger"><i class="fa fa-calendar"></i></button>',
        });
    });
    
</script>