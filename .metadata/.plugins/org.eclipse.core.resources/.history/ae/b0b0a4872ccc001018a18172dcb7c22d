<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix = "fn" uri = "http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib uri = "http://java.sun.com/jsp/jstl/functions" prefix = "fn" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}"/>
<script src="${contextPath}/resources/javascripts/accountMaster.js"></script>
<script src="${contextPath}/resources/javascripts/common.js"></script>
<script src="resources/javascripts/createAccountMaster.js"></script>
<style>
.table-striped>tbody>tr:nth-of-type(odd) {
    --bs-table-accent-bg: rgb(247 249 244) !important;
    /* color: var(--bs-table-striped-color); */
}
.accordion-body {
    padding: 0.5rem;
    background: #091a16 !important;
}
.onwip{
	display:none;
}
</style>

<div class="container-fluid">
          <!-- Start::row-1 -->
          <div class="row">
              <div class="col-xl-12">
                  <div class="card custom-card">
                      <div class="top-left"></div>
                      <div class="top-right"></div>
                      <div class="bottom-left"></div>
                      <div class="bottom-right"></div>
                      <div class="card-body">
                     <h5><b>Project Milestone details</b></h5>
								<%-- <p class="mandatory" align="right"><spring:message code="LAND.ALLOTMENT.MANDATORY"/></p> --%>
								<div class="col-md-12">
									<form class="form-horizontal form-bordered" action="${contextPath}/saveProjectMistoneDetaislPage" method="POST"  
									id="saveProjectMistoneDetaislPage" enctype="multipart/form-data">
                            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
							 <input type="hidden" name="hiddenProjectMilestoneDetailsId" id="hiddenProjectMilestoneDetailsId" value=""/>
							 <input type="hidden" name="hiddenFinalCost" id="hiddenFinalCost" value=""/>
							  <input type="hidden" name="expectedDate" id="expectedDate" value=""/>

								<div class="row">
								<%@ include file="/WEB-INF/views/ajaxLoader.jsp" %> 
									<div class="col-md-3 col-sm-3">
										<div class="form-group">
											<label class="col-md-12 required" for="project">Projects:</label>
												<div class="col-md-12">
													<select class="form-select" name="project" id="project" onchange="getPhasesByProjectd();">
														 <option value="">---select---</option>
														<c:forEach items="${projectList}" var="projects">
										                    <option value="${projects.projectId}">${projects.projectName}</option>
														</c:forEach>
													</select>
												</div>
											</div>
										</div>
									<div class="col-md-3 col-sm-3">
										<div class="form-group">
											<label class="col-md-12 required" for="phases">Phases:</label>
											<div class="col-md-12">
												<select class="form-control" id="phases" name="phases" data-plugin-selectTwo onchange="getMilestoneData(),checkPhase(this.value),checkByProjectStatus()">
												<option value="">---select---</option>
													<c:forEach items="${phasesList}" var="phases">
																<option value="${phases.phaseId}">${phases.phaseName}</option>
													</c:forEach>
												</select>
											</div>
										</div>
									</div>
									<div class="col-md-3 col-sm-3">
										<div class="form-group">
											<label class="col-md-12" for="status">Status:</label>
											<div class="col-md-12">
												<select class="form-control" name="status" data-plugin-selectTwo id="status" >
													<option value="">---select---</option>
													<option value="On-Hold">On-Hold</option>
													<option value="Complete">Complete</option>
													<option value="WIP">WIP</option>
											</select>
											</div>
										</div>
									</div>
									<div class="col-md-3 col-sm-3">
										<div class="form-group">
											<label class="col-md-12" for="inputDefault">Document:</label>
											<div class="col-md-12">
									 			<input type="file" class="form-control form-control-sm" name="fileName" style="height: 30px;" id="fileId" value="" aria-describedby="helpId" onchange="checkFiles(this);">
												<a href="#" class="hidden" target="_blank" id="viewDoc">view</a>
											</div>
										</div>
									</div>
<!-- 										<div class="form-group col-md-3 hidden"> -->
<!-- 		                                   <label for="startDate" class="form-label required">Start Date:</label> -->
<!-- 		                                   <div class="datepicker-box"> -->
<!-- 		                                       <input type="text" class="form-control datepicker" id="startDate" name="startDate" autocomplete="off" maxlength="25"> -->
<!-- 		                                   </div> -->
<!-- 		                               </div> -->
<!-- 		                               <div class="form-group col-md-3 hidden"> -->
<!-- 		                                   <label for="endDate" class="form-label required">End Date:</label> -->
<!-- 		                                   <div class="datepicker-box"> -->
<!-- 		                                       <input type="text" class="form-control datepicker" id="endDate" name="endDate" autocomplete="off" maxlength="25"> -->
<!-- 		                                   </div> -->
<!-- 		                               </div> -->
		                               <div class="form-group col-md-3 ">
		                                   <label for="deliveryDate" class="form-label required">Expected Delivery Date:</label>
		                                   <div class="form-group">
		                                       <input type="text" class="form-control form-control-sm" id="deliveryDate" name="deliveryDate" autocomplete="off" maxlength="25" readonly>
		                                   </div>
		                               </div>
		                               <div class="col-md-3 col-sm-3 ">
										<div class="form-group">
											<label class="col-md-12" for="remarks">Delay Remarks:</label>
											<div class="col-md-12">
									 			<input type="text" class="form-control form-control-sm" name="remarks" style="height: 30px;" id="remarks" value="">
											</div>
										</div>
								  	 </div>
								  	 <div class="col-md-3 col-sm-3 ">
									    <div class="form-group">
									        <label class="col-md-12" for="penaltyPercentage">Penalty percentage:</label>
									        <div class="col-md-12">
									            <input type="number" class="form-control form-control-sm" name="penaltyPercentage" 
									                   style="height: 30px;" id="penaltyPercentage" min="0" max="100" step="0.01" onblur="calculatePenaltyAmountByPercentage(this.value)">
									        </div>
									    </div>
									</div>
									</div>
									<div class="row">
									<div class="col-md-6"></div>
									<div class="col-md-6">
									<div class="row">
									
									<div class="col-md-12 col-sm-12 ">
									    <div class="form-group row">
									        <label class="col-md-6 text-end">Phase Amount:</label>
									        <div class="col-md-6">
									            <input type="text" class="form-control form-control-sm" name="phaseAmount" 
									                   style="height: 30px;text-align:right" id="phaseAmount" readonly>
									        </div>
									    </div>
									</div>
									<div class="col-md-12 col-sm-12 ">
										<div class="form-group row">
											<label class="col-md-6 text-end" for="inputDefault">Penalty calculated amount:</label>
											<div class="col-md-6">
									 			<input type="text" class="form-control form-control-sm" name="penaltyAmount" style="height: 30px;text-align:right" id="penaltyAmount"  readonly>
											</div>
										</div>
									</div>
									<div class="col-md-12 col-sm-12 ">
										<div class="form-group row">
											<label class="col-md-6 text-end" for="inputDefault">Total invoice amount:</label>
											<div class="col-md-6">
									 			<input type="text" class="form-control form-control-sm" name="totalInvoiceAmount" style="height: 30px;text-align:right" id="totalInvoiceAmount"  readonly>
											</div>
										</div>
									</div>
								</div>
							</div>
									
								  	 <%-- <div class="col-md-3 col-sm-3 ">
									    <div class="form-group ">
									        <label class="col-md-12">Phase Amount:</label>
									        <div class="col-md-12">
									            <input type="text" class="form-control form-control-sm" name="phaseAmount" 
									                   style="height: 30px;text-align:right" id="phaseAmount" readonly>
									        </div>
									    </div>
									</div>
									
									<div class="col-md-3 col-sm-3 onwip">
										<div class="form-group">
											<label class="col-md-12" for="inputDefault">Penalty calculated amount:</label>
											<div class="col-md-12">
									 			<input type="text" class="form-control form-control-sm" name="penaltyAmount" style="height: 30px;text-align:right" id="penaltyAmount"  readonly>
											</div>
										</div>
									</div>
									<div class="col-md-3 col-sm-3 onwip">
										<div class="form-group">
											<label class="col-md-12" for="inputDefault">Total invoice amount:</label>
											<div class="col-md-12">
									 			<input type="text" class="form-control form-control-sm" name="totalInvoiceAmount" style="height: 30px;text-align:right" id="totalInvoiceAmount"  readonly>
											</div>
										</div>
									</div>
									<div class="col-md-3 col-sm-3 onwip">
										<div class="form-group">
											<div class="col-md-12">
												<a href="${contextPath}/inv/invoice" ><input type="button" class="btn btn-danger" value="Generate Invoice"></a></div>
										</div>
									</div> --%>
								<div class="col-sm-12" style="margin-top:10px;">
									<div class="form-group text-center d-flex align-items-center justify-content-center" style="gap:10px">
										<button type="button" class="btn btn-info" id="saveBtn" onclick="checkFormData_onSubmit('saveProjectMistoneDetaislPage')" style="height: 29px;" >Save</button>
										<a href="${contextPath}/home" ><input type="button" class="btn btn-danger" value=<spring:message code="COMMON.BUTTON.BACK"></spring:message>></a>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
          </div>
     </div>
  </div>
</div>
        
<form action="${contextPath}/inv/invoiceGeneration" method="POST" id="invoiceGeneration">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="projectForInv" name="projectForInv">
	<input type="hidden" id="phaseForInv" name="phaseForInv">
</form>


   <script>
   function checkFiles(input) {
   	debugger
       var fileName = input.value.split('\\').pop(); // Extract the actual filename
       var ext = fileName.split('.').pop().toLowerCase();

       if (ext !== "pdf") {
           bootbox.alert("Please upload a PDF file only.");
           input.value = "";
           return; // Exit the function if the file type is not PDF
       }

       var fileSize = 0;

       if (input.files && input.files[0]) {
           fileSize = input.files[0].size;
       }

       var maxSizeInBytes = 2097152; // 2MB

       if (fileSize > maxSizeInBytes) {
           bootbox.alert('Please choose a file less than 2MB.');
           input.value = "";
       }
   }
   
   function getPhasesByProjectd(){
   	showLoader();
   	var projectId=$("#project").val();
   	 setTimeout(function () {
   	  $.ajax({
   			url:"${contextPath}/getPhasesByProjectd",
   			type : "GET",
   			data : {
   				"projectId" : projectId
   				
   			},
   	success:function(response){
   		debugger
   		hideLoader();
   		var data = JSON.parse(response);
   		var html = "<option value='0' >--select--</option>";
   		if(data.length != 0){
   		$.each(data, function(index,value){
   			$("#hiddenFinalCost").val(value.finalCost);
   			//$("#phaseAmount").val(value.finalCost);
   			$("#phaseAmount").val(value.finalCost.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
   			count=index+1;
   			html=html+"<option value="+value.phasesId+">" +value.phasesName+"</option>"
   		 });
   		
   		}else{
   			}
   		$('#phases').empty().append(html);
   		//$('#phases').val(selEmployee);
   		
   			},
   	error:function(error){
   		var html = "<option value='' >--select--</option>";
   			$('#phases').empty().append(html);
   		}
   	});	
   	 },1000);
   }
   
   const checkFormData_onSubmit = async (formId) => {
	    debugger
	    const requiredFields = document.querySelectorAll('.required');
	    let validationFailed = false;

	    for (const field of requiredFields) {
	        const inputId = field.getAttribute('for');
	        const inputField = document.getElementById(inputId);
	        if (!inputField.value) {
	            inputField.style.borderColor = 'red';
	            await showNotification(true, field.textContent.replace(/:/g, "") + " is required.");
	            setTimeout(() => {
	                inputField.style.borderColor = '';
	            }, 3000);
	            validationFailed = true;
	            break;
	        }
	    }

	    if (!validationFailed) {
	        bootbox.confirm({
	            message: "Are you sure you want to proceed?",
	            buttons: {
	                confirm: {
	                    label: 'Yes',
	                    className: 'btn-success'
	                },
	                cancel: {
	                    label: 'No',
	                    className: 'btn-danger'
	                }
	            },
	            callback: function (result) {
	                if (result === true) {
	                	showLoader();
	                    $('#saveProjectMistoneDetaislPage').submit();
	                }
	            }
	        });
	    }

	    return false;
	}

   function calculatePenaltyAmountByPercentage(penaltyPercentage) {
	   debugger
	    var finalCost = parseFloat($("#hiddenFinalCost").val()); 
	    var percentage = parseFloat(penaltyPercentage); 
	    var phaseAmount = parseFloat($("#phaseAmount").val()); // Get the phase amount

	    if (!isNaN(finalCost) && !isNaN(percentage)) {
	        var penaltyAmount = (finalCost * percentage) / 100; 
	        $("#penaltyAmount").val(penaltyAmount.toFixed(2)); 

	        // Calculate total invoice amount: finalCost - penaltyAmount
	        var totalInvoiceAmount = finalCost - penaltyAmount;
	        $("#totalInvoiceAmount").val(totalInvoiceAmount.toFixed(2)); // Set total invoice amount
	    } else {
	        $("#penaltyAmount").val(''); 
	        $("#totalInvoiceAmount").val(''); // Clear total invoice amount if inputs are invalid
	    }
	}

  
   
   function getMilestoneData() {
	    debugger
	     showLoader();
	    var projectId = $("#project").val();
	    var phaseId = $("#phases").val();
	    setTimeout(function () {
	        $.ajax({
	            url: "${contextPath}/getMilestoneData",
	            type: "GET",
	            data: {
	                "projectId": projectId,
	                "phaseId": phaseId
	            },
	            success: function(response) {
	                debugger
	                 hideLoader();

	                // Function to convert 'YYYY-MM-DD' date to 'DD-MM-YYYY'
	                function formatDate(dateString) {
	                    var date = new Date(dateString);
	                    var day = String(date.getDate()).padStart(2, '0');
	                    var month = String(date.getMonth() + 1).padStart(2, '0');
	                    var year = date.getFullYear();
	                    return day + '/' + month + '/' + year;
	                }

	                // Convert and set all date fields
	                var formattedExpectedDate = formatDate(response.expectedDate);
	                $("#expectedDate").val(formattedExpectedDate);
	                $("#deliveryDate").val(formattedExpectedDate);
	                $("#totalInvoiceAmount").val(response.totalInvoiceAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

	                checkByProjectStatus();
	                if(response.projectMilestoneDetailsDto!=null && response.projectMilestoneDetailsDto!=''){
// 	                	  var formattedStartDate = formatDate(response.projectMilestoneDetailsDto.startDate);
// 	  	                $("#startDate").val(formattedStartDate);

// 	  	                var formattedDeliveryDate = formatDate(response.expectedDate);
// 	  	                $("#deliveryDate").val(formattedDeliveryDate);

// 	  	                var formattedEndDate = formatDate(response.projectMilestoneDetailsDto.endDate);
// 	  	                $("#endDate").val(formattedEndDate);

	  	                $("#status").val(response.projectMilestoneDetailsDto.status);
	  	                $("#remarks").val(response.projectMilestoneDetailsDto.remarks);
	  	                $("#hiddenProjectMilestoneDetailsId").val(response.projectMilestoneDetailsDto.hiddenProjectMilestoneDetailsId);
	  	                $("#penaltyPercentage").val(response.penaltyPercentage);
		                $("#penaltyAmount").val(response.penaltyAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
						$("#saveBtn").html("Update");
						if(response.projectMilestoneDetailsDto.documentName!='' && response.projectMilestoneDetailsDto.documentName!=null){
						//	$("#viewDoc").attr("href", "${contextPath}/downloadDoc?doc="+response.projectMilestoneDetailsDto.documentName);
							$("#viewDoc").attr("href", "${contextPath}/downloadDoc?hdnPrjctMilDetId="+response.projectMilestoneDetailsDto.hiddenProjectMilestoneDetailsId);
							$("#viewDoc").removeClass("hidden");
						}
						
	  	                
// 	  	                if (response.projectMilestoneDetailsDto.status != null && response.projectMilestoneDetailsDto.status != '' && response.projectMilestoneDetailsDto.status != 'Complete') {
// 	  	    				$('.onwip').css('display', 'block');
	  	    				
// 	  	    			}else{
// 	  	    				$('.onwip').css('display', 'block');
// 	  	    			//	$('.onwip').css('display', 'none');
// 	  	    			}
	  	                
	  	                if(response.invoiceMaster!=null && response.invoiceMaster!=''){
	  	                	$("#generateInvoiceBtn").html("Download Invoice");
	  	                	 document.getElementById("saveBtn").disabled = true;
	  	                }
	  	                
	                }else{
	                	$("#viewDoc").addClass("hidden");
	                	   $("#startDate").val('');
		  	               // $("#deliveryDate").val('');
		  	                $("#endDate").val('');

		  	                $("#status").val('');
		  	                $("#remarks").val('');
		  	                $("#hiddenProjectMilestoneDetailsId").val('');
		  	                $("#penaltyPercentage").val('');
		  	                $("#penaltyAmount").val('');
	                }
	              
	            },
	            error: function(error) {
	                var html = "<option value='' >--select--</option>";
	                $('#phases').empty().append(html);
	            }
	        });
	    }, 1000);
	}

   
   
   function checkByProjectStatus() {
	    debugger
	    var finalCost = parseFloat($("#hiddenFinalCost").val()); 
	    var expectedDate = $("#expectedDate").val();

	    	debugger
	        if (expectedDate) {
	            // Split the date string 'DD-MM-YYYY'
	            var dateParts = expectedDate.split('/');
	            var day = dateParts[0];
	            var month = dateParts[1] - 1;  // JS months are 0-based (Jan is 0, Dec is 11)
	            var year = dateParts[2];

	            // Create the date object using 'YYYY-MM-DD' format
	            var expectedDateObj = new Date(year, month, day);

	            var currentDate = new Date();
	            currentDate.setHours(0, 0, 0, 0);  // Set time to 00:00:00 for accurate comparison

// 	            if (expectedDateObj > currentDate) {
// 	                $('.onwip').css('display', 'block');
// 	            } else {
// 	                $('.onwip').css('display', 'none');
// 	            }
	        }
	}

   

function validateDates() {
    var startDate = new Date($('#startDate').val());
    var endDate = new Date($('#endDate').val());
    var deliveryDate = new Date($('#deliveryDate').val());

    // Clear any previous error messages
    $('.date-error').remove();

    // Check if End Date is greater than or equal to Start Date
    if (endDate < startDate) {
        $('#endDate').after('<span class="date-error" style="color:red;">End Date must be greater than or equal to Start Date</span>');
    }

    // Check if Delivery Date is greater than or equal to Start Date and End Date
    if (deliveryDate < startDate || deliveryDate < endDate) {
        $('#deliveryDate').after('<span class="date-error" style="color:red;">Delivery Date must be greater than or equal to both Start Date and End Date</span>');
    }
}

// Initialize datepick on the date fields
$('#startDate, #endDate, #deliveryDate').datepick({
    showTrigger: '#calImg',
    onSelect: function() {
        validateDates(); // Validate dates when one is selected
    }
});


function checkPhase(phaseId){
	   	showLoader();
	   	 setTimeout(function () {
	   	  $.ajax({
	   			url:"${contextPath}/checkPhase",
	   			type : "GET",
	   			data : {
	   				"phaseId" : phaseId
	   				
	   			},
	   	success:function(response){
	   		debugger
	   		hideLoader();
	   		if(response!=null && response!=''){
	   			if(response=='notProceed'){
	   				 bootbox.alert("First insert data against previou phase.");
	   				$("#phases").val('');
	   				return false;
	   			}
	   		}
	   		
	   			},
	   	error:function(error){
	   		var html = "<option value='' >--select--</option>";
	   			$('#phases').empty().append(html);
	   		}
	   	});	
	   	 },1000);
	   }
	   
	   
	   function fetchDataForInvoiceGenerate(){
		   $("#projectForInv").val($("#project").val());
		   $("#phaseForInv").val($("#phases").val());
		   $("#invoiceGeneration").submit();
	   }
	   
	   $(document).ready(function() {
		   hideLoader();
		});
   </script>
								
		