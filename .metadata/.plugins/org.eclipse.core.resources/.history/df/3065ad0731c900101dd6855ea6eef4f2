package com.aashdit.prod.heads.hims.ipms.controller;


import javax.servlet.ServletRequest;
import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.aashdit.prod.heads.common.service.CommonService;
import com.aashdit.prod.heads.framework.core.ServiceOutcome;
import com.aashdit.prod.heads.hims.ipms.dto.RegistrationFormDto;
import com.aashdit.prod.heads.hims.ipms.model.RegistrationForm;
import com.aashdit.prod.heads.hims.ipms.service.RegistrationFormService;
import com.aashdit.prod.heads.hims.ipms.utils.ApplicationConstants;
import com.aashdit.prod.heads.hims.ipms.utils.DecryptCipherText;
import com.fasterxml.jackson.databind.ObjectMapper;

import lombok.extern.slf4j.Slf4j;


@Controller
@Slf4j
@RequestMapping("/public")
public class RegistrationFormController {

	@Autowired
	private RegistrationFormService registrationFormService;

	@Autowired
	private CommonService commonService;

	@GetMapping("/add-reg")
	public String applyRegistrationForm(Model model) {
		try {
			model.addAttribute("isLoginShow", false);
			model.addAttribute("genderList", commonService.findAllGenderByIsActiveTrue().getData());
		} catch (Exception e) {
			log.error("Exception occured in applyRegistrationForm method in RegistrationFormController",e);
		}
		return "site.registrationForm";
	}

	@PostMapping("/save-reg")
	public String saveRegistrationForm(RedirectAttributes attr,RegistrationFormDto  registrationFormDto) {
		try {
			ServiceOutcome<String> regDetails=registrationFormService.saveRegistrationDetails(registrationFormDto);
			attr.addFlashAttribute(regDetails.getOutcome()? "success_msg" : "error_msg", regDetails.getMessage());
		} catch (Exception e) {
			log.error("Exception occured in saveRegistrationForm method in RegistrationFormController",e);
		}
		return "redirect:/public/add-reg";
	}


	@GetMapping("/checkStatus")
	public String getStatus(String cipherText, ServletRequest request, Model model,Long registrationId) {

		try {
			ServiceOutcome<RegistrationFormDto> srvc=registrationFormService.getByregistrationId(registrationId);
			if(srvc.getOutcome())
			{
				model.addAttribute("registrationDetails",srvc.getData());
			}else {
				model.addAttribute("error_msg", srvc.getMessage());
			}
		}catch(Exception e)
		{
			e.getMessage();
			model.addAttribute("error_msg", "Something went wrong. Please try again.");

		}
		return "site.registration.status.check";
	}


	@GetMapping("/getRegistrationList")
	public String getRegistrationList(Model model) {
		try {
			model.addAttribute("registrationList",registrationFormService.getAllRegistration().getData());
		} catch (Exception e) {
			log.error("Error occurred in the getRegistrationList method in RegistrationFormController ====>", e);
			model.addAttribute("error_msg", "Something went wrong while loading registration list.");
		}
		return "site.registration.list";
	}

	@PostMapping("/processRegistrationStatus")
	public String processStatus(String cipherText,RedirectAttributes redirect,HttpServletRequest request) {
		try {

			String realFormData = DecryptCipherText.decryptCipherText(cipherText, request);
			if (realFormData == null || realFormData.isEmpty()) {
				redirect.addFlashAttribute(ApplicationConstants.ERROR_MSG, "Invalid form data");
				return "redirect:/public/getRegistrationList";
			}
			ObjectMapper objectMapper = new ObjectMapper();
			RegistrationFormDto registration = objectMapper.readValue(realFormData, RegistrationFormDto.class);

			ServiceOutcome<RegistrationForm> serviceOut = registrationFormService.processStatus(registration);

			if(serviceOut.getOutcome())
			{
				redirect.addFlashAttribute("success_msg", serviceOut.getMessage());
			}else {
				redirect.addFlashAttribute("error_msg", serviceOut.getMessage());
			}
		}catch(Exception e)
		{
			log.error("Error occurred in processStatus method in the CoachingController =====>"+e);

		}
		return "redirect:/public/getRegistrationList";
	}
	
	
}
