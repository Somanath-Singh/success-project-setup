<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
	pageEncoding="ISO-8859-1"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet"
	href="${contextPath}/assets/js/plugin/jquery_autocomplete/jquery.autocomplete.css" />
<script src="${contextPath}/assets/js/plugin/jquery.autocomplete.min.js"></script>
<script src="${contextPath}/assets/appJs/validation/party-master.js"></script>
<script src="${contextPath}/assets/appJs/validation/invoice.js"></script>
<style>
body {
	font-family: Arial, sans-serif;
	margin: 20px;
}

.product-list {
	margin-bottom: 20px;
}

.form-control {
	margin-right: 10px;
	margin-bottom: 10px;
}

.btn-add-product {
	margin-top: 10px;
	padding: 10px 20px;
	background-color: #007bff;
	color: #fff;
	border: none;
	cursor: pointer;
}

.btn-add-product:hover {
	background-color: #0056b3;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-top: 20px;
}

th, td {
	border: 1px solid #ddd;
	padding: 8px;
}

th {
	background-color: #1c985f;
	text-align: left;
}

body {
	font-family: Arial, sans-serif;
	background-color: #f5f5f5;
	margin: 0;
	padding: 0;
}

.container {
	max-width: 800px;
	margin: 50px auto;
	background: #fff;
	padding: 20px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

header {
	text-align: center;
	margin-bottom: 20px;
}

h1 {
	font-size: 24px;
	margin: 0;
}

.form-group {
	margin-bottom: 15px;
}

label {
	display: block;
	margin-bottom: 5px;
}

input[type="text"], input[type="date"], select {
	width: 100%;
	padding: 10px;
	border: 1px solid #ccc;
	border-radius: 5px;
}

.product-list {
	margin: 20px 0;
}

.product-item {
	display: flex;
	gap: 10px;
	margin-bottom: 10px;
}

.product-item input {
	flex: 1;
}

.totals {
	background: #f9f9f9;
	padding: 10px;
	margin: 20px 0;
}
.error-border {
	border: 2px solid red !important;
}

.total-item {
	display: flex;
	justify-content: space-between;
	padding: 5px 0;
}

button[type="button"] {
	background: #007bff;
	color: #fff;
	border: none;
	padding: 10px 20px;
	border-radius: 5px;
	cursor: pointer;
}

button[type="submit"] {
	background: #28a745;
	color: #fff;
	border: none;
	padding: 10px 20px;
	border-radius: 5px;
	cursor: pointer;
	display: block;
	width: 100%;
	margin-top: 20px;
}

button:hover {
	opacity: 0.9;
}

.remove-btn {
    background-color: #dc3545 !important; 
    border-color: #dc3545 !important; 
    color: white !important; 
}

.remove-btn:hover {
    background-color: #c82333; /* Darker red on hover */
    border-color: #bd2130; /* Darker border on hover */
}

</style>

<script>
	$(function()
	{
		$('#datatable-default').dataTable({
			"bSort": false,
			"autoWidth": false
		});
	})
</script>

<div class="container-fluid">
<!-- Start::row-1 -->
<div class="row">
	<div class="col-xl-12">
		<div class="card custom-card">
			<div class="top-left"></div>
			<div class="top-right"></div>
			<div class="bottom-left"></div>
			<div class="bottom-right"></div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-12">
						<section class="panel">
							<header class="panel-heading">
								<div>
									<div id="c" tabindex="1"></div>
								</div>
								<h4 class="panel-title">
									<span>Project Phase Map</span>
								</h4>
								<!-- <jsp:include page="/WEB-INF/views/message.jsp" /> -->
							</header>
						<div class="panel-body" id="partyDtlsInRequest">
							<div class="col-md-12">
								<form class="form-horizontal form-bordered" id="projectPhaseForm" 
									action="${contextPath}/projectPhaseMap/manage" method="post" >
                                     <input type="hidden" value="true" id="labelmsg" name="labelmsg">
                                      <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                                      <input type="hidden" id="mapId" name="mapId" value="${ProjectDetailsPhasesMap.mapId}" />
                                      <input type="hidden" id="partyId" name="partyId" value="${ProjectDetailsPhasesMap.projectId.clientId.partyId}" />

                                      <div class="row">
                                      	<!-- <h6 class="panel-title"><span>Manage Project Milestone</span></h6> -->
                                      </div>
										<div class="row">
											<div class="col-md-5">
												<label class="col-md-12 required" for="inputDefault"><spring:message
														code="LABEL.ACCOUNTS.INVOICE.PARTY.CODENAME" /></label>
												<div class="col-md-12">
													<input type="text" class="form-control"
														name="billingFromPartyName" id="billingFromPartyName"
														value="${ProjectDetailsPhasesMap.projectId.clientId.partyName}"> <input type="hidden"
														name="partyId" id="partyId" value="${ProjectDetailsPhasesMap.projectId.clientId.partyId}">
												</div>
											</div>

											<div class="col-md-2">
												<div class="form-group">
													<label for="invoice-id">Project</label> 
													<select class="form-select required" name="projectId" id="projectId" data-plugin-selectTwo 
										        	>
														<option value="${ProjectDetailsPhasesMap.projectId.projectId}">
															${ProjectDetailsPhasesMap.projectId.projectName}
														</option>
													</select>
												</div>
											</div>
														
											<div class="col-md-2 col-sm-2">
											    <div class="form-group">
											        <label class="col-md-12" for="phaseType">Phase Type:</label>
											        <div class="col-md-12">
											            <select class="form-control" name="phaseType" id="phaseType">
											                <option value="">SELECT</option>
											                <option value="D" ${data.phaseType eq 'D' ? 'selected="selected"' : ''}>Delivery</option>
											                <option value="P" ${data.phaseType eq 'P' ? 'selected="selected"' : ''}>Payment</option>
											            </select>
											        </div>
											    </div>
											</div>

											<div class="col-lg-3 col-md-3">
											    <div class="form-group">
											        <label for="phaseId" class="col-md-12"><span>Phase</span></label>
											          <div class="col-md-12">
											        <select class="ms form-control require" name="phaseId" id="phaseId" multiple>
											           <option value="${ProjectDetailsPhasesMap.phaseId.phaseId}">
											               ${ProjectDetailsPhasesMap.phaseId.phaseName}</option>
											        </select>
											        </div>
											    </div>
											</div>

											<div class="row">
                                     			<h6 class="panel-title"><span>Phases</span></h6>
                                     		 </div>
										</div>
  
									  <div class="col-md-12">
												<table class=""
													id="">
													<thead>
														<tr>
															<th>Project</th>
															<th>Phase</th>
															<th></th>
														</tr>
													</thead>
													<tbody>
														<c:forEach items="${projectPhaseMapList}" var="phaseList">
															<tr class="gradeX">
																<td>${phaseList.projectId.projectName}</td>
																<td>${phaseList.phaseId.phaseName}</td>
																
															<td><a class="btn btn-xs btn-circle btn-warning text-white btn-sm" onclick="edit('${phaseList.mapId}')"> 
														<i class="fa fa-pencil" aria-hidden="true" title=<spring:message code="COMMON.LABEL.EDIT"/>></i>
														</a></td>
															</tr>
														</c:forEach>
													</tbody>
												</table>
											</div>
										</form>
									</div>
										<div class="row">
											<div class="col-sm-12" style="margin-top: 10px;">
												<div class="form-group text-center">
												 <c:if test="${not empty ProjectDetailsPhasesMap.mapId}">
												    <input type="button" class="btn btn-success" onclick="formSubmit()" value="UPDATE" />
												 </c:if>
												
												<c:if test="${empty ProjectDetailsPhasesMap.mapId}">
												    <input type="button" class="btn btn-success" onclick="formSubmit()" value="SAVE" />
												</c:if>
													
														<a href="${contextPath}/projectPhaseMap/add">
															<input type="button" class="btn btn-danger" value="Reset">
														</a>
														<!-- /paymentReceipt/add -->
												</div>
											</div>
										</div>
									</div>
								</section>
							</div>
						<hr>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<form id="editmapid"
	action="${contextPath}/projectPhaseMap/updateprojectphaseMap" method="post">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	   <input type="hidden" name="encDataa" id="hdnData1"/>
<!-- 		<input type="hidden" name="accountGroupId"id="accountGroupId" value="" /> -->
</form>

<script>
var url='${contextPath}';

$(document).ready(function() {
	


	// amount format initializing when page loads for first 
	$('.amount-format').on('blur', function () {
        let value = parseFloat($(this).val());
        if (!isNaN(value)) {
            // Format the value to two decimal places
            $(this).val(value.toFixed(2));
        } else {
            // If the input is not a valid number, clear the field
            $(this).val('');
        }
    });

	  var partyName = '${ProjectDetailsPhasesMap.projectId.clientId.partyName}';
		console.log(partyName);
	    if (partyName == '') {
	    	$("input[name^='billingFromPartyName']").autocomplete({
	    	    serviceUrl: '${contextPath}/projectMilestone/findPartyDetailByPartyType',
	    	    paramName: "clientcode",
	    	    delimiter: ",",
	    	    width: '150px',
	    	    transformResult: function(response) {
	    	        return {
	    	            suggestions: $.map($.parseJSON(response), function(item) {
	    	                return {
	    	                    value: item.clientcode,
	    	                    data: item.clientid
	    	                };
	    	            })
	    	        };
	    	    },
	    	    onSelect: function (suggestion) {
	    	        var selectedRow = parseInt(this.parentNode.parentNode.rowIndex) - 1;
	    	        document.getElementById("partyId").value = suggestion.data;
	    			console.log(suggestion.data);

	    			// fetch invoice details by party 
	    			fetchProjectListByClientId(suggestion.data);
	    	    }
	    	});
	    } 
	
	
	
	
});


//  AJAX call to fetch project list by party id
function fetchProjectListByClientId(partyId) {
	debugger;
    $.ajax({
        url: url+ '/common/api/projectByParty',
        type: 'GET',
        data: { partyId: partyId },
        success: function(response) {
			debugger;

			// empty table
			$('#projectId').empty();
			var htm = '<option value="0">--select--</option>';
            if (response.outcome) {
				 // Iterate directly over response.data (if it's already an array)
				 response.result.forEach((project) => {
						htm += '<option value="' + project.projectId + '">' + project.projectName + '</option>';
					});		
            }
			$('#projectId').append(htm);
        },
        error: function() {
            alert('Error fetching project details.');
        }
    });
}



// AJAX call to fetch phase list by project
function fetchPhaseDetailsByProjectId(projectId) {
    debugger;
    if (projectId && projectId != '0') {
        $.ajax({
            url: url + '/projectPhaseMap/getPhaseDetailsByProject',
            type: 'GET',
            data: { projectId: projectId },
            success: function(response) {
                debugger;
                if (response.outcome) {
                    populatePhaseDetailsTable(response.result);  // Populate the milestone table
                } else {
                    emptyTable();
                    alert('Phase details not found');
                }
            },
            error: function() {
                alert('Error fetching phase details.');
            }
        });
    }else{
		emptyTable();
		$('#totalAmount').val('0.00');
	}
}




function populatePhaseDetailsTable(phaseDto) {
    let tableBody = $('#milestone-tbl-body');
    tableBody.empty();  // Clear any existing rows
    // Get today's date in the format YYYY-MM-DD
    let today = new Date().toISOString().split('T')[0];

    if (phaseDto.phaseDtoList.length === 0) {
        emptyTable();
    } else {
        $('#totalAmount').val(parseFloat(phaseDto.finalAmount).toFixed(2));
        phaseDto.phaseDtoList.forEach((phase, index) => {
            // Check if the phase has existing milestone data (e.g., percentage, amount, expectedDate)
            let percentage = phase.percentage ? phase.percentage : '';  // Set percentage if available
            let phaseAmount = phase.phaseAmount ? parseFloat(phase.phaseAmount).toFixed(2) : '';  // Set phase amount if available

            // Convert the date from 'YYYY-MM-DD HH:MM:SS.sss' to 'YYYY-MM-DD'
            let expectedDate = phase.expectedDate ? phase.expectedDate.split(' ')[0] : '';  

            // Insert input fields for Phase Percentage, Phase Amount, Expected Date, and hidden fields for IDs
            let row = '<tr>' +
                        '<td>' + (index + 1) + '</td>' +
                        '<td>' + phase.phaseName + '</td>' +
                        '<td>' +
                            '<input type="text" class="form-control text-end" ' +
                            'name="phaseDtoList[' + index + '].percentage" ' +
                            'id="phasePercentage' + index + '" ' +
                            'placeholder="Enter %" value="' + percentage + '" ' +
                            'oninput="calculatePhaseAmount(' + index + ')">' +
                        '</td>' +
                        '<td>' +
                            '<input type="hidden" value="'+phase.projectPhaseMapId+'" name="phaseDtoList[' + index + '].projectPhaseMapId" />' +
                            (phase.milestoneId ? '<input type="hidden" value="'+phase.milestoneId+'" name="phaseDtoList[' + index + '].milestoneId" />' : '') +
                            '<input type="text" class="form-control text-end" ' +
                            'name="phaseDtoList[' + index + '].phaseAmount" ' +
                            'id="phaseAmount' + index + '" value="' + phaseAmount + '" readonly>' +
                        '</td>' +
                        '<td>' +
                            '<input type="date" class="form-control" ' +
                            'name="phaseDtoList[' + index + '].expectedDate" ' +
                            'id="expectedDate' + index + '" min="'+today+'" value="' + expectedDate + '">' +
                        '</td>' +
                    '</tr>';
            tableBody.append(row);
        });
    }
}



function calculatePhaseAmount(index) {
    // Fetch the total project amount from the input field
    let totalAmount = parseFloat($('#totalAmount').val());

    // Fetch the percentage entered by the user for this phase
    let phasePercentage = parseFloat($('#phasePercentage' + index).val());

    // Calculate the phase amount if both values are available and valid
    if (!isNaN(phasePercentage) && !isNaN(totalAmount)) {
        let phaseAmount = (phasePercentage / 100) * totalAmount;
        $('#phaseAmount' + index).val(phaseAmount.toFixed(2));  // Update the phase amount input field
    } else {
        $('#phaseAmount' + index).val('0.00');  // Set to zero if invalid input
    }
}


function emptyTable(){
	let tableBody = $('#milestone-tbl-body');
	tableBody.empty();
	let noDataRow = '<tr>' +
				'<td colspan="6" class="text-center">No data found</td>' +
			'</tr>';
	tableBody.append(noDataRow);
}


//  submitting form  
function formSubmit() {
    /* let isValid = true; // Initialize isValid to true
    const partyId = $('#partyId').val();
    const projectId = $('#projectId').val();
    const phaseType = $('#phaseType').val();
    const phaseId = $('#phaseId').val();

    // Reset previous error styles
    $('input, select').removeClass('error-border');

    // Validate party selection
    if (partyId === '') {
        bootbox.alert("Please select a party");
        $('#billingFromPartyName').addClass('error-border');
        isValid = false;
        return isValid;
    }

    // Validate project selection
    if (projectId === '' || projectId === '0') {
        bootbox.alert("Please select a project");
        $('#projectId').addClass('error-border');
        isValid = false;
        return isValid;
    }
    
    if (phaseType === '' || phaseType === '0') {
        bootbox.alert("Please select at phaseType ");
        $('#phaseType').addClass('error-border');
        isValid = false;
        return isValid;
    }

    if (!phaseId || phaseId.length === 0) {
        bootbox.alert("Please select at least one phase");
        $('#phaseId').addClass('error-border');
        isValid = false;
        return isValid;
    } */

    // If all validations pass, proceed with form submission
    if (validateForm()) {
        // const flag = window.confirm("Do you want to save the data?");
        // if (flag) {
        //     $("#milestoneForm").submit();
        // }
		confirmation('projectPhaseForm');
    }
}


function edit(mapId){
	  var mapIddata = mapId.toString();
  $("#hdnData1").val(AES256.encrypt(mapIddata));
  $("#editmapid").submit();
}

$(document).ready(function() {
    var selectedPhaseType = '${ProjectDetailsPhasesMap.phaseId.phaseType}'; 
    var initialPhaseId = '${ProjectDetailsPhasesMap.phaseId.phaseId}'; 


    function fetchPhases(phaseType) {
        $('#phaseId').empty().append('<option value="0"></option>');

        $.ajax({
            url: '${contextPath}/projectPhaseMap/getPhaseTypeWiseByPhase/' + phaseType, 
            type: 'GET',
            success: function(data) {
             
                $.each(data, function(index, projectPhase) {
                    $('#phaseId').append($('<option>', {
                        value: projectPhase.phaseId,
                        text: projectPhase.phaseName
                    }));
                });

              
                if (initialPhaseId) {
                    $('#phaseId').val(initialPhaseId);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching phases:', error);
                alert('An error occurred while fetching phases. Please try again.');
            }
        });
    }

    
    if (selectedPhaseType) {
        $('#phaseType').val(selectedPhaseType).change(); 
    }

    $('#phaseType').change(function() {
        var selectedType = $(this).val(); 

        if (selectedType) {
            fetchPhases(selectedType); 
        } else {
            
            $('#phaseId').empty().append('<option value="0">--select--</option>');
        }
    });
});


</script>