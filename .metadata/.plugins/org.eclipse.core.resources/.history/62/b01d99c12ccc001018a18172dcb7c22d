<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<fmt:formatDate value="${now}" pattern="dd-MM-yyyy" var="currentDate" />


<!-- NOTE: CSS & JS should be in <head> or Tiles <put-attribute name="js"> -->
<!-- Remove <link> and <script> from here â€” move to Tiles layout or header -->

<!-- Breadcrumb -->
<%-- <div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Building Maintenance</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i
						class="fa fa-home"></i> Home</a></li>
				<li class="breadcrumb-item active" aria-current="page">Building
					Planning List</li>
			</ol>
		</nav>
	</div>
</div> --%>
<div class="card mt-3">
	<div class="card-header"><h5 class="card-title">BAMS Maintenance Details</h5></div>
	<div class="card-body">
		<form action="${contextPath}/bams/maintenance/save" id="maintenanceForm" method="post" enctype="multipart/form-data" class="">
			<input type="hidden" id="cipherText" name="cipherText" /> 
			<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
			<input type="hidden" id="maintenanceId" name="maintenanceId" value="${maintenance.maintenanceId}" />
			<div class="row">
				<!-- DISTRICT -->
				<div class="col-md-3">
					<div class="form-group">
						<label class="required">District :</label> <select
							class="form-control form-control-sm form-select" id="districtId"
							name="districtId" onchange="LoadBlockByDistrict(this.value)"
							required>
							<option value="" disabled selected>- Select -</option>
							<c:forEach items="${districtList}" var="d">
								<option value="${d.districtId}"
									${d.districtId eq maintenance.districtId ? 'selected':''}>
									${d.districtName}</option>
							</c:forEach>
						</select>
					</div>
				</div>

				<!-- AREA TYPE -->
				<div class="col-md-3">
					<div class="form-group">
						<label class="required">Area Type :</label> <select id="areaType"
							name="areaType" class="form-control form-control-sm form-select"
							onchange="toggleAreaType(this.value)" required>
							<option value="" disabled selected>- Select -</option>
							<option value="RURAL"
								${maintenance.areaType eq 'RURAL'?'selected':''}>Rural</option>
							<option value="URBAN"
								${maintenance.areaType eq 'URBAN'?'selected':''}>Urban</option>
						</select>
					</div>
				</div>

				<!-- BLOCK (RURAL) -->
				<div class="col-md-3 ruralSection" style="display: none;">
					<div class="form-group">
						<label class="required">Block :</label> <select id="blockId"
							name="blockId" class="form-control form-control-sm form-select"
							onchange="LoadGrampanchayatByBlock(this.value)">
							<option value="" disabled selected>- Select -</option>
							<c:forEach items="${blockList}" var="b">
								<option value="${b.blockId}"
									${b.blockId eq maintenance.blockId ? 'selected':''}>
									${b.blockName}</option>
							</c:forEach>
						</select>
					</div>
				</div>

				<!-- GP (RURAL) -->
				<div class="col-md-3 ruralSection" style="display: none;">
					<div class="form-group">
						<label class="required">GramPanchayat :</label> <select id="gpId"
							name="gpId" class="form-control form-control-sm form-select"
							onchange="LoadVillageByGrampanchayat(this.value)">
							<option value="" disabled selected>- Select -</option>
							<c:forEach items="${gpList}" var="gp">
								<option value="${gp.gpId}"
									${gp.gpId eq maintenance.gpId ? 'selected':''}>
									${gp.gpName}</option>
							</c:forEach>
						</select>
					</div>
				</div>

				<!-- VILLAGE -->
				<div class="col-md-3 ruralSection" style="display: none;">
					<div class="form-group">
						<label class="required">Village :</label> <select id="villageId"
							name="villageId" class="form-control form-control-sm form-select">
							<option value="" disabled selected>- Select -</option>
							<c:forEach items="${villageList}" var="v">
								<option value="${v.villageId}"
									${v.villageId eq maintenance.villageId ? 'selected':''}>
									${v.villageName}</option>
							</c:forEach>
						</select>
					</div>
				</div>



				<!-- ======== Urban Section ======== -->
				<div class="col-md-3 urbanSection" style="display: none;">
					<div class="form-group">
						<label class="col-md-12 required" for="municipalityId">Municipality Name :</label>
						<div class="col-md-12">
							<select id="municipalityId" name="municipalityId"
								class="form-control form-control-sm form-select"
								onchange="LoadWardByMunicipality(this.value)">
								<option value="" selected disabled>- Select -</option>
								<c:if test="${not empty municipalityList}">
									<c:forEach var="municipality" items="${municipalityList}">
										<option value="${municipality.municipalityId}"
											${municipality.municipalityId eq maintenance.municipalityId ? 'selected' : ''}>
											${municipality.municipalityName}</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
				</div>

				<div class="col-md-3 urbanSection" style="display: none;">
					<div class="form-group">
						<label class="col-md-12 required" for="wardId">Ward Name :</label>
						<div class="col-md-12">
							<select id="wardId" name="wardId"
								class="form-control form-control-sm form-select">
								<option value="" selected disabled>- Select -</option>
								<c:if test="${not empty wardList}">
									<c:forEach var="ward" items="${wardList}">
										<option value="${ward.wardId}"
											${ward.wardId eq maintenance.wardId ? 'selected' : ''}>
											${ward.wardName}</option>
									</c:forEach>
								</c:if>
							</select>
						</div>
					</div>
				</div>

				<!-- MAIN TYPE -->
				<div class="col-md-3">
					<div class="form-group">
						<label class="required">Main Type :</label> <select id="mainId"
							name="mainId" class="form-control form-control-sm form-select">
							<option value="" disabled selected>- Select -</option>
							<c:forEach items="${mainTypeList}" var="m">
								<option value="${m.maintenceId}"
									${m.maintenceId eq maintenance.mainId ? 'selected' : ''}>
									${m.maintenceName}</option>


							</c:forEach>
						</select>
					</div>
				</div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="required">Building Type :</label> <select
							id="buildingType" name="buildingType"
							class="form-control form-control-sm form-select"
							onchange="getBuildingNameByBuildingType(this.value,'buildingId');"
							required>

							<option value="" selected>- Select -</option>

							<c:forEach var="buildType" items="${buildingTypeList}">
								<option value="${buildType.valueEn}"
									${maintenance.buildingType == buildType.valueEn ? 'selected' : ''}>
									${buildType.valueEn}</option>
							</c:forEach>
						</select>

					</div>
				</div>
				<div class="col-md-3">
					<div class="form-group">
						<label class="required">Building Name :</label> <select
							id="buildingId" name="buildingId"
							class="form-control form-control-sm form-select" required>
							<option value="" selected>- Select -</option>
						</select>


					</div>
				</div>
				<!-- LOCATION NAME -->
				<div class="col-md-3">
					<div class="form-group">
						<label class="required">Location Name :</label> <input type="text"
							id="locationName" name="locationName"
							class="form-control form-control-sm"
							value="${maintenance.locationName}" required />
					</div>
				</div>

				<%--   <!-- HOSTEL NAME -->
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="required">Hostel Name :</label>
                        <input type="text" id="hostelName" name="hostelName"
                               class="form-control form-control-sm"
                               value="${maintenanceDTO.hostelName}" required/>
                    </div>
                </div> --%>

				<!-- PROJECT START DATE -->
				<div class="col-md-3">
					<label class="required" for="projectStartDate">Project Start Date :</label>
					<div class="datepicker-box">
						<input type="text" id="projectStartDate" name="projectStartDate"
							class="form-control form-control-sm datepicker"
							value="${maintenance.projectStartDate}" readonly />
					</div>
				</div>


				<!-- PROJECT END DATE -->
				<div class="col-md-3">
					<label class="required" for="projectEndDate">Project End Date :</label>
					<div class="datepicker-box">
						<input type="text" id="projectEndDate" name="projectEndDate"
							class="form-control form-control-sm datepicker"
							value="${maintenance.projectEndDate}" readonly />
					</div>
				</div>


				<!-- LAST REPAIRED DATE -->
				<div class="col-md-3">
					<label class="required" for="lastRepairedDate">Last Repaired Date :</label>
					<div class="datepicker-box">
						<input type="text" id="lastRepairedDate" name="lastRepairedDate"
							class="form-control form-control-sm datepicker"
							value="${maintenance.lastRepairedDate}" readonly />
					</div>
				</div>



                <!-- DATE TILL TODAY -->
				<div class="col-md-3">
					<div class="form-group mb-3">
						<label class="required">Date till Today :</label> <input type="text"
							class="form-control form-control-sm" id="dateTillToday"
							name="dateTillToday" readonly />
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Pre Work Image :</label>

					<div class="col-md-12 position-relative">

						<input type="file" id="preWorkImage" name="preWorkImage"
							class="form-control form-control-sm" accept="image/*"
							onchange="uploadFileCheck(this)"
							<c:if test="${not empty maintenance.preWorkImagePath}">
                    			data-existing="true"
               				</c:if> />

						<c:if test="${not empty maintenance.preWorkImagePath}">
							<button type="button"
								class="btn btn-sm btn-primary position-absolute"
								style="right: 1px; top: 1px;bottom: 0;"
								onclick="viewDocument('${maintenance.preWorkImagePath}', 'BAMS_PRE_WORK_IMAGE')"
								title="View Image">
								<i class="fa fa-download"></i>
							</button>

							<span style="font-size: 12px; color: #7b3f00; font-weight: 600;">
								${fn:substringAfter(maintenance.preWorkImagePath, '/')} </span>
						</c:if>

					</div>
				</div>


				<div class="form-group col-md-3">
					<label class="required">UC Document :</label>

					<div class="col-md-12 position-relative">

						<input type="file" id="ucDocument" name="ucDocument"
							class="form-control form-control-sm" accept=".pdf,.doc,.docx"
							onchange="uploadFileCheck(this)"
							<c:if test="${not empty maintenance.ucDocumentPath}">
                    			data-existing="true"
               				</c:if> />

						<c:if test="${not empty maintenance.ucDocumentPath}">
							<button type="button"
								class="btn btn-sm btn-primary position-absolute"
								style="right: 1px; top: 1px;bottom: 0;"
								onclick="viewDocument('${maintenance.ucDocumentPath}', 'BAMS_UC_DOCUMENT')"
								title="View Document">
								<i class="fa fa-download"></i>
							</button>

							<span style="font-size: 12px; color: #7b3f00; font-weight: 600;">
								${fn:substringAfter(maintenance.ucDocumentPath, '/')} </span>
						</c:if>

					</div>
				</div>
				<div class="col-md-12 text-end mt-3" style="">
					<c:set var="dynamicFromId" value="maintenanceForm" scope="request" />
					<c:set var="wonFunction" value="submitMaintenanceForm()" />
					<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
				</div>
			</div>
		</form>
	</div>
</div>

<script>
function toggleAreaType(type) {
    const districtId = $("#districtId").val();

    $(".ruralSection, .urbanSection").hide();

    if (!districtId) {
        bootbox.alert("Please select District first.");
        $("#areaType").val("");
        return;
    }

    if (type === "RURAL") {
        $(".ruralSection").slideDown();
        if('${maintenance.maintenanceId}'==='')
        	LoadBlockByDistrict(districtId);
    } else {
        $(".urbanSection").slideDown();
        if('${maintenance.maintenanceId}'==='')
        	LoadMunicipalityByDistrict(districtId);
    }
}

$(document).ready(function() {

    const at = '${maintenance.areaType}';

    if (at) toggleAreaType(at);

});

function validateMaintenanceForm() {
    debugger;

    // Grab all fields
    const districtId = $("#districtId").val();
    const areaType = $("#areaType").val();
    const mainId = $("#mainId").val();
    const buildingType = $("#buildingType").val();

    const locationName = $("#locationName").val()?.trim();
    //const hostelName = $("#hostelName").val()?.trim();

    const projectStartDate = $("#projectStartDate").val();
    const projectEndDate = $("#projectEndDate").val();
    const lastRepairedDate = $("#lastRepairedDate").val();
    const dateTillToday = $("#dateTillToday").val();

    const preWorkFileEl = $("#preWorkImage").get(0);
    const ucDocumentEl = $("#ucDocument").get(0);

    const hasPreWorkImage = preWorkFileEl && preWorkFileEl.files.length > 0;
    const hasUcDocument = ucDocumentEl && ucDocumentEl.files.length > 0;

    const existingPreWork = $("#preWorkImage").data("existing");
    const existingUcDoc = $("#ucDocument").data("existing");

    // Date helper
    const toDate = (d) => {
        let parts = d.split("-");
        return new Date(parts[2], parts[1] - 1, parts[0]);
    };

    // ------------------- Validations -------------------

    if (!districtId) { bootbox.alert("Please select District."); return false; }

    if (!areaType) { bootbox.alert("Please select Area Type."); return false; }

    if (areaType === "RURAL") {
        if (!$("#blockId").val()) { bootbox.alert("Please select Block."); return false; }
        if (!$("#gpId").val()) { bootbox.alert("Please select Gram Panchayat."); return false; }
        if (!$("#villageId").val()) { bootbox.alert("Please select Village."); return false; }
    }

    if (areaType === "URBAN") {
        if (!$("#municipalityId").val()) { bootbox.alert("Please select Municipality."); return false; }
        if (!$("#wardId").val()) { bootbox.alert("Please select Ward."); return false; }
    }

    if (!mainId) { bootbox.alert("Please select Main Type."); return false; }
    if (!buildingType) { bootbox.alert("Please select Building Type."); return false; }
    if (!locationName) { bootbox.alert("Please enter Location Name."); return false; }
    //if (!hostelName) { bootbox.alert("Please enter Hostel Name."); return false; }

    if (!projectStartDate) { bootbox.alert("Please select Project Start Date."); return false; }
    if (!projectEndDate) { bootbox.alert("Please select Project End Date."); return false; }

    // Start < End Date
    if (projectStartDate && projectEndDate) {
        let start = toDate(projectStartDate);
        let end = toDate(projectEndDate);
        if (end < start) {
            bootbox.alert("Project End Date cannot be earlier than Project Start Date.");
            return false;
        }
    }

    if (!lastRepairedDate) { bootbox.alert("Please select Last Repaired Date."); return false; }

    // Last Repaired >= End Date
    if (projectEndDate && lastRepairedDate) {
        let end = toDate(projectEndDate);
        let repaired = toDate(lastRepairedDate);

        if (repaired < end) {
            bootbox.alert("Last Repaired Date cannot be earlier than Project End Date.");
            return false;
        }
    }

    if (!dateTillToday) { bootbox.alert("Date Till Today is missing."); return false; }

    // File validations
    if (!hasPreWorkImage && !existingPreWork) {
        bootbox.alert("Please upload Pre Work Image.");
        return false;
    }

    if (!hasUcDocument && !existingUcDoc) {
        bootbox.alert("Please upload UC Document.");
        return false;
    }

    $("#currentStatus").val("File Upload Section");

    return true;
}



  
function submitMaintenanceForm() {

    if (!validateMaintenanceForm()) {

        return false;
    }
    else{
    	let formDataArray = $("#maintenanceForm")
        .find("input:not([type='file']):not([name='_csrf']):not([name='cipherText']), select, textarea")
        .serializeArray();

    $("#cipherText").val(
        enc_password(JSON.stringify(convertFormToJSONArray(formDataArray)))
    );

    bootbox.confirm("Do You Want To Continue?", function(result) {
        if (result) {
            showLoader();
            $("#maintenanceForm").submit();
        }
    });
    }

    
}
function getBuildingNameByBuildingType(buildingType, targetId) {
    $.ajax({
        type: "GET",
        url: "${contextPath}/bams/getBuildingDetails",
        data: { buildingType: buildingType },
        success: function (response) {

            var buildingData = response.data;
            var selectedBuildingId = '${assetData.buildingId}'; // <--- THIS IS THE EDIT VALUE

            var $buildingSelect = $("#" + targetId);
            $buildingSelect.empty();
            $buildingSelect.append('<option value="" disabled>- Select -</option>');

            if (buildingData && buildingData.length > 0) {
                $.each(buildingData, function (index, building) {

                    var selected = (selectedBuildingId == building.buildingId) ? "selected" : "";

                    $buildingSelect.append(
                        '<option value="' + building.buildingId + '" ' + selected + '>' +
                        building.buildingName +
                        '</option>'
                    );
                });
            }
        },
        error: function () {
            alert("Error loading building details!");
        }
    });
}

$(document).ready(function () {
    var buildingType = $("#buildingType").val();
    if (buildingType) {
        getBuildingNameByBuildingType(buildingType, "buildingId");
    }

    if (typeof $.datepick !== 'undefined') {
        $(".datepicker").datepick({
            dateFormat: "dd-mm-yyyy",
            yearRange: "c-20:c+10",
            showOnFocus: true,
            showTrigger: '<button type="button" class="trigger btn btn-sm"><i class="fa fa-calendar"></i></button>'
        });
    }
});



$(document).ready(function () {
    if (typeof $.datepick !== 'undefined') {
      $(".datepicker").datepick({
        dateFormat: "dd-mm-yyyy",
        yearRange: "c-20:c+10",
        showOnFocus: true,
        showTrigger: '<button type="button" class="trigger btn btn-sm"><i class="fa fa-calendar"></i></button>'
      });
    } else {
      console.warn("jQuery Datepick plugin not loaded. Datepicker disabled.");
    }
  });
  
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();

    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0'); 
    const yyyy = today.getFullYear();

    const formattedDate = dd + "-" + mm + "-" + yyyy;

    document.getElementById('dateTillToday').value = formattedDate;
});

  

</script>

