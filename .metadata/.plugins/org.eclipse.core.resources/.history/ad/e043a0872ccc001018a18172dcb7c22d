<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
	pageEncoding="ISO-8859-1"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<sec:authentication var="principal" property="principal" />
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
<link rel="stylesheet"
	href="${contextPath}/assets/js/plugin/jquery_autocomplete/jquery.autocomplete.css" />
<script src="${contextPath}/assets/js/plugin/jquery.autocomplete.min.js"></script>
<script src="resources/javascripts/common.js"></script>
<script src="${contextPath}/assets/appJs/validation/party-master.js"></script>
<script src="${contextPath}/assets/appJs/validation/invoice.js"></script>
<script src="${contextPath}/assets/js/ipmsJs/ipms.js"></script>
<%@ page import="com.aashdit.fams.utils.ApplicationStringUtilsFams" %> 

<style>

</style>

<div class="breadcrumb_conatiner">
    <div class="col-md-6">
        <h4 class="change-color">Deviation Statement</h4>
    </div>
    <div class="col-md-6">
        <nav aria-label="breadcrumb">
	        <ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home" title="Home"><i class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Deviation Statement</li>
			</ol>
        </nav>
     </div>
</div>
<div class="row">
	<div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title">Deviation Statement</h6>
            </div>
            <div class="card-body">
                <div class="col-md-12">
                    <form action="${contextPath}/deviation/statement" method="POST" id="devStatementForm" autocomplete="off" enctype="multipart/form-data">
                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                        <input type="hidden" name="actionCode" id="actionCode" value="ADD"/>
                        <input type="hidden" name="deviationId" id="deviationId" value="${mainData.deviationId}" />
                        <input type="hidden" id="cipherText" name="cipherText">
                        <div class="row">
                         <%@ include file="/WEB-INF/views/entityIdAndUserLevelListDrp.jsp"%>
                            <div class="col-md-2 col-sm-3">
                                <div class="form-group">
                                    <label for="estimationNo" class="required ">Project</label>
                                    <div class="col-md-12">
                                        <select class="form-control require " name="projectId"
                                            id="projectId"
                                            onchange="featchWorkOrdersByProject(this.value,0,'workOrder')">
                                            <option value="">
                                                <spring:message code="COMMON.LABEL.DROPDOWN.SELECT" />
                                            </option>
                                            <c:forEach items="${projectList}" var="project">
                                                <option value="${project.projectId}" ${project.projectId eq mainData.projectId ? 'selected' : ''}>${project.projectCode} | ${project.projectName}</option>
                                            </c:forEach>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-3">
                                <div class="form-group">
                                    <label for="workOrder" class="required">Workorder:</label>
                                    <div class="col-md-12">
                                        <select class="form-control" name="workorderId" id="workOrder"
                                            onchange="featchBoqListByWorkOrder(this.value,0,'boqMstId')">
                                            <option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
                                            <c:forEach items="${workList}" var="workorder">
                                                <option value="${workorder.workOrderId}" ${workorder.workOrderId eq mainData.workorderId ? 'selected' : ''}>${workorder.workOrderNo}</option>
                                            </c:forEach>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-3">
                                <div class="form-group">
                                    <label for="estimationNo" class="required ">BOQ</label>
                                    <div class="col-md-12">
                                        <select class="form-control require" name="boqMstId" id="boqMstId" onchange="featchMeasurementListByBoq(this.value,0,'msmntMstId')">
                                            <option value=""><spring:message code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-3">
                                <div class="form-group">
                                    <label for="workOrder" class="required">Measurement:</label>
                                    <div class="col-md-12">
                                        <select class="form-control unfreezeField" name="msmntMstId"
                                            id="msmntMstId" onchange="getParticularsBymsmntMstId()">
                                            <option value=""><spring:message
                                                    code="COMMON.LABEL.DROPDOWN.SELECT" /></option>
                                            <c:forEach items="${msmntList}" var="msmnt">
                                                <option value="${msmnt.msmntMstId}"
                                                    ${msmnt.msmntMstId eq mainData.msmntMstId ? 'selected' : ''}>${msmnt.measurementCode}</option>
                                            </c:forEach>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <hr />
                            <div class="row">
                                <h6 class="panel-title">
                                    <span>Deviation Statement</span>
                                </h6>
                            </div>
                            <div class="table-responsive">
                                <table  class="table table-bordered " id="boq-table">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Sl. No.</th>
                                            <th rowspan="2">Item Name</th>
                                            <th rowspan="2">Description of Work</th>
                                            <th rowspan="2">Unit</th>
                                            <th rowspan="2">Rate</th>
                                            <th colspan="2">As per Agreement Provision</th>
                                            <th colspan="2">As per Actual Execution</th>
                                            <th rowspan="2">Quantity (Excess/Less)</th>
                                            <th rowspan="2">Amount (Excess/Less)</th>
                                            <th rowspan="2" class="required">Reason of Excess or Less</th>
                                        </tr>
                                        <tr>
                                            <th>Quantity</th>
                                            <th>Amount</th>
                                            <th>Quantity</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>

                                    <tbody id="tbd" class="appendBox">
                                        <c:set var="notExact" value="true"></c:set>
                                        <c:forEach items="${mainData.particulars}" var="prticlrs"
                                            varStatus="count">
                                            <input type="hidden" name="particulars[${count.index}].prtclrId"
                                                value="${prticlrs.prtclrId}" />
                                            <tr>
                                                <td>${count.count}</td>
                                                <td>${prticlrs.measurementBookData.boqItem.itemName}</td>
                                                <td>${prticlrs.measurementBookData.boqItem.description}</td>
                                                <td>${prticlrs.measurementBookData.boqItem.unitType.unitTypeName}</td>
                                                <td>${ApplicationStringUtilsFams.convertDoubleToTwoDecimal(prticlrs.measurementBookData.boqItem.ratePerUnit)}</td>
                                                <td>${ApplicationStringUtilsFams.convertDoubleToTwoDecimal(prticlrs.measurementBookData.boqItem.quantity)}</td>
                                                <td>${ApplicationStringUtilsFams.convertDoubleToTwoDecimal(prticlrs.measurementBookData.boqItem.totalAmt)}</td>
                                                <td>${ApplicationStringUtilsFams.convertDoubleToTwoDecimal(prticlrs.measurementBookData.totalPrtclrQnty)}</td>
                                                <td>${ApplicationStringUtilsFams.convertDoubleToTwoDecimal(prticlrs.measurementBookData.totalPrtclrAmt)}</td>
                                                <td>${((prticlrs.measurementBookData.boqItem.quantity) - (prticlrs.measurementBookData.totalPrtclrQnty)) < 0 ? ApplicationStringUtilsFams.convertDoubleToTwoDecimal(((prticlrs.measurementBookData.boqItem.quantity) - (prticlrs.measurementBookData.totalPrtclrQnty)) * -1) : ApplicationStringUtilsFams.convertDoubleToTwoDecimal(((prticlrs.measurementBookData.boqItem.quantity) - (prticlrs.measurementBookData.totalPrtclrQnty)))}
                                                    [${((prticlrs.measurementBookData.boqItem.quantity) - (prticlrs.measurementBookData.totalPrtclrQnty)) eq 0 ? 'No Changes' : ((prticlrs.measurementBookData.boqItem.quantity) - (prticlrs.measurementBookData.totalPrtclrQnty)) < 0 ? 'Excess' : 'Less'}]</td>
                                                <td>${((prticlrs.measurementBookData.boqItem.totalAmt) - (prticlrs.measurementBookData.totalPrtclrAmt)) < 0 ? ApplicationStringUtilsFams.convertDoubleToTwoDecimal(((prticlrs.measurementBookData.boqItem.totalAmt) - (prticlrs.measurementBookData.totalPrtclrAmt)) * -1) : ApplicationStringUtilsFams.convertDoubleToTwoDecimal(((prticlrs.measurementBookData.boqItem.totalAmt) - (prticlrs.measurementBookData.totalPrtclrAmt)))}
                                                    [${((prticlrs.measurementBookData.boqItem.totalAmt) - (prticlrs.measurementBookData.totalPrtclrAmt)) eq 0 ? 'No Changes' : ((prticlrs.measurementBookData.boqItem.totalAmt) - (prticlrs.measurementBookData.totalPrtclrAmt)) < 0 ? 'Excess' : 'Less'}]</td>
                                                <td>
                                                    <div class="col-md-12 col-sm-12">
                                                        <div class="form-group">
                                                            <input type="text" class="form-control require" id="reason${count.index}"
                                                                name="particulars[${count.index}].reason"
                                                                value="${prticlrs.reason}" />
                                                        </div>
                                                    </div>
                                                </td>
                                                <c:if
                                                    test="${(((prticlrs.measurementBookData.boqItem.quantity) - (prticlrs.measurementBookData.totalPrtclrQnty)) ne 0 or ((prticlrs.measurementBookData.boqItem.totalAmt) - (prticlrs.measurementBookData.totalPrtclrAmt)) ne 0) and notExact}">
                                                    <c:set var="notExact" value="false"></c:set>
                                                </c:if>
                                            </tr>
                                        </c:forEach>
                                    </tbody>
                                </table>
                            </div>
                            <div class="row">
                                <div class="col-sm-12" style="margin-top: 30px;">
                                    <div class="form-group text-center">
                                        <c:if
                                            test="${mainData.deviation.stageForwardedRule.stage.stageCode eq 'FINAL' or (notExact eq true and not empty mainData.particulars)}">
                                            <!-- //TODO -->
                                            <input type="button" class="btn btn-success unfreezeField"
                                                onclick="runningBill()" value="Running Bill" />
                                        </c:if>
                                        <c:if
                                            test="${not empty mainData.particulars and notExact eq false}">
                                            <c:set var="dynamicFromId" value="devStatementForm"
                                                scope="request" />
                                            <c:set var="wonFunction" value="submitFormData()" />
                                            <%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
                                        </c:if>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<form action="${contextPath}/deviation/running-bill" method="GET" id="runningBillForm">
<input type="hidden" name="msmntMstId" id="hdnMsmntMstId" />
</form>

<script>


$( document ).ready(function() {
	
	var projectId= '${mainData.projectId}';
	var workorderId='${mainData.workorderId}';
	var boqMstId='${mainData.boqMstId}';
	var msmntMstId='${mainData.msmntMstId}';
	
	
	if(projectId!='' && workorderId!='' ){
		featchWorkOrdersByProject(projectId,workorderId,'workOrder');
	}
	if(workorderId!='' && boqMstId!='' ){
	featchBoqListByWorkOrder(workorderId,boqMstId,'boqMstId');
	}
	if(boqMstId!='' && msmntMstId!='' ){
	featchMeasurementListByBoq(boqMstId,msmntMstId,'msmntMstId')
	}
	

});

function submitFormData(){
	if($('#msmntMstId').val() == ''){
		bootbox.alert('Please select measurement.');
		return false;
	} 
	else {
		if(validateForm()){
		bootbox.confirm({
	        message: "Do you want to save all the details ?",
	        buttons: {
	            confirm: {
	                label: 'Yes',
	                className: 'btn-success'
	            },
	            cancel: {
	                label: 'No',
	                className: 'btn-danger'
	            }
	        },
	        callback: async (result) => {
	            if (result) {
	            	showLoader();
// 	            	$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#devStatementForm").serializeArray()))));
	            	$("#devStatementForm").submit();
	            }
	        }
	    });
	 }
	}
}

function runningBill(){
	if($('#msmntMstId').val() == ''){
		bootbox.alert('Please select measurement.');
		return false;
	} 
	else {
		bootbox.confirm({
	        message: "Are you sure ?",
	        buttons: {
	            confirm: {
	                label: 'Yes',
	                className: 'btn-success'
	            },
	            cancel: {
	                label: 'No',
	                className: 'btn-danger'
	            }
	        },
	        callback: async (result) => {
	            if (result) {
	            	showLoader();
	            	$('#hdnMsmntMstId').val(btoa($('#msmntMstId').val()));
// 	            	$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#devStatementForm").serializeArray()))));
	            	$("#runningBillForm").submit();
	            }
	        }
	    });
	}
}

function uploadBoq(){
	if($('#msmntMstId').val() == ''){
		bootbox.alert('Please select measurement.');
		return false;
	} 
	else {
		bootbox.confirm({
	        message: "Are you sure ?",
	        buttons: {
	            confirm: {
	                label: 'Yes',
	                className: 'btn-success'
	            },
	            cancel: {
	                label: 'No',
	                className: 'btn-danger'
	            }
	        },
	        callback: async (result) => {
	            if (result) {
	            	showLoader();
// 	            	$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#devStatementForm").serializeArray()))));
	            	$("#devStatementForm").submit();
	            }
	        }
	    });
	}
}

function getParticularsBymsmntMstId(){
	if($('#msmntMstId').val() != ''){
		$("#actionCode").val('EDIT');
		showLoader();
// 		$("#cipherText").val(enc_password(JSON.stringify(convertFormToJSONArray($("#devStatementForm").serializeArray()))));
		$("#devStatementForm").submit();
	}
}


</script>