<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/AadharVaidator.js"></script>
<jsp:useBean id="strUtils" class="com.aashdit.common.utils.ApplicationStringUtils"/> 
			
			
				
				<div class="breadcrumb_conatiner">
					<div class="col-md-6">
						<h4 class="change-color">Manage Budget</h4>
					</div>
					<div class="col-md-6">
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb">
								<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
								<li class="breadcrumb-item active" aria-current="page">Add Budget</li>
							</ol>
						</nav>
					</div>
				</div>
				
				

		<div class="row mt-2">
			<div class="col-md-12">
				<div class="card full-height">
					<div class="card-header">
						<h4 class="card-title"> Budget</h4>

					</div>
					<div class="card-body">

						<form class="form-horizontal" action="${contextPath}/bdg/budget/add" method="post" enctype="multipart/form-data" id="form">
							<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
							<input type="hidden" name="budgetId" value="${budget.budgetId}"/>
							<input type="hidden" class="" id="encodedDataform" name="encodedDataform" value="" />
						
							<div class="row">
								<div class="col-md-3">
									<div class="form-group">
										<label class="col-md-12 smallInput required" for="">Financial Year :</label>
										<div class="col-md-12">
											<select class="form-control form-select requiredField ${not empty budget.finyear.finyearId ? 'frezz' : ''}" id="finyearId" name="finyearId"  onchange="getBudgetAmount()" >
												<option value="">--Select--</option>
												<c:forEach items="${lstFinyear}" var="finyear">
													<option value="${finyear.finyearId}" ${finyear.finyearId eq budget.finyear.finyearId ? 'selected':'' }>${finyear.finYear}</option>
												</c:forEach>
												
											</select>
										</div>
									</div>
								</div>
								<c:set var="functionList" value="getBudgetAmount()"/>
								<%@ include file="/WEB-INF/views/entityIdAndUserLevelListForMst.jsp"%>
								
								<div class="col-md-3">
									<div class="form-group">
										<label class="required">Budget Creation Date :</label>
										<div class="col-md-12 datepicker_con">
											<input type="text" class="form-control form-control-sm disbursDate requiredField" name="transDate" id="transDate" readonly="readonly" required="required"  value="<fmt:formatDate pattern="dd/MM/yyyy" value='${budget.transDate}' />" >

										</div>
									</div>
								</div>
									<div class="col-md-3" id="bdg">
										<div class="form-group">
											<label class="required">Approved Budget Amount untill today :</label>
											<div class="col-md-12">
											<input type="text" class="form-control form-control-sm x-turnover NumbersOnlyForAmount frezz"  id="budgAmt" name="stillAppBudgetAmount" maxlength="15" value="${budget.stillAppBudgetAmount}" readonly>
											</div>
										</div>
									</div>
								 <div class="col-md-3">
									<div class="form-group">
										<label class="required">Amount :</label>
										<div class="col-md-12">
												<input type="hidden" class="form-control form-control-sm x-turnover greaterThanZero" id="turnover1" name="amount"  value="${budget.amount}" maxlength="15">
										<input type="text" class="form-control form-control-sm x-turnover NumbersOnlyForAmount numberWithTwoDesimal greaterThanZero requiredField onClickInput"  id="turnover1Converted" value="${not empty budget ? strUtils.convertAmountToINRFormat(budget.amount) : 0}" maxlength="15" onchange="currencyConverter(this.value,'turnover1Converted')">
										</div>
									</div>
								</div> 
							</div>
							<!-- <div class="col-md-12 mt-3 text-center">
								<button type="button" class="btn btn-sm btn-success" onclick="saveBudgetForm();">${not empty budget ? 'Update' : 'Save'}</button>
								<a class="btn btn-sm btn-warning" href="${contextPath}/bdg/budget/list?tabCode=${tabCode}"> Back </a>
							</div> -->
							<c:set var="dynamicFromId" value="form" scope="request" />
							<%@ include file="/WEB-INF/views/stageConfig/stageButton.jsp"%>
						</form>
					</div>
				</div>
			</div>
		</div>
            
 <script>
	$(document).ready(function(){
		var res='${not empty budget && budget.stillAppBudgetAmount > 0}';
		if(res=='' || res=='false'){
			$("#bdg").hide();
		}
		
	});

	function findSubHeadListByHeadId(headId){
		$.ajax({
			type : "GET",
			url : '${contextPath}/ecashcommon/findSubHeadListByHeadId',
			dataType : "json",
			data : {
				"headId" : headId,
			},
			success : function(response) {
				var html = "<option value='' selected>-Select-</option>";
				var data = response;
				if (data != "" && data != null && data.length > 0) {
					$.each(data, function(index, value) {
						html = html + "<option value="+value.subHeadId+">"
								+ value.subHeadName + "</option>";
					});
				}
				$('#subHeadId').empty().append(html);
			},
			error : function(error) {
				bootbox.alert("Something went wrong !!!");
			}
		});
	}
	function findEntityListBySchemeId(schemeId){
		$.ajax({
			type : "GET",
			url : '${contextPath}/ecashcommon/findEntityListBySchemeId',
			dataType : "json",
			data : {
				"schemeId" : schemeId,
			},
			success : function(response) {
				var html = "<option value='' selected>-Select-</option>";
				var data = response;
				if (data != "" && data != null && data.length > 0) {
					$.each(data, function(index, value) {
						html = html + "<option value="+value.entitySchemeId+">"
								+ value.entityName + "</option>";
					});
				}
				$('#entityTypeId').empty().append(html);
			},
			error : function(error) {
				bootbox.alert("Something went wrong !!!");
			}
		});
	}
	$('.NumbersOnlyForAmount').keypress(function(event) {
		var regex = new RegExp("^[0-9.]+$");
		var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
		if (!regex.test(key)) {
			event.preventDefault();
			return false;
		}
	});
	$(function() {
		$('.disbursDate').datepick({
			onShow : $.datepick.monthOnly,
			dateFormat : 'dd/mm/yyyy',
			yearRange : "-100:+20",
			maxDate: '0',
			showOnFocus : true,
			showTrigger : '<button type="button" class="trigger ${canTakeAction eq false ? "frezz" : ""}" >'
					+ '<i class="fa fa-calendar"></i></button>',
		onSelect: function(selected) {
			var date = new Date(selected);
		
			
				var fyear= $("#finyearId option:selected").text().split("-");
					var firstDate = 01 + "/" + 04 + "/" +fyear[0];
					var lastDate =  31 + "/" + 03 + "/" +fyear[1];	
				
				var sDate = firstDate.replace(/(\d+[/])(\d+[/])/, '$2$1');
				var tDate = lastDate.replace(/(\d+[/])(\d+[/])/, '$2$1');
				var data1 = new Date(sDate);
				var data2 = new Date(tDate);
				if((date <= data2 && date >= data1)) {
				}else{
					$("#"+this.id).val("");
					bootbox.alert("Please select date between the financial year .")
				}
			}
		}); 
	}); 

	function getBudgetAmount(){
		var finyearId=$("#finyearId").val();
		var object=$("#objectIdAndTypeId").val();
		$("#bdg").hide();
		if(finyearId!='' && object!='' ){
			$.ajax({
			type : "GET",
			url : '${contextPath}/bdg/budget/getBudgetAmount',
			dataType : "json",
			data : {
				"object" : object,
				"finyearId" : finyearId,
			},
			success : function(response) {
				if(response.outcome){
					if(response.data > 0){
						$("#bdg").show();
						$("#budgAmt").val(response.data);
					}
				}else {
					bootbox.alert(response.message);
					$("#objectIdAndTypeId").val("");
					$("#fundTypeId").val("");
					$("#schemeId").val("");
					$("#subHeadId").val("");
				}
			},
			error : function(error) {
				bootbox.alert("Something went wrong !!!");
			}
		});
		}

		
	}
 
 </script>           
    