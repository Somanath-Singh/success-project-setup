package com.aashdit.prod.heads.common.controller;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.aashdit.prod.heads.common.dto.FileEncryptDto;
import com.aashdit.prod.heads.common.model.BankBranchMaster;
import com.aashdit.prod.heads.common.model.Block;
import com.aashdit.prod.heads.common.model.District;
import com.aashdit.prod.heads.common.model.Grampanchayat;
import com.aashdit.prod.heads.common.model.Municipality;
import com.aashdit.prod.heads.common.model.State;
import com.aashdit.prod.heads.common.model.Village;
import com.aashdit.prod.heads.common.model.Ward;
import com.aashdit.prod.heads.common.service.CommonService;
import com.aashdit.prod.heads.common.service.MasterCommonService;
import com.aashdit.prod.heads.common.utils.DownloadFile;
import com.aashdit.prod.heads.common.utils.FormDecryptionUtil;
import com.aashdit.prod.heads.common.utils.GetPropertyValue;
import com.aashdit.prod.heads.framework.core.ServiceOutcome;

import lombok.extern.slf4j.Slf4j;

@Controller
@Slf4j
@RequestMapping("/common")
public class MasterCommonController {
	
	@Autowired
	private MasterCommonService masterCommonService;
	
	@Autowired
	private CommonService commonService;
	
    /**
	 * Handles common logic.
	 *
	 * @author Somanath Singh
	 * @since 2/06/2025
	 */
    
	@GetMapping(path = "/fetchState", name = "Fetch All State")
	@ResponseBody
	public ResponseEntity<List<State>> fetchState() {
		try {
			ServiceOutcome<List<State>> outcome = masterCommonService.getAllActiveStatesIdAndName();
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchState of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}
	
	@GetMapping(path = "/fetchDistrict", name = "Fetch All District")
	@ResponseBody
	public ResponseEntity<List<District>> fetchDistrict() {
		try {
			ServiceOutcome<List<District>> outcome = masterCommonService.getAllActiveDistrictIdAndName();
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchDistrict of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}
	
	@GetMapping(path = "/fetchDistrictsByState", name = "Fetch District By State Id")
	@ResponseBody
	public ResponseEntity<List<District>> fetchDistrictsByState(@RequestParam Long stateId) {
		try {
			ServiceOutcome<List<District>> districtList = masterCommonService
					.getAllActiveDistrictsIdAndNameByState(stateId);
			return ResponseEntity.ok(districtList.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchDistrictsByState of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}

	@GetMapping(path = "/fetchBlockByDistrict", name = "Fetch Block By District Id")
	@ResponseBody
	public ResponseEntity<List<Block>> fetchBlockByDistrict(@RequestParam Long districtId) {
		try {
			ServiceOutcome<List<Block>> outcome = masterCommonService
					.getAllActiveBlockIdAndNameByDistrict(districtId);
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchBlockByDistrict of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}

	@GetMapping(path = "/fetchGrampanchayatByBlock", name = "Fetch Grampanchayat By Block Id")
	@ResponseBody
	public ResponseEntity<List<Grampanchayat>> fetchGrampanchayatByBlock(@RequestParam Long blockId) {
		try {
			ServiceOutcome<List<Grampanchayat>> outcome = masterCommonService
					.getAllActiveGrampanchayatIdAndNameByBlock(blockId);
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchGrampanchayatByBlock of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}
	
	@GetMapping(path = "/fetchVillageByGrampanchayat", name = "Fetch Village By Grampanchayat Id")
	@ResponseBody
	public ResponseEntity<List<Village>> fetchVillageByGrampanchayat(@RequestParam Long gpId) {
		try {
			ServiceOutcome<List<Village>> outcome = masterCommonService.getAllActiveVillageIdAndNameByGrampanchayat(gpId);
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchVillageByGrampanchayat of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}
	
	@GetMapping(path = "/fetchMunicipalityByDistrict")
	@ResponseBody
	public ResponseEntity<List<Municipality>> fetchMunicipalityByDistrict(@RequestParam Long districtId) {
		try {
			ServiceOutcome<List<Municipality>> outcome = masterCommonService.getAllActiveMunicipalityIdAndNameByDistrict(districtId);
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchMunicipalityByDistrict of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}
	
	@GetMapping(path = "/fetchWardByMunicipality")
	@ResponseBody
	public ResponseEntity<List<Ward>> fetchWardByMunicipality(@RequestParam Long municipalityId) {
		try {
			ServiceOutcome<List<Ward>> outcome = masterCommonService.getAllActiveWardIdAndNameByMunicipalityId(municipalityId);
			return ResponseEntity.ok(outcome.getData());
		} catch (Exception e) {
			log.error("Exception occured in fetchWardByMunicipality of MasterCommonController" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
		}
	}

	@SuppressWarnings("unchecked")
	@ResponseBody
	@GetMapping("/fetchBranchByBank")
	public String fetchBranchByBank(@RequestParam Long bankId) {
	    JSONObject response = new JSONObject();
	    try {
	        ServiceOutcome<List<BankBranchMaster>> outcome = commonERPService.findByBankId(bankId);
	        if (outcome != null && outcome.getData() != null && !outcome.getData().isEmpty()) {
	            JSONArray branchArray = new JSONArray();
	            for (BankBranchMaster branch : outcome.getData()) {
	                JSONObject branchObj = new JSONObject();
	                branchObj.put("bankBranchId", branch.getBankBranchId());
	                branchObj.put("branchName", branch.getBranchName());
	                branchArray.add(branchObj);
	            }
	            response.put("status", "success");
	            response.put("data", branchArray);
	        } else {
	            response.put("status", "empty");
	            response.put("message", "No branches found for the given bank.");
	        }
	    } catch (Exception e) {
	        response.put("status", "error");
	        response.put("message", "An error occurred while fetching branches: " + e.getMessage());
	    }
	    return response.toString();
	}
	
	@GetMapping("/viewFile")
	@ResponseBody
	public ResponseEntity<?> viewFile(String cipherText, HttpServletRequest request,HttpServletResponse response) {
		try {
			String uploadedPath = GetPropertyValue.getPropertyValue("UPLOAD.FILE.PATH");
			FileEncryptDto fileDto = FormDecryptionUtil.decryptAndDeserializeForm(cipherText, request,FileEncryptDto.class);
			
			if(fileDto == null) {
				return ResponseEntity.status(HttpStatus.NOT_FOUND).body("fileDto is null");
			}
			
			String path = uploadedPath + File.separator + fileDto.getModuleName() + File.separator + fileDto.getFileName();
			Path file = Paths.get(path);
			
			if(!Files.exists(file) && !Files.isReadable(file)) {
	        	return ResponseEntity.status(HttpStatus.NOT_FOUND).body("file not found :" + fileDto.getFileName());
	        }
			
			DownloadFile.viewUploadedDocument(file, request, response);
			return ResponseEntity.ok().build();
		} catch (Exception e) {
			log.error("Exception occured in viewFile() of ProjectController :" + e.getMessage());
			e.printStackTrace();
			return ResponseEntity.status(HttpStatus.NOT_FOUND).body("Request File Not Found .");
		}
	}
	

	
}
