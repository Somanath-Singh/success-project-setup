<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<%@ page isELIgnored="false" %>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<script src="${contextPath}/assets/js/common.js"></script>

<style>

.breadcrumb_conatiner h4 {
    margin: 0;
    font-size: 13px;
    color: #566d7e;
}

.change-color {
  font-size: 20px;
  font-weight: 500;
  color: #006bb6;
  margin-bottom: 0;
}
.card {
    border-radius: 12px;
    overflow: hidden;
}
.is-datepick{
    padding: 5px !important;
}
</style>
<div class="container-fluid">
    <div class="breadcrumb_conatiner">
        <div class="col-md-6">
           <h4 class="change-color">Candidate Registration</h4>
           <%@ include file="/WEB-INF/views/ajaxLoader.jsp"%>
        </div>
        <div class="col-md-6">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
                    <li class="breadcrumb-item"><a href="#">Human Resource</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Candidate Registration</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mt-3">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Candidate Registration</h5>
                        </div>
                        <div class="card-body">
                            <form class="filter-sec" action="${contextPath}/public/candidateRegistration" method="POST" id="participantRegistration" enctype="multipart/form-data">
                            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                            <input type="hidden" id="hiddenPartRegdId" name="hiddenId" value="${dto.hiddenId}"/>
                                <div class="row">
<!--                                 <div class="col-md-3"> -->
<!--                                         <div class="form-group"> -->
<!--                                             <label>District</label> -->
<!--                                           <select class="form-control form-control-sm" id="districtId" name="districtId" onchange="getBlocksByDistrict(this.value,0)"> -->
<!-- 												<option value="">--Select--</option> -->
<%-- 												<c:forEach items="${districtList}" var="district"> --%>
<%-- 													<option value="${district.districtId}" ${dto.districtId eq district.districtId ?'selected':'' }>${district.districtName}</option> --%>
<%-- 												</c:forEach> --%>
<!-- 											</select> -->
<!--                                         </div> -->
<!--                                     </div> -->
<!--                                     <div class="col-md-3"> -->
<!--                                         <div class="form-group"> -->
<!--                                             <label>Block</label> -->
<!--                                             <select class="form-select" id="blockId" name="blockId" onchange="getGpByBlockId(this.value,0)"> -->
<!--                                                 <option>-Select-</option> -->
<!--                                             </select> -->
<!--                                         </div> -->
<!--                                     </div> -->
<!--                                     <div class="col-md-3"> -->
<!--                                         <div class="form-group"> -->
<!--                                             <label>Gram Panchayat</label> -->
<!--                                             <select class="form-select" id="gpId" name="gpId" onchange="getVillageByGpId(this.value,0)"> -->
<!--                                                 <option>-Select-</option> -->
<!--                                             </select> -->
<!--                                         </div> -->
<!--                                     </div> -->
<!--                                     <div class="col-md-3"> -->
<!--                                         <div class="form-group"> -->
<!--                                             <label>Village</label> -->
<!--                                             <select class="form-select" id="villageId" name="villageId"> -->
<!--                                                 <option>-Select-</option> -->
<!--                                             </select> -->
<!--                                         </div> -->
<!--                                     </div> -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="col-sm-12 required">Name</label>
                                            <input type="text" class="form-control" id="name" name="name" value="${dto.name}" maxlength="50">
                                        </div>
                                    </div>
                                     <div class="col-md-3 hidden">
                                        <div class="form-group">
                                            <label class="col-sm-12 required">Code</label>
                                            <input type="text" class="form-control"  id="code" name="code" value="${dto.code}" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="col-sm-12 required">Father Name</label>
                                            <input type="text" class="form-control" id="fatherName" name="fatherName" value="${dto.fatherName}" maxlength="50">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="col-sm-12 required">Mother Name</label>
                                            <input type="text" class="form-control" id="motherName" name="motherName" value="${dto.motherName}" maxlength="50">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
									    <div class="form-group">
									        <label class="col-sm-12 required">Mobile Number</label>
									        <input type="number" class="form-control" id="mobileNo" name="mobileNo" value="${dto.mobileNo}" onblur="validateNum(this.value,'mobile'),checkDuplicate(this, 'mobile')">
									        <small id="mobileError" style="color: red; display: none;">Please enter a valid 10-digit mobile number.</small>
									        <small id="mobileDuplicateError" style="color: red; display: none;">Mobile number already exists.</small>
									    </div>
									</div>
									<div class="col-md-3"> 
									    <div class="form-group">
									        <label class="col-sm-12 required">Mail</label>
									        <input type="email" class="form-control" id="mail" name="mail" value="${dto.mail}" onblur="validateNum(this.value,'mail'),checkDuplicate(this, 'mail')">
									        <small id="mailError" style="color: red; display: none;">Please enter a valid email.</small>
<!-- 									        <small id="mailDuplicateError" style="color: red; display: none;">Email already exists.</small> -->
									    </div>
									</div>
									<div class="col-md-3">
									    <div class="form-group">
									        <label class="col-sm-12 required">Aadhar No</label>
									        <input type="number" class="form-control" id="aadhaar" name="aadhaar" value="${dto.aadhaar}" onblur="validateNum(this.value,'aadhaarNo'),checkDuplicate(this, 'aadhaarNo')">
									        <small id="aadhaarError" style="color: red; display: none;">Please enter a valid 12-digit Aadhaar number.</small>
<!-- 									        <small id="aadhaarDuplicateError" style="color: red; display: none;">Aadhaar number already exists.</small> -->
									    </div>
									</div>

                                    <div class="col-md-3">
                                        <div class="form-group" style="position: relative;" >
                                            <label class="col-sm-12 required">D.O.B</label>
                                            <input type="text" class="form-control datepicker_con" id="dob" name="dob" value="${dto.dob}" readonly>
                                            <i class="fa fa-calendar"style="position: absolute; bottom: 5px; right: 10px; font-size: 20px;color: #0f67b1;"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="col-sm-12 required">Age</label>
                                            <input type="text" class="form-control" id="age" name="age" value="${dto.age}" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="col-sm-12 required">Gender</label>
                                            <select class="form-select" id="gender" name="gender">
                                                <option value="">-Select-</option>
                                                <option value="Male" ${dto.gender eq 'Male'?'selected':''}>Male</option>
                                                <option value="Female" ${dto.gender eq 'Female'?'selected':''}>Female</option>
                                                <option value="Others" ${dto.gender eq 'Others'?'selected':''}>TransGender</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    
                                   <div class="col-md-12 text-center mt-3">
					                  <div class="form-group">
					                    <button type="button" class="btn btn-primary" onclick="submitForm()">Proceed</button>
					                    <a href="${contextPath}/public/vacancyViewPage" class="btn btn-warning" style="">Back</a>
					                     <p style="text-align:left; color:red;"><b>Note: Please save the registration number.</b></p>
					                  </div>
						            </div>
                                </div>
                            </form>
                           </div>
                         </div>
                       </div>
                     </div>
<!--                      <div class="row mt-3"> -->
<!-- 		                <div class="col-lg-12"> -->
<!-- 		                    <div class="card"> -->
<!-- 		                        <div class="card-header"> -->
<!-- 		                            <h5 class="card-title">Participant Registration</h5> -->
<!-- 		                        </div> -->
<!-- 		                        <div class="card-body"> -->
<!-- 		                            <div class="table-responsive"> -->
<!-- 		                            	<table class="DataTable table table-bordered"> -->
<!-- 		                            		<thead> -->
<!-- 		                            			<tr> -->
<!-- 		                            				<th>Sl No.</th> -->
<!-- 		                            				<th>Name</th> -->
<!-- 		                            				<th>Code</th> -->
<!-- 		                            				<th>Mobile No.</th> -->
<!-- 		                            				<th>Email</th> -->
<!-- 		                            				<th>Aadhaar</th> -->
<!-- 		                            				<th>Gender</th> -->
<!-- 		                            				<th>Dob</th> -->
<!-- 		                            				<th>Age</th> -->
<!-- 		                            				<th>Action</th> -->
<!-- 		                            			</tr> -->
<!-- 		                            		</thead> -->
<!-- 		                            		<tbody> -->
<%-- 		                            		    <c:forEach items="${participantsList}" var="part" varStatus="count"> --%>
<!-- 			                            		    <tr> -->
<%-- 			                            		      <td>${count.count}</td> --%>
<%-- 			                            		      <td>${part.name}</td> --%>
<%-- 			                            		      <td>${part.code}</td> --%>
<%-- 			                            		      <td>${part.mobileNo}</td> --%>
<%-- 			                            		      <td>${part.mailId}</td> --%>
<%-- 			                            		      <td>${part.aadhaarNo}</td> --%>
<%-- 			                            		      <td>${part.gender}</td> --%>
<%-- 			                            		      <td><fmt:formatDate pattern="dd-MM-yyyy" value="${part.dob}" /></td> --%>
<%-- 			                            		      <td>${part.age}</td> --%>
<!-- 			                            		      <td><button title="Edit" type="button" -->
<%-- 																onclick="getAllParticipantsDetails('${part.regdId}')" --%>
<!-- 																class="btn btn-xs btn-warning"> -->
<!-- 																<i class="fas fa-edit"></i> -->
<!-- 														 </button> -->
<!-- 												 	  </td> -->
<!-- 			                            			</tr> -->
<%-- 		                            			</c:forEach> --%>
<!-- 		                            		</tbody> -->
<!-- 		                            	</table> -->
<!-- 		                            </div> -->
<!-- 		                        </div> -->
<!-- 		                    </div> -->
<!-- 		                </div> -->
<!--                      </div> -->
<div id="messageModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">${applied_message}</h5>
                <!-- Close button (cross mark) -->
                <button type="button" class="close" onclick="closeModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
</div>

<form action="${contextPath}/editCandidateDetails" method="post" id="editParticipantsDetails">
<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
<input type="hidden" name="hiddenRegdId"  id="hiddenRegdId" value="">
</form>

<script>
function submitForm() {
	debugger
    // Array of field objects: { fieldId, errorMessage }
    const fields = [
//         { id: "districtId", message: "Please select District." },
//         { id: "blockId", message: "Please select Block." },
//         { id: "gpId", message: "Please select Gram Panchayat." },
//         { id: "villageId", message: "Please select Village." },
        { id: "name", message: "Name is required." },
        { id: "fatherName", message: "Father's Name is required." },
        { id: "motherName", message: "Mother's Name is required." },
        { id: "mobileNo", message: "Mobile Number is required." },
        { id: "mail", message: "Mail is required." },
        { id: "aadhaar", message: "Aadhaar Number is required." },
        { id: "dob", message: "Date of Birth is required." },
        { id: "age", message: "Age is required." },
        { id: "gender", message: "Please select Gender." }
    ];
    

    // Loop through fields and validate
    for (const field of fields) {
        const value = document.getElementById(field.id).value.trim();
        if (!value) {
        	bootbox.alert(field.message);
            document.getElementById(field.id).focus();
            return false;
        }
    }

    const confirmMessage = "Are you sure you want to complete this registration?";
    if (confirm(confirmMessage)) {
        // If the user confirms, submit the form
        document.getElementById("participantRegistration").submit();
    } else {
        return false;
    }
}


$(document).ready(function() {
    // Initialize the datepicker with options
    $('.datepicker_con').datepick({
        dateFormat: 'dd/mm/yyyy',
        yearRange: 'c-100:c+5',
        showOnFocus: true,
        onSelect: function(selected) {
            let dobField = document.getElementById("dob");
            let ageField = document.getElementById("age");
            let dobValue = dobField.value.trim();

            // Ensure D.O.B is selected
            if (!dobValue) {
            	bootbox.alert("Please select a valid Date of Birth.");
                dobField.classList.add("is-invalid");
                ageField.value = ""; // Clear age if invalid D.O.B
                return false;
            }

            // Convert D.O.B (dd/mm/yyyy) to a Date object
            let dobParts = dobValue.split('/');
            let dobDate = new Date(dobParts[2], dobParts[1] - 1, dobParts[0]); // Create Date object in mm/dd/yyyy format

            let today = new Date();

            // Ensure D.O.B is not greater than today's date
            if (dobDate > today) {
            	bootbox.alert("D.O.B cannot be greater than today's date.");
                dobField.value = ""; // Clear invalid D.O.B
                ageField.value = ""; // Clear the age field
                dobField.classList.add("is-invalid");
                return false;
            }

            // Calculate age based on D.O.B
            let age = today.getFullYear() - dobDate.getFullYear();
            let m = today.getMonth() - dobDate.getMonth();

            // Adjust age if the birthday has not occurred yet this year
            if (m < 0 || (m === 0 && today.getDate() < dobDate.getDate())) {
                age--;
            }

            // Validate age is at least 17
            if (age < 17) {
            	bootbox.alert("Age must be at least 17 years.");
                dobField.value = ""; // Clear invalid D.O.B
                ageField.value = ""; // Clear the age field
                dobField.classList.add("is-invalid");
                return false;
            }

            // Set the calculated age
            ageField.value = age;

            // Remove invalid class if the date is valid
            dobField.classList.remove("is-invalid");
        }
    });
});



function getAllParticipantsDetails(regdId){
	debugger
	  //document.getElementById("submitButton").innerText = "Update";
	 $("#hiddenRegdId").val(regdId);
	 $("#editParticipantsDetails").submit();
}



$(document).ready(function() {
	debugger
    var appliedMessage = '${applied_message}';
    
    if (appliedMessage != '') {
        // Show the modal using jQuery
        $('#messageModal').modal('show');
    }
});


function validateNum(value,fieldType) {
	debugger

	 if (fieldType === 'mobile') {
	        regex = /^\d{10}$/;
	        errorText = document.getElementById('mobileError');
	        
	        // Check if the mobile number is exactly 10 digits
	        if (value.length === 10) {
	            errorText.style.display = 'none'; // Hide error message
	        } else {
	            errorText.style.display = 'block'; // Show error message
	            $("#mobileNo").val('');
	        }
	    } else if (fieldType === 'aadhaarNo') {
	        regex = /^\d{12}$/;
	        errorText = document.getElementById('aadhaarError');
	        
	        // Check if the mobile number is exactly 10 digits
	        if (value.length === 12) {
	            errorText.style.display = 'none'; // Hide error message
	        } else {
	            errorText.style.display = 'block'; // Show error message
	            $("#aadhaar").val('');
	        }
	    } if (fieldType === 'mail') {
	        regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Email validation regex
	        errorText = document.getElementById('mailError');

	        // Check if the email matches the format
	        if (regex.test(value)) {
	            errorText.style.display = 'none'; // Hide error message
	        } else {
	            errorText.style.display = 'block'; // Show error message
	            document.getElementById('mail').value = ''; // Clear the input field
	        }
	    }
   
}

//Function to close the modal
function closeModal() {
	if($("#hiddenPartRegdId").val()==''){
		 document.getElementById("messageModal").style.display = "none";
	}
}


function checkDuplicate(inputField, fieldType) {
    debugger;
    var value = inputField.value.trim();
    var errorId = fieldType + "DuplicateError"; // Ensure this ID matches your HTML

    if (value === "") {
        $("#" + errorId).hide();
        return;
    }

    $.ajax({
        type: "GET",
        url: "${contextPath}/public/check-duplicate", // Update with actual backend API
        data: { fieldType: fieldType, value: value },
        success: function (response) {
            if (response.exists) {
               bootbox.alert("Duplicate "+fieldType+" not allowed");
               $(inputField).val("");
               return false;
            } else {
                $("#" + errorId).hide(); // Hide error if no duplicate
                $(inputField).removeClass("is-invalid");
            }
        },
        error: function () {
            console.error("Error checking duplicate for " + fieldType);
        }
    });
}


</script>