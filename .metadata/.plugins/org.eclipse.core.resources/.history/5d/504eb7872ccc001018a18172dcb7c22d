<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>

<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<link href="${contextPath}/assets/css/dashboard.css" rel="stylesheet" type="text/css" />
<script src="${contextPath}/assets/appJs/validation/common-utils.js"></script>

<style>

.model-width{
	max-width: 45%; 
	margin: 1.75rem auto;
}

</style>


<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">View Assign Maintenance Request</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">

				<li class="breadcrumb-item"><a href="${contextPath}/home"><i
						class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Assign Maintenance Request</li>
			</ol>
		</nav>
	</div>
</div>

<div class="card">
	<div class="card-header">
		<h5 class="card-title">Assign User To Create Maintenance Request</h5>
	</div>
	<div class="card-body">
		<div class="row">
			<div class="col-md-3">
				<div class="form-group">
<!-- 					<label class="smallInput required" for="">Project :</label> -->
<label class="smallInput required" for="">Building :</label>
					<div class="">
						<select class="form-control form-control-sm select2 form-select"
							id="projectId" name="projectId"
							onchange="fetchMaintenceByProjectId(this.value);fetchExistMaintenceByProjectId(this.value);">
							<option value="0" selected disabled>- Select -</option>
							<c:forEach items="${projectList}" var="project">
								<option value="${project.projectId}">${project.projectName}</option>
							</c:forEach>
						</select>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="card mt-3">
	<div class="card-header">
		<h5 class="card-title">Maintenance List Of Assigned user</h5>
	</div>
	<div class="card-body">
		<!-- Tabs -->
		<div class="nav nav-tabs mb-2 tabnav" id="AssignTaskTabs" role="tablist">
		    <button class="nav-link active" id="tab1-tab" data-bs-toggle="tab"
		        data-bs-target="#tab1" type="button" role="tab">Not Assign Task</button>
		    <button class="nav-link" id="tab2-tab" data-bs-toggle="tab"
		        data-bs-target="#tab2" type="button" role="tab">Assign Task</button>
		</div>

		<div>
			<div class="row">
				<div class="col-md-12">
					<div class="container text-center my-4">
					
						<!-- Tab Content -->
						<div class="tab-content" id="AssignTaskTabsContent">
						    
						    <!-- Not Assign Task -->
						    <div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
						        <table class="table table-hover table-bordered mt-3">
						            <thead class="table-light">
						                <tr>
						                    <th>Sl.No</th>
						                    <th>Maintenance Name</th>
						                    <th>Maintenance Code</th>
						                    <th>Action</th>
						                </tr>
						            </thead>
						            <tbody id="maintenance-table-body">
						                <!-- User rows will be appended here via AJAX -->
						            </tbody>
						        </table>
						    </div>
						
						    <!-- Assign Task -->
						    <div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
						        <table class="table table-hover table-bordered mt-3">
						            <thead class="table-light">
						                <tr>
						                    <th>Sl.No</th>
						                    <th>Maintenance Name</th>
						                    <th>Maintenance Code</th>
						                    <th>Action</th>
						                </tr>
						            </thead>
						            <tbody id="exist-maintenance-table-body">
						                <!-- User rows will be appended here via AJAX -->
						            </tbody>
						        </table>
						    </div>
						
						</div>
						
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<!-- Modal -->
<div class="modal fade" id="assignedUser" tabindex="-1" aria-labelledby="assignedUserLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="assignedUserLabel">Assign Users</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="assignedUserBody">
        <!-- Dynamic form will be injected here -->
      </div>
    </div>
  </div>
</div>



<script>

	let openedMaintenanceCheckboxes = [];
	let contextPath = '${contextPath}';

	function submitFormData(formElement) {
		const form = $(formElement);
		const formId = form.attr("id");
		const maintenanceId = form.find("input[name='maintenanceRepairId']").val();
		const assignData = collectAssignTaskData(formElement); 

		if (!assignData) return;
	
		const assign = JSON.parse(assignData);
		
		if (formId.startsWith("assignTaskForm-") && assign.assignTaskUserDetailsDto.length === 0) {
			bootbox.alert("Please select at least one user to assign.");
			return false;
		}
	
		$.ajax({
			url: contextPath + "/assign/is-maintenance-exist",
			type: "GET",
			data: {
				maintenanceId: maintenanceId,
				assignId: assign.assignId || null
			},
			success: function (checked) {
				if (!checked) {
					form.find(".cipher-text").val(enc_password(assignData));
					bootbox.confirm("Do you want to submit the form?", function (result) {
						if (result === true) {
							showLoader();
							form.submit(); 
						}
					});
				} else {
					bootbox.alert("In the Assign Task, Maintenance is already present.");
				}
			},
			error: function (error) {
				bootbox.alert("Error fetching projects: " + error.statusText);
			}
		});
	}
	
	function collectAssignTaskData(formElement) {
		const form = $(formElement);
		const selectedUsers = [];
		
		form.find('input.user-checkbox:checked').each(function () {
		    const $checkbox = $(this);
		    const $row = $checkbox.closest('tr');
		    const assignUserId = $row.find('input[name="assignUserId"]').val();

		    selectedUsers.push({
		        userId: $checkbox.data("user-id"),
		        assignUserId: assignUserId 
		    });
		});
		
		const assignTask = {
			assignId: form.find("input[name='assignId']").val() || null,
			maintenanceRepairId: form.find("input[name='maintenanceRepairId']").val(),
			isActive: form.find("input[name='isActive']").val() === "true",
			assignTaskUserDetailsDto: selectedUsers,
			_csrf: form.find("input[name='_csrf']").val(),
		};
		return JSON.stringify(assignTask);
	}

	function showLoader() {
	  $(".loader-div").css("display", "flex");
	}
	
	function fetchMaintenceByProjectId(projectId) {
		  $.ajax({
		    type: "GET",
		    url: contextPath + "/assign/get-maintence-by-project",
		    data: { projectId: projectId },
		    success: function(maintenances) {
		      var tbody = $("#maintenance-table-body");
		      tbody.empty();

		      $.each(maintenances, function(index, maintenance) {
		        var row = ''
		          + '<tr data-maintenance-row="' + maintenance.maintenanceRepairId + '">'
		          +   '<td>' + (index + 1) + '</td>'
		          +   '<td>' + maintenance.mainName + '</td>'
		          +   '<td>' + maintenance.mainCode + '</td>'
		          +   '<td>'
		          +     '<input type="checkbox" class="form-check-input maintenance-toggle-new" '
		          +       'data-id="' + maintenance.maintenanceRepairId + '" '
		          +       'data-name="' + maintenance.mainName + '">'
		          +   '</td>'
		          + '</tr>';
		        tbody.append(row);
		      });
		      attachUserCheckboxHandler(); 
		    },
		    error: function() {
		      bootbox.alert("Error loading maintenance.");
		    }
		  });
		}
	
		function attachUserCheckboxHandler() {
		  $(".maintenance-toggle-new").off("change").on("change", function () {
		    const checkbox = $(this);
		    const maintenanceId = checkbox.data("id");
		    const maintenanceName = checkbox.data("name");

		    if (checkbox.is(":checked")) {
		   	  openedMaintenanceCheckboxes.push(checkbox); 

		      $.ajax({
		        type: "GET",
		        url: contextPath + "/assign/get-user-data",
		        data: { maintenanceId: maintenanceId },
		        success: function (data) {
		          let modalTitle = maintenanceName + " - Assign Users";
		          let modalBody = '';

		          if (!data || !Array.isArray(data.assignedTaskUserDto) || data.assignedTaskUserDto.length === 0) {
		            modalBody = '<div class="text-center text-muted p-3"><em>No users available for assignment.</em></div>';
		          } else {
		            modalBody = '<form method="POST" action="' + contextPath + '/assign/save-assign-task" '
		              + 'class="assign-task-form" id="assignTaskForm-' + maintenanceId + '">'
		              + '<input type="hidden" name="cipherText" class="cipher-text" value=""/>'
		              + '<input type="hidden" name="_csrf" class="_csrf" value="' + $("input[name='_csrf']").val() + '"/>'
		              + '<input type="hidden" name="assignId" class="assign-id" value="' + (data.assignId || '') + '"/>'
		              + '<input type="hidden" name="isActive" class="is-active" value="' + ($("#isActive").val() || 'true') + '"/>'
		              + '<input type="hidden" name="maintenanceRepairId" class="maintenance-id" value="' + maintenanceId + '"/>'

		              + '<div class="maintenance-box p-2 rounded bg-white">'
		              + '<table class="table table-hover table-bordered text-center mb-2">'
		              + '<thead class="table-light"><tr><th style="width:8%;">Sl.No</th><th style="width:40%;">User Name</th><th style="width:8%;">Action</th></tr></thead><tbody>';

		            $.each(data.assignedTaskUserDto, function (index, user) {
		              const isChecked = user.isAssigned ? 'checked' : '';
		              const isDisabled = user.isAssigned ? 'disabled readonly' : '';

		              modalBody += '<tr>'
		                + '<td>' 
		                + (index + 1) 
		                + '<input type="hidden" name="assignUserId" value="' + user.assignUserId + '" />'
		                + '</td>'
		                + '<td>' + (user.userName || "User ID: " + user.userId) + '</td>'
		                + '<td><input type="checkbox" class="user-checkbox" '
		                + 'name="userIds" value="' + user.userId + '" '
		                + 'data-user-id="' + user.userId + '" '
		                + 'data-maintenance-id="' + maintenanceId + '" '
		                + isChecked + ' ' + isDisabled + '></td>'
		                + '</tr>';
		            });

		            modalBody += '</tbody></table></div>'
		              + '<div class="modal-footer">'
		              + '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>'
		              + '<button type="button" class="btn btn-primary px-3 py-2" '
		              + 'data-maintenance-id="' + maintenanceId + '" onclick="submitFormData(this.form)">Assign</button>'
		              + '</div></form>';
		          }

		          $("#assignedUserLabel").text(modalTitle);
		          $("#assignedUserBody").html(modalBody);

		          const modalElement = document.getElementById('assignedUser');
		          const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
		          modalInstance.show();
		        },
		        error: function () {
		          bootbox.alert("Failed to load users.");
		          checkbox.prop("checked", false);
		        }
		      });
		    }
		  });
		  $('#assignedUser').off('hidden.bs.modal').on('hidden.bs.modal', function () {
			  openedMaintenanceCheckboxes.forEach(cb => cb.prop("checked", false));
			  openedMaintenanceCheckboxes = []; 
			});
		}
	
	function fetchExistMaintenceByProjectId(projectId) {
	  $.ajax({
	    type: "GET",
	    url: contextPath + "/assign/get-maintence-by-project",
	    data: { projectId: projectId },
	    success: function(maintenances) {
	      var tbody = $("#exist-maintenance-table-body");
	      tbody.empty();

	      $.each(maintenances, function(index, maintenance) {
	        var row = ''
	          + '<tr data-maintenance-row="' + maintenance.maintenanceRepairId + '">'
	          +   '<td>' + (index + 1) + '</td>'
	          +   '<td>' + maintenance.mainName + '</td>'
	          +   '<td>' + maintenance.mainCode + '</td>'
	          +   '<td><input type="checkbox" class="form-check-input maintenance-toggle-exist" '
	          +         'data-id="' + maintenance.maintenanceRepairId + '" '
	          +         'data-name="' + maintenance.mainName + '"></td>'
	          + '</tr>'
	        tbody.append(row);
	      });

	      attachCheckedUserCheckboxHandler(); 
	    },
	    error: function() {
	      bootbox.alert("Error loading maintenance.");
	    }
	  });
	}
	
	function attachCheckedUserCheckboxHandler() {
		  $(".maintenance-toggle-exist").off("change").on("change", function () {
		    var checkbox = $(this);
		    var maintenanceId = checkbox.data("id");
		    var maintenanceName = checkbox.data("name");

		    if (checkbox.is(":checked")) {
		      openedMaintenanceCheckboxes.push(checkbox);
		      
		      $.ajax({
		        type: "GET",
		        url: contextPath + "/assign/get-assigned-task-by-maintemance",
		        data: { maintenanceId: maintenanceId },
		        success: function (task) {
		          var serial = 1;
		          var hasUsers = false;
		          var htmlContent = '';

		          var assignedUsers = task.assignedTaskUserDto || [];
		          var assignId = task.assignId || '';
		          var isActive = task.isActive === true ? 'true' : 'false';
		          var maintenanceRepairId = task.maintenanceRepairId;
		          var userRows = '';

		          if (Array.isArray(assignedUsers) && assignedUsers.length > 0) {
		            $.each(assignedUsers, function (j, userDto) {
		              if (userDto.userId) {
		                hasUsers = true;
		                userRows += '<tr>'
		                  + '<td>' 
		                  + (serial++) 
		                  + '<input type="hidden" name="assignUserId" value="' + userDto.assignUserId + '" />'
		                  + '</td>'
		                  + '<td>' + (userDto.userName || 'User ID: ' + userDto.userId) + '</td>'
		                  + '<td>'
		                  + '<input type="checkbox" class="user-checkbox"'
		                  + ' name="userIds"'
		                  + ' value="' + userDto.userId + '"'
		                  + ' data-user-id="' + userDto.userId + '"'
		                  + ' data-assign-id="' + (userDto.assignId || '') + '"'
		                  + ' data-maintenance-id="' + maintenanceRepairId + '"'
		                  + (userDto.isAssigned ? ' checked' : '') + '>'
		                  + '</td>'
		                  + '</tr>';
		              }
		            });
		          }

		          if (hasUsers) {
		            htmlContent += '<form method="POST" action="' + contextPath + '/assign/save-assign-task" '
		              + 'class="assign-task-form" id="editAssignTaskForm-' + maintenanceRepairId + '">'
		              + '<input type="hidden" name="cipherText" class="cipher-text" value=""/>'
		              + '<input type="hidden" name="_csrf" class="_csrf" value="' + $("input[name='_csrf']").val() + '"/>'
		              + '<input type="hidden" name="assignId" class="assign-id" value="' + assignId + '"/>'
		              + '<input type="hidden" name="isActive" class="is-active" value="' + isActive + '"/>'
		              + '<input type="hidden" name="maintenanceRepairId" class="maintenance-id" value="' + maintenanceRepairId + '"/>'

		              + '<div class="maintenance-box p-2 rounded bg-white">'
		              + '<table class="table table-hover table-bordered text-center mb-2">'
		              + '<thead class="table-light">'
		              + '<tr><th style="width:8%;">Sl.No</th><th style="width:40%;">User Name</th><th style="width:8%;">Action</th></tr>'
		              + '</thead><tbody>'
		              
		              + userRows
		              + '</tbody></table>'
		              + '</div>' 
		              + '<div class="modal-footer">'
		              + '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>'
		              + '<button type="button" class="btn btn-primary px-3 py-2" '
		              + 'data-maintenance-id="' + maintenanceId + '" onclick="submitFormData(this.form)">Not Assign</button>'
		              + '</div>'
		              + '</form>';

		            $("#assignedUserLabel").text(maintenanceName + " - Assign Users");
		            $("#assignedUserBody").html(htmlContent);

		            const modalElement = document.getElementById('assignedUser');
		            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
		            modalInstance.show();
		          } else {
		            const messageHtml = '<div class="text-center text-muted p-3">'
		              + '<em>No users assigned for maintenance "' + maintenanceName + '"</em>'
		              + '</div>';
		            $("#assignedUserLabel").text(maintenanceName + " - Assign Users");
		            $("#assignedUserBody").html(messageHtml);
		            const modalElement = document.getElementById('assignedUser');
		            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
		            modalInstance.show();
		          }
		        },
		        error: function () {
		          bootbox.alert("Failed to load users.");
		          checkbox.prop("checked", false);
		        }
		      });
		    }
		  });

		  $('#assignedUser').off('hidden.bs.modal').on('hidden.bs.modal', function () {
			  openedMaintenanceCheckboxes.forEach(cb => cb.prop("checked", false));
			  openedMaintenanceCheckboxes = [];
			});

		}
	
	$(document).ready(function () {
		$('.nav-link').on('click', function () {
			const controller = $(this).data('controller');
			const action = $(this).data('action');
			const projectId = $('#projectId').val();
	
			if (!projectId) {
				bootbox.alert("Please select a project first.");
				return;
			}
	
			const url = contextPath + '/' + controller + '/' + action;
	
			if (action === 'get-maintence-by-project') {
				fetchMaintenceByProjectId(projectId);
			} else if (action === 'get-assigned-task-by-maintemance') {
				fetchExistMaintenceByProjectId(projectId);
			}
		});
	});


</script>
