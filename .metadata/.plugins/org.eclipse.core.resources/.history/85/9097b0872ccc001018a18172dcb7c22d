<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<c:set var="bankRow" value="0" />


<div class="breadcrumb_conatiner">
	<div class="col-md-6">
		<h4 class="change-color">Vendor</h4>
	</div>
	<div class="col-md-6">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="${contextPath}/home"><i class="fa fa-home"></i></a></li>
				<li class="breadcrumb-item active" aria-current="page">Vendor</li>
			</ol>
		</nav>
	</div>
</div>

<div class="row">
	<div class="col-md-12">
		<div class="card">
			<div class="card-header">
				<h5 class="card-title">Vendor</h5>
			</div>
			<div class="card-body">
				<form method="POST" action="${contextPath}/mst/vendor/save" id="addVendorFrm" enctype="multipart/form-data">
					<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
					<input type="hidden" id="vendorId" name="vendorId" value="${vendor.vendorId }"> 
					<input type="hidden" class="" id="encodedDataaddVendorFrm" name="encodedDataFrm" value="" />
					<div class="row">
						<div class="col-md-12">
							<div class="row">

								<c:set var="functionList" value="" />
								<c:set var="upperOrDown" value="down" />
								<%@ include file="/WEB-INF/views/entityIdAndUserLevelListForMst.jsp"%>

								<div class="form-group col-md-3">
									<label for="inputEmail4" class="required">Vendor Type:</label>
									<c:choose>
										<c:when test="${lstVndTyp.size() > 1}">
											<select class="form-select" aria-label="Default select example" id="vendorTypeId" name="vendorTypeId">
												<option>-Select-</option>
												<c:forEach items="${lstVndTyp}" var="vnd">
													<option value="${vnd.vendorTypeId}" ${vnd.vendorTypeId eq vendor.vendorType.vendorTypeId ? 'selected' :''}>${vnd.vendorTypeName}</option>
												</c:forEach>
											</select>
										</c:when>
										<c:otherwise>
											<input type="hidden" name="vendorTypeId" value="${lstVndTyp[0].vendorTypeId}" />
											<input type="text" class="form-control form-control-sm" value="${lstVndTyp[0].vendorTypeName}" readonly="readonly" />
										</c:otherwise>
									</c:choose>
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">Vendor Name:</label> 
									<input class="form-control form-control-sm thisisRequiredField" type="text" id="vendorName" name="vendorName" placeholder="Enter Vendor Name" value="${vendor.vendorName}" maxlength="30">
								</div>
								<div class="form-group col-md-3">
									<label for="inputEmail4">Category :</label> 
									<select class="form-select form-control form-control-sm" aria-label="Default select example" id="categoryName" name="categoryId">
										<option value="">-Select-</option>
										<c:forEach items="${catList}" var="cat">
											<option value="${cat.categoryId}" ${cat.categoryId eq vendor.category.categoryId ? 'selected' :''}>${cat.categoryName}</option>
										</c:forEach>
									</select>
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">Mobile No:</label>
									<input class="form-control form-control-sm NumbersOnly validPhoneNo thisisRequiredField" type="text" id="mobileNo" name="mobileNo" placeholder="Enter Mobile No" value="${vendor.mobileNo}" maxlength="20">
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">Email:</label> 
									<input class="form-control form-control-sm validEmail thisisRequiredField" type="text" id="email" name="email" placeholder="Enter Email" value="${vendor.email}" maxlength="35">
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">GST-IN:</label> 
									<!-- validGSTIN -->
									<input class="form-control form-control-sm validGSTIN thisisRequiredField" type="text" id="gstNo" name="gstNo" placeholder="Enter Gst Number" value="${vendor.gstNo}" maxlength="15">
								</div>
								<div class="form-group col-md-3" style="position: relative;">
									<label class="col-md-12 required" for="text">GST-IN Copy:</label>
									<input class="form-control form-control-sm ${not empty vendor ? '' : 'thisisRequiredField' }" type="file" id="attachmentFile0" name="gstDocc" placeholder="enter Attachment Name" value="" onchange="imagePDFCheck(this)">
									<c:if test="${not empty vendor && not empty vendor.gstDoc}">
										<button type="button" class="btn btn-primary" style="padding: 4px 5px;position: absolute; top: 23px; right: 16px;" onclick="downloadDoc('${vendor.gstDoc}', 'Master/Vendor/Gst')"><i class="fa fa-eye" aria-hidden="true"></i></button>
									</c:if>
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 " for="text">Aadhar No:</label>
									<input class="form-control form-control-sm validAadhar NumbersOnly" type="text" id="aadharNo" name="aadharNo" placeholder="Enter Aadhar Number" value="${vendor.aadharNo}" maxlength="12">
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">Pan No:</label> 
									<input class="form-control form-control-sm validPAN  thisisRequiredField" type="text" id="panNo" name="panNo" placeholder="Enter Pan Number" value="${vendor.panNo}" maxlength="10">
								</div>
								<div class="form-group col-md-3" style="position: relative;">
									<label class="col-md-12 required" for="text">Pan Copy:</label>
									<input class="form-control form-control-sm ${not empty vendor ? '' : 'thisisRequiredField' }" type="file" id="attachmentFile0" name="panDocc" placeholder="enter Attachment Name" value="" onchange="imagePDFCheck(this)">
									<c:if test="${not empty vendor && not empty vendor.panDoc}">
										<button type="button" class="btn btn-primary" style="padding: 4px 5px;position: absolute; top: 23px; right: 16px;" onclick="downloadDoc('${vendor.panDoc}', 'Master/Vendor/Pan')"><i class="fa fa-eye" aria-hidden="true"></i></button>
									</c:if>
								</div>
								<div class="form-group col-md-3" style="position: relative;">
									<label class="col-md-12 " for="text">Tan Copy:</label>
									<input class="form-control form-control-sm " type="file" id="attachmentFile0" name="tanDocc" placeholder="enter Attachment Name" value="" onchange="imagePDFCheck(this)">
									<c:if test="${not empty vendor && not empty vendor.tanDoc}">
										<button type="button" class="btn btn-primary" style="padding: 4px 5px;position: absolute; top: 23px; right: 16px;" onclick="downloadDoc('${vendor.tanDoc}', 'Master/Vendor/Tan')"><i class="fa fa-eye" aria-hidden="true"></i></button>
									</c:if>
								</div>
								<div class="form-group col-md-3" style="position: relative;">
									<label class="col-md-12 " for="text">Letter of incorporation or registation:</label>
									<input class="form-control form-control-sm " type="file" id="attachmentFile0" name="liorDocc" placeholder="enter Attachment Name" value="" onchange="imagePDFCheck(this)">
									<c:if test="${not empty vendor && not empty vendor.liorDoc}">
										<button type="button" class="btn btn-primary" style="padding: 4px 5px;position: absolute; top: 23px; right: 16px;" onclick="downloadDoc('${vendor.liorDoc}', 'Master/Vendor/Lior')"><i class="fa fa-eye" aria-hidden="true"></i></button>
									</c:if>
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">Point Of Contact:</label>
									<input class="form-control form-control-sm thisisRequiredField" type="text" id="pointOfContact" name="pointOfContact" placeholder="Enter Point Of Contact" value="${vendor.pointOfContact}" maxlength="30">
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 required" for="text">POC Mobile No:</label> 
									<input class="form-control form-control-sm NumbersOnly validPhoneNo thisisRequiredField" type="text" id="contactNumber" name="contactNumber" placeholder="Enter Contact Number" value="${vendor.contactNumber}" maxlength="15">
								</div>
								<div class="form-group col-md-3">
									<label class="col-md-12 " for="text">POC Email:</label> 
									<input class="form-control form-control-sm validEmail " type="text" id="email" name="pocEmail" placeholder="Enter Email" value="${vendor.pocEmail}" maxlength="35">
								</div>
								<div class="form-group col-md-6">
									<label class="col-md-12 required" for="text">Address:</label>
									<textarea class="form-control thisisRequiredField" style="width: 100%;height: 100px; outline: none; max-height: 71px;" id="vendorAddress" name="vendorAddress" placeholder="Enter Address" maxlength="250">${vendor.vendorAddress}</textarea>
								</div>

								<c:if test="${not empty vendor.vendorId }">
									<div class="form-group col-md-3  mt-4 toggleTrueFalse" data-label-on="True" data-label-off="False" data-toggle-width="90" style="margin-left: 15px;">
										<input type="checkbox" value="${vendor.isActive}" class="toggleCheckBox" ${vendor.isActive == 'true' ? 'checked' : ''} id="parametros_MOSTRAPEDIDOS" name="isActive" /> 
										<label class="clickToggle" for="parametros_MOSTRAPEDIDOS"></label>
									</div>
								</c:if>
								<div class="row mt-2" >
									<div class="col-md-6"  align="left">
										<h5 class="card-title">Bank Details</h5>
									</div>
									<div class="col-md-6"  align="right">
										<button type="button" class="btn-pluse" style=" padding: 5px 15px;margin-bottom: 10px;" onclick="addbankRow()"><i class="fa fa-plus" aria-hidden="true"></i> Add Row </button>
									</div>
									<div class="col-md-12">
									<table class="table table-striped table-bordered" >
										<thead>
											<tr>
												<th class="required">IFSC Code</th>
												<th class="required">Bank Name</th>
												<th class="required">Bank Branch</th>
												<th class="required">Account No.</th>
												<th class="required">Account Holder Name</th>
												<th class="required">Is Primary Account:</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody id="bankDetails">
											<c:choose>
												<c:when test="${not empty vendor && not empty vendor.vendorBankDetails && vendor.vendorBankDetails.size() > 0 }">
													<c:forEach items="${vendor.vendorBankDetails}" var="vndbnk" varStatus="count">
														<tr style="vertical-align: middle;" id="row${count.index}">
															<td>
																<input type="hidden" name="vendorBankDetails[${count.index}].vendorBankMapId" value="${vndbnk.vendorBankMapId}">
																<input class="form-control form-control-sm noSpecialChar thisisRequiredField" type="text" id="ifsc${count.index}" placeholder="enter IFSC code" value="${vndbnk.bankBranchMaster.ifscCode}" maxlength="30" onchange="fetchBankDetails(this.value,${count.index})">
															</td>
															<td>
																<input class="form-control form-control-sm thisisRequiredField" type="text" id="bank${count.index}" placeholder="enter bank name" value="${vndbnk.bankBranchMaster.bankId.bankName}" maxlength="30" readonly>
															</td>
															<td>
																<input type="hidden" id="branchId${count.index}" name="vendorBankDetails[${count.index}].bankBranchId" value="${vndbnk.bankBranchMaster.bankBranchId}">
																<input class="form-control form-control-sm thisisRequiredField" type="text"id="branch${count.index}" placeholder="enter bank branch name" value="${vndbnk.bankBranchMaster.branchName}" maxlength="30" readonly>
																
															</td>
															<td>
																<input class="form-control form-control-sm NumbersOnly thisisRequiredField" type="text" name="vendorBankDetails[${count.index}].accountNo" id="account${count.index}" placeholder="enter account no." value="${vndbnk.accountNo}" maxlength="20" >
															</td>
															<td>
																<input class="form-control form-control-sm thisisRequiredField" type="text" name="vendorBankDetails[${count.index}].accountHolderName" id="holder${count.index}" placeholder="enter account holder name" value="${vndbnk.accountHolderName}" maxlength="30" >
															</td>
															<td>
																<input type="radio" class="col-12" style='height:15px' id="" name='isFractional' onclick="setPrimaryData(${count.index})" ${vndbnk.isPrimary ? 'checked' : ''}>
																<input type="hidden" class="isPrimary" name="vendorBankDetails[${count.index}].isPrimary" id="isPrimary${count.index}" value="${vndbnk.isPrimary}"  > 
															</td>
															<td>
																<button type="button" class="btn btn-danger" title='Remove' onclick="removebankRow(${count.index})"><i class="fa fa-trash" aria-hidden="true"></i></button>
															</td>
															<c:set var="bankRow" value="${count.count}" />
														</tr>
													</c:forEach>
												</c:when>
												<c:otherwise>
													<tr style="vertical-align: middle;" id="row0">
														<td>
														    <input type="hidden" id="branchId0" name="vendorBankDetails[0].bankBranchId" value="">
															<input class="form-control form-control-sm noSpecialChar thisisRequiredField" type="text" id="ifsc0" placeholder="enter IFSC code" value="" maxlength="30" onchange="fetchBankDetails(this.value,0)">
														</td>
														<td>
															<input class="form-control form-control-sm thisisRequiredField" type="text" id="bank0" placeholder="enter bank name" value="" maxlength="30" readonly>
														</td>
														<td>
															<input class="form-control form-control-sm thisisRequiredField" type="text"id="branch0" placeholder="enter bank branch name" value="" maxlength="30" readonly>

														</td>
														<td>
															<input class="form-control form-control-sm NumbersOnly thisisRequiredField" type="text" name="vendorBankDetails[0].accountNo" id="account0" placeholder="enter account no." value="" maxlength="20" >
														</td>
														<td>
															<input class="form-control form-control-sm thisisRequiredField" type="text" name="vendorBankDetails[0].accountHolderName" id="holder0" placeholder="enter account holder name" value="" maxlength="30" >
														</td>
														<td>
															<input type="radio" class="col-12" style='height:15px' id="" name='isFractional' onclick="setPrimaryData(0)">
															<input type="hidden" class="isPrimary" name="vendorBankDetails[0].isPrimary" id="isPrimary0" value="false">
														</td>
														<td>
															<button type="button" class="btn btn-danger" title='Remove' onclick="removebankRow(0)"><i class="fa fa-trash" aria-hidden="true"></i></button>
														</td>
														<c:set var="bankRow" value="1" />
													</tr>
												</c:otherwise>
											</c:choose>
											
										</tbody>
									</table>
									</div>
									
								</div>

								<div class="col-md-12" align="center">
									<input type="button" class="btn-success btn" value="${not empty vendor.vendorId  ? 'Update' : 'Save'}" onclick="validateForms()">
									<a type="button" class="btn btn-sm btn-danger" style="" onclick="backToModule()">Cancel</a>

									<c:if test="${not empty vendor.vendorId }">
										<a type="button" href="${contextPath}/mst/vendor/add" class="btn btn-submit">Add New</a>
									</c:if>

								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
		<div class="card mt-3">
			<div class="card-header">
				<h5 class="card-title">Vendor List</h5>
			</div>
			<div class="card-body">
				<div class="col-md-12">
					<div class="row">
						<%@ include file="/WEB-INF/views/entityIdAndUserLevelListDrpForMst.jsp"%>
					</div>
					<div class="table-responsive">
						<table class="datatable table table-striped table-bordered exportbtn mt-3">
							<thead>
								<tr>
									<th>Sl No</th>
									<th>Vendor type</th>
									<th>Vendor Name</th>
									<th>Vendor Code</th>
									<th>Category</th>
									<th>Phone</th>
									<th>Email</th>
									<th>Address</th>
									<th>Active/InActive</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								<c:forEach items="${vendorList}" var="vendor" varStatus="status">
									<tr>
										<td>${status.count}</td>
										<td>${vendor.vendorType.vendorTypeName}</td>
										<td>${vendor.vendorName}</td>
										<td>${vendor.vendorCode}</td>
										<td>${not empty vendor.category.categoryName ?  vendor.category.categoryName : '*****'}</td>
										<td>${vendor.mobileNo}</td>
										<td>${vendor.email}</td>
										<td>${vendor.vendorAddress}</td>
										<td>
											<div class="toggleTrueFalse" data-label-on="True"
												data-label-off="False" data-toggle-width="90">
												<input type="checkbox" value="${vendor.isActive}" class="toggleCheckBox" ${vendor.isActive == 'true' ? 'checked' : ''}
													id="parametros_MOSTRAPEDIDOS${status.count}" name="parametros_MOSTRAPEDIDOS${status.count}" disabled="disabled" /> 
												<label class="clickToggle" for="parametros_MOSTRAPEDIDOS${status.count}"></label>
											</div>
										</td>
										<td>
											<a href="#" onclick="edit(${vendor.vendorId})" class="btn " data-toggle="tooltip" title="Edit Sub Category"><i class='fa fa-pencil' style="color: #fff;"></i></a>
										</td>
									</tr>
								</c:forEach>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<form method="get" action="${contextPath}/mst/vendor/add"
	id="edit">
	<input type="hidden" id="vendorIddd" name="vendorId" value="">
	<input type="hidden" class="" id="encodedDataedit"
		name="encodedDataedit" value="" />
</form>
<form method="post"
	action="${contextPath}/mst/vendor/delete"
	id="deleteVendor">
	<input type="hidden" name="${_csrf.parameterName}"
		value="${_csrf.token}" /> <input type="hidden" id="vendorIdd"
		name="vendorId" value="">
</form>
<form method="post" action="${contextPath}/document/download" id="download" target="empty">
	<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" /> 
	<input type="hidden" id="docPath" name="docPath" value=""> 
	<input type="hidden" id="module" name="module" value="">
</form>
<script>
    function edit(id) {
        $("#vendorIddd").val(id);
        encryptFormData("edit", tableOrTbodyIDS, tableOrTbodyKeys);
        $("#edit").submit();
    }
	function validateForms(){
		validateAndFormSubmit('addVendorFrm', 'thisisRequiredField');
	}
	var tableOrTbodyID=['bankDetails'];
	var tableOrTbodyKey=['vendorBankDetails'];
	function validateAndFormSubmit(formId, className){
		let isValid = validateRequiredFields(className, formId);
		if(isValid){
			var result=true;
			$('#bankDetails').find('input[type="radio"]').each(function() {
				if (this.checked) {
					result=false;
				}
			});
			if(result){
				isValid=false;
				bootbox.alert("Please choose primary bank.");
			}
		}
		encryptFormData(formId, tableOrTbodyID, tableOrTbodyKey);
		if(isValid){
			bootbox.confirm("Are you sure you want to submit the form?", function(result){
				if(result){
					
					$("#"+formId).submit();
				}
			});
		}
	}

	function deleteVendor(id){
		$("#vendorIdd").val(id);
		$("#deleteVendor").submit();
	}
	$('#objectIdAndTypeIdDiv').addClass('col-md-3');
	$('#upperEntityIdDiv').addClass('col-md-3');
	$('#objectEntityIdAndTypeId .btn-light').css('border', '1px dashed #b9bfcf');

	var bankRow=0+${bankRow};
	function addbankRow(){
	$.getScript('${contextPath}/assets/utilsJs/common-utils.js');
		var html="<tr style='vertical-align: middle;' id='row"+bankRow+"'>";
			html+="<td><input class='form-control form-control-sm noSpecialChar thisisRequiredField' type='text' id='ifsc"+bankRow+"' name='' placeholder='enter IFSC code' value='' maxlength='30' onchange='fetchBankDetails(this.value,"+bankRow+")'></td>";
			html+="<td><input class='form-control form-control-sm thisisRequiredField' type='text' name='' id='bank"+bankRow+"' placeholder='enter bank name' value='' maxlength='30' readonly></td>";
			html+="<td><input type='hidden' id='branchId"+bankRow+"' name='vendorBankDetails["+bankRow+"].bankBranchId' value=''>	";
			html+="<input class='form-control form-control-sm thisisRequiredField' type='text' name='' id='branch"+bankRow+"' placeholder='enter bank branch name' value='' maxlength='30' readonly></td>";
			html+="<td><input class='form-control form-control-sm NumbersOnly thisisRequiredField' type='text' name='vendorBankDetails["+bankRow+"].accountNo' id='account"+bankRow+"' placeholder='enter account no.' value='' maxlength='20' ></td>";
			html+="<td><input class='form-control form-control-sm thisisRequiredField' type='text' name='vendorBankDetails["+bankRow+"].accountHolderName' id='holder"+bankRow+"' placeholder='enter account holder name' value='' maxlength='30' ></td>";
			html+="<td><input type='radio' class='col-12' style='height:15px' name='isFractional' id='' onclick='setPrimaryData("+bankRow+")'><input type='hidden' class='isPrimary' id='isPrimary"+bankRow+"' name='vendorBankDetails["+bankRow+"].isPrimary' value='false'></td>";
			html+="<td><button type='button' class='btn btn-danger' title='Remove' onclick='removebankRow("+bankRow+")'><i class='fa fa-trash' aria-hidden='true'></i></button></td>";
			html+="</tr>";
		$("#bankDetails").append(html);
		bankRow++;
	}
	function removebankRow(id){
		if(id==bankRow-1){
			if(bankRow==1){
				bootbox.alert("atleast one bank details compulsory");
				return false;
			}
			$("#row"+id).remove();
			bankRow--;
		}
	}
	function setPrimaryData(id){
		$(".isPrimary").val(false);
		$("#isPrimary"+id).val(true); 
	}

	function downloadDoc(path,module){
		$("#docPath").val(path);
		$("#module").val(module);
		$("#download").submit();
	}

	function fetchBankDetails(ifsccode,id){

		$.ajax({
			url : '${contextPath}/ajax/getBankDetails?ifscCode='+ifsccode,
			success : function(response) {
				var obj=JSON.parse(response);
				if(obj.result){
					$("#branchId"+id).val(obj.branchId);
					$("#bank"+id).val(obj.bankName);
					$("#branch"+id).val(obj.branchName);
				}else{
					$("#ifsc"+id).val("");
					bootbox.alert("Please Enter correct ifsc code.");
					return false;
				}
			},error: function(error) {
			
			}
		});	
	}
function backToModule(){
       let currentModuleCode =  localStorage.getItem('currentModuleCode');
       $('#moduleId').val(enc_password(currentModuleCode));
       $('#moduleForm').submit();
    }
</script>