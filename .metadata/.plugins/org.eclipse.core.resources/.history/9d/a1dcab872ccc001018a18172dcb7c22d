<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>
<c:set var="contextPath" value="${pageContext.request.contextPath}" />
<%-- <c:set var="userDetails" value="${serviceOutcome.data}"/> 
 --%>
<%-- <script type="text/javascript" src="${contextPath}/assets/appJs/validation/common-utils.js"></script> --%>
<%-- <script type="text/javascript" src="${contextPath}/assets/js/fams/common-utils.js"></script> --%>
<script type="text/javascript" src="${contextPath}/assets/utilsJs/common-utils.js"></script>
<script src="${contextPath}/assets/appJs/validation/commonMaster.js"></script>
<style>
.freeze {
	pointer-events: none;
}

.headingText {
	border-bottom: 1px solid #aa6b28;
	margin-bottom: 10px;
}

.headingText>h6 {
	font-size: 14px;
}
</style>
<div class="card">
	<div class='card-header'>
		<div class="row">
			<div class="col-md-12">
				<h5 class="card-title">Create Vendor</h5>
			</div>
		</div>
	</div>

	<div class="card-body">
		<form class="form-horizontal" action="${contextPath}/agency/save"
			method="POST" id="agencyForm">
			<input type="hidden" name="${_csrf.parameterName}"
				value="${_csrf.token}" /> <input type="hidden" name="agencyId"
				value="${agencyId}" id="agencyId">
				 <input type="hidden" name="agencyCode"
				value="${agencyData.agencyCode}" id="agencyCode">
				<input type="hidden" id="cipherText" name="cipherText" value="">
				  <input type="hidden" id="actionType" name="action" value="${action}" />
			<div class="row">


				<div class="form-group col-md-3">
					<label class="required">Vendor Name: </label>
					<div class="col-md-12">
						<input type="text" id="agencyName" name="agencyName"
						class="form-control form-control-sm"
						required maxlength="35" value="${agencyData.agencyName}">
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Vendor Type:</label>
					<div class="col-md-12">
						<select id="agencyType" name="agencyType"
							class="form-control form-control-sm form-select" required>
							<option value="">-- Select --</option>
							<c:forEach var="agency" items="${agencyTypeList}">
								<option value="${agency.valueEn}"
									${agencyData.agencyType == agency.valueEn ? 'selected' : ''}>
									${agency.valueEn}</option>
							</c:forEach>
						</select>
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">GST No: </label>
					<div class="col-md-12">
						<input type="text" id="gst" name="gst" placeholder=" "
							class="form-control form-control-sm alphanumeric uppercase" maxlength="15"
							value="${agencyData.gst}" onblur="isValidGST(this)" >
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">PAN: </label>
					<div class="col-md-12">
						<c:choose>
							<c:when test="${action eq 'EDIT'}">
								<input type="text" id="pan" name="pan"
									class="form-control form-control-sm alphanumeric uppercase"
									value="${agencyData.pan}" disabled="disabled" />
							</c:when>
							<c:otherwise>
								<input type="text" id="pan" name="pan"
									class="form-control form-control-sm alphanumeric uppercase"
									required maxlength="15" value="${agencyData.pan}"
									onblur="checkDuplicatePanAndAadhar();" />
							</c:otherwise>
						</c:choose>
					</div>					
				</div>
				<div class='col-md-12'>
					<div class='headingText'>
						<h6>Authorize Person Details</h6>
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Name: </label>
					<div class="col-md-12">
						<input type="text" id="authPerName" name="authPerName"
							placeholder="" class="form-control form-control-sm AlphaSpaceNumericOnly"
							maxlength="35" value="${agencyData.authPerName}">
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Aadhaar: </label>
					<div class="col-md-12">
						<input type="text" id="authPerAdhar" name="authPerAdhar"
							placeholder=" " class="form-control form-control-sm numeric"
							maxlength="12" value="${agencyData.authPerAdhar}" onblur="checkDuplicatePanAndAadhar();" required>
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Email: </label>
					<div class="col-md-12">
						<input type="text" id="authPerEmail" name="authPerEmail"
							placeholder=" " class="form-control form-control-sm email"
							maxlength="35" value="${agencyData.authPerEmail}" onblur="validateEmailField('#authPerEmail');" required>
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Mobile: </label>
					<div class="col-md-12">
						<input type="text" id="authPerMob" name="authPerMob"
							placeholder=" "
							class="form-control form-control-sm mobile-number" maxlength="10"
							value="${agencyData.authPerMob}" onblur="validateMobileNumber(this)" required>
					</div>
				</div>

				<div class='col-md-12'>
					<div class='headingText'>
						<h6>Contact Person Details</h6>
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Name: </label>
					<div class="col-md-12">
						<input type="text" id="conPerName" name="conPerName"
							placeholder="" class="form-control form-control-sm AlphaSpaceNumericOnly"
							maxlength="35" value="${agencyData.conPerName}" required>
					</div>
				</div>
				<div class="form-group col-md-3">
					<label class="required">Email: </label>
					<div class="col-md-12">
						<input type="text" id="conPerEmail" name="conPerEmail"
							placeholder=" " class="form-control form-control-sm email"
							maxlength="35" value="${agencyData.conPerEmail}" onblur="validateEmailField('#conPerEmail')">
					</div>
				</div>

				<div class="form-group col-md-3">
					<label class="required">Mobile: </label>
					<div class="col-md-12">
						<input type="text" id="conPerMob" name="conPerMob"
							class="form-control form-control-sm mobile-number" maxlength="10"
							value="${agencyData.conPerMob}" onblur="validateMobileNumber(this)">
					</div>
				</div>
				<div class="form-group col-md-3">
					<label class="required">Address: </label>
					<div class="col-md-12">
						<input type="text" id="address" name="address"
							class="form-control form-control-sm" maxlength="100"
							value="${agencyData.address}">
					</div>
				</div>
				<div class='col-md-12'>
					<div class='row'>
						<div class="col-md-3">
							<div class="form-group">
								<label class="col-md-12 required" for="districtId">District
									Name</label>
								<div class="col-md-12">
									<select class="form-control form-control-sm form-select select2"
										data-live-search="true" id="districtId" name="districtId"
										onchange="LoadBlockByDistrict(this.value)">
										<option value="0" selected disabled>-Select District-</option>
										<c:forEach var="district" items="${districtList}">
											<option value="${district.districtId}"
												${district.districtId eq agencyRecordDto.districtId?'selected':''}>${district.districtName}</option>
										</c:forEach>
									</select>
								</div>
							</div>
						</div>

						<div class="col-md-3">
							<div class="form-group">
								<label class="col-md-12 required" for="blockId">Block
									Name</label>
								<div class="col-md-12">
									<select id="blockId" name="blockId"
										class="form-control form-control-sm form-select select2" required="required"
										onchange="LoadGrampanchayatByBlock(this.value)">
										<option value="0" selected disabled>-Select Block-</option>
										<c:forEach var="block" items="${blockList}">
											<option value="${block.blockId}"
												${block.blockId eq agencyRecordDto.blockId?'selected':''}>
												${block.blockName}</option>
										</c:forEach>
									</select>
								</div>
							</div>
						</div>

						<div class="col-md-3">
							<div class="form-group">
								<label class="col-md-12 required" for="gpId">GramPanchayat
									Name</label>
								<div class="col-md-12">
									<select id="gpId" name="gpId"
										class="form-control form-control-sm form-select select2" required="required"
										onchange="LoadVillageByGrampanchayat(this.value)">
										<option value="0" selected disabled>-Select
											GramPanchayat-</option>
										<c:forEach var="panchayat" items="${panchayatList}">
											<option value="${panchayat.gpId}"
												${panchayat.gpId eq agencyRecordDto.gpId?'selected':''}>${panchayat.gpName}</option>
										</c:forEach>
									</select>
								</div>
							</div>
						</div>

						<div class="col-md-3">
							<div class="form-group">
								<label class="col-md-12 required" for="gpId">Village
									Name</label>
								<div class="col-md-12">
									<select id="villageId" name="villageId"
										class="form-control form-control-sm form-select select2" required="required">
										<option value="0" selected disabled>--Select
											Village--</option>
										<c:forEach var="village" items="${villageList}">
											<option value="${village.villageId}"
												${village.villageId eq agencyRecordDto.villageId?'selected':''}>${village.villageName}</option>
										</c:forEach>
									</select>
								</div>
							</div>
						</div>

						
					</div>
				</div>

				<div class="table-responsive" id="tblrt">
					<table style="width: 100%"
						class="table table-striped table-bordered  mt-3 "
						id="apndTable12">
						<thead>
							<tr>
								<!-- <th>Sl No.<span class="text-danger">*</span></th> -->
								<th>Bank<span class="text-danger">*</span></th>
								<th>Branch<span class="text-danger">*</span></th>
								<th>IFSC Code<span class="text-danger">*</span></th>
								<th>Account No<span class="text-danger">*</span></th>
								<th>Account Holder Name<span class="text-danger">*</span></th>
								<th>Is Primary</th>
								<th>
									<button type="button" class="btn btn-success" title="Add"
										id="addRow">
										<i class="fa fa-plus"></i>
									</button>
								</th>
							</tr>
						</thead>
						<tbody id="myTableBody">
							<c:choose>
								<c:when test="${not empty bankDetails}">
									<c:forEach var="bankDetail" items="${bankDetails}"
										varStatus="status">
										<tr>
											<input type="hidden"
												name="bankList[${status.index}].agencyBankId"
												value="${bankDetail.agencyBankId}" />
											<td><select class="form-control form-control-sm form-select"
												id="bank${status.index}"
												name="bankList[${status.index}].bankId"
												onchange="getBranchByBank(this.value, ${status.index})">
													<option value="0" selected disabled>--Select
														Bank--</option>
													<c:forEach items="${bankList}" var="bank">
														<option value="${bank.bankId}"
															<c:if test="${bankDetail.bankId == bank.bankId}">selected</c:if>>
															${bank.bankName}</option>
													</c:forEach>
											</select></td>

											<td><select id="branch${status.index}"
												name="bankList[${status.index}].branchId"
												class="form-control form-control-sm form-select"
												onchange="getIFSCByBranchId(this.value,${status.index});">
													<option value="" selected disabled>-Select Branch-</option>
													<c:forEach var="branch" items="${bankDetail.branchList}">
														<option value="${branch.bankBranchId}"
															<c:if test="${branch.bankBranchId == bankDetail.branchId}">selected</c:if>>
															${branch.branchName}</option>
													</c:forEach>
											</select></td>

											<td><input type="text" id="ifsc${status.index}"
												name="bankList[${status.index}].ifscCode"
												value="${bankDetail.ifscCode}"
												class="form-control form-control-sm alphanumeric"
												maxlength="15" readonly="readonly" /></td>

											<td><input type="text" id="accNo${status.index}"
												name="bankList[${status.index}].accountNo"
												value="${bankDetail.accountNo}"
												class="form-control form-control-sm numeric" maxlength="20" onblur="validateAccountNumber('#accNo${status.index}')" /></td>

											<td><input type="text" id="accHldName${status.index}"
												name="bankList[${status.index}].accHldName"
												value="${bankDetail.accHldName}"
												class="form-control form-control-sm alpha-space"
												maxlength="50" /></td>

											<td><input type="checkbox"
												name="bankList[${status.index}].isPrimary"
												class="isPrimaryCheckbox form-check-input"
												<c:if test="${bankDetail.isPrimary}">checked</c:if> /></td>
											<td>
												<button type="button" class="btn btn-danger deleteRow"
													title="Delete"
													<c:if test="${status.index == 0}">disabled</c:if>>
													<i class="fa fa-minus"></i>
												</button>
											</td>
										</tr>
									</c:forEach>
								</c:when>

								<c:otherwise>
									<tr>
										<td><select class="form-control form-control-sm form-select select2"
											id="bank0" name="bankList[0].bankId"
											onchange="getBranchByBank(this.value, 0)">
												<option value="0" selected disabled>--Select Bank--</option>
												<c:forEach items="${bankList}" var="bank">
													<option value="${bank.bankId}">${bank.bankName}</option>
												</c:forEach>
										</select></td>
										<td><select id="branch0" name="bankList[0].branchId"
											class="form-control form-control-sm form-select select2"
											onchange="getIFSCByBranchId(this.value,0);">
												<option value="" selected disabled>--Select
													Branch--</option>
										</select></td>
										<td><input type="text" id="ifsc0"
											name="bankList[0].ifscCode" maxlength="15"
											class="form-control form-control-sm alphanumeric"
											readonly="readonly" /></td>

										<td><input type="text" id="accNo0"
											name="bankList[0].accountNo" maxlength="20"
											class="form-control form-control-sm numeric" onblur="validateAccountNumber('#accNo0')"/></td>
										<td><input type="text" id="accHldName0"
											name="bankList[0].accHldName" maxlength="50"
											class="form-control form-control-sm alpha-space" /></td>
										<td><input type="checkbox" name="bankList[0].isPrimary"
											class="isPrimaryCheckbox form-check-input" /></td>
										<td>
											<button type="button" class="btn btn-danger deleteRow"
												disabled>
												<i class="fa fa-minus"></i>
											</button>
										</td>
									</tr>
								</c:otherwise>
							</c:choose>
						</tbody>
					</table>
				</div>
			</div>
			<div class="col-md-12 mt-2 text-center">
				<c:choose>
					<c:when test="${not empty agencyData.agencyId}">
						<button type="button" class="btn btn-success" id="updateButton"
							onclick="prepareSubmit();">Update</button>
					</c:when>
					<c:otherwise>
						<button type="button" class="btn btn-success"
							onclick="prepareSubmit();">Save</button>
					</c:otherwise>

				</c:choose>
				<a href="${contextPath}/home" type="button"
					class="btn btn-warning btn-sm">Back</a>

			</div>

		</form>
	</div>
</div>
<script>
let isSubmitTriggered = false;
	function submitForm() {
		//event.preventDefault();
		debugger;
	    let agencyName = $('#agencyName').val().trim();
	    let agencyType = $('#agencyType').val();
	    let gst = $('#gst').val().trim();
	    let pan = $('#pan').val().trim();
	    let authPerName = $('#authPerName').val().trim();
	    let authPerAdhar = $('#authPerAdhar').val().trim();
	    let authPerEmail = $('#authPerEmail').val().trim();
	    let authPerMob = $('#authPerMob').val().trim();
	    let conPerName = $('#conPerName').val().trim();
	    let conPerEmail = $('#conPerEmail').val().trim();
	    let conPerMob = $('#conPerMob').val().trim();
	    let districtId = $('#districtId').val();
	    let blockId = $('#blockId').val();
	    let gpId = $('#gpId').val();
	    let villageId = $('#villageId').val();
	    let address = $('#address').val().trim();
	    let action = $('#actionType').val();


	    if (agencyName === "") {
	        bootbox.alert("Agency Name is required."); 
	        return false;
	    }
	    if (agencyType === "") {
	        bootbox.alert("Agency Type is required."); 
	        return false;
	    }
	    if (gst === "") {
	        bootbox.alert("GST No is required."); 
	        return false;
	    }
	    if (pan === "") {
	        bootbox.alert("PAN is required."); 
	        return false;
	    }
	    if (authPerName === "") {
	        bootbox.alert("Authorised Person Name is required."); 
	        return false;
	    }
	    if (authPerAdhar === "") {
	        bootbox.alert("Authorised Person Aadhaar is required."); 
	        return false;
	    }
	    if (authPerEmail === "") {
	        bootbox.alert("Authorised Person Email is required."); 
	        return false;
	    }
	    if (authPerMob === "") {
	        bootbox.alert("Authorised Person Mobile is required."); 
	        return false;
	    }
	    if (conPerName === "") {
	        bootbox.alert("Contact Person Name is required."); 
	        return false;
	    }
	    if (conPerEmail === "") {
	        bootbox.alert("Contact Person Email is required."); 
	        return false;
	    }
	    if (conPerMob === "") {
	        bootbox.alert("Contact Person Mobile is required."); 
	        return false;
	    }
	    if (districtId === "0" || districtId === null ) {
	        bootbox.alert("Please select District."); 
	        return false;
	    }
	    if (blockId === "0" || blockId === null) {
	        bootbox.alert("Please select Block."); 
	        return false;
	    }
	    if (gpId === "0"|| gpId === null) {
	        bootbox.alert("Please select Gram Panchayat."); 
	        return false;
	    }
	    if (villageId === "0"|| villageId === null) {
	        bootbox.alert("Please select Village."); 
	        return false;
	    }
	    if (address === "") {
	        bootbox.alert("Address is required."); 
	        return false;
	    }
	        
	    if (action !== 'EDIT') {
			$.ajax({
				url: contextPath + "/agency/check-duplicate",
				type: "GET",
				data: { pan: pan, aadhar: authPerAdhar },
				success: function (response) {
					if (response.pan) {
						bootbox.alert("PAN number already exists.");
						$('#pan').val('').focus();
						return;
					}
					if (response.aadhar) {
						bootbox.alert("Aadhaar number already exists.");
						$('#authPerAdhar').val('').focus();
						return;
					}
					if (validateAgencyForm()) {
						submitEncryptFormData();				
					}
				},
				error: function () {
					bootbox.alert("Error checking for duplicates.");
				}
			});
		} else {
			if (validateAgencyForm()) {
				submitEncryptFormData();
			}
		}
	   
	}
	
	
	function submitEncryptFormData(){
		
		var actionType =  $("#actionType").val();
	       var message = (actionType !== 'EDIT' ? 'save' : 'update');
	   	var bizContent = $("#agencyForm").serializeArray();
	   	console.log(enc_password(collectAgencyData()));
	   	console.log()
	   	$("#cipherText").val(enc_password(collectAgencyData()));
	   	bootbox.confirm("Do you want to " + message + " Agency Detials ?", function(result) {
	   		if (result) {
	   			showLoader();
	   			$('#agencyForm').submit();
	   			console.log($("#cipherText").val());
	   		}
	   	});	
				
	}
	
	
	function collectAgencyData() {
		debugger;
	    const bankList = [];
	    $("#myTableBody tr").each(function () {
	        const row = $(this);
	        const bankItem = {
	            agencyId: parseInt(row.find("input[name*='agencyId']").val()) || null,
	            agencyBankId: parseInt(row.find("input[name*='agencyBankId']").val()) || null,
	            bankId: parseInt(row.find("select[name*='bankId']").val()) || null,
	            bankName: row.find("input[name*='bankName']").val() || "",
	            branchId: parseInt(row.find("select[name*='branchId']").val()) || null,
	            branchName: row.find("input[name*='branchName']").val() || "",
	            ifscCode: row.find("input[name*='ifscCode']").val() || "",
	            accountNo: row.find("input[name*='accountNo']").val() || "",
	            accHldName: row.find("input[name*='accHldName']").val() || "",
	            isPrimary: row.find("input[name*='isPrimary']").is(":checked"),
	        };

	        bankList.push(bankItem);
	    });

	    const agencyData = {
	    		
	        agencyId: parseInt($("#agencyId").val()) || null,
	        agencyName: $("#agencyName").val(),
	        agencyCode: $("#agencyCode").val(),
	        agencyType: $("#agencyType").val(),
	        gst: $("#gst").val(),
	        authPerName: $("#authPerName").val(),
	        authPerAdhar: $("#authPerAdhar").val(),
	        authPerEmail: $("#authPerEmail").val(),
	        authPerMob: $("#authPerMob").val(),
	        conPerName: $("#conPerName").val(),
	        conPerEmail: $("#conPerEmail").val(),
	        conPerMob: $("#conPerMob").val(),
	        villageId: parseInt($("#villageId").val()) || null,
	        address: $("#address").val(),
	        isActive: $("#isActive").is(":checked"),
	        bankList: bankList,
	        primaryBank: $("#primaryBank").val(),
	        _csrf: $("#_csrf").val(),
	        cipherText: $("#cipherText").val()
	    };
	    if (!$("#pan").is(':disabled')) {
	        agencyData.pan = $("#pan").val();
	    }
	    return JSON.stringify(agencyData);
	}


	function showLoader() {
		$(".loader-div").css("display", "flex");
	}

	function hideLoader() {
		$(".loader-div").css("display", "none");
	}
	
	function prepareSubmit(){
		debugger;
	    isSubmitTriggered = true;
	    setTimeout(() => {
	        submitForm();  
	    }, 100);
	}

	
	function LoadBlockByDistrict(distId) {
		
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchBlockByDistrict",
	        data: {
	        	districtId: distId,
	        },
	        success: function (blocks) {
	            var block = $('#blockId'); 
	            block.empty();
	            block.append('<option value="" selected disabled>-Select Block-</option>');

	            $.each(blocks, function(index, blockData) {
	            	block.append('<option value="' + blockData.blockId + '">' + blockData.blockName + '</option>');
	            });
	        },
	        error: function (error) {
	            console.error("Error fetching blocks:", error);
	        }
	    });
	}
	
	function LoadGrampanchayatByBlock(blockId) {
		debugger;
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchGrampanchayatByBlock",
	        data: {
	        	blockId: blockId,
	        },
	        success: function (grampanchayats) {
	            var gp = $('#gpId'); 
	            gp.empty();
	            gp.append('<option value="" selected disabled>-Select GramPanchayat-</option>');

	            $.each(grampanchayats, function(index, grampanchayat) {
	            	gp.append('<option value="' + grampanchayat.gpId + '">' + grampanchayat.gpName + '</option>');
	            });
	        },
	        error: function (error) {
	            console.error("Error fetching grampanchayat:", error);
	        }
	    });
	}
	
	function getBranchByBank(bankId,count) {
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchBranchByBank",
	        data: {
	            bankId: bankId
	        },
	        success: function (response) {
	            var branch = $('#branch'+count);
	            branch.empty();
	            branch.append('<option value="" selected disabled>-Select Branch-</option>');
	            $('#accNo' + count).val('');
	            $('#ifsc' + count).val('');
	            var jsonResponse = typeof response === 'string' ? JSON.parse(response) : response;

	            if (jsonResponse.status === 'success' && jsonResponse.data && jsonResponse.data.length > 0) {
	                $.each(jsonResponse.data, function(index, branchData) {
	                    branch.append('<option value="' + branchData.bankBranchId + '">' + branchData.branchName + '</option>');
	                	//branch.append('<option value="' + branchData.branchName + '">' + branchData.branchName + '</option>');
	                });
	            } else if (jsonResponse.status === 'empty') {
	                console.warn(jsonResponse.message);
	            } else {
	                console.error("Unexpected response status:", jsonResponse.status);
	            }
	        },
	        error: function (error) {
	            console.error("Error fetching branches:", error);
	        }
	    });
	}
	

	function getIFSCByBranchId(branchId, count) {
	    $.ajax({
	        type: "GET",
	        url: '${contextPath}/agency/fetchIFSCByBranchId',
	        data: { branchId: branchId },
	        success: function (response) {
	            console.log(response);
	            var jsonResponse = typeof response === 'string' ? JSON.parse(response) : response;

	            var ifscInput = $('#ifsc' + count);

	            if (jsonResponse.data && jsonResponse.data.ifscCode) {
	                ifscInput.val(jsonResponse.data.ifscCode); 
	                $('#accNo' + count).val('');
	            } else {
	                ifscInput.val(""); 
	                console.warn("IFSC code not found.");
	            }
	        },
	        error: function (error) {
	            console.error("Error fetching IFSC code:", error);
	        }
	    });
	}
	
	let countt = $('#myTableBody tr').length - 1;

	$('#addRow').on('click', function () {
		debugger;
	    let lastRow = $('#myTableBody tr:last');
	    if (lastRow.length > 0) {
	        let bankVal = lastRow.find('select[name*=".bankId"]').val();
	        let branchVal = lastRow.find('select[name*=".branchId"]').val();
	        let ifscVal = lastRow.find('input[name*=".ifscCode"]').val();
	        let accNoVal = lastRow.find('input[name*=".accountNo"]').val();
	        let accHldNameVal = lastRow.find('input[name*=".accHldName"]').val();

	        if (!bankVal || bankVal === "0") {
	            bootbox.alert("Please Select Bank.");
	            return false;
	        }
	        if (!branchVal || branchVal === "0") {
	            bootbox.alert("Please Select Branch.");
	            return false;
	        }
	        if (!ifscVal) {
	            bootbox.alert("Please Enter IFSC Code.");
	            return false;
	        }
	        if (!accNoVal) {
	            bootbox.alert("Please Enter Account Number.");
	            return false;
	        }
	        if (!accHldNameVal) {
	            bootbox.alert("Please Enter Account Holder Name.");
	            return false;
	        }
	    }

	    countt++;

	    let html = '<tr>';
	    html += '<td><select class="form-control form-control-sm form-select" id="bank' + countt + '" name="bankList[' + countt + '].bankId" onchange="getBranchByBank(this.value,' + countt + ')">';
	    html += '<option value="0"selected disabled>--Select Bank--</option>';
	    html += '<c:forEach items="${bankList}" var="bank"><option value="${bank.bankId}">${bank.bankName}</option></c:forEach>';
	    html += '</select></td>';
	    html += '<td><select id="branch' + countt + '" name="bankList[' + countt + '].branchId" class="form-control form-control-sm form-select" onchange="getIFSCByBranchId(this.value,' + countt + ');">';
	    html += '<option value="" selected disabled>--Select Branch--</option>';
	    html += '</select></td>';
	    html += '<td><input type="text" maxlength="15" readonly="readonly"  id="ifsc' + countt + '" name="bankList[' + countt + '].ifscCode" class="form-control form-control-sm alphanumeric" /></td>';
	    html += '<td><input type="text" maxlength="20" onblur="validateAccountNumber(\'#accNo' + countt + '\')"  class="form-control form-control-sm NumbersOnly" id="accNo' + countt + '" name="bankList[' + countt + '].accountNo" /></td>';
	    html += '<td><input type="text" maxlength="50" class="form-control form-control-sm AlphabetsOnly" id="accHldName' + countt + '" name="bankList[' + countt + '].accHldName" /></td>';
	    html += '<td><input type="checkbox" class="form-check-input isPrimaryCheckbox" name="bankList[' + countt + '].isPrimary" /></td>';
	    html += '<td><button type="button" class="btn btn-danger deleteRow" title="Delete"><i class="fa fa-minus"></i></button></td>';
	    html += '</tr>';

	    $('#myTableBody').append(html);
	});

	$('#myTableBody').on('click', '.deleteRow', function () {
	    $(this).closest('tr').remove();
	    reindexBankListRows();
	});

	function reindexBankListRows() {
	    $('#myTableBody tr').each(function (index) {
	        $(this).find('select[name*=".bankId"]').attr({
	            name: 'bankList[' + index + '].bankId',
	            id: 'bank' + index,
	            onchange: 'getBranchByBank(this.value,' + index + ')'
	        });
	        $(this).find('select[name*=".branchId"]').attr({
	            name: 'bankList[' + index + '].branchId',
	            id: 'branch' + index,
	            onchange: 'getIFSCByBranchId(this.value,' + index + ')'
	        });
	        $(this).find('input[name*=".ifscCode"]').attr({
	            name: 'bankList[' + index + '].ifscCode',
	            id: 'ifsc' + index
	        });
	        $(this).find('input[name*=".accountNo"]').attr({
	            name: 'bankList[' + index + '].accountNo',
	            id: 'accNo' + index,
	            onblur: "validateAccountNumber('#accNo" + index + "')"
	        });
	        $(this).find('input[name*=".accHldName"]').attr({
	            name: 'bankList[' + index + '].accHldName',
	            id: 'accHldName' + index
	        });
	        $(this).find('input[name*=".isPrimary"]').attr('name', 'bankList[' + index + '].isPrimary');
	    });

	    countt = $('#myTableBody tr').length - 1;
	}
	
function LoadVillageByGrampanchayat(gpId) {		
	    $.ajax({
	        type: "GET",
	        url: "${contextPath}/common/fetchVillageByGrampanchayat",
	        data: {
	        	gpId: gpId,
	        },
	        success: function (villages) {
	            var gp = $('#villageId'); 
	            gp.empty();
	            gp.append('<option value="" selected disabled>--Select Village--</option>');

	            $.each(villages, function(index, village) {
	            	gp.append('<option value="' + village.villageId + '">' + village.villageName + '</option>');
	            });
	        },
	        error: function (error) {
	            console.error("Error fetching village:", error);
	        }
	    });
	}
	
$(document).on('change', 'input[type="checkbox"][name*=".isPrimary"]', function () {
    if (this.checked) {
        $(this).val(true);
        $('input[type="checkbox"][name*=".isPrimary"]').not(this).prop('checked', false);
        $('input[type="checkbox"][name*=".isPrimary"]').not(this).prop('value', false);
    }
});

$(document).on('change', 'input[name*=".ifscCode"], input[name*=".accountNo"]', function () {  
    const $currentRow = $(this).closest('tr');
    const bankId = $currentRow.find('select[name*=".bankId"]').val();
    const accNo = $currentRow.find('input[name*=".accountNo"]').val().trim();
    const ifscCode = $currentRow.find('input[name*=".ifscCode"]').val().trim();
    let action = $('#actionType').val();
   

    if (!bankId || bankId === "0" || accNo === "") 
    	return;
    if (action !== 'EDIT') {
    	$.ajax({
            type: 'GET',
            url: "${contextPath}/agency/validateAccountNumber",
            data: {
            	ifscCode: ifscCode,
                accountNo: accNo
            },
            success: function (response) {
                if (!response.valid) {
                    bootbox.alert("This account number already exists under the selected bank.");
                    $currentRow.find('input[name*=".accountNo"]').val('');
                }
            },
            error: function () {
                bootbox.alert("Server error while checking account number.");
            }
        });
    }
    
    const accountIfscMap = new Set();

    $('tr').each(function () {
        const $row = $(this);
        const bankId = $row.find('select[name*=".bankId"]').val();
        const accNo = $row.find('input[name*=".accountNo"]').val();
        const ifsc = $row.find('input[name*=".ifscCode"]').val();
        if (!bankId || bankId === "0" || accNo === "" || ifsc === "") 
        	return;
        const key = accNo + "|" + ifsc; 
        if (accountIfscMap.has(key)) {
            bootbox.alert("This Account Number and IFSC Code already exists. Please enter unique values.");
            $row.find('input[name*=".accountNo"]').val('');
             //$row.find('input[name*=".ifscCode"]').val('');
            return false;
        }

        accountIfscMap.add(key);
    });

    

    
});




function validateAgencyForm() {
    let isValid = true;
    let errorMessage = "";
    let primaryCount = 0;
    $('#myTableBody tr').each(function (index) {
        let bankId = $(this).find('select[name="bankList['+index+'].bankId"]').val();
        let branchId = $(this).find('select[name="bankList['+index+'].branchId"]').val();
        let ifsc = $(this).find('input[name="bankList[' + index + '].ifscCode"]').val();
        let accNo = $(this).find('input[name="bankList[' + index + '].accountNo"]').val();
        let accHldName = $(this).find('input[name="bankList[' + index + '].accHldName"]').val();
        let isPrimary = $(this).find('input[name="bankList[' + index + '].isPrimary"]').is(":checked");     
        if (bankId == "0" || bankId == null) {
            errorMessage = 'Please select a bank for row '+(index+1);
            isValid = false;
            return false;
        }
        else if (branchId == "" || branchId == null || branchId == "0") {
            errorMessage = 'Please select a branch for row'+(index+1);
            isValid = false;
            return false;
        }
        else if (ifsc === "" || ifsc == null ) {
            errorMessage = 'IFSC Code is missing in row'+(index+1);
            isValid = false;
            return false;
        }
        else if (accNo === ""|| accNo == null) {
            errorMessage = 'Account No is required in row'+(index+1);
            isValid = false;
            return false;
        }
        else if(accHldName === "" || accHldName == null) {
            errorMessage = 'Account Holder Name is required in row'+(index+1);
            isValid = false;
            return false;
        }
        
        if (isPrimary) {
            primaryCount++;
        }

    });

    if (!isValid) {
        bootbox.alert(errorMessage);
        return false;
    }
    if (primaryCount === 0) {
        bootbox.alert("Please select one Primary Bank Account.");
        return false;
    } else if (primaryCount > 1) {
        bootbox.alert("Only one bank can be marked as Primary.");
        return false;
    }

    return true; 
}

function checkDuplicatePanAndAadhar() {
    let action = $('#actionType').val();
    if (action === 'EDIT'|| isSubmitTriggered) {
        return;
    }
    let pan = $('#pan').val().trim();
    let aadhar = $('#authPerAdhar').val().trim();

    $.ajax({
        url: "${contextPath}/agency/check-duplicate",
        type: "GET",
        data: { pan: pan, aadhar: aadhar },
        success: function (response) {
            if (response.pan) {
                bootbox.alert("PAN number already exists.");
                $('#pan').val('').focus();
            }
            if (response.aadhar) {
                bootbox.alert("Aadhaar number already exists.");
                $('#authPerAdhar').val('').focus();
            }
        },
        error: function () {
            bootbox.alert("Error checking for duplicates.");
        }
    });
}


function validateEmailField(selector) {
	const emailInput = document.querySelector(selector);
    if (!emailInput) return false;
    let email = emailInput.value.trim();
    if (email === "") {
        return true;
    }
    email = email.toLowerCase();
    emailInput.value = email;
    const maxLength = 35;
    const validateRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const allowedRegex = /^[A-Za-z0-9@._-]+$/;
    if (email.length > maxLength) {
        bootbox.alert("Email is too long. Maximum allowed length is 35 characters.");
        emailInput.value = ''
        return false;
    }
    if (!allowedRegex.test(email)) {
        bootbox.alert("Email contains invalid characters.");
        emailInput.value = ''
        return false;
    }
    if (!validateRegex.test(email)) {
        bootbox.alert("Please enter a valid email address.");
        emailInput.value = '';
        return false;
    }

    return true;
    
}

document.querySelector("#authPerAdhar").addEventListener("blur", function () {
    const aadharField = this;
    const aadhar = aadharField.value.trim();
    if (aadhar !== "") {
        const aadharRegex = /^\d{12}$/;

        if (!aadharRegex.test(aadhar)) {
            bootbox.alert("Please enter a valid 12-digit Aadhaar number.");
            aadharField.value = '';
        } 
    }
});


function validateAccountNumber(element) {
    const accountInput = document.querySelector(element);
    const accountNo = accountInput.value.trim();
	if(accountNo === ""){
		return true;
	}
    const accountRegex = /^\d{6,20}$/; 

    if (!accountRegex.test(accountNo)) {
        bootbox.alert("Account Number must be a numeric value between 6 to 20 digits.");
        accountInput.value = '';
        return false;
    }

    return true;
}


function isValidGST(vGSTnoObj) {
    if (vGSTnoObj == null)
        vGSTnoObj = window.event ? window.event.srcElement : null;

    if (!vGSTnoObj)
        return false;

    const gstVal = vGSTnoObj.value.trim().toUpperCase();
    vGSTnoObj.value = gstVal;

    const gstRegEx = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z][1-9A-Z]Z[0-9A-Z]$/;

    if (gstVal !== "" && !gstRegEx.test(gstVal)) {
        bootbox.alert("GST Number is invalid. It should be like: '27ABCDE1234F1Z5'");
        vGSTnoObj.value = '';
        document.getElementById("pan").value = '';
        return false;
    }

    const extractedPAN = gstVal.substring(2, 12);
    const panRegEx = /^[A-Z]{5}[0-9]{4}[A-Z]$/;

    if (panRegEx.test(extractedPAN)) {
        document.getElementById("pan").value = extractedPAN;
    } else {
    	if(gstVal !== "" && document.getElementById("pan").value !== ""){
      	  bootbox.alert("Extracted PAN from GST is invalid.");
            document.getElementById("pan").value = '';
        }
    }

    return true;
}

function validateMobileNumber(mobileField) {
    if (!mobileField) 
    	return false;

    const mobile = mobileField.value.trim();

    if (mobile === "") 
    	return true;
    const mobileRegex = /^[6-9][0-9]{9}$/;

    if (!mobileRegex.test(mobile)) {
        bootbox.alert("Mobile number must be 10 digits and start with 6 to 9.");
        mobileField.value = '';
        return false;
    }

    return true;
}


$('#myTableBody').on('keypress', '.NumbersOnly', function (event) {
    const regex = /^[0-9]+$/;
    const key = String.fromCharCode(event.which || event.keyCode);
    if (!regex.test(key)) {
        event.preventDefault();
        return false;
    }
});


$(document).on('keypress', '.AlphabetsOnly', function (event) {
    const regex = /^[a-zA-Z\s]*$/; 
    const key = String.fromCharCode(event.which || event.keyCode);
    if (!regex.test(key)) {
        event.preventDefault();
        return false;
    }
});

$(document).on('keypress', '.AlphaSpaceNumericOnly', function (event) {
    const regex = /^[a-zA-Z0-9\s]$/; 
    const key = String.fromCharCode(event.which || event.keyCode);
    if (!regex.test(key)) {
        event.preventDefault();
        return false;
    }
});


</script>